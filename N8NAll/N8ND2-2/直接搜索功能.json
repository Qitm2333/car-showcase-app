{
  "nodes": [
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1837650523,
          "mode": "list",
          "cachedResultName": "NewallCarMappingå®Œæ•´",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit#gid=1837650523"
        },
        "options": {}
      },
      "id": "a99fb46c-1fb8-485a-808e-acfe8597e32c",
      "name": "è¯»å–Google Sheet2",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        4112,
        3248
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YS5a72jpKHezwxcc",
          "name": "Google Sheets account 5"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// æ¨¡ç³ŠåŒ¹é…ç®—æ³• - æœ€å°ä¿®æ”¹ç‰ˆ\nconst inputCarName = $('å‡†å¤‡æŸ¥è¯¢2').item.json.carName;\nconst allCars = $input.all();\n\nconst MATCH_THRESHOLD = 0.70; // åŒ¹é…é˜ˆå€¼70%\n\nconsole.log(`\\n===== å¼€å§‹æ¨¡ç³ŠåŒ¹é… =====`);\nconsole.log(`è¾“å…¥è½¦å‹: ${inputCarName}`);\nconsole.log(`æ•°æ®åº“æ€»æ•°: ${allCars.length}`);\n\n// ===== å­—ç¬¦ä¸²ç›¸ä¼¼åº¦ç®—æ³• =====\n\n// 1. Levenshteinè·ç¦»ï¼ˆç¼–è¾‘è·ç¦»ï¼‰\nfunction levenshteinDistance(str1, str2) {\n  const len1 = str1.length;\n  const len2 = str2.length;\n  const matrix = [];\n\n  for (let i = 0; i <= len1; i++) {\n    matrix[i] = [i];\n  }\n  for (let j = 0; j <= len2; j++) {\n    matrix[0][j] = j;\n  }\n\n  for (let i = 1; i <= len1; i++) {\n    for (let j = 1; j <= len2; j++) {\n      const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;\n      matrix[i][j] = Math.min(\n        matrix[i - 1][j] + 1,\n        matrix[i][j - 1] + 1,\n        matrix[i - 1][j - 1] + cost\n      );\n    }\n  }\n\n  return matrix[len1][len2];\n}\n\n// 2. åŸºäºç¼–è¾‘è·ç¦»çš„ç›¸ä¼¼åº¦ï¼ˆ0-1ï¼‰\nfunction levenshteinSimilarity(str1, str2) {\n  const maxLen = Math.max(str1.length, str2.length);\n  if (maxLen === 0) return 1.0;\n  const distance = levenshteinDistance(str1, str2);\n  return 1 - distance / maxLen;\n}\n\n// 3. Jaro-Winklerç›¸ä¼¼åº¦\nfunction jaroWinklerSimilarity(s1, s2) {\n  // Jaroç›¸ä¼¼åº¦\n  function jaroSimilarity(s1, s2) {\n    if (s1.length === 0 && s2.length === 0) return 1.0;\n    if (s1.length === 0 || s2.length === 0) return 0.0;\n\n    const matchDistance = Math.floor(Math.max(s1.length, s2.length) / 2) - 1;\n    const s1Matches = new Array(s1.length).fill(false);\n    const s2Matches = new Array(s2.length).fill(false);\n\n    let matches = 0;\n    let transpositions = 0;\n\n    for (let i = 0; i < s1.length; i++) {\n      const start = Math.max(0, i - matchDistance);\n      const end = Math.min(i + matchDistance + 1, s2.length);\n\n      for (let j = start; j < end; j++) {\n        if (s2Matches[j] || s1[i] !== s2[j]) continue;\n        s1Matches[i] = true;\n        s2Matches[j] = true;\n        matches++;\n        break;\n      }\n    }\n\n    if (matches === 0) return 0.0;\n\n    let k = 0;\n    for (let i = 0; i < s1.length; i++) {\n      if (!s1Matches[i]) continue;\n      while (!s2Matches[k]) k++;\n      if (s1[i] !== s2[k]) transpositions++;\n      k++;\n    }\n\n    return (\n      (matches / s1.length +\n        matches / s2.length +\n        (matches - transpositions / 2) / matches) /\n      3\n    );\n  }\n\n  const jaro = jaroSimilarity(s1, s2);\n  const prefixLength = Math.min(4, s1.length, s2.length);\n  let prefix = 0;\n  for (let i = 0; i < prefixLength; i++) {\n    if (s1[i] === s2[i]) prefix++;\n    else break;\n  }\n\n  return jaro + prefix * 0.1 * (1 - jaro);\n}\n\n// 4. ç®€å•åŒ…å«åŒ¹é…\nfunction containsMatch(input, target) {\n  const inputLower = input.toLowerCase();\n  const targetLower = target.toLowerCase();\n  \n  // å®Œå…¨åŒ…å«\n  if (targetLower.includes(inputLower) || inputLower.includes(targetLower)) {\n    return 1.0;\n  }\n  \n  // åˆ†è¯åçš„åŒ…å«åŒ¹é…\n  const inputTokens = inputLower.split(/[\\s\\-]+/);\n  const targetTokens = targetLower.split(/[\\s\\-]+/);\n  \n  let matchCount = 0;\n  for (const inputToken of inputTokens) {\n    if (inputToken.length < 2) continue;\n    for (const targetToken of targetTokens) {\n      if (targetToken.includes(inputToken) || inputToken.includes(targetToken)) {\n        matchCount++;\n        break;\n      }\n    }\n  }\n  \n  return inputTokens.length > 0 ? matchCount / inputTokens.length : 0;\n}\n\n// 5. å“ç‰Œ+è½¦å‹åˆ†ç¦»åŒ¹é…ï¼ˆé’ˆå¯¹ä¸­æ–‡è½¦å‹ï¼‰\nfunction brandModelMatch(input, target) {\n  const inputParts = input.split(/[-\\s]+/);\n  const targetParts = target.split(/[-\\s]+/);\n  \n  if (inputParts.length < 2 || targetParts.length < 2) {\n    return 0;\n  }\n  \n  // å“ç‰ŒåŒ¹é…\n  const brandMatch = inputParts[0].toLowerCase() === targetParts[0].toLowerCase() ? 1 : 0;\n  \n  // è½¦å‹åŒ¹é…\n  const modelSimilarity = levenshteinSimilarity(\n    inputParts.slice(1).join('').toLowerCase(),\n    targetParts.slice(1).join('').toLowerCase()\n  );\n  \n  // å“ç‰Œå¿…é¡»åŒ¹é…ï¼Œè½¦å‹ç›¸ä¼¼åº¦>=0.6\n  return brandMatch && modelSimilarity >= 0.6 ? (brandMatch + modelSimilarity) / 2 : 0;\n}\n\n// ===== ç»¼åˆåŒ¹é…è®¡ç®— =====\nfunction calculateComprehensiveScore(input, target) {\n  const inputNorm = input.replace(/\\s+/g, '').toLowerCase();\n  const targetNorm = target.replace(/\\s+/g, '').toLowerCase();\n  \n  // ğŸ”¥ å…³é”®ä¿®æ”¹ï¼šæ£€æŸ¥å®Œæ•´åŒ…å«\n  const inputClean = input.replace(/[\\s\\-]/g, '').toLowerCase();\n  const targetClean = target.replace(/[\\s\\-]/g, '').toLowerCase();\n  const isFullyContained = targetClean.includes(inputClean) && inputClean.length >= 3;\n  \n  // è®¡ç®—å„ç§ç›¸ä¼¼åº¦\n  const levenScore = levenshteinSimilarity(inputNorm, targetNorm);\n  const jaroScore = jaroWinklerSimilarity(inputNorm, targetNorm);\n  const containsScore = containsMatch(input, target);\n  const brandModelScore = brandModelMatch(input, target);\n  \n  // åŠ æƒç»¼åˆè¯„åˆ†\n  const weights = {\n    levenshtein: 0.25,\n    jaroWinkler: 0.25,\n    contains: 0.30,\n    brandModel: 0.20\n  };\n  \n  let finalScore = \n    levenScore * weights.levenshtein +\n    jaroScore * weights.jaroWinkler +\n    containsScore * weights.contains +\n    brandModelScore * weights.brandModel;\n  \n  // ğŸ”¥ å®Œæ•´åŒ…å«åŠ æˆï¼šç›´æ¥æå‡åˆ°85%ä»¥ä¸Š\n  if (isFullyContained) {\n    finalScore = Math.max(finalScore, 0.88);\n  }\n  \n  return {\n    finalScore: finalScore,\n    details: {\n      levenshtein: levenScore.toFixed(3),\n      jaroWinkler: jaroScore.toFixed(3),\n      contains: containsScore.toFixed(3),\n      brandModel: brandModelScore.toFixed(3)\n    }\n  };\n}\n\n// ===== æ‰§è¡ŒåŒ¹é… =====\nconst matches = [];\n\nfor (const car of allCars) {\n  const carName = car.json.carName || '';\n  const carID = car.json.carID;\n  const brandID = car.json.brandID;\n  \n  if (!carName || !carID) continue;\n  \n  const scoreResult = calculateComprehensiveScore(inputCarName, carName);\n  \n  matches.push({\n    carName: carName,\n    carID: carID,\n    brandID: brandID,\n    vehicleClass: car.json.vehicleClass,\n    priceRange: car.json.carPriceRange,\n    score: scoreResult.finalScore,\n    scoreDetails: scoreResult.details\n  });\n}\n\n// æŒ‰åˆ†æ•°æ’åº\nmatches.sort((a, b) => b.score - a.score);\n\n// è¾“å‡ºå‰5ä¸ªåŒ¹é…ç»“æœ\nconsole.log(`\\nå‰5ä¸ªåŒ¹é…ç»“æœ:`);\nmatches.slice(0, 5).forEach((match, index) => {\n  console.log(`${index + 1}. ${match.carName} - ç›¸ä¼¼åº¦: ${(match.score * 100).toFixed(1)}%`);\n  console.log(`   è¯¦æƒ…: L=${match.scoreDetails.levenshtein}, J=${match.scoreDetails.jaroWinkler}, C=${match.scoreDetails.contains}, B=${match.scoreDetails.brandModel}`);\n});\n\nconst bestMatch = matches[0];\n\nif (bestMatch && bestMatch.score >= MATCH_THRESHOLD) {\n  console.log(`\\nâœ… åŒ¹é…æˆåŠŸï¼`);\n  console.log(`è¾“å…¥: ${inputCarName}`);\n  console.log(`åŒ¹é…: ${bestMatch.carName}`);\n  console.log(`ç›¸ä¼¼åº¦: ${(bestMatch.score * 100).toFixed(1)}%`);\n  console.log(`carID: ${bestMatch.carID}`);\n  console.log(`========================\\n`);\n  \n  return {\n    json: {\n      needsSearch: false,\n      resolved: true,\n      carId: bestMatch.carID,\n      carName: bestMatch.carName,\n      brandID: bestMatch.brandID,\n      matchType: 'googlesheet_fuzzy_match',\n      similarityScore: bestMatch.score,\n      matchDetails: bestMatch.scoreDetails,\n      inputCarName: inputCarName\n    }\n  };\n}\n\nconsole.log(`\\nâš ï¸ æœªæ‰¾åˆ°æ»¡è¶³é˜ˆå€¼çš„åŒ¹é…ï¼Œé™çº§åˆ°SerpAPIæœç´¢`);\nconsole.log(`æœ€ä½³åŒ¹é…: ${bestMatch?.carName || 'N/A'} - ç›¸ä¼¼åº¦: ${bestMatch ? (bestMatch.score * 100).toFixed(1) : '0'}%`);\nconsole.log(`é˜ˆå€¼è¦æ±‚: ${(MATCH_THRESHOLD * 100).toFixed(0)}%`);\nconsole.log(`========================\\n`);\n\nreturn {\n  json: {\n    needsSearch: true,\n    carName: inputCarName,\n    matchType: 'low_similarity',\n    bestMatchScore: bestMatch?.score || 0,\n    bestMatchName: bestMatch?.carName || null\n  }\n};"
      },
      "id": "6d42760c-b31b-444f-b0b8-6712db525b10",
      "name": "æ¨¡ç³ŠåŒ¹é…åˆ†æ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4352,
        3248
      ]
    },
    {
      "parameters": {
        "keepOnlySet": true,
        "values": {
          "string": [
            {
              "name": "series_name",
              "value": "={{ $json.body && $json.body.carName ? $json.body.carName : $json.carName }}"
            }
          ]
        },
        "options": {}
      },
      "id": "531773ab-98fd-4c00-ac9f-23dd7318438a",
      "name": "æå–è½¦å‹åç§°1",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [
        3680,
        3248
      ]
    },
    {
      "parameters": {
        "jsCode": "// å‡†å¤‡æŸ¥è¯¢ - åªéœ€è¦è½¦å‹åç§°\nconst carName = ($input.first().json.series_name || '').trim();\n\nif (!carName) {\n  return {\n    json: {\n      success: false,\n      error: 'è¯·æä¾›è½¦å‹åç§°',\n      code: 'CAR_NAME_REQUIRED'\n    }\n  };\n}\n\nconsole.log(`å‡†å¤‡æŸ¥è¯¢è½¦å‹: ${carName}`);\n\nreturn {\n  json: {\n    carName: carName\n  }\n};"
      },
      "id": "945d2165-7907-4d71-9536-20390aeb41d8",
      "name": "å‡†å¤‡æŸ¥è¯¢2",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3920,
        3248
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.needsSearch }}",
              "value2": true
            }
          ]
        }
      },
      "id": "a664244a-6d44-444e-87fc-493c707b5521",
      "name": "æ£€æŸ¥æ˜¯å¦éœ€è¦æœç´¢2",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        4592,
        3248
      ]
    },
    {
      "parameters": {
        "url": "=https://serpapi.com/search.json?engine=google&q=site:autohome.com.cn+{{ $json.carName }}&api_key=c6805b62d6f0757df69b7b0f41e27570c6b8989caec90d8356e455cf76794514",
        "options": {
          "redirect": {
            "redirect": {
              "followRedirects": true,
              "maxRedirects": 5
            }
          },
          "response": {
            "response": {
              "responseFormat": "json"
            }
          },
          "timeout": 15000
        }
      },
      "id": "394b510d-6a6c-4b62-b852-56959a106665",
      "name": "æœç´¢è½¦å‹2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        4832,
        3168
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// ä»IFèŠ‚ç‚¹ä¼ é€’è¿‡æ¥çš„æ•°æ®ä¸­è·å–carName\nconst carName = $('æ£€æŸ¥æ˜¯å¦éœ€è¦æœç´¢2').first().json.carName;\nconst response = $input.item.json;\n\nconsole.log('===== SerpAPIå“åº” =====');\nconsole.log('è½¦å‹åç§°:', carName);\nconsole.log('SerpAPIå“åº”:', JSON.stringify(response, null, 2));\n\nconst organicResults = response.organic_results || [];\nconsole.log('æ‰¾åˆ°', organicResults.length, 'ä¸ªæœç´¢ç»“æœ');\n\nlet carId = null;\n\n// éå†æœç´¢ç»“æœ\nfor (const result of organicResults) {\n  const link = result.link || '';\n  console.log('æ£€æŸ¥é“¾æ¥:', link);\n  \n  // ğŸ”¥ ä¿®æ”¹æ­£åˆ™ï¼šæ”¯æŒ2-5ä½æ•°çš„carID\n  const patterns = [\n    /autohome\\.com\\.cn\\/(\\d{2,5})\\/?/,           // æ”¹è¿™é‡Œï¼š2-5ä½\n    /series-(\\d{2,5})\\.html/,                    // æ”¹è¿™é‡Œï¼š2-5ä½\n    /config\\/series\\/(\\d{2,5})/                  // æ”¹è¿™é‡Œï¼š2-5ä½\n  ];\n  \n  for (const pattern of patterns) {\n    const match = link.match(pattern);\n    if (match && match[1]) {\n      carId = match[1];\n      console.log('âœ… æ‰¾åˆ°carId:', carId);\n      break;\n    }\n  }\n  \n  if (carId) break;\n}\n\n// ğŸ”¥ éªŒè¯carIDæ ¼å¼ï¼šæ”¹æˆ2-5ä½\nif (carId && /^\\d{2,5}$/.test(carId)) {\n  console.log('âœ… æˆåŠŸæå–carId:', carId);\n  return {\n    json: {\n      carId: carId,\n      carName: carName,\n      matchType: 'serpapi_search',\n      resolved: true\n    }\n  };\n}\n\nconsole.log('âŒ æœªèƒ½ä»æœç´¢ç»“æœä¸­æå–carId');\nreturn {\n  json: {\n    success: false,\n    error: 'æœªèƒ½ä»æœç´¢ç»“æœä¸­æå–carId',\n    code: 'EXTRACTION_FAILED',\n    carName: carName,\n    debug: {\n      resultsCount: organicResults.length,\n      firstResult: organicResults[0]?.link || 'none'\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5072,
        3168
      ],
      "id": "63fd9186-9b90-4292-a244-86fb4fe9aeaf",
      "name": "å¤„ç†SerpAPIå“åº”2"
    },
    {
      "parameters": {
        "jsCode": "// ç”Ÿæˆæ‰€æœ‰åˆ†ç±»çš„ä»»åŠ¡\nconst data = $input.item.json;\n\nif (data.success === false || !data.resolved) {\n  return { json: data };\n}\n\nconst carId = data.carId;\nconst carName = data.carName || '';\nconst brandID = data.brandID || '';\n\nif (!carId || !/^\\d+$/.test(carId.toString())) {\n  return {\n    json: {\n      success: false,\n      error: 'carIdæ ¼å¼æ— æ•ˆ',\n      code: 'INVALID_CAR_ID'\n    }\n  };\n}\n\n// å®šä¹‰æ‰€æœ‰è¦çˆ¬å–çš„åˆ†ç±»\nconst categories = [\n  { code: '1', name: 'å¤–è§‚' },\n  { code: '10', name: 'å†…é¥°' },\n  { code: '3', name: 'åº§æ¤…' }\n];\n\nconsole.log(`ä¸ºè½¦å‹ ${carName} (ID: ${carId}) ç”Ÿæˆ ${categories.length} ä¸ªçˆ¬å–ä»»åŠ¡`);\n\n// ä¸ºæ¯ä¸ªåˆ†ç±»ç”Ÿæˆä¸€ä¸ªä»»åŠ¡\nreturn categories.map(category => ({\n  json: {\n    carId: carId,\n    carName: carName,\n    brandID: brandID,\n    categoryCode: category.code,\n    categoryName: category.name,\n    matchType: data.matchType\n  }\n}));"
      },
      "id": "f78d8be0-d456-4a12-a5f8-8080f501b729",
      "name": "ç”Ÿæˆæ‰€æœ‰åˆ†ç±»ä»»åŠ¡1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5344,
        3264
      ]
    },
    {
      "parameters": {
        "url": "={{ 'https://car.autohome.com.cn/pic/series/' + $json.carId + '-' + $json.categoryCode + '.html' }}",
        "options": {
          "redirect": {
            "redirect": {
              "followRedirects": true,
              "maxRedirects": 3
            }
          },
          "response": {
            "response": {
              "responseFormat": "text"
            }
          },
          "timeout": 15000
        }
      },
      "id": "ae74d8a9-763f-4a11-bf4b-70b7bc59e782",
      "name": "çˆ¬å–ç›®æ ‡é¡µé¢2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        5568,
        3264
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// ä»å½“å‰è¾“å…¥è·å–categoryä¿¡æ¯\nconst currentInput = $input.item.json;\n\n// å°è¯•ä»ç”Ÿæˆæ‰€æœ‰åˆ†ç±»ä»»åŠ¡èŠ‚ç‚¹è·å–å‚æ•°ï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰\nlet params;\ntry {\n  params = $('ç”Ÿæˆæ‰€æœ‰åˆ†ç±»ä»»åŠ¡1').item.json;\n} catch (e) {\n  console.log('è­¦å‘Š: æ— æ³•ä»ç”Ÿæˆæ‰€æœ‰åˆ†ç±»ä»»åŠ¡1è·å–æ•°æ®ï¼Œå°è¯•ä»å½“å‰è¾“å…¥è·å–');\n  params = currentInput;\n}\n\nconst carName = params.carName || currentInput.carName || '';\nconst categoryName = params.categoryName || currentInput.categoryName || '';\nconst carId = params.carId || currentInput.carId || '';\nconst categoryCode = params.categoryCode || currentInput.categoryCode || '';\nconst matchType = params.matchType || currentInput.matchType || '';\n\nconsole.log(`å¤„ç†åˆ†ç±»: ${categoryName} (code: ${categoryCode})`);\n\nif ($input.item.json.error) {\n  return {\n    json: {\n      success: false,\n      error: 'é¡µé¢è·å–å¤±è´¥',\n      message: $input.item.json.error.message || 'ç½‘ç»œè¯·æ±‚é”™è¯¯',\n      code: 'HTTP_REQUEST_FAILED',\n      carId: carId,\n      carName: carName,\n      categoryName: categoryName\n    }\n  };\n}\n\n// æå–HTMLå†…å®¹\nlet html = '';\n\ntry {\n  if ($input.item.binary && $input.item.binary.data) {\n    const binaryData = $input.item.binary.data;\n    if (Buffer.isBuffer(binaryData)) {\n      html = binaryData.toString('latin1');\n    } else if (binaryData.data) {\n      html = Buffer.from(binaryData.data).toString('latin1');\n    }\n  } \n  \n  if (!html || html.length < 100) {\n    html = String($input.item.json.data || $input.item.json.body || '');\n  }\n} catch (error) {\n  html = String($input.item.json.data || $input.item.json.body || '');\n}\n\nif (html.length < 1000) {\n  return {\n    json: {\n      success: false,\n      error: 'é¡µé¢å†…å®¹å¼‚å¸¸',\n      code: 'INVALID_PAGE_CONTENT',\n      carId: carId,\n      carName: carName,\n      categoryName: categoryName\n    }\n  };\n}\n\nfunction extractImages(htmlContent, maxImages = 30) {\n  const images = [];\n  const seenUrls = new Set();\n  \n  const patterns = [\n    /data-webp\\s*=\\s*[\"']([^\"']+)[\"']/gi,\n    /data-original\\s*=\\s*[\"']([^\"']+)[\"']/gi,\n    /src\\s*=\\s*[\"'](https?:\\/\\/[^\"']*(?:autoimg\\.cn|autohome\\.com\\.cn)[^\"']*)[\"']/gi\n  ];\n  \n  for (const pattern of patterns) {\n    let match;\n    while ((match = pattern.exec(htmlContent)) !== null && images.length < maxImages) {\n      let url = match[1];\n      \n      if (!url || url.length > 500 || seenUrls.has(url)) continue;\n      \n      if (url.startsWith('//')) {\n        url = 'https:' + url;\n      } else if (!url.startsWith('http')) {\n        continue;\n      }\n      \n      if ((url.includes('autoimg.cn') || url.includes('autohome.com.cn')) && \n          !url.includes('base64') &&\n          (url.includes('/cardfs/') || url.includes('/product/') || url.includes('.jpg') || url.includes('.webp'))) {\n        \n        seenUrls.add(url);\n        images.push({\n          url: url,\n          type: url.includes('data-webp') ? 'high_quality' : 'standard',\n          category: categoryName,\n          carName: carName\n        });\n      }\n    }\n  }\n  \n  return images;\n}\n\nconst images = extractImages(html);\n\nconsole.log(`${categoryName}: æå–åˆ° ${images.length} å¼ å›¾ç‰‡`);\n\nreturn {\n  json: {\n    success: images.length > 0,\n    carId: carId,\n    carName: carName,\n    category: categoryName,\n    categoryCode: categoryCode,\n    matchType: matchType,\n    totalImages: images.length,\n    images: images\n  }\n};"
      },
      "id": "7b64fbaa-4369-4372-929e-67517263a14b",
      "name": "æå–å›¾ç‰‡1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5808,
        3264
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// åˆå¹¶æ‰€æœ‰åˆ†ç±»çš„å›¾ç‰‡ç»“æœ\nconst allResults = $input.all();\n\nlet allImages = [];\nlet successCount = 0;\nlet totalCount = 0;\nlet carId = null;\nlet carName = null;\nlet matchType = null;\n\nconst categorySummary = {};\n\nfor (const result of allResults) {\n  const data = result.json;\n  \n  if (!carId) carId = data.carId;\n  if (!carName) carName = data.carName;\n  if (!matchType) matchType = data.matchType;\n  \n  totalCount++;\n  \n  if (data.success && data.images && data.images.length > 0) {\n    successCount++;\n    allImages = allImages.concat(data.images);\n    categorySummary[data.category] = data.images.length;\n    console.log(`${data.category}: ${data.images.length} å¼ å›¾ç‰‡`);\n  } else {\n    categorySummary[data.category] = 0;\n    console.log(`${data.category}: è·å–å¤±è´¥`);\n  }\n}\n\nconsole.log(`\\n=== æ±‡æ€» ===`);\nconsole.log(`æ€»è®¡: ${allImages.length} å¼ å›¾ç‰‡`);\nconsole.log(`æˆåŠŸåˆ†ç±»: ${successCount}/${totalCount}`);\nconsole.log(`è¯¦ç»†ç»Ÿè®¡:`, categorySummary);\n\nreturn {\n  json: {\n    success: allImages.length > 0,\n    carId: carId,\n    carName: carName,\n    matchType: matchType,\n    totalImages: allImages.length,\n    images: allImages,\n    categorySummary: categorySummary,\n    message: allImages.length > 0 ? `æˆåŠŸè·å–${allImages.length}å¼ å›¾ç‰‡ï¼ˆ${successCount}ä¸ªåˆ†ç±»ï¼‰` : 'æœªæ‰¾åˆ°ä»»ä½•å›¾ç‰‡',\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "cf4c15da-b308-41f0-9e0c-0ba5d2caea9d",
      "name": "åˆå¹¶æ‰€æœ‰ç»“æœ1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6048,
        3264
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "239bd5d7-b366-4eff-93f1-4eec9410f199",
      "name": "è¿”å›å“åº”2",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        6288,
        3264
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "get-all-car-images",
        "responseMode": "responseNode",
        "options": {
          "rawBody": false
        }
      },
      "id": "4a044d15-dd65-479a-a3d8-c610832807fb",
      "name": "ç›´æ¥æœç´¢",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        3472,
        3248
      ],
      "webhookId": "get-all-car-images"
    }
  ],
  "connections": {
    "è¯»å–Google Sheet2": {
      "main": [
        [
          {
            "node": "æ¨¡ç³ŠåŒ¹é…åˆ†æ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ¨¡ç³ŠåŒ¹é…åˆ†æ": {
      "main": [
        [
          {
            "node": "æ£€æŸ¥æ˜¯å¦éœ€è¦æœç´¢2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æå–è½¦å‹åç§°1": {
      "main": [
        [
          {
            "node": "å‡†å¤‡æŸ¥è¯¢2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å‡†å¤‡æŸ¥è¯¢2": {
      "main": [
        [
          {
            "node": "è¯»å–Google Sheet2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ£€æŸ¥æ˜¯å¦éœ€è¦æœç´¢2": {
      "main": [
        [
          {
            "node": "æœç´¢è½¦å‹2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ç”Ÿæˆæ‰€æœ‰åˆ†ç±»ä»»åŠ¡1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æœç´¢è½¦å‹2": {
      "main": [
        [
          {
            "node": "å¤„ç†SerpAPIå“åº”2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "å¤„ç†SerpAPIå“åº”2": {
      "main": [
        [
          {
            "node": "ç”Ÿæˆæ‰€æœ‰åˆ†ç±»ä»»åŠ¡1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ç”Ÿæˆæ‰€æœ‰åˆ†ç±»ä»»åŠ¡1": {
      "main": [
        [
          {
            "node": "çˆ¬å–ç›®æ ‡é¡µé¢2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "çˆ¬å–ç›®æ ‡é¡µé¢2": {
      "main": [
        [
          {
            "node": "æå–å›¾ç‰‡1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æå–å›¾ç‰‡1": {
      "main": [
        [
          {
            "node": "åˆå¹¶æ‰€æœ‰ç»“æœ1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "åˆå¹¶æ‰€æœ‰ç»“æœ1": {
      "main": [
        [
          {
            "node": "è¿”å›å“åº”2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ç›´æ¥æœç´¢": {
      "main": [
        [
          {
            "node": "æå–è½¦å‹åç§°1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "5cb72472896fce0666bc03ef84936c4f09ec11e6b4f95f9aebe3d538947c7935"
  }
}