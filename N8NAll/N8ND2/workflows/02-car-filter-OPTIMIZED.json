{
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "car-image-filter",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*, null"
        }
      },
      "id": "121a7e1e-3c4d-4b15-978c-4ec3ca150d05",
      "name": "Webhookæ¥æ”¶ç­›é€‰è¯·æ±‚1",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        3600,
        2240
      ],
      "webhookId": "car-image-filter"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1550254241,
          "mode": "list",
          "cachedResultName": "CarImageURLMVPç”¨",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit#gid=1550254241"
        },
        "options": {}
      },
      "id": "3ed5c50d-138e-4406-bfab-6f144d9f0c96",
      "name": "è¯»å–Google Sheet",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        4080,
        2240
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YS5a72jpKHezwxcc",
          "name": "Google Sheets account 5"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// âœ… ä¼˜åŒ–ç‰ˆ - è§£æå¹¶è½¬æ¢ç­›é€‰å‚æ•°\nconst input = $input.item.json.body || $input.item.json;\n\n// ğŸ¯ è§†è§’æ˜ å°„è¡¨ï¼šä¸­æ–‡ â†’ è‹±æ–‡ï¼ˆGoogle Sheetæ ¼å¼ï¼‰\nconst VIEW_MAPPING = {\n  'æ­£45Â°': ['view45', 'view-45'],           // æ”¯æŒå¤šç§æ ¼å¼\n  'å‰è„¸': ['viewfront', 'viewFront'],       \n  'æ­£ä¾§å›¾': ['viewside', 'viewSide'],       \n  'é—¨æ¿': ['viewdoor', 'viewDoor'],         \n  'IP': ['viewip', 'viewIP'],               \n  'CNSL': ['viewcnsl', 'viewCNSL'],         \n  'åº§æ¤…': ['viewseat', 'viewSeat']          \n};\n\n// è½¬æ¢è§†è§’å‚æ•°\nlet convertedViews = [];\nif (Array.isArray(input.views) && input.views.length > 0) {\n  input.views.forEach(view => {\n    const mappedViews = VIEW_MAPPING[view];\n    if (mappedViews) {\n      convertedViews = convertedViews.concat(mappedViews);\n    } else {\n      // å¦‚æœæ²¡æœ‰æ˜ å°„ï¼Œä¿ç•™åŸå€¼ï¼ˆå…¼å®¹ç›´æ¥ä¼ è‹±æ–‡çš„æƒ…å†µï¼‰\n      convertedViews.push(view);\n    }\n  });\n}\n\nconst filters = {\n  keyword: (input.keyword || '').trim(),\n  brands: Array.isArray(input.brands) ? input.brands : [],\n  models: Array.isArray(input.models) ? input.models : [],\n  views: convertedViews,                    // âœ… ä½¿ç”¨è½¬æ¢åçš„è‹±æ–‡æ ¼å¼\n  originalViews: input.views || [],         // ä¿ç•™åŸå§‹ä¸­æ–‡ï¼ˆç”¨äºæ—¥å¿—ï¼‰\n  timestamp: new Date().toISOString()\n};\n\nconsole.log('===== æ¥æ”¶åˆ°çš„ç­›é€‰æ¡ä»¶ =====');\nconsole.log('å…³é”®è¯:', filters.keyword);\nconsole.log('å“ç‰Œ:', filters.brands.join(', ') || 'æ— ');\nconsole.log('è½¦å‹:', filters.models.join(', ') || 'æ— ');\nconsole.log('è§†è§’ï¼ˆåŸå§‹ï¼‰:', filters.originalViews.join(', ') || 'æ— ');\nconsole.log('è§†è§’ï¼ˆè½¬æ¢åï¼‰:', filters.views.join(', ') || 'æ— ');\nconsole.log('==============================');\n\nreturn { json: filters };"
      },
      "id": "b525215b-1bb0-4a2b-8889-6cf4d675f75e",
      "name": "è§£æç­›é€‰æ¡ä»¶",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3888,
        2240
      ]
    },
    {
      "parameters": {
        "jsCode": "// âœ… ä¼˜åŒ–ç‰ˆ - é«˜çº§ç­›é€‰é€»è¾‘\nconst filters = $('è§£æç­›é€‰æ¡ä»¶').item.json;\nconst sheetData = $input.all();\n\nconsole.log('===== ç­›é€‰æ‰§è¡Œ =====');\nconsole.log('æ€»æ•°æ®æ¡æ•°:', sheetData.length);\nconsole.log('ç­›é€‰æ¡ä»¶:', JSON.stringify(filters, null, 2));\n\n// ç­›é€‰å‡½æ•°\nfunction matchesFilters(row) {\n  const carName = (row.carName || '').toLowerCase();\n  const vehicleClass = (row.vehicleClass || '').toLowerCase();\n  const viewType = (row.viewType || '').toLowerCase(); // Sheetä¸­çš„æ ¼å¼ï¼šview45, viewFrontç­‰\n  \n  // 1. å…³é”®è¯æœç´¢ - ä¿®å¤ç‰ˆï¼ˆæ”¯æŒå¤šå…³é”®è¯ï¼Œä»»ä¸€åŒ¹é…ï¼‰\n  if (filters.keyword) {\n    const keywords = filters.keyword.toLowerCase().split(/\\s+/); // æŒ‰ç©ºæ ¼åˆ†å‰²\n    const matchesAnyKeyword = keywords.some(keyword => \n      keyword && carName.includes(keyword)\n    );\n    if (!matchesAnyKeyword) {\n      return false;\n    }\n  }\n  \n  // 2. å“ç‰Œç­›é€‰\n  if (filters.brands && filters.brands.length > 0) {\n    const matchesBrand = filters.brands.some(brand => \n      carName.includes(brand.toLowerCase())\n    );\n    if (!matchesBrand) {\n      return false;\n    }\n  }\n  \n  // 3. è½¦å‹ç­›é€‰ - åŒ¹é… vehicleClass æˆ– carName\n  if (filters.models && filters.models.length > 0) {\n    const matchesModel = filters.models.some(model => {\n      const modelLower = model.toLowerCase();\n      // vehicleClass å¯èƒ½æ˜¯ \"ç´§å‡‘å‹è½¦Sedan\"ï¼Œæ‰€ä»¥ç”¨ includes\n      return vehicleClass.includes(modelLower) || carName.includes(modelLower);\n    });\n    if (!matchesModel) {\n      return false;\n    }\n  }\n  \n  // 4. âœ… è§†è§’ç­›é€‰ - ä¼˜åŒ–ç‰ˆï¼ˆæ”¯æŒå¤šç§æ ¼å¼åŒ¹é…ï¼‰\n  if (filters.views && filters.views.length > 0) {\n    const matchesView = filters.views.some(view => {\n      const viewLower = view.toLowerCase();\n      // æ”¯æŒï¼š\n      // - å®Œå…¨åŒ¹é…: \"view45\" === \"view45\"\n      // - åŒ…å«åŒ¹é…: \"view-45\".includes(\"view45\") æˆ– \"view45\".includes(\"view-45\")\n      return viewType === viewLower || \n             viewType.includes(viewLower) || \n             viewLower.includes(viewType);\n    });\n    if (!matchesView) {\n      return false;\n    }\n  }\n  \n  return true;\n}\n\n// æ‰§è¡Œç­›é€‰\nconst filteredResults = [];\nsheetData.forEach((item, index) => {\n  if (matchesFilters(item.json)) {\n    filteredResults.push({\n      json: item.json,\n      pairedItem: { item: index }\n    });\n  }\n});\n\nconsole.log('ç­›é€‰åç»“æœæ•°:', filteredResults.length);\nif (filteredResults.length > 0) {\n  console.log('ç¬¬ä¸€æ¡ç»“æœç¤ºä¾‹:', JSON.stringify(filteredResults[0].json, null, 2));\n}\nconsole.log('====================');\n\n// å¦‚æœæ²¡æœ‰ç»“æœ\nif (filteredResults.length === 0) {\n  return [{\n    json: {\n      _noResults: true,\n      message: 'æœªæ‰¾åˆ°åŒ¹é…çš„ç»“æœ',\n      filters: filters\n    },\n    pairedItem: { item: 0 }\n  }];\n}\n\nreturn filteredResults;"
      },
      "id": "fea8a5f4-eb76-412f-b9ba-e703b194d195",
      "name": "æ‰§è¡Œç­›é€‰",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4336,
        2240
      ]
    },
    {
      "parameters": {
        "jsCode": "// æ ¼å¼åŒ–è¿”å›ç»“æœ\nconst allItems = $input.all();\nconst filters = $('è§£æç­›é€‰æ¡ä»¶').item.json;\n\n// æ£€æŸ¥æ˜¯å¦æœ‰ç»“æœ\nif (allItems.length === 1 && allItems[0].json._noResults) {\n  return {\n    json: {\n      success: true,\n      count: 0,\n      results: [],\n      filters: filters,\n      message: 'æœªæ‰¾åˆ°åŒ¹é…çš„ç»“æœ',\n      timestamp: new Date().toISOString()\n    }\n  };\n}\n\n// æå–æ‰€æœ‰ç»“æœ\nconst results = allItems.map(item => item.json);\n\nconsole.log('===== æœ€ç»ˆè¿”å› =====');\nconsole.log('ç»“æœæ•°é‡:', results.length);\nconsole.log('ç­›é€‰æ¡ä»¶ï¼ˆåŸå§‹ï¼‰:', {\n  brands: filters.brands,\n  models: filters.models,\n  views: filters.originalViews\n});\nif (results.length > 0) {\n  console.log('å‰2æ¡ç»“æœç¤ºä¾‹:', results.slice(0, 2).map(r => ({\n    carName: r.carName,\n    viewType: r.viewType,\n    vehicleClass: r.vehicleClass\n  })));\n}\nconsole.log('====================');\n\nreturn {\n  json: {\n    success: true,\n    count: results.length,\n    results: results,\n    filters: {\n      keyword: filters.keyword,\n      brands: filters.brands,\n      models: filters.models,\n      views: filters.originalViews  // âœ… è¿”å›åŸå§‹ä¸­æ–‡è§†è§’åç§°\n    },\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "359ebe7b-ff89-4772-9ee7-f853d03caebd",
      "name": "æ ¼å¼åŒ–å“åº”",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4656,
        2240
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "POST, GET, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type, Authorization"
              },
              {
                "name": "Content-Type",
                "value": "application/json; charset=utf-8"
              }
            ]
          }
        }
      },
      "id": "81061b11-e921-4f27-a493-b458c01a95b2",
      "name": "è¿”å›ç»“æœ1",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        4960,
        2240
      ]
    }
  ],
  "connections": {
    "Webhookæ¥æ”¶ç­›é€‰è¯·æ±‚1": {
      "main": [
        [
          {
            "node": "è§£æç­›é€‰æ¡ä»¶",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è¯»å–Google Sheet": {
      "main": [
        [
          {
            "node": "æ‰§è¡Œç­›é€‰",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "è§£æç­›é€‰æ¡ä»¶": {
      "main": [
        [
          {
            "node": "è¯»å–Google Sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ‰§è¡Œç­›é€‰": {
      "main": [
        [
          {
            "node": "æ ¼å¼åŒ–å“åº”",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "æ ¼å¼åŒ–å“åº”": {
      "main": [
        [
          {
            "node": "è¿”å›ç»“æœ1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "5cb72472896fce0666bc03ef84936c4f09ec11e6b4f95f9aebe3d538947c7935"
  }
}

