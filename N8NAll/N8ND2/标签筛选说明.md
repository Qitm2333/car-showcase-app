# 🏷️ 标签筛选功能说明

## ✅ 功能已整合

标签输入功能现已完全整合到N8N筛选系统中！

---

## 🎯 工作原理

### 用户操作流程

```
1. 用户在搜索框左侧输入标签
   ↓
2. 按下回车键（Enter）
   ↓
3. 标签显示在搜索框中
   ↓
4. 自动触发筛选功能
   ↓
5. 标签文本作为 keyword 参数发送到 N8N
   ↓
6. N8N 在 carName 字段中搜索匹配项
   ↓
7. 返回筛选结果并动态显示
```

### 技术实现

```javascript
// 标签变化监听（中部栏.tsx）
useEffect(() => {
  const visibleLabelTexts = labels
    .filter(label => label.visible)
    .map(label => label.text);
  
  const keyword = visibleLabelTexts.join(' '); // 组合所有标签文本
  
  onFilterChange({
    keyword: keyword.trim(),  // 🏷️ 作为关键词传递
    brands: [],
    models: [],
    views: [],
    parts: [],
    times: []
  });
}, [labels]);
```

---

## 📊 数据流向

```
用户输入: "ZEEKR"
    ↓
标签组件: { text: "ZEEKR 09", visible: true }
    ↓
筛选条件: { keyword: "ZEEKR 09", brands: [], ... }
    ↓
N8N API: POST /car-image-filter
         { "keyword": "ZEEKR 09" }
    ↓
Google Sheet: 搜索 carName 字段
              WHERE carName LIKE "%ZEEKR 09%"
    ↓
返回结果: [
  { carName: "ZEEKR 009", vehicleClass: "MPV", ... },
  { carName: "ZEEKR 001", vehicleClass: "Sedan", ... }
]
```

---

## 🧪 测试场景

### 场景 1: 单个标签筛选

**操作：**
1. 在输入框输入 `比亚迪`
2. 按回车键

**预期结果：**
- ✅ 标签"比亚迪"显示在搜索框中
- ✅ 页面显示"正在筛选..."
- ✅ 显示所有包含"比亚迪"的车型
- ✅ 控制台输出：`🏷️ 标签变化，触发筛选: ["比亚迪"]`

---

### 场景 2: 多个标签组合

**操作：**
1. 输入 `比亚迪` 并回车
2. 输入 `Seal` 并回车

**预期结果：**
- ✅ 显示两个标签："比亚迪" 和 "Seal"
- ✅ 筛选条件：`keyword: "比亚迪 Seal"`
- ✅ 显示同时包含"比亚迪"和"Seal"的车型（如 BYD Seal 06）

**N8N匹配逻辑：**
```javascript
// 关键词搜索
if (filters.keyword) {
  const keyword = filters.keyword.toLowerCase();
  if (!carName.includes(keyword)) {
    return false; // 不匹配
  }
}
```

---

### 场景 3: 删除标签

**操作：**
1. 点击标签右侧的 ❌ 按钮

**预期结果：**
- ✅ 标签消失
- ✅ 自动触发新的筛选（使用剩余标签）
- ✅ 如果删除所有标签，显示默认12张卡片

---

### 场景 4: 标签 + 下拉筛选组合

**操作：**
1. 输入标签：`比亚迪`
2. 选择车型：`SUV`

**预期结果：**
- ✅ 同时应用两个条件
- ✅ API请求：
```json
{
  "keyword": "比亚迪",
  "brands": [],
  "models": ["SUV"],
  "views": []
}
```
- ✅ 显示"比亚迪 + SUV"的车型（如 BYD Song Plus）

**注意：** 标签筛选和右侧下拉筛选是**独立触发**的：
- 标签变化 → 立即触发筛选（只传keyword）
- 下拉变化 → 立即触发筛选（只传brands/models/views）
- **后触发的会覆盖前一次的结果**

---

## ⚙️ 优化建议

### 问题：重复调用API

**现象：**
- 用户输入标签后，又选择品牌
- 会触发2次API调用（1次keyword，1次brand）

**解决方案：**
```javascript
// 方案1: 合并筛选状态（推荐）
const [filters, setFilters] = useState({
  keyword: '',
  brands: [],
  models: [],
  views: []
});

// 方案2: 防抖处理
const debouncedFilter = useDebouce(handleFilterChange, 300);
```

### 问题：标签筛选覆盖下拉筛选

**现象：**
- 用户先选择"品牌: 比亚迪"
- 然后输入标签"ZEEKR"
- 品牌筛选被清空

**解决方案：**
需要在父组件（CarShowcaseMain）中**合并**两种筛选条件：

```javascript
const [currentFilters, setCurrentFilters] = useState({
  keyword: '',
  brands: [],
  models: [],
  views: []
});

const handleFilterChange = (newFilters) => {
  // 合并新旧筛选条件
  setCurrentFilters(prev => ({
    keyword: newFilters.keyword ?? prev.keyword,
    brands: newFilters.brands?.length > 0 ? newFilters.brands : prev.brands,
    models: newFilters.models?.length > 0 ? newFilters.models : prev.models,
    views: newFilters.views?.length > 0 ? newFilters.views : prev.views
  }));
};
```

---

## 🔍 N8N 工作流匹配逻辑

### 关键词匹配（来自N8N代码）

```javascript
// 1. 关键词搜索
if (filters.keyword) {
  const keyword = filters.keyword.toLowerCase();
  if (!carName.includes(keyword)) {
    return false; // carName不包含关键词，不匹配
  }
}
```

### 示例

**标签：** `"ZEEKR 009"`  
**Google Sheet 数据：**
```
carName: "ZEEKR 009 2024款"  → ✅ 匹配（包含"ZEEKR 009"）
carName: "ZEEKR 001"         → ❌ 不匹配（只包含"ZEEKR"）
carName: "BYD Song Plus"     → ❌ 不匹配
```

**标签：** `"比亚迪"`  
**Google Sheet 数据：**
```
carName: "BYD Seal 06"       → ❌ 不匹配（carName是英文）
carName: "比亚迪海豹06"       → ✅ 匹配
carName: "比亚迪汉"          → ✅ 匹配
```

**⚠️ 注意：** 如果Google Sheet中的`carName`是英文，输入中文标签无法匹配！

---

## 💡 使用建议

### ✅ 推荐用法

1. **品牌搜索** - 输入品牌名（如"比亚迪"、"ZEEKR"）
2. **车型搜索** - 输入完整车型名（如"ZEEKR 009"）
3. **模糊搜索** - 输入部分关键词（如"Seal"查找所有Seal系列）

### ❌ 不推荐

1. **过于模糊** - 输入"车"、"SUV"等（应该用下拉筛选）
2. **多个无关词** - "比亚迪 吉利"（不会返回OR结果，是AND关系）
3. **特殊字符** - 避免使用符号（可能影响匹配）

---

## 🎨 用户体验优化

### 当前实现

- ✅ 标签输入即时反馈
- ✅ 回车确认添加
- ✅ 点击❌删除标签
- ✅ 自动触发筛选
- ✅ 加载动画提示

### 待优化

- ⏳ 合并标签筛选和下拉筛选的状态
- ⏳ 添加防抖，减少API调用
- ⏳ 支持输入多个关键词（逗号分隔）
- ⏳ 添加标签建议（根据历史输入）
- ⏳ 标签颜色区分（品牌、车型、自定义）

---

## 📝 代码位置

| 文件 | 修改内容 |
|------|----------|
| `src/imports/inspiration-main/中部栏.tsx` | 添加标签变化监听，传递keyword |
| `src/pages/CarShowcaseMain.tsx` | 接收keyword参数，调用API |
| `src/services/carFilterService.ts` | 已支持keyword参数 |
| `N8ND2/根据GoogleSheet筛选的N8N工作流.json` | 关键词匹配逻辑 |

---

## ✨ 总结

🎉 标签筛选功能已完全整合！用户现在可以：

1. ✅ 输入标签进行关键词搜索
2. ✅ 结合下拉筛选器使用
3. ✅ 实时查看筛选结果
4. ✅ 保持原有卡片布局

---

**Happy Tagging! 🏷️**

