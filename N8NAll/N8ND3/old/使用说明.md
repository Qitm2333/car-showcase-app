# 汽车详情查询系统（带AI分析）- 使用说明

## 📦 文件说明

### 1. **car-explorer.html** - 唯一的HTML页面
- 包含Webhook配置界面
- 搜索和详情整合在一个页面
- 支持自定义webhook地址
- 显示AI智能分析内容

### 2. **汽车详情工作流-完整版.json** - 唯一的工作流
- 只有**1个webhook入口**
- 🔄 内部完成所有逻辑（数据处理 + AI分析）
- 🤖 集成AI智能体（DeepSeek + Pinecone向量检索）
- ❌ 不调用其他任何工作流

### 3. 参考文件（可选）
- `筛选图片功能工作流.json` - 仅供参考
- `直接搜索返回图像卡片工作流.json` - 仅供参考

---

## 🚀 部署步骤

### 步骤1：导入N8N工作流

1. 登录N8N控制台
2. 导入 `汽车详情工作流-完整版.json`
3. **配置凭据**：
   - ✅ Google Sheets凭据
   - ✅ DeepSeek API凭据
   - ✅ Pinecone API凭据
   - ✅ OpenAI API凭据（用于嵌入）
4. **激活工作流**
5. 复制webhook地址，例如：
   ```
   https://n8n.seanhe.tech/webhook/car-detail-complete
   ```

### 步骤2：配置HTML页面

1. 打开 `car-explorer.html`
2. 在顶部配置面板输入你的webhook地址
3. 点击"保存配置"

**就这么简单！**

---

## 🎯 工作流架构

```
用户请求 (carName)
  ↓
Webhook接收 (唯一入口)
  ↓
解析参数
  ↓
读取Google Sheet (所有数据)
  ↓
处理所有逻辑节点 (一次性完成)
  ├─ 筛选当前车型数据（模糊匹配）
  ├─ 提取基本信息
  ├─ 查找view45主图
  ├─ 收集详细图片
  └─ 智能匹配相关车型
  ↓
AI智能体分析 (新增✨)
  ├─ DeepSeek Chat Model (语言模型)
  ├─ Pinecone向量检索 (知识库)
  └─ OpenAI嵌入模型 (向量化)
  ↓
整合最终结果
  ├─ 基本信息
  ├─ AI分析内容 (新增✨)
  ├─ 相关车型
  └─ 详细图片
  ↓
返回完整JSON (一次性返回)
```

**核心特点：**
- ✅ 只有1个webhook
- ✅ 只调用1次Google Sheets
- ✅ 所有逻辑在工作流内部完成
- ✅ 一次请求得到所有数据（包括AI分析）
- 🤖 AI分析由DeepSeek生成，基于Pinecone知识库

---

## 📡 API说明

### 请求

**端点**: `POST /webhook/car-detail-complete`

**请求体**:
```json
{
  "carName": "比亚迪海豹"
}
```

### 响应

```json
{
  "success": true,
  "data": {
    "carName": "比亚迪海豹",
    "carPriceRange": "21.28-28.98万",
    "vehicleClass": "中型车Sedan",
    "carID": 5964,
    "brandID": 75,
    "mainImageUrl": "https://...",
    
    "aiAnalysis": "车型定位：中型轿车，主打家用市场。核心设计：海洋美学设计，流线型车身。相关竞品：特斯拉Model 3、小鹏P7。核心亮点：刀片电池安全、快充技术、智能驾驶辅助。",
    
    "relatedCars": [...],
    "detailImages": [...],
    "stats": {
      "totalImages": 45,
      "relatedCarsCount": 6
    }
  },
  "timestamp": "2025-10-30T12:00:00.000Z"
}
```

---

## 🎨 页面功能

### 1. 配置Webhook

- 输入N8N的webhook地址
- 点击保存
- 配置会保存在浏览器本地存储

### 2. 查询车型

- 输入汽车名称（如：比亚迪海豹、秦PLUS）
- 支持模糊匹配（输入"秦PLUS"能匹配"比亚迪-秦PLUS"）
- 点击"查询详情"或按回车

### 3. 查看详情

显示内容：
- **左侧**: view45主图 + 收藏按钮
- **右侧AI分析区**: 
  - 车型分类和价格
  - 🤖 **AI智能分析**（新增）
    - 车型定位
    - 核心设计
    - 相关竞品
    - 3个核心亮点
  - 跳转官网按钮
  - 6个相关车型（可点击）
- **底部**: 所有详细图片（可点击放大）

---

## 🤖 AI分析功能

### AI提示词

系统提示词：
```
你是汽车感知质量专家，请用简洁专业的方式介绍车辆信息。
格式要求：
1. 车型定位(SUV/轿车/MPV等)
2. 核心设计(设计风格、设计亮点)
3. 相关竞品
4. 3个核心亮点
每项用一句话说明，总字数控制在100字内。
```

### 技术栈

- **语言模型**: DeepSeek Chat Model
- **向量数据库**: Pinecone
- **嵌入模型**: OpenAI (1024维)
- **知识库命名空间**: Test01

### 自定义AI分析

在工作流的"AI智能体"节点中修改：

```javascript
// 修改系统提示词
"systemMessage": "你的自定义提示词..."

// 修改输入内容
"chatinput": `请分析车型: ${carName}
价格区间: ${carPriceRange}
车型分类: ${vehicleClass}`
```

---

## 🔧 调试技巧

### 1. 测试API

使用Postman测试：
```bash
POST https://你的webhook地址/car-detail-complete
Content-Type: application/json

{
  "carName": "秦PLUS"
}
```

### 2. 查看AI分析日志

在N8N控制台查看"AI智能体"节点的输出：
- 输入提示词
- AI响应内容
- 向量检索结果

### 3. 调试模糊匹配

查看"处理所有逻辑"节点的日志：
```
目标车型: 秦PLUS
找到匹配: 6 条
实际车名: 比亚迪-秦PLUS
```

---

## ⚙️ 自定义配置

### 1. 修改相关车型数量

在"处理所有逻辑"节点：
```javascript
const topRelated = relatedCars.slice(0, 6); // 改成你要的数量
```

### 2. 修改AI分析长度

在"AI智能体"节点的系统提示词中：
```
总字数控制在100字内。  // 改成你要的字数
```

### 3. 修改Pinecone命名空间

在"从Pinecone检索向量"节点：
```javascript
"pineconeNamespace": "Test01"  // 改成你的命名空间
```

### 4. 切换AI模型

可以替换DeepSeek为其他模型：
- OpenAI GPT-4
- Claude
- Gemini

---

## 📊 模糊匹配规则

| 用户输入 | 数据库中的车名 | 是否匹配 |
|---------|--------------|---------|
| `秦PLUS` | `比亚迪-秦PLUS` | ✅ 包含匹配 |
| `比亚迪-秦PLUS` | `比亚迪-秦PLUS` | ✅ 完全匹配 |
| `海豹` | `比亚迪海豹` | ✅ 包含匹配 |
| `腾势` | `腾势N7` | ✅ 包含匹配 |

---

## ❓ 常见问题

**Q: AI分析显示"暂无AI分析"？**
A: 检查：
1. DeepSeek API凭据是否有效
2. Pinecone凭据是否配置
3. OpenAI API是否有额度
4. N8N控制台查看AI节点错误

**Q: AI分析速度慢？**
A: 
- AI生成需要3-5秒
- 向量检索需要1-2秒
- 总计约5-10秒

**Q: 如何不使用AI功能？**
A: 
- 删除"AI智能体"相关节点
- 直接连接"处理所有逻辑" → "整合最终结果"
- 修改"整合最终结果"代码，移除AI相关逻辑

**Q: Pinecone知识库如何准备？**
A: 
- 需要提前将汽车知识导入Pinecone
- 使用OpenAI嵌入模型向量化
- 存储到指定命名空间

**Q: 可以用其他知识库吗？**
A: 可以！替换为：
- Weaviate
- Qdrant
- Milvus
- 本地向量数据库

---

## 📞 技术支持

遇到问题时：

1. **检查配置**: 
   - Webhook地址是否正确
   - 所有API凭据是否有效
2. **查看Console**: 浏览器F12查看错误
3. **测试API**: 用Postman测试webhook
4. **检查N8N**: 
   - 工作流是否激活
   - 查看每个节点的执行日志
5. **验证数据**: Google Sheet是否有数据

---

## 🆕 更新日志

**v3.1.0 (2025-10-30)**
- ✨ 新增AI智能分析功能
- ✨ 集成DeepSeek语言模型
- ✨ 集成Pinecone向量检索
- ✨ 支持模糊匹配（"秦PLUS" → "比亚迪-秦PLUS"）
- 🎨 优化页面显示AI分析内容
- 📝 更新完整文档

**v3.0.0 (2025-10-30)**
- 🔄 单工作流架构
- ⚙️ 可配置webhook
- 📦 一次请求返回所有数据

---

**版本**: 3.1.0 (AI增强版)  
**特点**: 单工作流 + AI分析 + 模糊匹配 + 可配置webhook  
**创建日期**: 2025-10-30
