<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå¯¹è¯åˆ†æç³»ç»Ÿ - å®Œæ•´ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            overflow: hidden;
        }

        .main-container {
            display: flex;
            height: 100vh;
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            gap: 20px;
        }

        /* å·¦ä¾§ï¼šå†å²å¯¹è¯åˆ—è¡¨ */
        .sidebar {
            width: 300px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .sidebar-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .sidebar-header h2 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .new-chat-btn {
            width: 100%;
            padding: 10px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .new-chat-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .dialogue-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }

        .dialogue-item {
            padding: 15px;
            margin-bottom: 8px;
            background: #f8f9fa;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .dialogue-item:hover {
            background: #e9ecef;
        }

        .dialogue-item.active {
            background: #e3e8ff;
            border-color: #667eea;
        }

        .dialogue-item h3 {
            font-size: 14px;
            margin-bottom: 5px;
            color: #333;
        }

        .dialogue-item p {
            font-size: 12px;
            color: #999;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .dialogue-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }

        .dialogue-tag {
            font-size: 10px;
            padding: 2px 8px;
            background: #667eea;
            color: white;
            border-radius: 10px;
        }

        /* ä¸­é—´ï¼šèŠå¤©åŒºåŸŸ */
        .chat-area {
            flex: 1;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title h2 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .chat-title p {
            font-size: 12px;
            opacity: 0.8;
        }

        .generate-report-btn {
            padding: 10px 20px;
            background: white;
            color: #667eea;
            border: none;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .generate-report-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #f8f9fa;
        }

        .message {
            display: flex;
            margin-bottom: 15px;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 18px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.assistant .message-content {
            background: white;
            color: #333;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .input-area input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 50px;
            font-size: 14px;
            outline: none;
            transition: all 0.3s;
        }

        .input-area input:focus {
            border-color: #667eea;
        }

        .send-btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* å³ä¾§ï¼šè°ƒè¯•å·¥å…· */
        .debug-panel {
            width: 350px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .debug-header {
            padding: 20px;
            background: #2c3e50;
            color: white;
        }

        .debug-header h2 {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .debug-config {
            padding: 15px;
            border-bottom: 1px solid #e0e0e0;
        }

        .debug-config label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        .debug-config input {
            width: 100%;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            font-size: 13px;
            margin-bottom: 10px;
        }

        .save-config-btn {
            width: 100%;
            padding: 10px;
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 5px;
        }

        .save-config-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.4);
        }

        .save-config-btn:active {
            transform: translateY(0);
        }

        .debug-logs {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f8f9fa;
            font-family: 'Courier New', monospace;
            font-size: 11px;
        }

        .log-entry {
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }

        .log-entry.error {
            border-left-color: #e74c3c;
        }

        .log-entry.success {
            border-left-color: #2ecc71;
        }

        .log-time {
            color: #999;
            font-size: 10px;
        }

        .log-content {
            color: #333;
            margin-top: 5px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 40px;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- å·¦ä¾§ï¼šå¯¹è¯åˆ—è¡¨ -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>ğŸ’¬ å¯¹è¯å†å²</h2>
                <button class="new-chat-btn" onclick="startNewChat()">â• æ–°å¯¹è¯</button>
            </div>
            <div class="dialogue-list" id="dialogueList">
                <div class="empty-state">
                    <p>æš‚æ— å¯¹è¯å†å²</p>
                </div>
            </div>
        </div>

        <!-- ä¸­é—´ï¼šèŠå¤©åŒºåŸŸ -->
        <div class="chat-area">
            <div class="chat-header">
                <div class="chat-title">
                    <h2 id="currentTitle">ğŸš— AIè½¦å‹åˆ†æåŠ©æ‰‹</h2>
                    <p id="currentTags">è¯·å¼€å§‹å¯¹è¯</p>
                </div>
                <button class="generate-report-btn" onclick="generateReport()" id="generateBtn">
                    ğŸ“Š ç”ŸæˆæŠ¥å‘Š
                </button>
            </div>
            <div class="messages" id="messages">
                <div class="empty-state">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                    </svg>
                    <p>å¼€å§‹æ–°çš„å¯¹è¯å§ï¼</p>
                </div>
            </div>
            <div class="input-area">
                <input 
                    type="text" 
                    id="messageInput" 
                    placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼šè¯·å¸®æˆ‘åˆ†æé—®ç•ŒM7çš„å¤–è§‚..." 
                    onkeypress="handleKeyPress(event)"
                >
                <button class="send-btn" onclick="sendMessage()" id="sendBtn">å‘é€</button>
            </div>
        </div>

        <!-- å³ä¾§ï¼šè°ƒè¯•å·¥å…· -->
        <div class="debug-panel">
            <div class="debug-header">
                <h2>ğŸ› ï¸ è°ƒè¯•å·¥å…·</h2>
            </div>
            <div class="debug-config">
                <label>Webhook URL:</label>
                <input 
                    type="text" 
                    id="webhookURL" 
                    value="https://lynn-cafa-system.app.n8n.cloud/webhook/ai-analysis"
                    placeholder="è¾“å…¥N8N Webhookåœ°å€"
                >
                <label>User ID:</label>
                <input 
                    type="text" 
                    id="userID" 
                    value="testCode"
                    placeholder="è¾“å…¥ç”¨æˆ·ID"
                >
                <button class="save-config-btn" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
            </div>
            <div class="debug-logs" id="debugLogs">
                <div class="log-entry">
                    <div class="log-time">[ç³»ç»Ÿå¯åŠ¨]</div>
                    <div class="log-content">è°ƒè¯•å·¥å…·å·²å°±ç»ª</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ========== å…¨å±€çŠ¶æ€ ==========
        let currentDialogueID = null;
        let currentTitle = ''; // â­ æ–°å¢ï¼šç»´æŠ¤å½“å‰å¯¹è¯æ ‡é¢˜
        let conversationHistory = ''; // â­ æ–°å¢ï¼šç»´æŠ¤conversationHistory
        let dialogues = [];
        let messages = [];

        // ========== å·¥å…·å‡½æ•° ==========
        function getWebhookURL() {
            return document.getElementById('webhookURL').value;
        }

        function getUserID() {
            return document.getElementById('userID').value;
        }

        // â­ ä¿å­˜é…ç½®åˆ°localStorage
        function saveConfig() {
            const webhookURL = document.getElementById('webhookURL').value.trim();
            const userID = document.getElementById('userID').value.trim();

            if (!webhookURL) {
                alert('âŒ Webhook URLä¸èƒ½ä¸ºç©ºï¼');
                return;
            }

            if (!userID) {
                alert('âŒ User IDä¸èƒ½ä¸ºç©ºï¼');
                return;
            }

            // ä¿å­˜åˆ°localStorage
            localStorage.setItem('n8n_webhook_url', webhookURL);
            localStorage.setItem('n8n_user_id', userID);

            addLog('âœ… é…ç½®å·²ä¿å­˜ï¼\nWebhook: ' + webhookURL + '\nUser ID: ' + userID, 'success');
            alert('âœ… é…ç½®ä¿å­˜æˆåŠŸï¼');
        }

        // â­ ä»localStorageåŠ è½½é…ç½®
        function loadConfig() {
            const savedWebhookURL = localStorage.getItem('n8n_webhook_url');
            const savedUserID = localStorage.getItem('n8n_user_id');

            if (savedWebhookURL) {
                document.getElementById('webhookURL').value = savedWebhookURL;
                addLog('ğŸ“¥ å·²åŠ è½½ä¿å­˜çš„Webhook URL');
            }

            if (savedUserID) {
                document.getElementById('userID').value = savedUserID;
                addLog('ğŸ“¥ å·²åŠ è½½ä¿å­˜çš„User ID');
            }
        }

        function addLog(message, type = 'info') {
            const logsContainer = document.getElementById('debugLogs');
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${type}`;
            
            const time = new Date().toLocaleTimeString('zh-CN');
            logEntry.innerHTML = `
                <div class="log-time">[${time}]</div>
                <div class="log-content">${message}</div>
            `;
            
            logsContainer.appendChild(logEntry);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        function addMessage(role, content) {
            const messagesContainer = document.getElementById('messages');
            
            // ç§»é™¤ç©ºçŠ¶æ€
            const emptyState = messagesContainer.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.innerHTML = `
                <div class="message-content">${content}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function updateDialogueList(dialogueList) {
            const listContainer = document.getElementById('dialogueList');
            
            if (dialogueList.length === 0) {
                listContainer.innerHTML = '<div class="empty-state"><p>æš‚æ— å¯¹è¯å†å²</p></div>';
                return;
            }

            listContainer.innerHTML = dialogueList.map(dlg => {
                // â­ å…¼å®¹tagsçš„å¤šç§æ ¼å¼ï¼ˆæ•°ç»„/å­—ç¬¦ä¸²/ç©ºï¼‰
                let tagsArray = [];
                if (Array.isArray(dlg.tags)) {
                    tagsArray = dlg.tags;
                } else if (typeof dlg.tags === 'string' && dlg.tags) {
                    tagsArray = dlg.tags.split(',').map(t => t.trim()).filter(t => t);
                }
                
                return `
                    <div class="dialogue-item ${dlg.dialogueID === currentDialogueID ? 'active' : ''}" 
                         onclick="selectDialogue('${dlg.dialogueID}')">
                        <h3>${dlg.title}</h3>
                        <p>${dlg.preview || 'æš‚æ— å†…å®¹'}</p>
                        <div class="dialogue-tags">
                            ${tagsArray.map(tag => `<span class="dialogue-tag">${tag}</span>`).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ========== API è°ƒç”¨ ==========
        async function callAPI(action, data) {
            const url = getWebhookURL();
            const userID = getUserID();

            const payload = {
                action: action,
                userID: userID,
                ...data
            };

            addLog(`ğŸ“¤ å‘é€è¯·æ±‚: ${action}\n${JSON.stringify(payload, null, 2)}`);

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                addLog(`ğŸ“¥ æ”¶åˆ°å“åº”:\n${JSON.stringify(result, null, 2)}`, 'success');
                return result;
            } catch (error) {
                addLog(`âŒ è¯·æ±‚å¤±è´¥: ${error.message}`, 'error');
                throw error;
            }
        }

        // ========== åŠŸèƒ½å®ç° ==========
        async function loadDialogueList() {
            try {
                const result = await callAPI('getDialogueList', {});
                if (result.success) {
                    dialogues = result.dialogues;
                    updateDialogueList(dialogues);
                }
            } catch (error) {
                console.error('åŠ è½½å¯¹è¯åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        async function selectDialogue(dialogueID) {
            try {
                currentDialogueID = dialogueID;
                
                // æ›´æ–°UI
                const dialogue = dialogues.find(d => d.dialogueID === dialogueID);
                if (dialogue) {
                    document.getElementById('currentTitle').textContent = dialogue.title;
                    
                    // â­ å…¼å®¹tagsçš„å¤šç§æ ¼å¼
                    let tagsArray = [];
                    if (Array.isArray(dialogue.tags)) {
                        tagsArray = dialogue.tags;
                    } else if (typeof dialogue.tags === 'string' && dialogue.tags) {
                        tagsArray = dialogue.tags.split(',').map(t => t.trim()).filter(t => t);
                    }
                    document.getElementById('currentTags').textContent = tagsArray.length > 0 ? tagsArray.join(', ') : 'æš‚æ— æ ‡ç­¾';
                }

                updateDialogueList(dialogues);

                // åŠ è½½å¯¹è¯è¯¦æƒ…
                const result = await callAPI('getDialogueDetail', { dialogueID: dialogueID });
                if (result.success) {
                    // â­ è·å–å¹¶ç¼“å­˜title
                    if (result.title) {
                        currentTitle = result.title;
                        addLog('ğŸ“¥ åŠ è½½æ ‡é¢˜: ' + result.title);
                    }
                    
                    // â­ è·å–å¹¶ç¼“å­˜conversationHistory
                    if (result.conversationHistory) {
                        conversationHistory = result.conversationHistory;
                        addLog('ğŸ“¥ åŠ è½½conversationHistory: ' + conversationHistory.substring(0, 50) + '...');
                    }

                    // è§£æå¹¶æ˜¾ç¤ºæ¶ˆæ¯
                    messages = result.messages || [];
                    
                    const messagesContainer = document.getElementById('messages');
                    messagesContainer.innerHTML = '';
                    
                    messages.forEach(msg => {
                        addMessage(msg.role, msg.content);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½å¯¹è¯è¯¦æƒ…å¤±è´¥:', error);
            }
        }

        function startNewChat() {
            currentDialogueID = null;
            currentTitle = ''; // â­ æ¸…ç©ºæ ‡é¢˜
            conversationHistory = ''; // â­ æ¸…ç©ºå†å²
            messages = [];
            
            document.getElementById('currentTitle').textContent = 'ğŸš— AIè½¦å‹åˆ†æåŠ©æ‰‹';
            document.getElementById('currentTags').textContent = 'è¯·å¼€å§‹å¯¹è¯';
            
            const messagesContainer = document.getElementById('messages');
            messagesContainer.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg><p>å¼€å§‹æ–°çš„å¯¹è¯å§ï¼</p></div>';
            
            updateDialogueList(dialogues);
            
            addLog('ğŸ†• å¼€å§‹æ–°å¯¹è¯');
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content) {
                addLog('âš ï¸ æ¶ˆæ¯å†…å®¹ä¸ºç©º', 'error');
                return;
            }

            // ç¦ç”¨è¾“å…¥
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.disabled = true;
            sendBtn.innerHTML = '<span class="loading"></span>';

            // ä¹è§‚æ›´æ–°ï¼šç«‹å³æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessage('user', content);
            input.value = '';

            try {
                const result = await callAPI('sendMessage', {
                    dialogueID: currentDialogueID,
                    title: currentTitle, // â­ ä¼ é€’å½“å‰æ ‡é¢˜
                    conversationHistory: conversationHistory, // â­ ä¼ é€’å†å²
                    content: content
                });

                if (result.success) {
                    // æ˜¾ç¤ºAIå›å¤
                    addMessage('assistant', result.aiReply);

                    // â­ æ›´æ–°conversationHistory
                    if (result.conversationHistory) {
                        conversationHistory = result.conversationHistory;
                        addLog('ğŸ“ conversationHistoryå·²æ›´æ–°');
                    }

                    // â­ æ›´æ–°æ ‡é¢˜ï¼ˆåªåœ¨ç¬¬ä¸€æ¬¡æˆ–æ ‡é¢˜å˜åŒ–æ—¶ï¼‰
                    if (result.title && result.title !== 'æœªå‘½åå¯¹è¯') {
                        currentTitle = result.title;
                        document.getElementById('currentTitle').textContent = result.title;
                        addLog('ğŸ“ æ ‡é¢˜å·²æ›´æ–°: ' + result.title);
                    }
                    
                    // â­ æ›´æ–°æ ‡ç­¾
                    if (result.extractedTags && result.extractedTags.length > 0) {
                        document.getElementById('currentTags').textContent = result.extractedTags.join(', ');
                    }

                    // å¦‚æœæ˜¯æ–°å¯¹è¯ï¼Œæ›´æ–°å¯¹è¯åˆ—è¡¨
                    if (!currentDialogueID) {
                        currentDialogueID = result.dialogueID;
                        
                        // ä¹è§‚æ›´æ–°å¯¹è¯åˆ—è¡¨
                        dialogues.unshift({
                            dialogueID: result.dialogueID,
                            title: currentTitle,
                            tags: result.extractedTags,
                            createTime: new Date().toISOString(),
                            preview: content
                        });
                        updateDialogueList(dialogues);
                    }
                }
            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'å‘é€';
            }
        }

        async function generateReport() {
            if (!currentDialogueID) {
                alert('âŒ è¯·å…ˆå¼€å§‹ä¸€ä¸ªå¯¹è¯\n\næç¤ºï¼šåœ¨è¾“å…¥æ¡†å‘é€æ¶ˆæ¯åï¼Œå³å¯ç”ŸæˆæŠ¥å‘Š');
                addLog('âš ï¸ ç”ŸæˆæŠ¥å‘Šå¤±è´¥ï¼šæ²¡æœ‰æ´»åŠ¨å¯¹è¯', 'error');
                return;
            }

            // â­ æ£€æŸ¥å¯¹è¯å†…å®¹
            if (!conversationHistory || conversationHistory.trim().length === 0) {
                alert('âš ï¸ å¯¹è¯å†…å®¹ä¸ºç©º\n\nè¯·å…ˆä¸AIè¿›è¡Œå‡ è½®å¯¹è¯ï¼Œè®¨è®ºæ‚¨æƒ³å¯¹æ¯”çš„è½¦å‹');
                addLog('âš ï¸ ç”ŸæˆæŠ¥å‘Šå¤±è´¥ï¼šå¯¹è¯å†…å®¹ä¸ºç©º', 'error');
                return;
            }

            const generateBtn = document.getElementById('generateBtn');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="loading"></span> ç”Ÿæˆä¸­...';
            
            addLog('ğŸ“Š å¼€å§‹ç”ŸæˆæŠ¥å‘Šï¼ŒdialogueID: ' + currentDialogueID);

            try {
                const result = await callAPI('generateReport', {
                    dialogueID: currentDialogueID
                });

                if (result.success) {
                    addLog('âœ… æŠ¥å‘Šç”ŸæˆæˆåŠŸï¼æŠ¥å‘ŠID: ' + result.reportID, 'success');
                    const newWindow = window.open('', '_blank');
                    if (newWindow) {
                        newWindow.document.write(result.htmlContent);
                        newWindow.document.close();
                        alert('âœ… æŠ¥å‘Šå·²åœ¨æ–°çª—å£æ‰“å¼€\n\næç¤ºï¼šæ‚¨å¯ä»¥ä½¿ç”¨æµè§ˆå™¨çš„æ‰“å°åŠŸèƒ½ä¿å­˜ä¸ºPDF');
                    } else {
                        alert('âŒ æ— æ³•æ‰“å¼€æ–°çª—å£\n\nè¯·å…è®¸æµè§ˆå™¨å¼¹å‡ºçª—å£æƒé™');
                        addLog('âš ï¸ å¼¹å‡ºçª—å£è¢«é˜»æ­¢', 'error');
                    }
                } else {
                    alert('âŒ æŠ¥å‘Šç”Ÿæˆå¤±è´¥\n\n' + (result.error || 'æœªçŸ¥é”™è¯¯'));
                    addLog('âŒ æŠ¥å‘Šç”Ÿæˆå¤±è´¥: ' + (result.error || 'æœªçŸ¥é”™è¯¯'), 'error');
                }
            } catch (error) {
                console.error('ç”ŸæˆæŠ¥å‘Šå¤±è´¥:', error);
                alert('âŒ ç”ŸæˆæŠ¥å‘Šå¤±è´¥\n\n' + error.message + '\n\nè¯·æŸ¥çœ‹è°ƒè¯•æ—¥å¿—');
                addLog('âŒ è¯·æ±‚å¤±è´¥: ' + error.message, 'error');
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'ğŸ“Š ç”ŸæˆæŠ¥å‘Š';
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // ========== åˆå§‹åŒ– ==========
        window.onload = () => {
            loadConfig();  // â­ å…ˆåŠ è½½ä¿å­˜çš„é…ç½®
            addLog('ğŸš€ ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ');
            loadDialogueList();
        };
    </script>
</body>
</html>

