{
  "name": "AIå¯¹è¯åˆ†æç³»ç»Ÿ-å®Œæ•´ç‰ˆ",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ai-analysis",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "a1b2c3d4-e5f6-7890-1234-567890abcdef",
      "name": "Webhookå…¥å£",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [240, 400],
      "webhookId": "ai-analysis-webhook"
    },
    {
      "parameters": {
        "jsCode": "const action = $input.item.json.body.action;\nreturn {json: {action: action, data: $input.item.json.body}};"
      },
      "id": "b2c3d4e5-f6a7-8901-2345-678901bcdefg",
      "name": "Router",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 400]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{$json.action}}",
                    "rightValue": "sendMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "condition-1"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "sendMessage"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{$json.action}}",
                    "rightValue": "generateReport",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "condition-2"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "generateReport"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{$json.action}}",
                    "rightValue": "getDialogueList",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "condition-3"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "getDialogueList"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{$json.action}}",
                    "rightValue": "getDialogueDetail",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "condition-4"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "getDialogueDetail"
            }
          ]
        },
        "options": {}
      },
      "id": "c3d4e5f6-a7b8-9012-3456-789012cdefgh",
      "name": "Switch",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [680, 400]
    },
    {
      "parameters": {
        "jsCode": "// ========== å¤„ç†æ¶ˆæ¯ ==========\nconst data = $input.item.json.data;\nconst content = data.content || '';\nconst userID = data.userID || 'testCode';\nconst dialogueID = data.dialogueID || null;\nconst isNewDialogue = !dialogueID;\n\n// ç”Ÿæˆæ–°çš„dialogueIDï¼ˆå¦‚æœæ˜¯æ–°å¯¹è¯ï¼‰\nconst newDialogueID = isNewDialogue ? 'dlg_' + Date.now() : dialogueID;\n\n// å…³é”®è¯æå–\nconst keywords = ['å¤–è§‚','å†…é¥°','æ€§èƒ½','ç»­èˆª','ç©ºé—´','é…ç½®','æ™ºèƒ½åŒ–','ä»·æ ¼','å®‰å…¨','èˆ’é€‚','å¤–é¥°','å†…è£…','åŠ¨åŠ›'];\nconst extractedTags = keywords.filter(k => content.includes(k));\n\n// ç”Ÿæˆæ ‡é¢˜\nlet title = '';\nif (extractedTags.length > 0) {\n  title = extractedTags.slice(0, 3).join('ã€') + 'åˆ†æ';\n} else {\n  title = content.slice(0, 20) + (content.length > 20 ? '...' : '');\n}\n\nconst timestamp = new Date().toISOString();\n\nreturn {\n  json: {\n    dialogueID: newDialogueID,\n    userID: userID,\n    title: title,\n    tags: extractedTags.join(','),\n    createTime: timestamp,\n    status: 'active',\n    isNewDialogue: isNewDialogue,\n    userContent: content\n  }\n};"
      },
      "id": "d4e5f6a7-b8c9-0123-4567-890123defghi",
      "name": "ProcessMessage",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 200]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{$json.isNewDialogue}}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "true"
                    },
                    "id": "condition-new"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "æ–°å¯¹è¯"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "e5f6a7b8-c9d0-1234-5678-901234efghij",
      "name": "åˆ¤æ–­æ–°å¯¹è¯",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [1120, 200]
    },
    {
      "parameters": {
        "jsCode": "// ========== æ–°å¯¹è¯ï¼šåˆå§‹åŒ– ==========\nconst data = $input.item.json;\n\n// åˆå§‹åŒ–conversationHistory\nconst initialHistory = `userSpeak:${data.userContent}----`;\n\nreturn {\n  json: {\n    dialogueID: data.dialogueID,\n    userID: data.userID,\n    title: data.title,\n    tags: data.tags,\n    createTime: data.createTime,\n    conversationHistory: initialHistory,\n    status: data.status\n  }\n};"
      },
      "id": "f6a7b8c9-d0e1-2345-6789-012345fghijk",
      "name": "åˆå§‹åŒ–å¯¹è¯",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 100]
    },
    {
      "parameters": {
        "jsCode": "// ========== è°ƒç”¨ AI (æ¨¡æ‹Ÿç‰ˆ) ==========\nconst data = $input.item.json;\nconst conversationHistory = data.conversationHistory;\n\n// è§£æå†å²å¯¹è¯\nconst pairs = conversationHistory.split('----').filter(s => s.trim());\nconst messages = [];\nfor (const pair of pairs) {\n  if (pair.startsWith('userSpeak:')) {\n    messages.push({\n      role: 'user',\n      content: pair.replace('userSpeak:', '')\n    });\n  } else if (pair.startsWith('AISpeak:')) {\n    messages.push({\n      role: 'assistant',\n      content: pair.replace('AISpeak:', '')\n    });\n  }\n}\n\n// æ¨¡æ‹ŸAIå›å¤ï¼ˆMVPé˜¶æ®µï¼‰\nconst latestUserMessage = messages[messages.length - 1].content;\nlet aiReply = '';\n\nif (latestUserMessage.includes('å¤–è§‚') || latestUserMessage.includes('å¤–é¥°')) {\n  aiReply = 'æˆ‘ç†è§£æ‚¨å…³æ³¨è½¦è¾†çš„å¤–è§‚è®¾è®¡ã€‚å¤–è§‚æ˜¯ä¸€æ¬¾è½¦çš„ç¬¬ä¸€å°è±¡ï¼ŒåŒ…æ‹¬å‰è„¸è®¾è®¡ã€è½¦èº«çº¿æ¡ã€è½®æ¯‚é€ å‹ç­‰ã€‚æ‚¨æƒ³å¯¹æ¯”å“ªå‡ æ¬¾è½¦å‹çš„å¤–è§‚å‘¢ï¼Ÿ';\n} else if (latestUserMessage.includes('æ€§èƒ½') || latestUserMessage.includes('åŠ¨åŠ›')) {\n  aiReply = 'æ€§èƒ½åˆ†ææ˜¯å¾ˆé‡è¦çš„å¯¹æ¯”ç»´åº¦ã€‚æˆ‘ä¼šå…³æ³¨åŠ¨åŠ›å‚æ•°ã€åŠ é€Ÿæ€§èƒ½ã€æ“æ§è¡¨ç°ç­‰ã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³å¯¹æ¯”çš„è½¦å‹ï¼Œæˆ‘ä¼šä¸ºæ‚¨è¯¦ç»†åˆ†æã€‚';\n} else if (latestUserMessage.includes('ç”ŸæˆæŠ¥å‘Š') || latestUserMessage.includes('å¯¹æ¯”æŠ¥å‘Š')) {\n  aiReply = 'å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨ç”Ÿæˆè¯¦ç»†çš„è½¦å‹å¯¹æ¯”æŠ¥å‘Šã€‚è¯·ç‚¹å‡»"ç”ŸæˆæŠ¥å‘Š"æŒ‰é’®ï¼Œæˆ‘ä¼šæ ¹æ®æˆ‘ä»¬çš„å¯¹è¯å†…å®¹åˆ¶ä½œä¸“ä¸šçš„å¯¹æ¯”åˆ†ææŠ¥å‘Šã€‚';\n} else {\n  aiReply = 'å¥½çš„ï¼Œæˆ‘ç†è§£äº†æ‚¨çš„éœ€æ±‚ã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³å¯¹æ¯”çš„è½¦å‹å’Œå…³æ³¨çš„ç»´åº¦ï¼ˆå¦‚å¤–è§‚ã€å†…é¥°ã€æ€§èƒ½ã€é…ç½®ç­‰ï¼‰ï¼Œæˆ‘ä¼šä¸ºæ‚¨æä¾›è¯¦ç»†çš„åˆ†æã€‚';\n}\n\nconst messageID = 'msg_' + Date.now();\n\nreturn {\n  json: {\n    ...data,\n    aiReply: aiReply,\n    messageID: messageID\n  }\n};"
      },
      "id": "a7b8c9d0-e1f2-3456-7890-123456ghijkl",
      "name": "è°ƒç”¨AI",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1560, 200]
    },
    {
      "parameters": {
        "jsCode": "// ========== æ›´æ–°conversationHistory ==========\nconst data = $input.item.json;\nconst aiReply = data.aiReply;\n\n// è¿½åŠ AIå›å¤\nconst finalHistory = data.conversationHistory + `AISpeak:${aiReply}----`;\n\nreturn {\n  json: {\n    dialogueID: data.dialogueID,\n    userID: data.userID,\n    title: data.title,\n    tags: data.tags,\n    conversationHistory: finalHistory,\n    status: data.status,\n    createTime: data.createTime,\n    // è¿”å›ç»™å‰ç«¯çš„æ•°æ®\n    response: {\n      success: true,\n      dialogueID: data.dialogueID,\n      messageID: data.messageID,\n      aiReply: aiReply,\n      title: data.title,\n      extractedTags: data.tags ? data.tags.split(',') : []\n    }\n  }\n};"
      },
      "id": "b8c9d0e1-f2a3-4567-8901-234567hijklm",
      "name": "æ›´æ–°å†å²",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1780, 200]
    },
    {
      "parameters": {
        "jsCode": "return {json: $input.item.json.response};"
      },
      "id": "c9d0e1f2-a3b4-5678-9012-345678ijklmn",
      "name": "æ ¼å¼åŒ–å“åº”",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2220, 200]
    },
    {
      "parameters": {
        "jsCode": "// ========== ç”ŸæˆæŠ¥å‘Š ==========\nconst data = $input.item.json.data;\nconst dialogueID = data.dialogueID;\nconst userID = data.userID || 'testCode';\nconst tags = data.tags || ['å¤–è§‚','å†…é¥°'];\nconst vehicles = data.vehicles || [{name:'ææ°ª009'},{name:'å°é¹X9'},{name:'è…¾åŠ¿D9'}];\n\nconst reportID = 'report_' + Date.now();\nconst createTime = new Date().toISOString();\n\n// ç”ŸæˆHTML\nconst html = `<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>è½¦å‹å¯¹æ¯”æŠ¥å‘Š - ${reportID}</title>\n    <style>\n        * {margin: 0;padding: 0;box-sizing: border-box;}\n        body {font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', sans-serif;background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);padding: 40px 20px;min-height: 100vh;}\n        .container {max-width: 1200px;margin: 0 auto;background: white;border-radius: 20px;box-shadow: 0 20px 60px rgba(0,0,0,0.3);overflow: hidden;}\n        .header {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);color: white;padding: 40px;text-align: center;}\n        .header h1 {font-size: 32px;margin-bottom: 10px;}\n        .header p {opacity: 0.9;font-size: 14px;}\n        .print-btn {position: fixed;top: 20px;right: 20px;padding: 12px 24px;background: white;color: #667eea;border: none;border-radius: 50px;font-size: 16px;font-weight: 600;cursor: pointer;box-shadow: 0 4px 15px rgba(0,0,0,0.2);transition: all 0.3s;z-index: 1000;}\n        .print-btn:hover {transform: translateY(-2px);box-shadow: 0 6px 20px rgba(0,0,0,0.3);}\n        .content {padding: 40px;}\n        table {width: 100%;border-collapse: collapse;margin-top: 20px;}\n        thead {background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);color: white;}\n        th, td {padding: 20px;text-align: left;border-bottom: 1px solid #e0e0e0;}\n        th {font-weight: 600;font-size: 16px;}\n        td {font-size: 14px;color: #333;}\n        tbody tr:hover {background: #f8f9ff;}\n        .footer {text-align: center;padding: 30px;color: #999;font-size: 14px;border-top: 1px solid #e0e0e0;}\n        @media print {body {background: white;padding: 0;}.print-btn {display: none;}.container {box-shadow: none;}}\n    </style>\n</head>\n<body>\n    <button class=\"print-btn\" onclick=\"window.print()\">ğŸ–¨ï¸ æ‰“å°/ä¿å­˜PDF</button>\n    <div class=\"container\">\n        <div class=\"header\">\n            <h1>ğŸš— è½¦å‹å¯¹æ¯”åˆ†ææŠ¥å‘Š</h1>\n            <p>ç”Ÿæˆæ—¶é—´ï¼š${new Date(createTime).toLocaleString('zh-CN')}</p>\n        </div>\n        <div class=\"content\">\n            <table>\n                <thead>\n                    <tr>\n                        <th>å¯¹æ¯”ç»´åº¦</th>\n                        ${vehicles.map(v => `<th>${v.name}</th>`).join('')}\n                    </tr>\n                </thead>\n                <tbody>\n                    ${tags.map(tag => `\n                    <tr>\n                        <td><strong>${tag}</strong></td>\n                        ${vehicles.map(() => '<td>è¯¥è½¦å‹åœ¨æ­¤ç»´åº¦è¡¨ç°ä¼˜ç§€</td>').join('')}\n                    </tr>\n                    `).join('')}\n                </tbody>\n            </table>\n        </div>\n        <div class=\"footer\">\n            <p>æŠ¥å‘ŠID: ${reportID}</p>\n            <p>æœ¬æŠ¥å‘Šç”±AIæ™ºèƒ½åˆ†æç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒ</p>\n        </div>\n    </div>\n</body>\n</html>`;\n\nreturn {\n  json: {\n    success: true,\n    reportID: reportID,\n    htmlContent: html,\n    createTime: createTime\n  }\n};"
      },
      "id": "d0e1f2a3-b4c5-6789-0123-456789jklmno",
      "name": "GenerateReport",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 400]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.item.json.data;\nconst userID = data.userID || 'testCode';\n\n// MVPé˜¶æ®µï¼šè¿”å›æ¨¡æ‹Ÿæ•°æ®\nconst dialogues = [\n  {\n    dialogueID: 'dlg_001',\n    title: 'è½¦å‹å¤–è§‚å¯¹æ¯”',\n    tags: ['å¤–è§‚', 'è®¾è®¡'],\n    createTime: '2024-11-01 10:00',\n    preview: 'è¯·å¸®æˆ‘åˆ†æé—®ç•ŒM7çš„å¤–é¥°'\n  },\n  {\n    dialogueID: 'dlg_002',\n    title: 'ç»­èˆªæ€§èƒ½åˆ†æ',\n    tags: ['ç»­èˆª', 'æ€§èƒ½'],\n    createTime: '2024-11-01 14:30',\n    preview: 'æˆ‘æƒ³äº†è§£ä¸€ä¸‹æ–°èƒ½æºè½¦çš„ç»­èˆªè¡¨ç°'\n  }\n];\n\nreturn {\n  json: {\n    success: true,\n    dialogues: dialogues,\n    total: dialogues.length\n  }\n};"
      },
      "id": "e1f2a3b4-c5d6-7890-1234-567890klmnop",
      "name": "GetDialogueList",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 600]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.item.json.data;\nconst dialogueID = data.dialogueID;\n\n// MVPé˜¶æ®µï¼šè¿”å›æ¨¡æ‹Ÿæ•°æ®\nconst messages = [\n  {\n    role: 'user',\n    content: 'è¯·å¸®æˆ‘åˆ†æé—®ç•ŒM7çš„å¤–é¥°',\n    timestamp: '2024-11-01 10:00:00'\n  },\n  {\n    role: 'assistant',\n    content: 'æˆ‘ç†è§£æ‚¨å…³æ³¨è½¦è¾†çš„å¤–è§‚è®¾è®¡ã€‚å¤–è§‚æ˜¯ä¸€æ¬¾è½¦çš„ç¬¬ä¸€å°è±¡ï¼ŒåŒ…æ‹¬å‰è„¸è®¾è®¡ã€è½¦èº«çº¿æ¡ç­‰ã€‚',\n    timestamp: '2024-11-01 10:00:05'\n  }\n];\n\nreturn {\n  json: {\n    success: true,\n    dialogueID: dialogueID,\n    title: 'è½¦å‹å¤–è§‚å¯¹æ¯”',\n    messages: messages\n  }\n};"
      },
      "id": "f2a3b4c5-d6e7-8901-2345-678901lmnopq",
      "name": "GetDialogueDetail",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 800]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{$json}}",
        "options": {}
      },
      "id": "a3b4c5d6-e7f8-9012-3456-789012mnopqr",
      "name": "ç»Ÿä¸€å“åº”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2440, 400]
    }
  ],
  "connections": {
    "Webhookå…¥å£": {
      "main": [[{"node": "Router", "type": "main", "index": 0}]]
    },
    "Router": {
      "main": [[{"node": "Switch", "type": "main", "index": 0}]]
    },
    "Switch": {
      "main": [
        [{"node": "ProcessMessage", "type": "main", "index": 0}],
        [{"node": "GenerateReport", "type": "main", "index": 0}],
        [{"node": "GetDialogueList", "type": "main", "index": 0}],
        [{"node": "GetDialogueDetail", "type": "main", "index": 0}]
      ]
    },
    "ProcessMessage": {
      "main": [[{"node": "åˆ¤æ–­æ–°å¯¹è¯", "type": "main", "index": 0}]]
    },
    "åˆ¤æ–­æ–°å¯¹è¯": {
      "main": [
        [{"node": "åˆå§‹åŒ–å¯¹è¯", "type": "main", "index": 0}],
        []
      ]
    },
    "åˆå§‹åŒ–å¯¹è¯": {
      "main": [[{"node": "è°ƒç”¨AI", "type": "main", "index": 0}]]
    },
    "è°ƒç”¨AI": {
      "main": [[{"node": "æ›´æ–°å†å²", "type": "main", "index": 0}]]
    },
    "æ›´æ–°å†å²": {
      "main": [[{"node": "æ ¼å¼åŒ–å“åº”", "type": "main", "index": 0}]]
    },
    "æ ¼å¼åŒ–å“åº”": {
      "main": [[{"node": "ç»Ÿä¸€å“åº”", "type": "main", "index": 0}]]
    },
    "GenerateReport": {
      "main": [[{"node": "ç»Ÿä¸€å“åº”", "type": "main", "index": 0}]]
    },
    "GetDialogueList": {
      "main": [[{"node": "ç»Ÿä¸€å“åº”", "type": "main", "index": 0}]]
    },
    "GetDialogueDetail": {
      "main": [[{"node": "ç»Ÿä¸€å“åº”", "type": "main", "index": 0}]]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "5cb72472896fce0666bc03ef84936c4f09ec11e6b4f95f9aebe3d538947c7935"
  },
  "tags": [],
  "settings": {
    "executionOrder": "v1"
  }
}
