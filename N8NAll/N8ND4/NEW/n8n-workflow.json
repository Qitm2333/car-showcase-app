{
  "name": "AIå¯¹è¯åˆ†æç³»ç»Ÿ-å®Œæ•´ç‰ˆ",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ai-analysis",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "webhook-001",
      "name": "Webhookå…¥å£",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [240, 400],
      "webhookId": "ai-analysis-webhook"
    },
    {
      "parameters": {
        "jsCode": "const action = $input.item.json.body.action;\nreturn {json: {action: action, data: $input.item.json.body}};"
      },
      "id": "router-002",
      "name": "Router",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [460, 400]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{$json.action}}",
                    "rightValue": "sendMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "condition-1"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "sendMessage"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{$json.action}}",
                    "rightValue": "generateReport",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "condition-2"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "generateReport"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{$json.action}}",
                    "rightValue": "getDialogueList",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "condition-3"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "getDialogueList"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{$json.action}}",
                    "rightValue": "getDialogueDetail",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "condition-4"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "getDialogueDetail"
            }
          ]
        },
        "options": {}
      },
      "id": "switch-003",
      "name": "Switch",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [680, 400]
    },
    {
      "parameters": {
        "jsCode": "// ========== å¤„ç†æ¶ˆæ¯ ==========\nconst data = $input.item.json.data;\nconst content = data.content || '';\nconst userID = data.userID || 'testCode';\nconst dialogueID = data.dialogueID || null;\nconst isNewDialogue = !dialogueID;\n\n// ç”Ÿæˆæ–°çš„dialogueIDï¼ˆå¦‚æœæ˜¯æ–°å¯¹è¯ï¼‰\nconst newDialogueID = isNewDialogue ? 'dlg_' + Date.now() : dialogueID;\n\n// å…³é”®è¯æå–\nconst keywords = ['å¤–è§‚','å†…é¥°','æ€§èƒ½','ç»­èˆª','ç©ºé—´','é…ç½®','æ™ºèƒ½åŒ–','ä»·æ ¼','å®‰å…¨','èˆ’é€‚','å¤–é¥°','å†…è£…','åŠ¨åŠ›'];\nconst extractedTags = keywords.filter(k => content.includes(k));\n\n// ç”Ÿæˆæ ‡é¢˜\nlet title = '';\nif (extractedTags.length > 0) {\n  title = extractedTags.slice(0, 3).join('ã€') + 'åˆ†æ';\n} else {\n  title = content.slice(0, 20) + (content.length > 20 ? '...' : '');\n}\n\nconst timestamp = new Date().toISOString();\n\nreturn {\n  json: {\n    dialogueID: newDialogueID,\n    userID: userID,\n    title: title,\n    tags: extractedTags.join(','),\n    createTime: timestamp,\n    status: 'active',\n    isNewDialogue: isNewDialogue,\n    userContent: content\n  }\n};"
      },
      "id": "process-msg-004",
      "name": "ProcessMessage",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 200]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{$json.isNewDialogue}}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "true"
                    },
                    "id": "condition-new"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "æ–°å¯¹è¯"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "check-new-005",
      "name": "åˆ¤æ–­æ–°å¯¹è¯",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [1120, 200]
    },
    {
      "parameters": {
        "jsCode": "// ========== æ–°å¯¹è¯ï¼šåˆå§‹åŒ– ==========\nconst data = $input.item.json;\n\n// åˆå§‹åŒ–conversationHistory\nconst initialHistory = `userSpeak:${data.userContent}----`;\n\nreturn {\n  json: {\n    dialogueID: data.dialogueID,\n    userID: data.userID,\n    title: data.title,\n    tags: data.tags,\n    createTime: data.createTime,\n    conversationHistory: initialHistory,\n    status: data.status\n  }\n};"
      },
      "id": "init-dialogue-006",
      "name": "åˆå§‹åŒ–å¯¹è¯",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 100]
    },
    {
      "parameters": {
        "jsCode": "// ========== å·²æœ‰å¯¹è¯ï¼šè¯»å–å†å² ==========\nconst data = $input.item.json;\nconst sheetData = $('è¯»å–å¯¹è¯å†å²').first().json;\n\nconst conversationHistory = sheetData.conversationHistory || '';\n\n// åœ¨å†å²åè¿½åŠ æ–°çš„ç”¨æˆ·æ¶ˆæ¯\nconst updatedHistory = conversationHistory + `userSpeak:${data.userContent}----`;\n\nreturn {\n  json: {\n    dialogueID: data.dialogueID,\n    userID: data.userID,\n    title: data.title || sheetData.title,\n    tags: data.tags || sheetData.tags,\n    createTime: data.createTime,\n    conversationHistory: updatedHistory,\n    status: data.status,\n    existingHistory: conversationHistory\n  }\n};"
      },
      "id": "append-user-007",
      "name": "è¿½åŠ ç”¨æˆ·æ¶ˆæ¯",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1560, 300]
    },
    {
      "parameters": {
        "jsCode": "// ========== è°ƒç”¨ DeepSeek API (æ¨¡æ‹Ÿ) ==========\nconst data = $input.item.json;\nconst conversationHistory = data.conversationHistory;\n\n// è§£æå†å²å¯¹è¯\nconst pairs = conversationHistory.split('----').filter(s => s.trim());\nconst messages = [];\nfor (const pair of pairs) {\n  if (pair.startsWith('userSpeak:')) {\n    messages.push({\n      role: 'user',\n      content: pair.replace('userSpeak:', '')\n    });\n  } else if (pair.startsWith('AISpeak:')) {\n    messages.push({\n      role: 'assistant',\n      content: pair.replace('AISpeak:', '')\n    });\n  }\n}\n\n// TODO: è¿™é‡Œæ¥å…¥çœŸå®çš„ DeepSeek API\n// const response = await fetch('https://api.deepseek.com/v1/chat/completions', {\n//   method: 'POST',\n//   headers: {\n//     'Content-Type': 'application/json',\n//     'Authorization': 'Bearer YOUR_API_KEY'\n//   },\n//   body: JSON.stringify({\n//     model: 'deepseek-chat',\n//     messages: [\n//       { role: 'system', content: 'ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ±½è½¦åˆ†æå¸ˆï¼Œæ“…é•¿å¯¹æ¯”åˆ†æä¸åŒè½¦å‹çš„ç‰¹ç‚¹ã€‚' },\n//       ...messages\n//     ]\n//   })\n// });\n// const result = await response.json();\n// const aiReply = result.choices[0].message.content;\n\n// æ¨¡æ‹ŸAIå›å¤ï¼ˆMVPé˜¶æ®µï¼‰\nconst latestUserMessage = messages[messages.length - 1].content;\nlet aiReply = '';\n\nif (latestUserMessage.includes('å¤–è§‚') || latestUserMessage.includes('å¤–é¥°')) {\n  aiReply = 'æˆ‘ç†è§£æ‚¨å…³æ³¨è½¦è¾†çš„å¤–è§‚è®¾è®¡ã€‚å¤–è§‚æ˜¯ä¸€æ¬¾è½¦çš„ç¬¬ä¸€å°è±¡ï¼ŒåŒ…æ‹¬å‰è„¸è®¾è®¡ã€è½¦èº«çº¿æ¡ã€è½®æ¯‚é€ å‹ç­‰ã€‚æ‚¨æƒ³å¯¹æ¯”å“ªå‡ æ¬¾è½¦å‹çš„å¤–è§‚å‘¢ï¼Ÿ';\n} else if (latestUserMessage.includes('æ€§èƒ½') || latestUserMessage.includes('åŠ¨åŠ›')) {\n  aiReply = 'æ€§èƒ½åˆ†ææ˜¯å¾ˆé‡è¦çš„å¯¹æ¯”ç»´åº¦ã€‚æˆ‘ä¼šå…³æ³¨åŠ¨åŠ›å‚æ•°ã€åŠ é€Ÿæ€§èƒ½ã€æ“æ§è¡¨ç°ç­‰ã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³å¯¹æ¯”çš„è½¦å‹ï¼Œæˆ‘ä¼šä¸ºæ‚¨è¯¦ç»†åˆ†æã€‚';\n} else if (latestUserMessage.includes('ç”ŸæˆæŠ¥å‘Š') || latestUserMessage.includes('å¯¹æ¯”æŠ¥å‘Š')) {\n  aiReply = 'å¥½çš„ï¼Œæˆ‘å°†ä¸ºæ‚¨ç”Ÿæˆè¯¦ç»†çš„è½¦å‹å¯¹æ¯”æŠ¥å‘Šã€‚è¯·ç‚¹å‡»"ç”ŸæˆæŠ¥å‘Š"æŒ‰é’®ï¼Œæˆ‘ä¼šæ ¹æ®æˆ‘ä»¬çš„å¯¹è¯å†…å®¹åˆ¶ä½œä¸“ä¸šçš„å¯¹æ¯”åˆ†ææŠ¥å‘Šã€‚';\n} else {\n  aiReply = 'å¥½çš„ï¼Œæˆ‘ç†è§£äº†æ‚¨çš„éœ€æ±‚ã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨æƒ³å¯¹æ¯”çš„è½¦å‹å’Œå…³æ³¨çš„ç»´åº¦ï¼ˆå¦‚å¤–è§‚ã€å†…é¥°ã€æ€§èƒ½ã€é…ç½®ç­‰ï¼‰ï¼Œæˆ‘ä¼šä¸ºæ‚¨æä¾›è¯¦ç»†çš„åˆ†æã€‚';\n}\n\nconst messageID = 'msg_' + Date.now();\n\nreturn {\n  json: {\n    ...data,\n    aiReply: aiReply,\n    messageID: messageID\n  }\n};"
      },
      "id": "call-ai-008",
      "name": "è°ƒç”¨AI",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1780, 200]
    },
    {
      "parameters": {
        "jsCode": "// ========== æ›´æ–°conversationHistory ==========\nconst data = $input.item.json;\nconst aiReply = data.aiReply;\n\n// è¿½åŠ AIå›å¤\nconst finalHistory = data.conversationHistory + `AISpeak:${aiReply}----`;\n\nreturn {\n  json: {\n    dialogueID: data.dialogueID,\n    userID: data.userID,\n    title: data.title,\n    tags: data.tags,\n    conversationHistory: finalHistory,\n    status: data.status,\n    // è¿”å›ç»™å‰ç«¯çš„æ•°æ®\n    response: {\n      success: true,\n      dialogueID: data.dialogueID,\n      messageID: data.messageID,\n      aiReply: aiReply,\n      title: data.title,\n      extractedTags: data.tags ? data.tags.split(',') : []\n    }\n  }\n};"
      },
      "id": "update-history-009",
      "name": "æ›´æ–°å†å²",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2000, 200]
    },
    {
      "parameters": {
        "jsCode": "return {json: $input.item.json.response};"
      },
      "id": "format-response-010",
      "name": "æ ¼å¼åŒ–å“åº”",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2440, 200]
    },
    {
      "parameters": {
        "jsCode": "// ========== ç”ŸæˆæŠ¥å‘Š ==========\nconst data = $input.item.json.data;\nconst dialogueID = data.dialogueID;\nconst userID = data.userID || 'testCode';\nconst folderIDs = data.folderIDs || [];\n\nreturn {\n  json: {\n    dialogueID: dialogueID,\n    userID: userID,\n    folderIDs: folderIDs\n  }\n};"
      },
      "id": "prepare-report-011",
      "name": "å‡†å¤‡æŠ¥å‘Šæ•°æ®",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 400]
    },
    {
      "parameters": {
        "jsCode": "// ========== ç”ŸæˆHTMLæŠ¥å‘Š ==========\nconst data = $input.item.json;\nconst dialogueData = $('è¯»å–å¯¹è¯ä¿¡æ¯').first().json;\nconst favoritesData = $('è¯»å–æ”¶è—å›¾ç‰‡').all();\n\nconst tags = (dialogueData.tags || 'å¤–è§‚,å†…é¥°,æ€§èƒ½').split(',');\nconst conversationHistory = dialogueData.conversationHistory || '';\n\n// è§£æå¯¹è¯å†å²\nconst pairs = conversationHistory.split('----').filter(s => s.trim());\nlet userMessages = [];\nfor (const pair of pairs) {\n  if (pair.startsWith('userSpeak:')) {\n    userMessages.push(pair.replace('userSpeak:', ''));\n  }\n}\n\n// æå–è½¦å‹ï¼ˆç®€å•ç‰ˆï¼šä»å¯¹è¯ä¸­è¯†åˆ«ï¼‰\nconst carNames = ['ææ°ª009', 'å°é¹X9', 'è…¾åŠ¿D9', 'é—®ç•ŒM7', 'ç†æƒ³L9'];\nconst mentionedCars = [];\nfor (const car of carNames) {\n  if (conversationHistory.includes(car)) {\n    mentionedCars.push(car);\n  }\n}\n\nconst vehicles = mentionedCars.length > 0 ? mentionedCars : ['ææ°ª009', 'å°é¹X9', 'è…¾åŠ¿D9'];\n\n// è·å–å›¾ç‰‡\nconst images = {};\nif (favoritesData.length > 0) {\n  favoritesData.forEach(item => {\n    const carName = item.json.carName;\n    const imageURL = item.json.imageURL;\n    if (!images[carName]) {\n      images[carName] = imageURL;\n    }\n  });\n}\n\n// TODO: è¿™é‡Œå¯ä»¥è°ƒç”¨DeepSeekç”Ÿæˆè¯¦ç»†çš„å¯¹æ¯”å†…å®¹\n// ç›®å‰ä½¿ç”¨æ¨¡æ¿ç”Ÿæˆ\n\nconst reportID = 'report_' + Date.now();\nconst createTime = new Date().toISOString();\n\n// ç”ŸæˆHTML\nconst html = `<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>è½¦å‹å¯¹æ¯”æŠ¥å‘Š - ${reportID}</title>\n    <style>\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n        body {\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n            padding: 40px 20px;\n            min-height: 100vh;\n        }\n        .container {\n            max-width: 1200px;\n            margin: 0 auto;\n            background: white;\n            border-radius: 20px;\n            box-shadow: 0 20px 60px rgba(0,0,0,0.3);\n            overflow: hidden;\n        }\n        .header {\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n            color: white;\n            padding: 40px;\n            text-align: center;\n        }\n        .header h1 {\n            font-size: 32px;\n            margin-bottom: 10px;\n        }\n        .header p {\n            opacity: 0.9;\n            font-size: 14px;\n        }\n        .print-btn {\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            padding: 12px 24px;\n            background: white;\n            color: #667eea;\n            border: none;\n            border-radius: 50px;\n            font-size: 16px;\n            font-weight: 600;\n            cursor: pointer;\n            box-shadow: 0 4px 15px rgba(0,0,0,0.2);\n            transition: all 0.3s;\n            z-index: 1000;\n        }\n        .print-btn:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 6px 20px rgba(0,0,0,0.3);\n        }\n        .content {\n            padding: 40px;\n        }\n        .tags {\n            display: flex;\n            flex-wrap: wrap;\n            gap: 10px;\n            margin-bottom: 30px;\n        }\n        .tag {\n            padding: 8px 16px;\n            background: #f0f0f0;\n            border-radius: 20px;\n            font-size: 14px;\n            color: #666;\n        }\n        table {\n            width: 100%;\n            border-collapse: collapse;\n            margin-top: 20px;\n        }\n        thead {\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n            color: white;\n        }\n        th, td {\n            padding: 20px;\n            text-align: left;\n            border-bottom: 1px solid #e0e0e0;\n        }\n        th {\n            font-weight: 600;\n            font-size: 16px;\n        }\n        td {\n            font-size: 14px;\n            color: #333;\n        }\n        tbody tr:hover {\n            background: #f8f9ff;\n        }\n        .car-image {\n            width: 100px;\n            height: 60px;\n            object-fit: cover;\n            border-radius: 8px;\n        }\n        .dimension-name {\n            font-weight: 600;\n            color: #667eea;\n        }\n        .footer {\n            text-align: center;\n            padding: 30px;\n            color: #999;\n            font-size: 14px;\n            border-top: 1px solid #e0e0e0;\n        }\n        @media print {\n            body {\n                background: white;\n                padding: 0;\n            }\n            .print-btn {\n                display: none;\n            }\n            .container {\n                box-shadow: none;\n            }\n        }\n    </style>\n</head>\n<body>\n    <button class=\"print-btn\" onclick=\"window.print()\">ğŸ–¨ï¸ æ‰“å°/ä¿å­˜PDF</button>\n    \n    <div class=\"container\">\n        <div class=\"header\">\n            <h1>ğŸš— è½¦å‹å¯¹æ¯”åˆ†ææŠ¥å‘Š</h1>\n            <p>ç”Ÿæˆæ—¶é—´ï¼š${new Date(createTime).toLocaleString('zh-CN')}</p>\n        </div>\n        \n        <div class=\"content\">\n            <div class=\"tags\">\n                ${tags.map(tag => `<span class=\"tag\">#${tag}</span>`).join('')}\n            </div>\n            \n            <table>\n                <thead>\n                    <tr>\n                        <th>å¯¹æ¯”ç»´åº¦</th>\n                        ${vehicles.map(car => `<th>${car}</th>`).join('')}\n                    </tr>\n                </thead>\n                <tbody>\n                    ${tags.map(tag => `\n                    <tr>\n                        <td class=\"dimension-name\">${tag}</td>\n                        ${vehicles.map(car => `\n                        <td>\n                            ${images[car] ? `<img src=\"${images[car]}\" class=\"car-image\" alt=\"${car}\"><br>` : ''}\n                            <strong>ä¼˜ç§€</strong> - è¯¥è½¦å‹åœ¨${tag}æ–¹é¢è¡¨ç°å‡ºè‰²ï¼Œç¬¦åˆä¸»æµéœ€æ±‚ã€‚\n                        </td>\n                        `).join('')}\n                    </tr>\n                    `).join('')}\n                </tbody>\n            </table>\n        </div>\n        \n        <div class=\"footer\">\n            <p>æŠ¥å‘ŠID: ${reportID}</p>\n            <p>æœ¬æŠ¥å‘Šç”±AIæ™ºèƒ½åˆ†æç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒ</p>\n        </div>\n    </div>\n</body>\n</html>`;\n\nreturn {\n  json: {\n    reportID: reportID,\n    dialogueID: data.dialogueID,\n    userID: data.userID,\n    htmlContent: html,\n    createTime: createTime\n  }\n};"
      },
      "id": "generate-html-012",
      "name": "ç”ŸæˆHTML",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1560, 400]
    },
    {
      "parameters": {
        "jsCode": "return {\n  json: {\n    success: true,\n    reportID: $input.item.json.reportID,\n    htmlContent: $input.item.json.htmlContent,\n    createTime: $input.item.json.createTime\n  }\n};"
      },
      "id": "format-report-013",
      "name": "æ ¼å¼åŒ–æŠ¥å‘Š",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2000, 400]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.item.json.data;\nconst userID = data.userID || 'testCode';\n\nreturn {\n  json: {\n    userID: userID\n  }\n};"
      },
      "id": "prepare-list-014",
      "name": "å‡†å¤‡æŸ¥è¯¢",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 600]
    },
    {
      "parameters": {
        "jsCode": "// è§£æå¯¹è¯åˆ—è¡¨\nconst items = $input.all();\n\nif (!items || items.length === 0 || !items[0].json || !items[0].json.dialogueID) {\n  return {\n    json: {\n      success: true,\n      dialogues: [],\n      total: 0\n    }\n  };\n}\n\nconst dialogues = items.map(item => {\n  const conversationHistory = item.json.conversationHistory || '';\n  const pairs = conversationHistory.split('----').filter(s => s.trim());\n  let preview = '';\n  for (const pair of pairs) {\n    if (pair.startsWith('userSpeak:')) {\n      preview = pair.replace('userSpeak:', '').slice(0, 50);\n      break;\n    }\n  }\n  \n  return {\n    dialogueID: item.json.dialogueID,\n    title: item.json.title,\n    tags: item.json.tags ? item.json.tags.split(',') : [],\n    createTime: item.json.createTime,\n    preview: preview + (preview.length >= 50 ? '...' : '')\n  };\n});\n\nreturn {\n  json: {\n    success: true,\n    dialogues: dialogues,\n    total: dialogues.length\n  }\n};"
      },
      "id": "format-list-015",
      "name": "æ ¼å¼åŒ–åˆ—è¡¨",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 600]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.item.json.data;\nconst dialogueID = data.dialogueID;\n\nreturn {\n  json: {\n    dialogueID: dialogueID\n  }\n};"
      },
      "id": "prepare-detail-016",
      "name": "å‡†å¤‡è¯¦æƒ…æŸ¥è¯¢",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [900, 800]
    },
    {
      "parameters": {
        "jsCode": "// è§£æå¯¹è¯è¯¦æƒ…\nconst item = $input.item.json;\nconst conversationHistory = item.conversationHistory || '';\n\nconst pairs = conversationHistory.split('----').filter(s => s.trim());\nconst messages = [];\n\nfor (const pair of pairs) {\n  if (pair.startsWith('userSpeak:')) {\n    messages.push({\n      role: 'user',\n      content: pair.replace('userSpeak:', ''),\n      timestamp: item.createTime\n    });\n  } else if (pair.startsWith('AISpeak:')) {\n    messages.push({\n      role: 'assistant',\n      content: pair.replace('AISpeak:', ''),\n      timestamp: item.createTime\n    });\n  }\n}\n\nreturn {\n  json: {\n    success: true,\n    dialogueID: item.dialogueID,\n    title: item.title,\n    messages: messages\n  }\n};"
      },
      "id": "format-detail-017",
      "name": "æ ¼å¼åŒ–è¯¦æƒ…",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1340, 800]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{$json}}",
        "options": {}
      },
      "id": "respond-018",
      "name": "ç»Ÿä¸€å“åº”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [2440, 500]
    }
  ],
  "connections": {
    "Webhookå…¥å£": {
      "main": [[{"node": "Router", "type": "main", "index": 0}]]
    },
    "Router": {
      "main": [[{"node": "Switch", "type": "main", "index": 0}]]
    },
    "Switch": {
      "main": [
        [{"node": "ProcessMessage", "type": "main", "index": 0}],
        [{"node": "å‡†å¤‡æŠ¥å‘Šæ•°æ®", "type": "main", "index": 0}],
        [{"node": "å‡†å¤‡æŸ¥è¯¢", "type": "main", "index": 0}],
        [{"node": "å‡†å¤‡è¯¦æƒ…æŸ¥è¯¢", "type": "main", "index": 0}]
      ]
    },
    "ProcessMessage": {
      "main": [[{"node": "åˆ¤æ–­æ–°å¯¹è¯", "type": "main", "index": 0}]]
    },
    "åˆ¤æ–­æ–°å¯¹è¯": {
      "main": [
        [{"node": "åˆå§‹åŒ–å¯¹è¯", "type": "main", "index": 0}],
        [{"node": "è¿½åŠ ç”¨æˆ·æ¶ˆæ¯", "type": "main", "index": 0}]
      ]
    },
    "åˆå§‹åŒ–å¯¹è¯": {
      "main": [[{"node": "è°ƒç”¨AI", "type": "main", "index": 0}]]
    },
    "è¿½åŠ ç”¨æˆ·æ¶ˆæ¯": {
      "main": [[{"node": "è°ƒç”¨AI", "type": "main", "index": 0}]]
    },
    "è°ƒç”¨AI": {
      "main": [[{"node": "æ›´æ–°å†å²", "type": "main", "index": 0}]]
    },
    "æ›´æ–°å†å²": {
      "main": [[{"node": "æ ¼å¼åŒ–å“åº”", "type": "main", "index": 0}]]
    },
    "æ ¼å¼åŒ–å“åº”": {
      "main": [[{"node": "ç»Ÿä¸€å“åº”", "type": "main", "index": 0}]]
    },
    "å‡†å¤‡æŠ¥å‘Šæ•°æ®": {
      "main": [[{"node": "ç”ŸæˆHTML", "type": "main", "index": 0}]]
    },
    "ç”ŸæˆHTML": {
      "main": [[{"node": "æ ¼å¼åŒ–æŠ¥å‘Š", "type": "main", "index": 0}]]
    },
    "æ ¼å¼åŒ–æŠ¥å‘Š": {
      "main": [[{"node": "ç»Ÿä¸€å“åº”", "type": "main", "index": 0}]]
    },
    "å‡†å¤‡æŸ¥è¯¢": {
      "main": [[{"node": "æ ¼å¼åŒ–åˆ—è¡¨", "type": "main", "index": 0}]]
    },
    "æ ¼å¼åŒ–åˆ—è¡¨": {
      "main": [[{"node": "ç»Ÿä¸€å“åº”", "type": "main", "index": 0}]]
    },
    "å‡†å¤‡è¯¦æƒ…æŸ¥è¯¢": {
      "main": [[{"node": "æ ¼å¼åŒ–è¯¦æƒ…", "type": "main", "index": 0}]]
    },
    "æ ¼å¼åŒ–è¯¦æƒ…": {
      "main": [[{"node": "ç»Ÿä¸€å“åº”", "type": "main", "index": 0}]]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "placeholder-instance-id"
  },
  "tags": [],
  "settings": {
    "executionOrder": "v1"
  }
}

