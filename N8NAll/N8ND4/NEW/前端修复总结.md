# å‰ç«¯ä¿®å¤æ€»ç»“ âœ…

## ğŸ“ å·²å®Œæˆçš„ä¿®å¤

### 1ï¸âƒ£ **sendMessageå‡½æ•° - UIæ›´æ–°é€»è¾‘ä¼˜åŒ–**
**ä½ç½®**ï¼š`NEW/ai-chat-demo.html` ç¬¬638-660è¡Œ

**ä¿®å¤å†…å®¹**ï¼š
- âœ… æ— è®ºæ˜¯æ–°å¯¹è¯è¿˜æ˜¯æ—§å¯¹è¯ï¼Œéƒ½æ›´æ–°titleå’Œtags
- âœ… æ”¯æŒåŠ¨æ€æ ‡ç­¾æ›´æ–°ï¼ˆç”¨æˆ·åœ¨å¯¹è¯ä¸­æåˆ°æ–°å…³é”®è¯æ—¶ï¼ŒUIå®æ—¶æ›´æ–°ï¼‰

**ä¿®å¤å‰**ï¼š
```javascript
// åªæœ‰æ–°å¯¹è¯æ‰æ›´æ–°UI
if (!currentDialogueID) {
    document.getElementById('currentTitle').textContent = result.title;
    document.getElementById('currentTags').textContent = result.extractedTags.join(', ');
}
```

**ä¿®å¤å**ï¼š
```javascript
// â­ æ— è®ºæ–°æ—§å¯¹è¯ï¼Œéƒ½æ›´æ–°UI
if (result.title) {
    document.getElementById('currentTitle').textContent = result.title;
}
if (result.extractedTags && result.extractedTags.length > 0) {
    document.getElementById('currentTags').textContent = result.extractedTags.join(', ');
}

// å¦‚æœæ˜¯æ–°å¯¹è¯ï¼Œæ›´æ–°å¯¹è¯åˆ—è¡¨
if (!currentDialogueID) {
    currentDialogueID = result.dialogueID;
    // ...æ›´æ–°dialoguesæ•°ç»„
}
```

---

### 2ï¸âƒ£ **updateDialogueListå‡½æ•° - tagsæ ¼å¼å…¼å®¹æ€§**
**ä½ç½®**ï¼š`NEW/ai-chat-demo.html` ç¬¬486-514è¡Œ

**ä¿®å¤å†…å®¹**ï¼š
- âœ… å…¼å®¹tagsçš„å¤šç§æ ¼å¼ï¼šæ•°ç»„ã€é€—å·åˆ†éš”å­—ç¬¦ä¸²ã€ç©ºå€¼
- âœ… é˜²æ­¢åç«¯è¿”å›å­—ç¬¦ä¸²æ—¶å‰ç«¯æŠ¥é”™

**ä¿®å¤å‰**ï¼š
```javascript
${dlg.tags.map(tag => `<span class="dialogue-tag">${tag}</span>`).join('')}
// âŒ å¦‚æœtagsæ˜¯å­—ç¬¦ä¸²ï¼Œè¿™é‡Œä¼šæŠ¥é”™ï¼
```

**ä¿®å¤å**ï¼š
```javascript
// â­ å…¼å®¹tagsçš„å¤šç§æ ¼å¼
let tagsArray = [];
if (Array.isArray(dlg.tags)) {
    tagsArray = dlg.tags;
} else if (typeof dlg.tags === 'string' && dlg.tags) {
    tagsArray = dlg.tags.split(',').map(t => t.trim()).filter(t => t);
}

${tagsArray.map(tag => `<span class="dialogue-tag">${tag}</span>`).join('')}
```

---

### 3ï¸âƒ£ **selectDialogueå‡½æ•° - tagsæ ¼å¼å…¼å®¹æ€§**
**ä½ç½®**ï¼š`NEW/ai-chat-demo.html` ç¬¬560-605è¡Œ

**ä¿®å¤å†…å®¹**ï¼š
- âœ… å…¼å®¹tagsçš„å¤šç§æ ¼å¼
- âœ… å¦‚æœæ²¡æœ‰æ ‡ç­¾æ˜¾ç¤º"æš‚æ— æ ‡ç­¾"

**ä¿®å¤å‰**ï¼š
```javascript
document.getElementById('currentTags').textContent = dialogue.tags.join(', ');
// âŒ å¦‚æœtagsæ˜¯å­—ç¬¦ä¸²ï¼Œè¿™é‡Œä¼šæŠ¥é”™ï¼
```

**ä¿®å¤å**ï¼š
```javascript
// â­ å…¼å®¹tagsçš„å¤šç§æ ¼å¼
let tagsArray = [];
if (Array.isArray(dialogue.tags)) {
    tagsArray = dialogue.tags;
} else if (typeof dialogue.tags === 'string' && dialogue.tags) {
    tagsArray = dialogue.tags.split(',').map(t => t.trim()).filter(t => t);
}
document.getElementById('currentTags').textContent = tagsArray.length > 0 ? tagsArray.join(', ') : 'æš‚æ— æ ‡ç­¾';
```

---

## ğŸ” è‡ªæŸ¥ç»“æœ

### âœ… **sendMessageæµç¨‹å®Œæ•´æ€§**
```
å‰ç«¯å‘é€ï¼š
{
  action: "sendMessage",
  userID: "testCode",
  dialogueID: "dlg_xxx" (æˆ–null),
  conversationHistory: "userSpeak:xxx----AISpeak:xxx----",
  content: "ç”¨æˆ·è¾“å…¥çš„å†…å®¹"
}

åç«¯è¿”å›ï¼š
{
  success: true,
  dialogueID: "dlg_xxx",
  messageID: "msg_xxx",
  aiReply: "AIçš„å›å¤",
  title: "å¯¹æ¯”åˆ†æ",
  extractedTags: ["å¤–è§‚", "å†…é¥°"],  // â­ æ•°ç»„æ ¼å¼
  conversationHistory: "userSpeak:xxx----AISpeak:xxx----AISpeak:xxx----"  // â­ æ›´æ–°åçš„å†å²
}

å‰ç«¯å¤„ç†ï¼š
âœ… æ˜¾ç¤ºAIå›å¤
âœ… æ›´æ–°conversationHistory
âœ… æ›´æ–°UIï¼ˆtitleå’Œtagsï¼‰
âœ… å¦‚æœæ˜¯æ–°å¯¹è¯ï¼Œæ›´æ–°å¯¹è¯åˆ—è¡¨
```

---

### âœ… **getDialogueDetailæµç¨‹å®Œæ•´æ€§**
```
å‰ç«¯å‘é€ï¼š
{
  action: "getDialogueDetail",
  userID: "testCode",
  dialogueID: "dlg_xxx"
}

åç«¯è¿”å›ï¼š
{
  success: true,
  dialogueID: "dlg_xxx",
  title: "å¯¹æ¯”åˆ†æ",
  conversationHistory: "userSpeak:xxx----AISpeak:xxx----",  // â­ å®Œæ•´å†å²
  messages: [  // â­ å·²è§£æçš„æ¶ˆæ¯æ•°ç»„
    { role: "user", content: "...", timestamp: "..." },
    { role: "assistant", content: "...", timestamp: "..." }
  ],
  totalMessages: 2
}

å‰ç«¯å¤„ç†ï¼š
âœ… ç¼“å­˜conversationHistory
âœ… æ˜¾ç¤ºmessagesæ•°ç»„
âœ… æ›´æ–°UIæ ‡é¢˜
```

---

### âœ… **tagsæ ¼å¼å…¼å®¹æ€§**
æ‰€æœ‰æ¶‰åŠtagsçš„åœ°æ–¹éƒ½å·²å¢åŠ å…¼å®¹æ€§å¤„ç†ï¼š
- âœ… `updateDialogueList` - å¯¹è¯åˆ—è¡¨æ¸²æŸ“
- âœ… `selectDialogue` - é€‰æ‹©å¯¹è¯æ—¶æ›´æ–°UI
- âœ… `sendMessage` - å‘é€æ¶ˆæ¯åæ›´æ–°UI

æ”¯æŒçš„æ ¼å¼ï¼š
- `["å¤–è§‚", "å†…é¥°"]` - æ•°ç»„ï¼ˆæ¨èï¼‰
- `"å¤–è§‚,å†…é¥°"` - é€—å·åˆ†éš”å­—ç¬¦ä¸²
- `""` - ç©ºå­—ç¬¦ä¸²
- `null` / `undefined` - ç©ºå€¼

---

## â³ å¾…å®ç°åŠŸèƒ½

### 1ï¸âƒ£ **getDialogueList**
**N8NèŠ‚ç‚¹éœ€è¦å®ç°**ï¼š
- è¯»å–Google Sheetsçš„AIDialoguesè¡¨
- ç­›é€‰å‡ºè¯¥userIDçš„æ‰€æœ‰å¯¹è¯
- æŒ‰createTimeå€’åºæ’åˆ—
- è¿”å›æ ¼å¼ï¼š
```json
{
  "success": true,
  "dialogues": [
    {
      "dialogueID": "dlg_xxx",
      "title": "å¤–è§‚å¯¹æ¯”åˆ†æ",
      "tags": ["å¤–è§‚", "è®¾è®¡"],  // â­ å¿…é¡»æ˜¯æ•°ç»„
      "createTime": "2024-11-01T10:00:00Z",
      "preview": "è¯·å¸®æˆ‘åˆ†æ..."
    }
  ],
  "total": 1
}
```

**å‰ç«¯å·²å‡†å¤‡å¥½**ï¼š
- âœ… `loadDialogueList()` å‡½æ•°ä¼šåœ¨é¡µé¢åŠ è½½æ—¶è°ƒç”¨
- âœ… `updateDialogueList()` å‡½æ•°æ”¯æŒtagså¤šç§æ ¼å¼

---

### 2ï¸âƒ£ **generateReport**
**N8NèŠ‚ç‚¹éœ€è¦å®ç°**ï¼š
- è¯»å–å¯¹è¯çš„conversationHistoryå’Œtags
- ä½¿ç”¨AIåˆ†æå†…å®¹
- ç”Ÿæˆå¯¹æ¯”çŸ©é˜µHTML
- è¿”å›æ ¼å¼ï¼š
```json
{
  "success": true,
  "reportID": "report_xxx",
  "htmlContent": "<!DOCTYPE html>...",
  "createTime": "2024-11-01T10:00:00Z"
}
```

**å‰ç«¯å·²å‡†å¤‡å¥½**ï¼š
- âœ… `generateReport()` å‡½æ•°å·²å®ç°
- âœ… ä¼šåœ¨æ–°çª—å£æ‰“å¼€HTMLæŠ¥å‘Š
- âœ… ç”¨æˆ·å¯ä»¥ä½¿ç”¨æµè§ˆå™¨æ‰“å°åŠŸèƒ½ä¿å­˜ä¸ºPDF

---

## ğŸ“Š å½“å‰è¿›åº¦

| åŠŸèƒ½ | N8Nåç«¯ | å‰ç«¯ | çŠ¶æ€ |
|------|---------|------|------|
| sendMessage | âœ… | âœ… | å®Œæˆ |
| getDialogueDetail | âœ… | âœ… | å®Œæˆ |
| getDialogueList | â³ | âœ… | å¾…N8Nå®ç° |
| generateReport | â³ | âœ… | å¾…N8Nå®ç° |

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

**ä½ ï¼ˆç”¨æˆ·ï¼‰éœ€è¦åšçš„**ï¼š
1. âœ… å·²å®Œæˆï¼šè°ƒæ•´N8Nçš„ProcessMessageã€å¤„ç†AIå“åº”ã€æ ¼å¼åŒ–å“åº”1èŠ‚ç‚¹
2. â³ å¾…å®ç°ï¼šGetDialogueListèŠ‚ç‚¹ï¼ˆè¯»å–Google Sheetsï¼‰
3. â³ å¾…å®ç°ï¼šGenerateReportèŠ‚ç‚¹ï¼ˆç”ŸæˆæŠ¥å‘Šï¼‰

**å‰ç«¯éƒ¨åˆ†**ï¼š
- âœ… å…¨éƒ¨å°±ç»ªï¼æ— éœ€é¢å¤–ä¿®æ”¹
- âœ… å·²æ”¯æŒæ‰€æœ‰APIçš„è°ƒç”¨å’Œå“åº”å¤„ç†
- âœ… å·²å¢åŠ å®Œå–„çš„å®¹é”™å’Œå…¼å®¹æ€§å¤„ç†

---

## ğŸš€ å‡†å¤‡æµ‹è¯•

ä¸€æ—¦ä½ å®ŒæˆN8Nçš„è°ƒæ•´ï¼Œå¯ä»¥æŒ‰ä»¥ä¸‹é¡ºåºæµ‹è¯•ï¼š

1. **æµ‹è¯•sendMessageï¼ˆæ–°å¯¹è¯ï¼‰**
   - å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯
   - æ£€æŸ¥æ˜¯å¦åˆ›å»ºæ–°å¯¹è¯
   - æ£€æŸ¥conversationHistoryæ˜¯å¦ä¿å­˜

2. **æµ‹è¯•sendMessageï¼ˆç»§ç»­å¯¹è¯ï¼‰**
   - åœ¨å·²æœ‰å¯¹è¯ä¸­ç»§ç»­å‘é€æ¶ˆæ¯
   - æ£€æŸ¥conversationHistoryæ˜¯å¦ç´¯ç§¯
   - æ£€æŸ¥AIæ˜¯å¦èƒ½çœ‹åˆ°å†å²

3. **æµ‹è¯•getDialogueDetail**
   - åˆ·æ–°é¡µé¢
   - ç‚¹å‡»å†å²å¯¹è¯
   - æ£€æŸ¥æ˜¯å¦åŠ è½½å®Œæ•´æ¶ˆæ¯

4. **æµ‹è¯•getDialogueListï¼ˆå¾…å®ç°ï¼‰**
   - é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è°ƒç”¨
   - æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºå†å²åˆ—è¡¨

5. **æµ‹è¯•generateReportï¼ˆå¾…å®ç°ï¼‰**
   - åœ¨å¯¹è¯ä¸­ç‚¹å‡»"ç”ŸæˆæŠ¥å‘Š"
   - æ£€æŸ¥æ˜¯å¦ç”ŸæˆHTML

---

**å‰ç«¯ä¿®å¤å…¨éƒ¨å®Œæˆï¼âœ…**

