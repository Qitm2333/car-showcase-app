# 📘 N8N 工作流配置详细指南

由于 N8N 工作流 JSON 的 Google Sheets 节点需要特定的凭证和文档ID，无法直接导出/导入，本文档提供**手动配置指南**。

---

## 🎯 工作流架构图

```
Webhook入口
    ↓
  Router (提取action)
    ↓
  Switch (路由到4个分支)
    ├─ sendMessage 分支
    │   ↓
    │  ProcessMessage (处理消息)
    │   ↓
    │  判断新对话
    │   ├─ 新对话 → 初始化对话 → 调用AI
    │   └─ 已有对话 → 读取对话历史(Google Sheets) → 追加用户消息 → 调用AI
    │   ↓
    │  调用AI (DeepSeek)
    │   ↓
    │  更新历史
    │   ↓
    │  保存到Google Sheets ⭐ (需要手动添加)
    │   ↓
    │  格式化响应 → 统一响应
    │
    ├─ generateReport 分支
    │   ↓
    │  准备报告数据
    │   ↓
    │  读取对话信息(Google Sheets) ⭐
    │   ↓
    │  读取收藏图片(Google Sheets) ⭐
    │   ↓
    │  生成HTML
    │   ↓
    │  保存报告(Google Sheets) ⭐
    │   ↓
    │  格式化报告 → 统一响应
    │
    ├─ getDialogueList 分支
    │   ↓
    │  准备查询
    │   ↓
    │  读取对话列表(Google Sheets) ⭐
    │   ↓
    │  格式化列表 → 统一响应
    │
    └─ getDialogueDetail 分支
        ↓
       准备详情查询
        ↓
       读取对话详情(Google Sheets) ⭐
        ↓
       格式化详情 → 统一响应
```

**⭐ 标记的节点需要手动添加**

---

## 📝 需要添加的 Google Sheets 节点（共7个）

---

### 节点1：读取对话历史（sendMessage分支）

**位置**: 连接到"追加用户消息"节点之前

**节点名称**: `读取对话历史`

**配置**:
```yaml
节点类型: Google Sheets
操作: Lookup (查找)
Document: [选择你的 Google Sheets 文档]
Sheet: AIDialogues
Lookup Column: dialogueID
Lookup Value: ={{$json.dialogueID}}
选项:
  ✅ Continue on Fail (查询不到时继续)
  ✅ Always Output Data
```

**连接关系**:
- 输入: `判断新对话` 节点的"已有对话"输出
- 输出: `追加用户消息` 节点

---

### 节点2：保存/更新对话（sendMessage分支）

**位置**: 连接到"更新历史"节点之后

**节点名称**: `保存对话到表格`

**配置**:
```yaml
节点类型: Google Sheets
操作: Update or Append (更新或追加)
Document: [选择你的 Google Sheets 文档]
Sheet: AIDialogues
匹配列: dialogueID

字段映射:
  dialogueID: ={{$json.dialogueID}}
  userID: ={{$json.userID}}
  title: ={{$json.title}}
  tags: ={{$json.tags}}
  createTime: ={{$json.createTime}}
  conversationHistory: ={{$json.conversationHistory}}
  status: ={{$json.status}}
```

**连接关系**:
- 输入: `更新历史` 节点
- 输出: `格式化响应` 节点

---

### 节点3：读取对话信息（generateReport分支）

**位置**: 连接到"生成HTML"节点之前

**节点名称**: `读取对话信息`

**配置**:
```yaml
节点类型: Google Sheets
操作: Lookup
Document: [选择你的 Google Sheets 文档]
Sheet: AIDialogues
Lookup Column: dialogueID
Lookup Value: ={{$json.dialogueID}}
```

**连接关系**:
- 输入: `准备报告数据` 节点
- 输出: `生成HTML` 节点

---

### 节点4：读取收藏图片（generateReport分支）

**位置**: 连接到"生成HTML"节点之前（与节点3并行）

**节点名称**: `读取收藏图片`

**配置**:
```yaml
节点类型: Google Sheets
操作: Read (读取)
Document: [选择你的 Google Sheets 文档]
Sheet: Favorites
Filters:
  - userID = ={{$json.userID}}
  - status = active
选项:
  ✅ Always Output Data
```

**连接关系**:
- 输入: `准备报告数据` 节点
- 输出: `生成HTML` 节点

**注意**: 这个节点和"读取对话信息"节点需要同时连接到"生成HTML"，形成两个输入。

---

### 节点5：保存报告（generateReport分支）

**位置**: 连接到"格式化报告"节点之后

**节点名称**: `保存报告到表格`

**配置**:
```yaml
节点类型: Google Sheets
操作: Append (追加)
Document: [选择你的 Google Sheets 文档]
Sheet: AIReports

字段映射:
  reportID: ={{$json.reportID}}
  dialogueID: ={{$json.dialogueID}}
  userID: ={{$json.userID}}
  htmlContent: ={{$json.htmlContent}}
  createTime: ={{$json.createTime}}
```

**连接关系**:
- 输入: `格式化报告` 节点
- 输出: `统一响应` 节点

---

### 节点6：读取对话列表（getDialogueList分支）

**位置**: 连接到"准备查询"节点之后

**节点名称**: `读取对话列表`

**配置**:
```yaml
节点类型: Google Sheets
操作: Read (读取)
Document: [选择你的 Google Sheets 文档]
Sheet: AIDialogues
Filters:
  - userID = ={{$json.userID}}
  - status = active
Sort:
  - Column: createTime
  - Direction: DESC (降序)
选项:
  ✅ Always Output Data
```

**连接关系**:
- 输入: `准备查询` 节点
- 输出: `格式化列表` 节点

---

### 节点7：读取对话详情（getDialogueDetail分支）

**位置**: 连接到"准备详情查询"节点之后

**节点名称**: `读取对话详情`

**配置**:
```yaml
节点类型: Google Sheets
操作: Lookup
Document: [选择你的 Google Sheets 文档]
Sheet: AIDialogues
Lookup Column: dialogueID
Lookup Value: ={{$json.dialogueID}}
```

**连接关系**:
- 输入: `准备详情查询` 节点
- 输出: `格式化详情` 节点

---

## 🔧 手动配置步骤（以节点1为例）

### 步骤1: 添加节点

1. 在 N8N 画布上点击 "+" 按钮
2. 搜索 "Google Sheets"
3. 选择 "Google Sheets" 节点

### 步骤2: 配置凭证

1. 点击 "Credentials" 下拉框
2. 如果没有凭证，点击 "Create New"
3. 选择 "Google Sheets OAuth2 API"
4. 按照提示完成 OAuth2 认证

### 步骤3: 选择操作

1. Resource: "Sheet"
2. Operation: "Lookup" (根据具体节点选择)

### 步骤4: 选择文档和工作表

1. Document: 点击下拉框，选择你的 Google Sheets 文档
2. Sheet: 选择对应的工作表（如 AIDialogues）

### 步骤5: 配置查询条件

1. Lookup Column: 选择 "dialogueID"
2. Lookup Value: 输入 `={{$json.dialogueID}}`

### 步骤6: 配置选项

1. 展开 "Options"
2. 勾选需要的选项（如 Continue on Fail）

### 步骤7: 连接节点

1. 从前一个节点拖动连接线到当前节点
2. 从当前节点拖动连接线到后一个节点

### 步骤8: 测试节点

1. 点击节点左上角的 "Test step"
2. 查看输出是否正确

---

## 🎨 节点位置建议（坐标）

为了保持工作流美观，建议使用以下坐标：

```yaml
读取对话历史: [1340, 300]
保存对话到表格: [2220, 200]
读取对话信息: [1120, 400]
读取收藏图片: [1120, 500]
保存报告到表格: [2220, 400]
读取对话列表: [1120, 600]
读取对话详情: [1120, 800]
```

---

## ✅ 配置完成检查清单

- [ ] 所有 Google Sheets 节点已添加
- [ ] OAuth2 凭证已配置
- [ ] 所有节点连接正确
- [ ] 测试 sendMessage 功能
- [ ] 测试 generateReport 功能
- [ ] 测试 getDialogueList 功能
- [ ] 测试 getDialogueDetail 功能
- [ ] Webhook URL 已复制到前端

---

## 🐛 常见问题

### Q: OAuth2 认证失败？
**A**: 
1. 确保 Google Cloud Console 中启用了 Google Sheets API
2. 检查 OAuth2 客户端ID和密钥是否正确
3. 确认回调URL是否匹配

### Q: 节点报错 "Document not found"？
**A**: 
1. 确认 Google Sheets 文档已共享给 N8N 的 OAuth2 账号
2. 检查文档 ID 是否正确

### Q: Lookup 操作返回空？
**A**: 
1. 检查查询条件是否正确
2. 确认 Google Sheets 中有对应的数据
3. 查看节点的原始输出（Raw Output）

### Q: 字段映射不生效？
**A**: 
1. 确保使用 `={{$json.fieldName}}` 格式
2. 检查前一个节点的输出是否包含该字段
3. 使用 Expression Editor 验证表达式

---

## 💡 小技巧

1. **复制粘贴节点**: 配置好一个 Google Sheets 节点后，可以复制粘贴，只需修改查询条件
2. **使用注释**: 在节点上添加注释（右键 → Add Note），说明节点用途
3. **颜色标记**: 给不同功能的节点设置不同颜色（右键 → Node Color）
4. **批量测试**: 配置完所有节点后，使用 "Execute Workflow" 进行完整测试

---

## 🔄 下一步

配置完成后，继续阅读 `README.md` 进行前端配置和功能测试！

---

**祝配置顺利！** 🎉

