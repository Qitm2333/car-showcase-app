# 📂 项目结构说明

## 文件树

```
NEW/
├── 📄 n8n-workflow.json                 # N8N 工作流配置（核心）
├── 📄 AIDialogues.csv                    # Google Sheets 对话表结构示例
├── 📄 AIReports.csv                      # Google Sheets 报告表结构示例
├── 🌐 ai-chat-demo.html                  # 前端演示界面（含调试工具）
├── 📘 README.md                          # 快速开始指南
├── 📘 工作流配置详细指南.md              # N8N 节点配置手册
├── 📘 DeepSeek-API接入指南.md            # AI API 接入教程
└── 📘 项目结构说明.md                    # 本文档
```

---

## 📄 核心文件说明

### 1. `n8n-workflow.json`

**用途**: N8N 工作流配置文件

**内容**:
- 18 个预配置节点（不含 Google Sheets 节点）
- 4 个主要分支：sendMessage / generateReport / getDialogueList / getDialogueDetail
- 完整的 conversationHistory 逻辑
- AI 调用接口（待接入 DeepSeek）

**使用**:
1. 在 N8N 中导入此文件
2. 按照《工作流配置详细指南.md》添加 Google Sheets 节点
3. 激活工作流

**注意**:
- 需要手动添加 7 个 Google Sheets 节点
- 需要配置 OAuth2 凭证
- Webhook URL 格式：`https://your-n8n.com/webhook/ai-analysis`

---

### 2. `AIDialogues.csv`

**用途**: Google Sheets "对话表" 的结构示例

**字段说明**:
| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| dialogueID | String | 对话唯一ID | dlg_1730448000001 |
| userID | String | 用户ID | testCode |
| title | String | 对话标题 | 问界M7外饰分析 |
| tags | String | 标签（逗号分隔） | 外观,外饰 |
| createTime | ISO String | 创建时间 | 2024-11-01T10:00:00.000Z |
| conversationHistory | String | 对话历史（特殊格式） | userSpeak:xxx----AISpeak:xxx---- |
| status | String | 状态 | active / deleted |

**conversationHistory 格式**:
```
userSpeak:用户第1条消息----AISpeak:AI第1条回复----userSpeak:用户第2条消息----AISpeak:AI第2条回复----
```

**使用**:
1. 在 Google Sheets 中创建新工作表，命名为 "AIDialogues"
2. 导入 CSV 文件，或手动创建表头
3. 确保字段名完全一致

---

### 3. `AIReports.csv`

**用途**: Google Sheets "报告表" 的结构示例

**字段说明**:
| 字段名 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| reportID | String | 报告唯一ID | report_1730448000001 |
| dialogueID | String | 关联的对话ID | dlg_1730448000001 |
| userID | String | 用户ID | testCode |
| htmlContent | String | 完整HTML | `<html>...</html>` |
| createTime | ISO String | 创建时间 | 2024-11-01T10:30:00.000Z |

**使用**:
1. 在 Google Sheets 中创建新工作表，命名为 "AIReports"
2. 导入 CSV 文件，或手动创建表头
3. 确保字段名完全一致

---

### 4. `ai-chat-demo.html`

**用途**: 前端演示界面（单文件应用）

**功能**:
- ✅ 对话列表（左侧）
- ✅ 实时聊天（中间）
- ✅ 调试工具（右侧）
- ✅ 乐观更新
- ✅ 历史对话加载
- ✅ 报告生成

**使用**:
1. 用浏览器直接打开（无需服务器）
2. 在右侧调试工具中配置 Webhook URL
3. 开始测试

**配置项**:
- Webhook URL: 你的 N8N Webhook 地址
- User ID: 测试用户ID（默认 testCode）

**浏览器兼容**:
- Chrome ✅
- Edge ✅
- Firefox ✅
- Safari ✅

---

## 📘 文档说明

### 1. `README.md`

**用途**: 快速开始指南

**内容**:
- 功能特性介绍
- 快速开始（3步配置）
- 常见问题解答
- 技术栈说明

**适合人群**: 第一次使用的用户

---

### 2. `工作流配置详细指南.md`

**用途**: N8N 工作流配置手册

**内容**:
- 工作流架构图
- 7 个 Google Sheets 节点详细配置
- 节点连接关系
- 手动配置步骤（带截图说明）
- 常见问题排查

**适合人群**: 需要手动添加 Google Sheets 节点的用户

---

### 3. `DeepSeek-API接入指南.md`

**用途**: AI API 接入教程

**内容**:
- 获取 API Key 步骤
- 3 种接入方法（HTTP Request / Code 节点 / 凭证管理）
- 错误处理
- 成本优化
- Token 使用监控

**适合人群**: 需要接入真实 AI 的用户

---

### 4. `项目结构说明.md`

**用途**: 项目文件说明（本文档）

**内容**:
- 文件树
- 核心文件详解
- 使用流程

**适合人群**: 想全面了解项目结构的用户

---

## 🎯 使用流程

### 新手快速上手

```
1. 阅读 README.md
   ↓
2. 创建 Google Sheets（使用 CSV 示例）
   ↓
3. 导入 n8n-workflow.json
   ↓
4. 按照《工作流配置详细指南.md》添加节点
   ↓
5. 打开 ai-chat-demo.html 测试
   ↓
6. （可选）按照《DeepSeek-API接入指南.md》接入AI
```

### 高级用户定制

```
1. 修改 n8n-workflow.json 中的逻辑
   ↓
2. 扩展 Google Sheets 表结构
   ↓
3. 定制 ai-chat-demo.html 界面
   ↓
4. 接入 DeepSeek API
   ↓
5. 优化 Prompt 和报告模板
```

---

## 📦 依赖说明

### 服务端（N8N）

| 依赖 | 版本 | 用途 |
|------|------|------|
| N8N | >= 1.0.0 | 工作流引擎 |
| Google Sheets API | v4 | 数据存储 |
| DeepSeek API | latest | AI 对话（可选） |

### 前端（HTML）

| 依赖 | 版本 | 用途 |
|------|------|------|
| Vanilla JS | ES6+ | 前端逻辑 |
| Fetch API | - | HTTP 请求 |
| CSS3 | - | 样式 |

**无需额外框架或构建工具！**

---

## 🔧 自定义指南

### 修改对话历史格式

如果你不喜欢 `userSpeak:xxx----AISpeak:xxx----` 格式，可以：

1. 修改"更新历史"节点的代码
2. 修改所有解析 conversationHistory 的节点
3. 更新前端的解析逻辑

**建议**: MVP 阶段先使用现有格式，后期迁移到 AIMessages 表。

---

### 添加新功能

#### 示例：添加"删除对话"功能

1. **后端**:
   - 在 Switch 节点添加新分支：`deleteDialogue`
   - 添加 Google Sheets Update 节点：设置 status = 'deleted'

2. **前端**:
   - 在对话列表项添加删除按钮
   - 调用 API：`callAPI('deleteDialogue', { dialogueID: xxx })`

---

### 更换数据库

如果想从 Google Sheets 迁移到 PostgreSQL：

1. 创建数据库表（对应 AIDialogues 和 AIReports）
2. 在 N8N 中替换所有 Google Sheets 节点为 Postgres 节点
3. 修改字段映射
4. 数据迁移（导出 CSV → 导入 PostgreSQL）

---

## 📊 数据流图

```
前端 (ai-chat-demo.html)
    ↓ POST /webhook/ai-analysis
N8N Webhook
    ↓
Router (提取 action)
    ↓
Switch (路由)
    ├─ sendMessage
    │   ↓
    │  Google Sheets (读/写)
    │   ↓
    │  DeepSeek API
    │   ↓
    │  返回 JSON
    │
    ├─ generateReport
    │   ↓
    │  Google Sheets (读取对话+图片)
    │   ↓
    │  生成 HTML
    │   ↓
    │  Google Sheets (保存报告)
    │   ↓
    │  返回 HTML
    │
    ├─ getDialogueList
    │   ↓
    │  Google Sheets (读取列表)
    │   ↓
    │  返回 JSON
    │
    └─ getDialogueDetail
        ↓
       Google Sheets (读取详情)
        ↓
       返回 JSON
```

---

## 🎨 界面截图说明

### 前端界面布局

```
┌─────────────┬────────────────────┬─────────────┐
│             │                    │             │
│  对话列表   │     聊天区域       │  调试工具   │
│  (左侧)     │     (中间)         │  (右侧)     │
│             │                    │             │
│  - 新对话   │  - 对话标题        │  - Webhook  │
│  - 历史1    │  - 消息列表        │  - User ID  │
│  - 历史2    │  - 输入框          │  - 日志     │
│  - 历史3    │  - 发送按钮        │             │
│             │  - 生成报告按钮    │             │
│             │                    │             │
└─────────────┴────────────────────┴─────────────┘
```

---

## ✅ 完整性检查

- [x] N8N 工作流文件
- [x] Google Sheets 结构示例
- [x] 前端界面（含调试工具）
- [x] 快速开始指南
- [x] 详细配置指南
- [x] API 接入指南
- [x] 项目结构说明

---

## 🔗 相关资源

- [N8N 官方文档](https://docs.n8n.io/)
- [Google Sheets API 文档](https://developers.google.com/sheets/api)
- [DeepSeek API 文档](https://www.deepseek.com/docs)

---

## 📝 版本历史

### v1.0.0 (2024-11-01)
- ✅ 完整工作流（4个分支）
- ✅ conversationHistory 存储方案
- ✅ 前端调试界面
- ✅ 完整文档

---

**祝使用愉快！** 🎉

