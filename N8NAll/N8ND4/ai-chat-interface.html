<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè½¦å‹åˆ†æåŠ©æ‰‹</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        /* å·¦ä¾§è¾¹æ  */
        .sidebar {
            width: 280px;
            background: #111827;
            color: white;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #374151;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 600;
        }

        .user-name {
            flex: 1;
        }

        .user-id {
            font-size: 12px;
            color: #9ca3af;
            margin-top: 2px;
        }

        .new-chat-btn {
            width: 100%;
            padding: 10px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background 0.2s;
        }

        .new-chat-btn:hover {
            background: #5568d3;
        }

        .history-section {
            flex: 1;
            overflow-y: auto;
            padding: 16px 12px;
        }

        .history-title {
            font-size: 12px;
            color: #9ca3af;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 12px;
            margin-bottom: 8px;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .history-item {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
        }

        .history-item:hover {
            background: #1f2937;
        }

        .history-item.active {
            background: #374151;
        }

        .history-item-title {
            font-size: 14px;
            color: #e5e7eb;
            margin-bottom: 6px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .history-item-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item-tags {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .mini-tag {
            font-size: 10px;
            padding: 2px 6px;
            background: #4f46e5;
            color: white;
            border-radius: 4px;
        }

        .history-item-time {
            font-size: 11px;
            color: #6b7280;
        }

        .empty-history {
            padding: 20px;
            text-align: center;
            color: #6b7280;
            font-size: 13px;
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fafafa;
        }

        .main-header {
            background: white;
            padding: 20px 40px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .action-btn {
            padding: 8px 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: #f9fafb;
        }

        /* å¯¹è¯åŒºåŸŸ */
        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .welcome-message {
            text-align: center;
            padding: 60px 20px;
        }

        .welcome-message h2 {
            font-size: 24px;
            color: #333;
            margin-bottom: 12px;
        }

        .welcome-message p {
            font-size: 14px;
            color: #666;
            line-height: 1.6;
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 800px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.assistant .message-avatar {
            background: #f3f4f6;
            color: #666;
        }

        .message-content {
            background: white;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
            max-width: 600px;
        }

        .message.user .message-content {
            background: #667eea;
            color: white;
        }

        .message-text {
            font-size: 14px;
            line-height: 1.6;
        }

        .message-tags {
            margin-top: 8px;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .tag {
            background: rgba(255, 255, 255, 0.2);
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
        }

        .message.assistant .tag {
            background: #e0e7ff;
            color: #4f46e5;
        }

        /* æŠ¥å‘Šå¡ç‰‡ */
        .report-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            max-width: 800px;
        }

        .report-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .report-title {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .report-actions {
            display: flex;
            gap: 8px;
        }

        .report-btn {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .report-btn:hover {
            background: #5568d3;
        }

        .report-btn.secondary {
            background: #f3f4f6;
            color: #666;
        }

        .report-btn.secondary:hover {
            background: #e5e7eb;
        }

        .report-info {
            margin-top: 12px;
            padding: 12px;
            background: #f9fafb;
            border-radius: 6px;
            font-size: 12px;
            color: #666;
        }

        /* è¾“å…¥åŒºåŸŸ */
        .input-container {
            background: white;
            border-top: 1px solid #e5e7eb;
            padding: 20px 40px;
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            max-width: 800px;
            margin: 0 auto;
        }

        .message-input {
            flex: 1;
            padding: 12px 20px;
            border: 1px solid #e5e7eb;
            border-radius: 24px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            font-family: inherit;
        }

        .message-input:focus {
            border-color: #667eea;
        }

        .send-btn {
            width: 44px;
            height: 44px;
            background: #667eea;
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .send-btn:hover {
            background: #5568d3;
            transform: scale(1.05);
        }

        .send-btn:disabled {
            background: #e5e7eb;
            cursor: not-allowed;
            transform: scale(1);
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }

        .loading-dot {
            width: 8px;
            height: 8px;
            background: #999;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .loading-dot:nth-child(1) { animation-delay: -0.32s; }
        .loading-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* é…ç½®é¢æ¿ */
        .config-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #1f2937;
            color: #e5e7eb;
            padding: 16px;
            border-radius: 8px;
            font-size: 12px;
            max-width: 400px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
        }

        .config-title {
            font-weight: 600;
            margin-bottom: 8px;
            color: #10b981;
        }

        .config-input {
            width: 100%;
            padding: 8px;
            margin: 8px 0;
            background: #374151;
            border: 1px solid #4b5563;
            color: white;
            border-radius: 4px;
            font-size: 12px;
        }

        .config-log {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid #374151;
            max-height: 150px;
            overflow-y: auto;
        }

        .log-item {
            margin-bottom: 4px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- å·¦ä¾§è¾¹æ  -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">?</div>
                    <div class="user-name">
                        <div id="userName">æœªç™»å½•</div>
                        <div class="user-id" id="userID">è¯·è®¾ç½®ç”¨æˆ·ID</div>
                    </div>
                </div>
                <button class="new-chat-btn" onclick="startNewChat()">
                    <span>+</span>
                    <span>æ–°å»ºå¯¹è¯</span>
                </button>
            </div>

            <div class="history-section">
                <div class="history-title">å¯¹è¯å†å²</div>
                <div class="history-list" id="historyList">
                    <div class="empty-history">æš‚æ— å†å²å¯¹è¯</div>
                </div>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <div class="main-content">
            <div class="main-header">
                <div class="chat-title" id="chatTitle">æ–°å»ºå¯¹è¯</div>
                <div class="header-actions">
                    <button class="action-btn" onclick="clearChat()">æ¸…ç©ºå¯¹è¯</button>
                </div>
            </div>

            <div class="chat-container" id="chatContainer">
                <div class="welcome-message">
                    <h2>ğŸ‘‹ æ¬¢è¿ä½¿ç”¨AIè½¦å‹åˆ†æåŠ©æ‰‹</h2>
                    <p>
                        æ‚¨å¯ä»¥å‘æˆ‘æè¿°æ‚¨å…³å¿ƒçš„è½¦å‹å¯¹æ¯”ç»´åº¦<br>
                        ä¾‹å¦‚ï¼š"æˆ‘æƒ³å¯¹æ¯”ææ°ª009ã€å°é¹X9å’Œè…¾åŠ¿D9çš„å¤–è§‚å’Œå†…é¥°"<br>
                        <br>
                        å½“æ‚¨å‡†å¤‡å¥½åï¼Œè¯´"ç”ŸæˆæŠ¥å‘Š"æˆ–"å¯¼å‡ºæŠ¥å‘Š"ï¼Œæˆ‘ä¼šä¸ºæ‚¨ç”Ÿæˆä¸“ä¸šçš„å¯¹æ¯”çŸ©é˜µï¼
                    </p>
                </div>
            </div>

            <div class="input-container">
                <div class="input-wrapper">
                    <textarea 
                        class="message-input" 
                        id="messageInput" 
                        placeholder="è¾“å…¥æ‚¨çš„éœ€æ±‚..."
                        rows="1"
                        onkeydown="handleKeyDown(event)"
                        oninput="autoResize(this)"
                    ></textarea>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">â–²</button>
                </div>
            </div>
        </div>
    </div>

    <!-- é…ç½®é¢æ¿ -->
    <div class="config-panel">
        <div class="config-title">ğŸ”§ é…ç½®</div>
        <label>Webhook URL:</label>
        <input 
            type="text" 
            id="webhookUrl" 
            class="config-input"
            placeholder="https://your-n8n.com/webhook/ai-analysis"
            onchange="saveConfig()"
        >
        <label>ç”¨æˆ·ID:</label>
        <input 
            type="text" 
            id="userIdInput" 
            class="config-input"
            placeholder="è¾“å…¥æ‚¨çš„ç”¨æˆ·ID"
            value="user_001"
            onchange="saveConfig()"
        >
        <div class="config-log" id="configLog">
            <div>ç­‰å¾…æ“ä½œ...</div>
        </div>
    </div>

    <script>
        // ===== å…¨å±€å˜é‡ =====
        let WEBHOOK_URL = '';
        let USER_ID = 'user_001';
        let currentDialogueID = null;
        let dialogueHistory = [];
        let currentMessages = [];
        let collectedTags = [];

        // ===== åˆå§‹åŒ– =====
        function init() {
            // åŠ è½½é…ç½®
            const savedUrl = localStorage.getItem('webhookUrl');
            const savedUserId = localStorage.getItem('userId');
            
            if (savedUrl) {
                WEBHOOK_URL = savedUrl;
                document.getElementById('webhookUrl').value = savedUrl;
            }
            
            if (savedUserId) {
                USER_ID = savedUserId;
                document.getElementById('userIdInput').value = savedUserId;
            }
            
            updateUserInfo();
            loadDialogueHistory();
        }

        // ===== é…ç½®ç®¡ç† =====
        function saveConfig() {
            WEBHOOK_URL = document.getElementById('webhookUrl').value;
            USER_ID = document.getElementById('userIdInput').value;
            
            localStorage.setItem('webhookUrl', WEBHOOK_URL);
            localStorage.setItem('userId', USER_ID);
            
            updateUserInfo();
            addLog('âœ… é…ç½®å·²ä¿å­˜');
        }

        function updateUserInfo() {
            const avatar = USER_ID.charAt(0).toUpperCase();
            document.getElementById('userAvatar').textContent = avatar;
            document.getElementById('userName').textContent = `ç”¨æˆ· ${avatar}`;
            document.getElementById('userID').textContent = USER_ID;
        }

        function addLog(message) {
            const log = document.getElementById('configLog');
            const time = new Date().toLocaleTimeString();
            const item = document.createElement('div');
            item.className = 'log-item';
            item.textContent = `[${time}] ${message}`;
            log.appendChild(item);
            
            while (log.children.length > 10) {
                log.removeChild(log.firstChild);
            }
            log.scrollTop = log.scrollHeight;
        }

        // ===== å¯¹è¯å†å²ç®¡ç† =====
        async function loadDialogueHistory() {
            if (!WEBHOOK_URL || !USER_ID) return;

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'getDialogueList',
                        userID: USER_ID
                    })
                });

                const data = await response.json();
                if (data.success && data.dialogues) {
                    dialogueHistory = data.dialogues;
                    renderHistoryList();
                    addLog(`ğŸ“‹ åŠ è½½äº† ${data.dialogues.length} æ¡å†å²å¯¹è¯`);
                }
            } catch (error) {
                console.log('åŠ è½½å†å²å¤±è´¥:', error);
            }
        }

        function renderHistoryList() {
            const listEl = document.getElementById('historyList');
            
            if (dialogueHistory.length === 0) {
                listEl.innerHTML = '<div class="empty-history">æš‚æ— å†å²å¯¹è¯</div>';
                return;
            }

            listEl.innerHTML = dialogueHistory.map(item => `
                <div class="history-item ${item.dialogueID === currentDialogueID ? 'active' : ''}" 
                     onclick="loadDialogue('${item.dialogueID}')">
                    <div class="history-item-title">${item.title || 'æœªå‘½åå¯¹è¯'}</div>
                    <div class="history-item-meta">
                        <div class="history-item-tags">
                            ${(item.tags || []).slice(0, 3).map(tag => 
                                `<span class="mini-tag">${tag}</span>`
                            ).join('')}
                        </div>
                        <div class="history-item-time">${formatTime(item.timestamp)}</div>
                    </div>
                </div>
            `).join('');
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 60000) return 'åˆšåˆš';
            if (diff < 3600000) return `${Math.floor(diff/60000)}åˆ†é’Ÿå‰`;
            if (diff < 86400000) return `${Math.floor(diff/3600000)}å°æ—¶å‰`;
            return date.toLocaleDateString();
        }

        function loadDialogue(dialogueID) {
            // TODO: ä»æœåŠ¡å™¨åŠ è½½å®Œæ•´å¯¹è¯å†…å®¹
            currentDialogueID = dialogueID;
            renderHistoryList();
            addLog(`ğŸ“‚ åŠ è½½å¯¹è¯: ${dialogueID}`);
        }

        // ===== æ–°å»ºå¯¹è¯ =====
        function startNewChat() {
            currentDialogueID = null;
            currentMessages = [];
            collectedTags = [];
            
            const container = document.getElementById('chatContainer');
            container.innerHTML = `
                <div class="welcome-message">
                    <h2>ğŸ‘‹ å¼€å§‹æ–°çš„å¯¹è¯</h2>
                    <p>å‘Šè¯‰æˆ‘æ‚¨æƒ³äº†è§£ä»€ä¹ˆå§ï¼</p>
                </div>
            `;
            
            document.getElementById('chatTitle').textContent = 'æ–°å»ºå¯¹è¯';
            document.getElementById('messageInput').value = '';
            document.getElementById('messageInput').focus();
            
            renderHistoryList();
            addLog('ğŸ†• å¼€å§‹æ–°å¯¹è¯');
        }

        function clearChat() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰å¯¹è¯å—ï¼Ÿ')) {
                startNewChat();
            }
        }

        // ===== å‘é€æ¶ˆæ¯ =====
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const content = input.value.trim();
            
            if (!content) return;
            if (!WEBHOOK_URL) {
                alert('è¯·å…ˆé…ç½®Webhook URLï¼');
                return;
            }

            // ç¦ç”¨è¾“å…¥
            input.disabled = true;
            document.getElementById('sendBtn').disabled = true;

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addUserMessage(content);
            input.value = '';
            autoResize(input);

            // æ£€æŸ¥æ˜¯å¦è§¦å‘æŠ¥å‘Šç”Ÿæˆ
            const reportKeywords = ['ç”ŸæˆæŠ¥å‘Š', 'å¯¼å‡ºæŠ¥å‘Š', 'ç”Ÿæˆå¯¹æ¯”', 'ç”Ÿæˆåˆ†æ', 'åˆ›å»ºæŠ¥å‘Š'];
            const shouldGenerateReport = reportKeywords.some(keyword => content.includes(keyword));

            if (shouldGenerateReport && collectedTags.length > 0) {
                // è§¦å‘æŠ¥å‘Šç”Ÿæˆ
                await generateReport();
            } else {
                // æ­£å¸¸å¯¹è¯
                const loadingId = addLoadingMessage();

                try {
                    const response = await fetch(WEBHOOK_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'sendMessage',
                            userID: USER_ID,
                            dialogueID: currentDialogueID,
                            content: content
                        })
                    });

                    const data = await response.json();
                    removeLoadingMessage(loadingId);

                    if (data.success) {
                        currentDialogueID = data.dialogueID;
                        addAssistantMessage(data.aiReply, data.extractedTags);
                        
                        // ç´¯ç§¯æ ‡ç­¾
                        if (data.extractedTags) {
                            collectedTags = [...new Set([...collectedTags, ...data.extractedTags])];
                        }
                        
                        addLog(`âœ… æ”¶åˆ°å›å¤ï¼Œæå–æ ‡ç­¾: ${data.extractedTags?.join(', ') || 'æ— '}`);
                    }
                } catch (error) {
                    removeLoadingMessage(loadingId);
                    addAssistantMessage('âš ï¸ æŠ±æ­‰ï¼Œè¿æ¥å¤±è´¥ï¼š' + error.message);
                    addLog(`âŒ é”™è¯¯: ${error.message}`);
                }
            }

            // æ¢å¤è¾“å…¥
            input.disabled = false;
            document.getElementById('sendBtn').disabled = false;
            input.focus();
        }

        // ===== ç”ŸæˆæŠ¥å‘Š =====
        async function generateReport() {
            if (!collectedTags || collectedTags.length === 0) {
                addAssistantMessage('æŠ±æ­‰ï¼Œæˆ‘è¿˜æ²¡æœ‰æ”¶é›†åˆ°è¶³å¤Ÿçš„ä¿¡æ¯æ¥ç”ŸæˆæŠ¥å‘Šã€‚è¯·å‘Šè¯‰æˆ‘æ‚¨å…³å¿ƒçš„å¯¹æ¯”ç»´åº¦ã€‚');
                return;
            }

            const loadingId = addLoadingMessage();
            addLog(`ğŸ“„ ç”ŸæˆæŠ¥å‘Šï¼Œç»´åº¦: ${collectedTags.join(', ')}`);

            try {
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'generateReport',
                        userID: USER_ID,
                        dialogueID: currentDialogueID,
                        tags: collectedTags,
                        vehicles: [
                            { name: 'ææ°ª009' },
                            { name: 'å°é¹X9' },
                            { name: 'è…¾åŠ¿D9' }
                        ]
                    })
                });

                const data = await response.json();
                removeLoadingMessage(loadingId);

                if (data.success) {
                    addReportCard(data.reportID, data.htmlContent);
                    addLog(`âœ… æŠ¥å‘Šç”ŸæˆæˆåŠŸ: ${data.reportID}`);
                } else {
                    addAssistantMessage('æŠ±æ­‰ï¼ŒæŠ¥å‘Šç”Ÿæˆå¤±è´¥ã€‚');
                }
            } catch (error) {
                removeLoadingMessage(loadingId);
                addAssistantMessage('âš ï¸ æŠ¥å‘Šç”Ÿæˆå¤±è´¥ï¼š' + error.message);
                addLog(`âŒ é”™è¯¯: ${error.message}`);
            }
        }

        // ===== UIæ“ä½œ =====
        function addUserMessage(text) {
            const container = document.getElementById('chatContainer');
            const welcome = container.querySelector('.welcome-message');
            if (welcome) welcome.remove();

            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.innerHTML = `
                <div class="message-avatar">${USER_ID.charAt(0).toUpperCase()}</div>
                <div class="message-content">
                    <div class="message-text">${escapeHtml(text)}</div>
                </div>
            `;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function addAssistantMessage(text, tags = []) {
            const container = document.getElementById('chatContainer');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            
            let tagsHtml = '';
            if (tags && tags.length > 0) {
                tagsHtml = '<div class="message-tags">' + 
                    tags.map(t => `<span class="tag">${t}</span>`).join('') +
                    '</div>';
            }
            
            messageDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="message-text">${escapeHtml(text)}</div>
                    ${tagsHtml}
                </div>
            `;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function addLoadingMessage() {
            const container = document.getElementById('chatContainer');
            const loadingDiv = document.createElement('div');
            loadingDiv.className = 'message assistant';
            loadingDiv.id = 'loading-' + Date.now();
            loadingDiv.innerHTML = `
                <div class="message-avatar">AI</div>
                <div class="message-content">
                    <div class="loading">
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                        <div class="loading-dot"></div>
                    </div>
                </div>
            `;
            container.appendChild(loadingDiv);
            container.scrollTop = container.scrollHeight;
            return loadingDiv.id;
        }

        function removeLoadingMessage(id) {
            const loading = document.getElementById(id);
            if (loading) loading.remove();
        }

        function addReportCard(reportID, htmlContent) {
            const container = document.getElementById('chatContainer');
            const reportDiv = document.createElement('div');
            reportDiv.className = 'report-card';
            reportDiv.innerHTML = `
                <div class="report-header">
                    <div class="report-title">ğŸ“Š è½¦å‹å¯¹æ¯”æŠ¥å‘Š</div>
                    <div class="report-actions">
                        <button class="report-btn" onclick='previewReport(${JSON.stringify(htmlContent)})'>
                            ğŸ‘ï¸ é¢„è§ˆ
                        </button>
                        <button class="report-btn" onclick='printReport(${JSON.stringify(htmlContent)})'>
                            ğŸ–¨ï¸ æ‰“å°PDF
                        </button>
                    </div>
                </div>
                <div class="report-info">
                    <div><strong>æŠ¥å‘ŠID:</strong> ${reportID}</div>
                    <div style="margin-top: 4px; color: #10b981;">âœ… æŠ¥å‘Šå·²ç”Ÿæˆï¼ç‚¹å‡»"æ‰“å°PDF"ä½¿ç”¨æµè§ˆå™¨ä¿å­˜</div>
                </div>
            `;
            container.appendChild(reportDiv);
            container.scrollTop = container.scrollHeight;
        }

        function previewReport(htmlContent) {
            const win = window.open('', '_blank');
            win.document.write(htmlContent);
            win.document.close();
        }

        function printReport(htmlContent) {
            const win = window.open('', '_blank');
            win.document.write(htmlContent);
            win.document.close();
            win.onload = () => {
                setTimeout(() => win.print(), 500);
            };
        }

        // ===== è¾…åŠ©å‡½æ•° =====
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function handleKeyDown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // ===== å¯åŠ¨ =====
        init();
    </script>
</body>
</html>

