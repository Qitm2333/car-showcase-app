# 🚀 AI车型分析助手 - 完整方案快速使用指南

## 📦 完整文件清单

```
✅ ai-chat-interface.html               # 前端界面（新版，支持历史记录）
✅ 完整N8N工作流.json                    # N8N工作流配置
✅ Google-Sheets表结构完整说明.md        # 数据库结构
✅ 完整方案-快速使用指南.md              # 本文件
```

---

## 🎯 新版功能特点

### ✨ **核心功能**

1. **用户登录系统**
   - 每个用户有独立的userID
   - 左侧显示该用户的历史对话

2. **对话历史管理**
   - 自动保存所有对话
   - 左侧列表显示历史记录
   - 点击可切换对话

3. **智能报告触发**
   - 当用户说"生成报告"、"导出报告"等关键词
   - 自动触发报告生成
   - 无需手动点击按钮

4. **HTML报告 + 打印功能**
   - 生成完整HTML报告
   - 用户通过浏览器打印生成PDF
   - 零后端成本

---

## 🏗️ 系统架构

```
┌─────────────────────────────────────────────────────────┐
│  前端界面 (ai-chat-interface.html)                       │
│  - 左侧：历史对话列表                                     │
│  - 右侧：当前对话界面                                     │
│  - 底部：输入框                                          │
└─────────────────┬───────────────────────────────────────┘
                  │ HTTP POST
                  ↓
┌─────────────────────────────────────────────────────────┐
│  N8N工作流 (完整N8N工作流.json)                          │
│  ┌─────────────────────────────────────────────────┐   │
│  │ Action 1: sendMessage                            │   │
│  │  - 接收用户消息                                   │   │
│  │  - 提取关键词标签                                 │   │
│  │  - 保存到 Google Sheets (AIDialogues)           │   │
│  │  - 返回AI回复                                     │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │ Action 2: generateReport                         │   │
│  │  - 根据标签生成HTML报告                           │   │
│  │  - 保存到 Google Sheets (AIReports)             │   │
│  │  - 返回HTML内容                                   │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │ Action 3: getDialogueList                        │   │
│  │  - 读取 Google Sheets (AIDialogues)             │   │
│  │  - 过滤当前用户的对话                             │   │
│  │  - 返回对话列表                                   │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────┬───────────────────────────────────────┘
                  │
                  ↓
┌─────────────────────────────────────────────────────────┐
│  Google Sheets 数据库                                    │
│  ┌─────────────────────────────────────────────────┐   │
│  │ Sheet 1: AIDialogues                             │   │
│  │  - dialogueID, userID, title                     │   │
│  │  - lastMessage, tags, timestamp                  │   │
│  └─────────────────────────────────────────────────┘   │
│  ┌─────────────────────────────────────────────────┐   │
│  │ Sheet 2: AIReports                               │   │
│  │  - reportID, dialogueID, tags                    │   │
│  │  - htmlContent, createTime                       │   │
│  └─────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

---

## 🔧 安装步骤（30分钟）

### **第1步：创建Google Sheets数据库**（10分钟）

1. 访问 https://sheets.google.com
2. 创建新文档，命名为 `AI车型分析数据库`
3. 创建两个Sheet：
   - **AIDialogues** - 对话记录
   - **AIReports** - 报告记录
4. 添加表头（详见 `Google-Sheets表结构完整说明.md`）

**AIDialogues 表头：**
```
dialogueID | userID | title | lastMessage | tags | timestamp
```

**AIReports 表头：**
```
reportID | userID | dialogueID | tags | vehicles | htmlContent | createTime
```

5. 复制Sheet ID（浏览器地址栏中的ID）

---

### **第2步：配置N8N工作流**（15分钟）

#### 2.1 导入工作流

**方法A：手动创建**（推荐，100%成功）
- 查看 `手动创建N8N工作流指南.md`
- 逐步创建15个节点

**方法B：JSON导入**（可能失败）
1. 打开 `完整N8N工作流.json`
2. 复制全部内容
3. N8N → Import from JSON → 粘贴

#### 2.2 配置Google Sheets凭据

1. N8N → Credentials → New
2. 搜索 **"Google Sheets OAuth2"**
3. 按提示完成Google账号授权
4. 保存凭据

#### 2.3 更新Sheet ID

在以下3个节点中更新：
- **保存对话到Sheets** 节点
- **保存报告到Sheets** 节点
- **读取对话列表** 节点

将 `YOUR_GOOGLE_SHEET_ID` 替换为你的实际ID。

#### 2.4 激活工作流

1. 点击右上角 **"Active"** 开关
2. 复制 **Production Webhook URL**
   ```
   https://your-n8n.com/webhook/ai-analysis
   ```

---

### **第3步：配置前端界面**（5分钟）

1. 打开 `ai-chat-interface.html`（双击用浏览器打开）

2. 在右下角配置面板中填写：
   - **Webhook URL**：粘贴N8N的Webhook地址
   - **用户ID**：输入你的测试ID（如 `user_001`）

3. 点击输入框外部，自动保存配置

4. ✅ 完成！

---

## 🧪 测试流程

### **测试1：发送消息**

1. 在输入框输入：
   ```
   我想对比极氪009、小鹏X9和腾势D9的外观和内饰
   ```

2. 点击发送（或按Enter）

3. **预期结果**：
   - AI回复：`好的，我理解了您的需求。我将重点关注外观、内饰这些方面。当您准备好后，说"生成报告"...`
   - 显示标签：`外观` `内饰`
   - Google Sheets AIDialogues 表中新增一条记录

---

### **测试2：生成报告**

1. 继续输入：
   ```
   生成报告
   ```

2. 点击发送

3. **预期结果**：
   - 显示报告卡片
   - 提供 `预览` 和 `打印PDF` 按钮
   - Google Sheets AIReports 表中新增一条记录

4. 点击 **"打印PDF"** 按钮

5. **预期结果**：
   - 新窗口打开HTML报告
   - 自动触发浏览器打印对话框
   - 选择 **"另存为PDF"** 保存

---

### **测试3：查看历史**

1. 刷新页面

2. **预期结果**：
   - 左侧边栏显示刚才的对话
   - 显示标题和标签
   - 显示时间（如"刚刚"、"5分钟前"）

3. 点击历史记录项

4. **预期结果**：
   - 高亮显示选中的对话
   - 右侧加载对话内容

---

## 📊 数据流说明

### **发送消息流程**

```
用户输入："我想对比外观和内饰"
    ↓
前端 POST → N8N Webhook
{
  "action": "sendMessage",
  "userID": "user_001",
  "content": "我想对比外观和内饰"
}
    ↓
N8N: 路由器 → IF-SendMessage → 处理消息节点
    ↓
提取关键词: ["外观", "内饰"]
    ↓
保存到 Google Sheets AIDialogues:
{
  dialogueID: "dlg_xxx",
  userID: "user_001",
  title: "我想对比外观和内饰",
  lastMessage: "好的，我将重点关注...",
  tags: ["外观","内饰"],
  timestamp: "2024-01-01T10:00:00.000Z"
}
    ↓
返回给前端:
{
  "success": true,
  "dialogueID": "dlg_xxx",
  "aiReply": "好的，我将重点关注外观、内饰...",
  "extractedTags": ["外观", "内饰"]
}
    ↓
前端显示AI回复 + 标签
```

---

### **生成报告流程**

```
用户输入："生成报告"
    ↓
前端检测到关键词 → 自动触发generateReport
    ↓
前端 POST → N8N Webhook
{
  "action": "generateReport",
  "userID": "user_001",
  "dialogueID": "dlg_xxx",
  "tags": ["外观", "内饰"],
  "vehicles": [...]
}
    ↓
N8N: 路由器 → IF-GenerateReport → 生成报告节点
    ↓
生成HTML内容（包含完整样式和打印功能）
    ↓
保存到 Google Sheets AIReports:
{
  reportID: "report_xxx",
  dialogueID: "dlg_xxx",
  htmlContent: "<!DOCTYPE html>...",
  createTime: "2024-01-01T10:05:00.000Z"
}
    ↓
返回给前端:
{
  "success": true,
  "reportID": "report_xxx",
  "htmlContent": "<!DOCTYPE html>..."
}
    ↓
前端显示报告卡片 + 预览/打印按钮
```

---

### **加载历史流程**

```
页面加载时自动调用
    ↓
前端 POST → N8N Webhook
{
  "action": "getDialogueList",
  "userID": "user_001"
}
    ↓
N8N: 路由器 → IF-GetDialogueList → 读取对话列表节点
    ↓
从 Google Sheets AIDialogues 读取所有记录
    ↓
过滤当前用户的对话
    ↓
按时间倒序排序，取最近50条
    ↓
返回给前端:
{
  "success": true,
  "dialogues": [
    {
      "dialogueID": "dlg_xxx",
      "title": "我想对比外观和内饰",
      "tags": ["外观","内饰"],
      "timestamp": "2024-01-01T10:00:00.000Z"
    }
  ]
}
    ↓
前端渲染左侧历史列表
```

---

## 💡 使用技巧

### **1. 关键词触发报告**

支持的关键词：
- `生成报告`
- `导出报告`
- `生成对比`
- `生成分析`
- `创建报告`

### **2. 自动提取标签**

系统会自动识别以下关键词：
```javascript
['外观', '内饰', '性能', '续航', '空间', '配置', '智能化', '价格']
```

示例：
```
输入："我关心外观和价格"
→ 自动提取: ["外观", "价格"]
```

### **3. 快捷键**

- **Enter**：发送消息
- **Shift + Enter**：换行
- **Ctrl + P**（报告页面）：打印PDF

---

## 🔍 故障排查

### **问题1：前端无法连接N8N**

**检查**：
- [ ] N8N工作流是否激活（Active）
- [ ] Webhook URL是否正确
- [ ] 浏览器控制台是否有CORS错误

**解决**：
如果有CORS错误，在N8N Webhook节点添加响应头：
```json
{
  "Access-Control-Allow-Origin": "*"
}
```

---

### **问题2：Google Sheets保存失败**

**检查**：
- [ ] Google Sheets凭据是否配置
- [ ] Sheet ID是否正确
- [ ] Sheet名称是否匹配（AIDialogues/AIReports）
- [ ] 表头是否正确

**解决**：
1. 重新授权Google Sheets OAuth2
2. 检查Sheet ID和名称
3. 在N8N中手动测试节点

---

### **问题3：历史记录不显示**

**检查**：
- [ ] Google Sheets中是否有数据
- [ ] userID是否匹配
- [ ] 浏览器控制台是否有错误

**解决**：
1. 手动在Google Sheets中插入测试数据
2. 检查userID是否一致
3. 查看N8N执行日志

---

## 🎯 后续优化方向

### **阶段1：基础功能**（当前）
- ✅ 对话功能
- ✅ 报告生成
- ✅ 历史记录

### **阶段2：AI集成**
- 集成DeepSeek API
- 真实的AI分析
- 更智能的标签提取

### **阶段3：增强功能**
- 图片识别（车型图片）
- 多对话管理
- 导出历史对话

### **阶段4：生产优化**
- 用户登录系统
- 权限管理
- 数据备份

---

## 📞 获取帮助

**遇到问题？**

1. 查看 `Google-Sheets表结构完整说明.md`
2. 查看 `手动创建N8N工作流指南.md`
3. 检查浏览器控制台错误
4. 检查N8N执行日志

**常见错误代码**：
- `404` - Webhook URL错误或工作流未激活
- `CORS` - 跨域问题，需配置响应头
- `500` - N8N执行错误，查看日志

---

## ✅ 完成检查清单

部署完成后，确认以下内容：

- [ ] Google Sheets已创建并配置
- [ ] N8N工作流已导入并激活
- [ ] Webhook URL已获取
- [ ] 前端界面可以打开
- [ ] 配置已保存（Webhook URL + userID）
- [ ] 测试1: 发送消息成功
- [ ] 测试2: 生成报告成功
- [ ] 测试3: 历史记录显示

---

## 🎉 开始使用！

现在一切就绪，开始体验AI车型分析助手吧！🚀

**祝使用愉快！** ✨

