# N8N èŠ‚ç‚¹é…ç½® - é€ä¸ªå¤åˆ¶ç²˜è´´

æŒ‰ç…§é¡ºåºåˆ›å»º9ä¸ªèŠ‚ç‚¹ï¼Œæ¯ä¸ªèŠ‚ç‚¹å¤åˆ¶ç²˜è´´é…ç½®å³å¯ã€‚

---

## èŠ‚ç‚¹1ï¸âƒ£ï¼šWebhookï¼ˆå…¥å£ï¼‰

**æ“ä½œ**ï¼šç‚¹å‡» "+" â†’ æœç´¢ "Webhook" â†’ æ·»åŠ 

**é…ç½®**ï¼š
- HTTP Method: `POST`
- Path: `ai-analysis`
- Response Mode: `Respond to Webhook`

**ä½ç½®**ï¼šæ‹–åˆ°æœ€å·¦è¾¹

---

## èŠ‚ç‚¹2ï¸âƒ£ï¼šRouterï¼ˆè·¯ç”±å™¨ï¼‰

**æ“ä½œ**ï¼šç‚¹å‡»Webhookåçš„ "+" â†’ æœç´¢ "Code" â†’ æ·»åŠ 

**èŠ‚ç‚¹åç§°**ï¼šæ”¹ä¸º `Router`

**JavaScriptä»£ç **ï¼š
```javascript
const action = $input.item.json.body.action;
return {json: {action: action, data: $input.item.json.body}};
```

---

## èŠ‚ç‚¹3ï¸âƒ£ï¼šSwitchï¼ˆé€‰æ‹©æ“ä½œï¼‰

**æ“ä½œ**ï¼šç‚¹å‡»Routeråçš„ "+" â†’ æœç´¢ "Switch" â†’ æ·»åŠ 

**èŠ‚ç‚¹åç§°**ï¼š`Switch`

**é…ç½®è§„åˆ™**ï¼šç‚¹å‡» "Add Routing Rule" æ·»åŠ 3æ¡è§„åˆ™

### è§„åˆ™1ï¼šsendMessage
- Condition 1:
  - Value 1: `={{$json.action}}`
  - Operation: `equals`
  - Value 2: `sendMessage`
- Output Key: `sendMessage`

### è§„åˆ™2ï¼šgenerateReport
ç‚¹å‡» "Add Routing Rule" æ·»åŠ ç¬¬2æ¡
- Condition 1:
  - Value 1: `={{$json.action}}`
  - Operation: `equals`
  - Value 2: `generateReport`
- Output Key: `generateReport`

### è§„åˆ™3ï¼šgetDialogueList
ç‚¹å‡» "Add Routing Rule" æ·»åŠ ç¬¬3æ¡
- Condition 1:
  - Value 1: `={{$json.action}}`
  - Operation: `equals`
  - Value 2: `getDialogueList`
- Output Key: `getDialogueList`

---

## èŠ‚ç‚¹4ï¸âƒ£ï¼šProcessMessageï¼ˆå¤„ç†æ¶ˆæ¯ï¼‰

**æ“ä½œ**ï¼šç‚¹å‡»Switchçš„ç¬¬1ä¸ªè¾“å‡ºåçš„ "+" â†’ æœç´¢ "Code" â†’ æ·»åŠ 

**èŠ‚ç‚¹åç§°**ï¼š`ProcessMessage`

**JavaScriptä»£ç **ï¼š
```javascript
const data = $input.item.json.data;
const content = data.content || '';
const keywords = ['å¤–è§‚','å†…é¥°','æ€§èƒ½','ç»­èˆª','ç©ºé—´','é…ç½®','æ™ºèƒ½åŒ–','ä»·æ ¼'];
const extractedTags = keywords.filter(k => content.includes(k));

let aiReply = 'å¥½çš„ï¼Œæˆ‘ç†è§£äº†æ‚¨çš„éœ€æ±‚ã€‚';
if (extractedTags.length > 0) {
  aiReply += `æˆ‘å°†é‡ç‚¹å…³æ³¨${extractedTags.join('ã€')}è¿™äº›æ–¹é¢ã€‚å½“æ‚¨å‡†å¤‡å¥½åï¼Œè¯´"ç”ŸæˆæŠ¥å‘Š"ã€‚`;
} else {
  aiReply += 'è¯·å‘Šè¯‰æˆ‘æ‚¨å…³å¿ƒçš„å¯¹æ¯”ç»´åº¦ã€‚';
}

const messageID = 'msg_' + Date.now();
const dialogueID = data.dialogueID || 'dlg_' + Date.now();
const timestamp = new Date().toISOString();

return {
  json: {
    success: true,
    messageID,
    aiReply,
    extractedTags,
    dialogueID,
    timestamp,
    userID: data.userID,
    userContent: content
  }
};
```

---

## èŠ‚ç‚¹5ï¸âƒ£ï¼šRespondMessageï¼ˆå“åº”æ¶ˆæ¯ï¼‰

**æ“ä½œ**ï¼šç‚¹å‡»ProcessMessageåçš„ "+" â†’ æœç´¢ "Respond to Webhook" â†’ æ·»åŠ 

**èŠ‚ç‚¹åç§°**ï¼š`RespondMessage`

**é…ç½®**ï¼š
- Respond With: `JSON`
- Response Body: `={{$json}}`

---

## èŠ‚ç‚¹6ï¸âƒ£ï¼šGenerateReportï¼ˆç”ŸæˆæŠ¥å‘Šï¼‰

**æ“ä½œ**ï¼šå›åˆ°SwitchèŠ‚ç‚¹ï¼Œç‚¹å‡»ç¬¬2ä¸ªè¾“å‡ºåçš„ "+" â†’ æœç´¢ "Code" â†’ æ·»åŠ 

**èŠ‚ç‚¹åç§°**ï¼š`GenerateReport`

**JavaScriptä»£ç **ï¼š
```javascript
const data = $input.item.json.data;
const tags = data.tags || ['å¤–è§‚','å†…é¥°'];
const vehicles = data.vehicles || [{name:'ææ°ª009'},{name:'å°é¹X9'},{name:'è…¾åŠ¿D9'}];
const reportID = 'report_' + Date.now();

const html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>æŠ¥å‘Š</title><style>body{font-family:sans-serif;padding:40px}table{width:100%;border-collapse:collapse}th,td{padding:15px;border:1px solid #ddd}button{position:fixed;top:20px;right:20px;padding:10px 20px;background:#667eea;color:#fff;border:none;border-radius:8px;cursor:pointer}@media print{button{display:none}}</style></head><body><button onclick="window.print()">æ‰“å°PDF</button><h1>è½¦å‹å¯¹æ¯”æŠ¥å‘Š</h1><table><thead><tr><th>ç»´åº¦</th>'+vehicles.map(v=>'<th>'+v.name+'</th>').join('')+'</tr></thead><tbody>'+tags.map(t=>'<tr><td>'+t+'</td>'+vehicles.map(()=>'<td>ä¼˜ç§€</td>').join('')+'</tr>').join('')+'</tbody></table><p style="margin-top:30px;text-align:center">æŠ¥å‘ŠID:'+reportID+'</p></body></html>';

return {
  json: {
    success: true,
    reportID,
    htmlContent: html,
    createTime: new Date().toISOString()
  }
};
```

---

## èŠ‚ç‚¹7ï¸âƒ£ï¼šRespondReportï¼ˆå“åº”æŠ¥å‘Šï¼‰

**æ“ä½œ**ï¼šç‚¹å‡»GenerateReportåçš„ "+" â†’ æœç´¢ "Respond to Webhook" â†’ æ·»åŠ 

**èŠ‚ç‚¹åç§°**ï¼š`RespondReport`

**é…ç½®**ï¼š
- Respond With: `JSON`
- Response Body: `={{$json}}`

---

## èŠ‚ç‚¹8ï¸âƒ£ï¼šGetDialoguesï¼ˆè·å–å¯¹è¯åˆ—è¡¨ï¼‰

**æ“ä½œ**ï¼šå›åˆ°SwitchèŠ‚ç‚¹ï¼Œç‚¹å‡»ç¬¬3ä¸ªè¾“å‡ºåçš„ "+" â†’ æœç´¢ "Code" â†’ æ·»åŠ 

**èŠ‚ç‚¹åç§°**ï¼š`GetDialogues`

**JavaScriptä»£ç **ï¼š
```javascript
return {
  json: {
    success: true,
    dialogues: []
  }
};
```

---

## èŠ‚ç‚¹9ï¸âƒ£ï¼šRespondListï¼ˆå“åº”åˆ—è¡¨ï¼‰

**æ“ä½œ**ï¼šç‚¹å‡»GetDialoguesåçš„ "+" â†’ æœç´¢ "Respond to Webhook" â†’ æ·»åŠ 

**èŠ‚ç‚¹åç§°**ï¼š`RespondList`

**é…ç½®**ï¼š
- Respond With: `JSON`
- Response Body: `={{$json}}`

---

## âœ… å®Œæˆæ£€æŸ¥

åˆ›å»ºå®Œæˆåï¼Œä½ çš„å·¥ä½œæµåº”è¯¥æœ‰ï¼š

```
Webhook 
  â†’ Router 
    â†’ Switch 
      â”œâ”€ [sendMessage] â†’ ProcessMessage â†’ RespondMessage
      â”œâ”€ [generateReport] â†’ GenerateReport â†’ RespondReport
      â””â”€ [getDialogueList] â†’ GetDialogues â†’ RespondList
```

**æ€»è®¡ï¼š9ä¸ªèŠ‚ç‚¹**

---

## ğŸš€ æ¿€æ´»å’Œæµ‹è¯•

1. ç‚¹å‡»å³ä¸Šè§’ **"Active"** å¼€å…³ï¼ˆå˜æˆç»¿è‰²ï¼‰
2. ç‚¹å‡»WebhookèŠ‚ç‚¹
3. å¤åˆ¶ **"Production URL"**ï¼ˆä¾‹å¦‚ï¼š`https://your-n8n.com/webhook/ai-analysis`ï¼‰
4. åœ¨å‰ç«¯ç•Œé¢é…ç½®è¿™ä¸ªURL
5. å¼€å§‹æµ‹è¯•ï¼

---

## ğŸ§ª æµ‹è¯•å‘½ä»¤

### æµ‹è¯•1ï¼šå‘é€æ¶ˆæ¯
```bash
curl -X POST YOUR_WEBHOOK_URL \
  -H "Content-Type: application/json" \
  -d '{
    "action": "sendMessage",
    "userID": "user_001",
    "content": "æˆ‘æƒ³å¯¹æ¯”å¤–è§‚å’Œå†…é¥°"
  }'
```

### æµ‹è¯•2ï¼šç”ŸæˆæŠ¥å‘Š
```bash
curl -X POST YOUR_WEBHOOK_URL \
  -H "Content-Type: application/json" \
  -d '{
    "action": "generateReport",
    "userID": "user_001",
    "tags": ["å¤–è§‚","å†…é¥°"],
    "vehicles": [{"name":"ææ°ª009"},{"name":"å°é¹X9"}]
  }'
```

### æµ‹è¯•3ï¼šè·å–å¯¹è¯åˆ—è¡¨
```bash
curl -X POST YOUR_WEBHOOK_URL \
  -H "Content-Type: application/json" \
  -d '{
    "action": "getDialogueList",
    "userID": "user_001"
  }'
```

---

## ğŸ’¡ æç¤º

- **æ¯åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹åå¯ä»¥ç‚¹å‡» "Test Node" æµ‹è¯•**
- **CodeèŠ‚ç‚¹å¯ä»¥æŸ¥çœ‹è¾“å‡ºæ•°æ®**
- **è¿æ¥èŠ‚ç‚¹æ—¶ï¼Œæ‹–åŠ¨èŠ‚ç‚¹å³ä¾§çš„åœ†ç‚¹åˆ°ä¸‹ä¸€ä¸ªèŠ‚ç‚¹**
- **SwitchèŠ‚ç‚¹ä¼šæœ‰3ä¸ªè¾“å‡ºç‚¹ï¼Œå¯¹åº”3æ¡è§„åˆ™**

**é¢„è®¡åˆ›å»ºæ—¶é—´ï¼š10åˆ†é’Ÿ** â±ï¸

**ä¸€å®šèƒ½æˆåŠŸï¼åŠ æ²¹ï¼** ğŸ’ª

