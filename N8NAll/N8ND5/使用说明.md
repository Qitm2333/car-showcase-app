# 汽车图片智能查询系统 - 使用说明

## 📁 文件清单

```
项目文件夹/
├── 汽车图片查询系统.html       # 前端页面
├── config.js                   # 配置文件 ⚙️
├── 整合工作流-输入车型获取图片.json  # n8n工作流
└── 使用说明.md                 # 本文件
```

---

## 🚀 快速开始

### 第一步：导入n8n工作流

1. 打开你的n8n实例
2. 点击右上角的 **"+"** → **"Import from File"**
3. 选择 `整合工作流-输入车型获取图片.json`
4. 确保Google Sheets凭证已配置
5. 激活工作流
6. 复制Webhook URL（通常是：`https://你的域名/webhook/get-car-images`）

### 第二步：打开HTML页面并配置

1. 双击打开 `汽车图片查询系统.html`
2. **点击右下角的⚙️按钮**打开调试配置面板
3. 在调试面板中配置你的webhook地址：
   - 填写生产环境URL或本地URL
   - 选择当前使用的环境
   - 设置超时时间
   - 调整调试选项
4. 点击"测试连接"按钮验证配置
5. 点击"保存配置"按钮保存到浏览器

**或者**手动编辑 `config.js` 文件（适合开发者）

### 第三步：开始使用

1. 双击打开 `汽车图片查询系统.html`
2. 或者使用本地服务器（推荐）：
   ```bash
   # 使用Python
   python -m http.server 8000
   
   # 使用Node.js
   npx http-server
   ```
3. 在浏览器中访问页面
4. 输入车型名称开始搜索！

---

## 🎨 调试面板使用指南

### 打开调试面板

点击页面右下角的**⚙️按钮**即可打开调试配置面板。

### 面板功能

#### 1️⃣ Webhook配置
- **环境选择**: 在生产环境和本地环境之间切换
- **生产环境URL**: 填写你的n8n服务器webhook地址
- **本地环境URL**: 填写本地开发地址（如localhost:5678）
- **请求超时**: 设置API请求超时时间（建议30秒以上）

#### 2️⃣ 调试选项
- **启用调试日志**: 在浏览器Console输出详细日志
- **显示详细错误**: 显示完整的错误信息和排查建议
- **使用模拟数据**: 不发送真实请求，使用预设的模拟数据（适合前端测试）
- **模拟延迟**: 设置模拟请求的延迟时间

#### 3️⃣ 快速操作
- **测试连接**: 发送测试请求验证webhook是否正常工作
- **保存配置**: 将当前配置保存到浏览器localStorage
- **重置配置**: 清除所有配置并重新加载页面
- **导出配置**: 将配置导出为JSON文件

#### 4️⃣ 配置预览
实时显示当前的配置状态，方便查看。

### 配置持久化

调试面板的配置会自动保存在浏览器的localStorage中，下次打开页面会自动加载。

---

## ⚙️ 配置详解

### Webhook配置

```javascript
webhook: {
    productionURL: 'https://你的n8n域名/webhook/get-car-images',
    localURL: 'http://localhost:5678/webhook/get-car-images',
    environment: 'production',  // 'production' 或 'local'
    timeout: 30000,            // 请求超时时间（毫秒）
    debug: true                // 是否输出调试信息
}
```

**说明：**
- `productionURL`: 部署后的n8n服务器地址
- `localURL`: 本地开发测试地址
- `environment`: 
  - 设为 `'production'` 使用 `productionURL`
  - 设为 `'local'` 使用 `localURL`
- `timeout`: 建议设置30秒以上（工作流需要时间处理）
- `debug`: 开启后会在浏览器控制台输出详细日志

### 界面配置

```javascript
ui: {
    exampleCars: [
        '奥迪A6L',
        '宝马X5',
        // ... 添加你的示例车型
    ],
    placeholder: '请输入车型名称...',
    autoFocusInput: true,
    messageAutoHideDelay: 5000
}
```

**说明：**
- `exampleCars`: 快速搜索的示例车型列表
- `placeholder`: 输入框提示文字
- `autoFocusInput`: 页面加载时是否自动聚焦输入框
- `messageAutoHideDelay`: 成功消息自动隐藏时间（毫秒）

### 调试配置

```javascript
debug: {
    logAPIRequests: true,      // 是否记录API请求日志
    showDetailedErrors: true,  // 是否显示详细错误信息
    useMockData: false,        // 是否使用模拟数据
    mockDelay: 2000            // 模拟延迟时间
}
```

**测试模式：**
如果你想在没有n8n服务器的情况下测试前端，可以：
```javascript
debug: {
    useMockData: true  // 启用模拟数据模式
}
```
这样就会使用预设的模拟数据，不发送真实请求。

---

## 🔧 调试指南

### 1. 检查配置

打开浏览器，按 `F12` 打开开发者工具，查看Console：

```
[汽车查询] ========================================
[汽车查询] 汽车图片查询系统配置信息
[汽车查询] ========================================
[汽车查询] Webhook URL: https://...
[汽车查询] 环境: production
[汽车查询] 调试模式: 开启
[汽车查询] 模拟数据: 关闭
[汽车查询] ========================================
[汽车查询] ✅ 配置验证通过
```

### 2. 测试连接

**步骤1：测试n8n webhook**
```bash
curl -X POST https://你的n8n域名/webhook/get-car-images \
  -H "Content-Type: application/json" \
  -d '{"carName": "奥迪A6L"}'
```

如果返回JSON数据，说明工作流正常。

**步骤2：在HTML页面测试**
1. 打开页面
2. 输入 "奥迪A6L"
3. 点击搜索
4. 查看Console日志

### 3. 常见问题

#### 问题1：请求失败 - CORS错误
**错误信息：**
```
Access to fetch at '...' from origin '...' has been blocked by CORS policy
```

**解决方法：**
在n8n的Webhook节点中：
1. 打开 "Respond" 节点设置
2. 添加Response Headers：
   - Name: `Access-Control-Allow-Origin`
   - Value: `*`

或者使用浏览器插件临时禁用CORS（仅用于开发测试）。

#### 问题2：请求超时
**错误信息：**
```
请求超时（30000ms）
```

**解决方法：**
在 `config.js` 中增加超时时间：
```javascript
webhook: {
    timeout: 60000  // 增加到60秒
}
```

#### 问题3：返回404
**错误信息：**
```
HTTP错误！状态码: 404
```

**解决方法：**
1. 检查webhook URL是否正确
2. 确认n8n工作流已激活
3. 检查webhook路径是否匹配

#### 问题4：配置未生效
**症状：**
修改了config.js但页面没有变化

**解决方法：**
1. 硬刷新页面（Ctrl + F5 或 Cmd + Shift + R）
2. 清除浏览器缓存
3. 检查config.js是否有语法错误（Console会报错）

---

## 📊 工作流程说明

```
用户输入车型名称
    ↓
前端发送POST请求到n8n
    ↓
n8n工作流处理：
  1. 从Google Sheet模糊匹配车型
  2. 如果匹配失败，使用SerpAPI搜索
  3. 获取carID
  4. 爬取汽车之家图片页面
  5. 提取7张精选图片（外观4+内饰2+座椅1）
    ↓
返回JSON结果给前端
    ↓
前端展示图片
```

---

## 🎨 自定义配置示例

### 示例1：本地开发配置

```javascript
// config.js
const APP_CONFIG = {
    webhook: {
        productionURL: 'https://n8n.example.com/webhook/get-car-images',
        localURL: 'http://localhost:5678/webhook/get-car-images',
        environment: 'local',  // 使用本地环境
        timeout: 60000,
        debug: true
    },
    debug: {
        logAPIRequests: true,
        showDetailedErrors: true,
        useMockData: false
    }
};
```

### 示例2：纯前端测试（不需要n8n）

```javascript
// config.js
const APP_CONFIG = {
    webhook: {
        environment: 'production',
        debug: true
    },
    debug: {
        useMockData: true,     // 启用模拟数据
        mockDelay: 1000,       // 快速响应
        logAPIRequests: true
    }
};
```

### 示例3：生产环境配置

```javascript
// config.js
const APP_CONFIG = {
    webhook: {
        productionURL: 'https://n8n.yourcompany.com/webhook/get-car-images',
        environment: 'production',
        timeout: 45000,
        debug: false  // 关闭调试日志
    },
    debug: {
        logAPIRequests: false,
        showDetailedErrors: false,
        useMockData: false
    }
};
```

---

## 📝 API数据格式

### 请求格式
```json
{
  "carName": "奥迪A6L"
}
```

### 响应格式
```json
{
  "success": true,
  "carId": "3170",
  "carName": "奥迪A6L",
  "brandID": "33",
  "matchType": "googlesheet_fuzzy_match",
  "totalImages": 7,
  "categorySummary": {
    "外观": 4,
    "内饰": 2,
    "座椅": 1
  },
  "images": [
    {
      "url": "https://...",
      "category": "外观",
      "view_type": "view45",
      "index": 1
    }
  ],
  "message": "成功获取7张图片",
  "timestamp": "2025-11-01T..."
}
```

---

## 🛠️ 技术栈

- **前端**: HTML5 + CSS3 + Vanilla JavaScript
- **后端**: n8n (无代码工作流自动化)
- **数据源**: 
  - Google Sheets (车型数据库)
  - 汽车之家 (图片来源)
  - SerpAPI (备用搜索)

---

## 📞 常见操作

### 修改示例车型

编辑 `config.js`：
```javascript
ui: {
    exampleCars: [
        '你的车型1',
        '你的车型2',
        '你的车型3'
    ]
}
```

### 修改超时时间

编辑 `config.js`：
```javascript
webhook: {
    timeout: 45000  // 45秒
}
```

### 切换环境

编辑 `config.js`：
```javascript
webhook: {
    environment: 'local'  // 或 'production'
}
```

### 启用/禁用日志

编辑 `config.js`：
```javascript
webhook: {
    debug: false  // 关闭
}
```

---

## ✅ 完成检查清单

配置前请确保：

- [ ] n8n服务器正常运行
- [ ] 工作流已导入并激活
- [ ] Google Sheets凭证已配置
- [ ] 已复制正确的webhook URL
- [ ] 在config.js中填写了webhook URL
- [ ] 浏览器支持ES6+（推荐Chrome、Firefox、Edge）

---

## 🎉 享受使用！

如有问题，请检查：
1. 浏览器Console (F12)
2. n8n工作流执行日志
3. 网络请求（Network标签）

祝使用愉快！🚗✨

