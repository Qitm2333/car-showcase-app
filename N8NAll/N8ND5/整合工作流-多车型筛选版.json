{
  "name": "æ•´åˆå·¥ä½œæµ-å¤šè½¦å‹ç­›é€‰ç‰ˆ",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "get-car-images",
        "responseMode": "responseNode",
        "options": {
          "rawBody": false
        }
      },
      "id": "webhook-start",
      "name": "Webhookè§¦å‘",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [500, 500],
      "webhookId": "get-car-images"
    },
    {
      "parameters": {
        "keepOnlySet": true,
        "values": {
          "string": [
            {
              "name": "carNames",
              "value": "={{ $json.body.carNames || [$json.body.carName] }}"
            },
            {
              "name": "filterCategory",
              "value": "={{ $json.body.filterCategory || 'all' }}"
            },
            {
              "name": "filterViewType",
              "value": "={{ $json.body.filterViewType || 'all' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "extract-carname",
      "name": "æå–è½¦å‹åç§°",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [720, 500]
    },
    {
      "parameters": {
        "jsCode": "// å‡†å¤‡æŸ¥è¯¢ - æ”¯æŒå¤šè½¦å‹\nconst carNamesInput = $input.first().json.carNames;\nconst carNames = Array.isArray(carNamesInput) ? carNamesInput : (carNamesInput ? [carNamesInput] : []);\n\nif (carNames.length === 0) {\n  return {\n    json: {\n      success: false,\n      error: 'è¯·æä¾›è½¦å‹åç§°',\n      code: 'CAR_NAME_REQUIRED'\n    }\n  };\n}\n\nconsole.log(`å‡†å¤‡æŸ¥è¯¢ ${carNames.length} ä¸ªè½¦å‹:`, carNames);\n\n// ä¸ºæ¯ä¸ªè½¦å‹åˆ›å»ºä¸€ä¸ªitem\nreturn carNames.map(carName => ({\n  json: {\n    carName: carName.trim(),\n    filterCategory: $input.first().json.filterCategory || 'all',\n    filterViewType: $input.first().json.filterViewType || 'all'\n  }\n}));"
      },
      "id": "prepare-query",
      "name": "å‡†å¤‡æŸ¥è¯¢",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [940, 500]
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet"
        },
        "sheetName": {
          "__rl": true,
          "value": 1837650523,
          "mode": "list",
          "cachedResultName": "NewallCarMappingå®Œæ•´"
        },
        "options": {}
      },
      "id": "read-google-sheet",
      "name": "è¯»å–Google Sheet",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [1160, 500],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YS5a72jpKHezwxcc",
          "name": "Google Sheets account 5"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// æ¨¡ç³ŠåŒ¹é…ç®—æ³•\nconst inputCarName = $('å‡†å¤‡æŸ¥è¯¢').first().json.carName;\nconst allCars = $input.all();\n\nconst MATCH_THRESHOLD = 0.70;\n\nconsole.log(`\\n===== å¼€å§‹æ¨¡ç³ŠåŒ¹é… =====`);\nconsole.log(`è¾“å…¥è½¦å‹: ${inputCarName}`);\nconsole.log(`æ•°æ®åº“æ€»æ•°: ${allCars.length}`);\n\n// å­—ç¬¦ä¸²ç›¸ä¼¼åº¦ç®—æ³•\nfunction levenshteinDistance(str1, str2) {\n  const len1 = str1.length;\n  const len2 = str2.length;\n  const matrix = [];\n\n  for (let i = 0; i <= len1; i++) {\n    matrix[i] = [i];\n  }\n  for (let j = 0; j <= len2; j++) {\n    matrix[0][j] = j;\n  }\n\n  for (let i = 1; i <= len1; i++) {\n    for (let j = 1; j <= len2; j++) {\n      const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;\n      matrix[i][j] = Math.min(\n        matrix[i - 1][j] + 1,\n        matrix[i][j - 1] + 1,\n        matrix[i - 1][j - 1] + cost\n      );\n    }\n  }\n\n  return matrix[len1][len2];\n}\n\nfunction levenshteinSimilarity(str1, str2) {\n  const maxLen = Math.max(str1.length, str2.length);\n  if (maxLen === 0) return 1.0;\n  const distance = levenshteinDistance(str1, str2);\n  return 1 - distance / maxLen;\n}\n\nfunction jaroWinklerSimilarity(s1, s2) {\n  function jaroSimilarity(s1, s2) {\n    if (s1.length === 0 && s2.length === 0) return 1.0;\n    if (s1.length === 0 || s2.length === 0) return 0.0;\n\n    const matchDistance = Math.floor(Math.max(s1.length, s2.length) / 2) - 1;\n    const s1Matches = new Array(s1.length).fill(false);\n    const s2Matches = new Array(s2.length).fill(false);\n\n    let matches = 0;\n    let transpositions = 0;\n\n    for (let i = 0; i < s1.length; i++) {\n      const start = Math.max(0, i - matchDistance);\n      const end = Math.min(i + matchDistance + 1, s2.length);\n\n      for (let j = start; j < end; j++) {\n        if (s2Matches[j] || s1[i] !== s2[j]) continue;\n        s1Matches[i] = true;\n        s2Matches[j] = true;\n        matches++;\n        break;\n      }\n    }\n\n    if (matches === 0) return 0.0;\n\n    let k = 0;\n    for (let i = 0; i < s1.length; i++) {\n      if (!s1Matches[i]) continue;\n      while (!s2Matches[k]) k++;\n      if (s1[i] !== s2[k]) transpositions++;\n      k++;\n    }\n\n    return (\n      (matches / s1.length +\n        matches / s2.length +\n        (matches - transpositions / 2) / matches) /\n      3\n    );\n  }\n\n  const jaro = jaroSimilarity(s1, s2);\n  const prefixLength = Math.min(4, s1.length, s2.length);\n  let prefix = 0;\n  for (let i = 0; i < prefixLength; i++) {\n    if (s1[i] === s2[i]) prefix++;\n    else break;\n  }\n\n  return jaro + prefix * 0.1 * (1 - jaro);\n}\n\nfunction containsMatch(input, target) {\n  const inputLower = input.toLowerCase();\n  const targetLower = target.toLowerCase();\n  \n  if (targetLower.includes(inputLower) || inputLower.includes(targetLower)) {\n    return 1.0;\n  }\n  \n  const inputTokens = inputLower.split(/[\\s\\-]+/);\n  const targetTokens = targetLower.split(/[\\s\\-]+/);\n  \n  let matchCount = 0;\n  for (const inputToken of inputTokens) {\n    if (inputToken.length < 2) continue;\n    for (const targetToken of targetTokens) {\n      if (targetToken.includes(inputToken) || inputToken.includes(targetToken)) {\n        matchCount++;\n        break;\n      }\n    }\n  }\n  \n  return inputTokens.length > 0 ? matchCount / inputTokens.length : 0;\n}\n\nfunction brandModelMatch(input, target) {\n  const inputParts = input.split(/[-\\s]+/);\n  const targetParts = target.split(/[-\\s]+/);\n  \n  if (inputParts.length < 2 || targetParts.length < 2) {\n    return 0;\n  }\n  \n  const brandMatch = inputParts[0].toLowerCase() === targetParts[0].toLowerCase() ? 1 : 0;\n  const modelSimilarity = levenshteinSimilarity(\n    inputParts.slice(1).join('').toLowerCase(),\n    targetParts.slice(1).join('').toLowerCase()\n  );\n  \n  return brandMatch && modelSimilarity >= 0.6 ? (brandMatch + modelSimilarity) / 2 : 0;\n}\n\nfunction calculateComprehensiveScore(input, target) {\n  const inputNorm = input.replace(/\\s+/g, '').toLowerCase();\n  const targetNorm = target.replace(/\\s+/g, '').toLowerCase();\n  \n  const inputClean = input.replace(/[\\s\\-]/g, '').toLowerCase();\n  const targetClean = target.replace(/[\\s\\-]/g, '').toLowerCase();\n  const isFullyContained = targetClean.includes(inputClean) && inputClean.length >= 3;\n  \n  const levenScore = levenshteinSimilarity(inputNorm, targetNorm);\n  const jaroScore = jaroWinklerSimilarity(inputNorm, targetNorm);\n  const containsScore = containsMatch(input, target);\n  const brandModelScore = brandModelMatch(input, target);\n  \n  const weights = {\n    levenshtein: 0.25,\n    jaroWinkler: 0.25,\n    contains: 0.30,\n    brandModel: 0.20\n  };\n  \n  let finalScore = \n    levenScore * weights.levenshtein +\n    jaroScore * weights.jaroWinkler +\n    containsScore * weights.contains +\n    brandModelScore * weights.brandModel;\n  \n  if (isFullyContained) {\n    finalScore = Math.max(finalScore, 0.88);\n  }\n  \n  return {\n    finalScore: finalScore,\n    details: {\n      levenshtein: levenScore.toFixed(3),\n      jaroWinkler: jaroScore.toFixed(3),\n      contains: containsScore.toFixed(3),\n      brandModel: brandModelScore.toFixed(3)\n    }\n  };\n}\n\nconst matches = [];\n\nfor (const car of allCars) {\n  const carName = car.json.carName || '';\n  const carID = car.json.carID;\n  const brandID = car.json.brandID;\n  \n  if (!carName || !carID) continue;\n  \n  const scoreResult = calculateComprehensiveScore(inputCarName, carName);\n  \n  matches.push({\n    carName: carName,\n    carID: carID,\n    brandID: brandID,\n    vehicleClass: car.json.vehicleClass,\n    priceRange: car.json.carPriceRange,\n    score: scoreResult.finalScore,\n    scoreDetails: scoreResult.details\n  });\n}\n\nmatches.sort((a, b) => b.score - a.score);\n\nconsole.log(`\\nå‰5ä¸ªåŒ¹é…ç»“æœ:`);\nmatches.slice(0, 5).forEach((match, index) => {\n  console.log(`${index + 1}. ${match.carName} - ç›¸ä¼¼åº¦: ${(match.score * 100).toFixed(1)}%`);\n});\n\nconst bestMatch = matches[0];\n\nif (bestMatch && bestMatch.score >= MATCH_THRESHOLD) {\n  console.log(`\\nâœ… åŒ¹é…æˆåŠŸï¼`);\n  console.log(`è¾“å…¥: ${inputCarName}`);\n  console.log(`åŒ¹é…: ${bestMatch.carName}`);\n  console.log(`ç›¸ä¼¼åº¦: ${(bestMatch.score * 100).toFixed(1)}%`);\n  console.log(`carID: ${bestMatch.carID}`);\n  \n  return {\n    json: {\n      needsSearch: false,\n      resolved: true,\n      carId: bestMatch.carID,\n      carName: bestMatch.carName,\n      brandID: bestMatch.brandID,\n      matchType: 'googlesheet_fuzzy_match',\n      similarityScore: bestMatch.score,\n      inputCarName: inputCarName\n    }\n  };\n}\n\nconsole.log(`\\nâš ï¸ æœªæ‰¾åˆ°æ»¡è¶³é˜ˆå€¼çš„åŒ¹é…ï¼Œé™çº§åˆ°SerpAPIæœç´¢`);\n\nreturn {\n  json: {\n    needsSearch: true,\n    carName: inputCarName,\n    inputCarName: inputCarName,\n    matchType: 'low_similarity',\n    bestMatchScore: bestMatch?.score || 0\n  }\n};"
      },
      "id": "fuzzy-match",
      "name": "æ¨¡ç³ŠåŒ¹é…åˆ†æ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1380, 500]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.needsSearch }}",
              "value2": true
            }
          ]
        }
      },
      "id": "check-needs-search",
      "name": "æ£€æŸ¥æ˜¯å¦éœ€è¦æœç´¢",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [1600, 500]
    },
    {
      "parameters": {
        "url": "=https://serpapi.com/search.json?engine=google&q=site:autohome.com.cn+{{ $json.carName }}&api_key=c6805b62d6f0757df69b7b0f41e27570c6b8989caec90d8356e455cf76794514",
        "options": {
          "redirect": {
            "redirect": {
              "followRedirects": true,
              "maxRedirects": 5
            }
          },
          "response": {
            "response": {
              "responseFormat": "json"
            }
          },
          "timeout": 15000
        }
      },
      "id": "search-serp",
      "name": "SerpAPIæœç´¢",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [1820, 400],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "const carName = $('æ£€æŸ¥æ˜¯å¦éœ€è¦æœç´¢').first().json.carName;\nconst inputCarName = $('æ£€æŸ¥æ˜¯å¦éœ€è¦æœç´¢').first().json.inputCarName;\nconst response = $input.item.json;\n\nconsole.log('===== SerpAPIå“åº” =====');\nconsole.log('è½¦å‹åç§°:', carName);\n\nconst organicResults = response.organic_results || [];\nconsole.log('æ‰¾åˆ°', organicResults.length, 'ä¸ªæœç´¢ç»“æœ');\n\nlet carId = null;\n\nfor (const result of organicResults) {\n  const link = result.link || '';\n  console.log('æ£€æŸ¥é“¾æ¥:', link);\n  \n  const patterns = [\n    /autohome\\.com\\.cn\\/(\\d{2,5})\\/?/,\n    /series-(\\d{2,5})\\.html/,\n    /config\\/series\\/(\\d{2,5})/\n  ];\n  \n  for (const pattern of patterns) {\n    const match = link.match(pattern);\n    if (match && match[1]) {\n      carId = match[1];\n      console.log('âœ… æ‰¾åˆ°carId:', carId);\n      break;\n    }\n  }\n  \n  if (carId) break;\n}\n\nif (carId && /^\\d{2,5}$/.test(carId)) {\n  console.log('âœ… æˆåŠŸæå–carId:', carId);\n  return {\n    json: {\n      carId: carId,\n      carName: carName,\n      inputCarName: inputCarName,\n      matchType: 'serpapi_search',\n      resolved: true\n    }\n  };\n}\n\nconsole.log('âŒ æœªèƒ½ä»æœç´¢ç»“æœä¸­æå–carId');\nreturn {\n  json: {\n    success: false,\n    error: 'æœªèƒ½ä»æœç´¢ç»“æœä¸­æå–carId',\n    code: 'EXTRACTION_FAILED',\n    carName: carName,\n    inputCarName: inputCarName\n  }\n};"
      },
      "id": "process-serp",
      "name": "å¤„ç†SerpAPIå“åº”",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2040, 400]
    },
    {
      "parameters": {
        "mode": "append",
        "options": {}
      },
      "id": "merge-carid",
      "name": "åˆå¹¶carIDç»“æœ",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [2260, 500]
    },
    {
      "parameters": {
        "url": "=https://www.autohome.com.cn/cars/imglist-x-x-{{ $json.carId }}-x-x-x-x-x-x-1.html",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0"
            }
          ]
        },
        "options": {
          "allowUnauthorizedCerts": true,
          "timeout": 15000
        }
      },
      "id": "request-page",
      "name": "è¯·æ±‚å›¾ç‰‡é¡µé¢",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2480, 500],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// æå–å¤–è§‚ã€å†…é¥°ã€åº§æ¤…å›¾ç‰‡\nconst inputData = $input.first().json;\n\n// ä»ä¸Šæ¸¸èŠ‚ç‚¹è·å–è½¦å‹ä¿¡æ¯\nconst carInfo = {\n  carId: $('åˆå¹¶carIDç»“æœ').item.json.carId,\n  carName: $('åˆå¹¶carIDç»“æœ').item.json.carName,\n  inputCarName: $('åˆå¹¶carIDç»“æœ').item.json.inputCarName,\n  brandID: $('åˆå¹¶carIDç»“æœ').item.json.brandID,\n  matchType: $('åˆå¹¶carIDç»“æœ').item.json.matchType\n};\n\nconsole.log('å¤„ç†è½¦å‹:', carInfo.carName, '(ID:', carInfo.carId, ')');\n\nlet htmlContent = '';\nif (inputData.data) {\n  htmlContent = inputData.data;\n} else if (typeof inputData === 'string') {\n  htmlContent = inputData;\n} else {\n  console.log('æ— æ³•æ‰¾åˆ°HTMLå†…å®¹');\n  return [{ json: { ...carInfo, error: 'æ•°æ®æ ¼å¼é”™è¯¯' } }];\n}\n\nconsole.log('HTMLé•¿åº¦:', htmlContent.length);\n\nconst scriptMatch = htmlContent.match(/<script id=\"__NEXT_DATA__\"[^>]*>(.*?)<\\/script>/);\n\nif (!scriptMatch) {\n  console.log('æœªæ‰¾åˆ°__NEXT_DATA__æ ‡ç­¾');\n  return [{ json: { ...carInfo, error: 'æœªæ‰¾åˆ°JSONæ•°æ®' } }];\n}\n\ntry {\n  const jsonData = JSON.parse(scriptMatch[1]);\n  console.log('æˆåŠŸè§£æJSONæ•°æ®');\n  \n  const picinfo = jsonData.props?.pageProps?.SeriesPicList?.picinfo;\n  \n  if (!picinfo || !picinfo.callist) {\n    console.log('æœªæ‰¾åˆ°å›¾ç‰‡åˆ†ç±»åˆ—è¡¨');\n    return [{ json: { ...carInfo, error: 'æœªæ‰¾åˆ°å›¾ç‰‡åˆ†ç±»' } }];\n  }\n  \n  console.log('æ‰¾åˆ°å›¾ç‰‡åˆ†ç±»åˆ—è¡¨ï¼Œæ•°é‡:', picinfo.callist.length);\n  \n  const imageList = [];\n  \n  // æå–å¤–è§‚å›¾ç‰‡\n  const waiGuanClass = picinfo.callist.find(item => item.name === 'å¤–è§‚');\n  \n  if (waiGuanClass && waiGuanClass.list && waiGuanClass.list.length > 0) {\n    console.log('å¤–è§‚å›¾ç‰‡æ€»æ•°:', waiGuanClass.list.length);\n    \n    const waiGuanViewTypes = ['view45', 'viewFront', 'view-45', 'viewSide'];\n    const waiGuanCount = Math.min(4, waiGuanClass.list.length);\n    \n    for (let i = 0; i < waiGuanCount; i++) {\n      const pic = waiGuanClass.list[i];\n      \n      imageList.push({\n        ...carInfo,\n        image_url: pic.picpath,\n        image_index: i + 1,\n        category: 'å¤–è§‚',\n        view_type: waiGuanViewTypes[i],\n        pic_id: pic.picid,\n        spec_id: pic.specid\n      });\n    }\n  }\n  \n  // æå–å†…é¥°å›¾ç‰‡\n  const neiShiClass = picinfo.callist.find(item => item.name === 'å†…é¥°');\n  \n  if (neiShiClass && neiShiClass.list && neiShiClass.list.length > 0) {\n    console.log('å†…é¥°å›¾ç‰‡æ€»æ•°:', neiShiClass.list.length);\n    \n    const neiShiIndexes = [0, 5];\n    const neiShiViewTypes = ['viewCNSL', 'viewIP'];\n    \n    for (let i = 0; i < neiShiIndexes.length; i++) {\n      const index = neiShiIndexes[i];\n      \n      if (index < neiShiClass.list.length) {\n        const pic = neiShiClass.list[index];\n        \n        imageList.push({\n          ...carInfo,\n          image_url: pic.picpath,\n          image_index: 4 + i + 1,\n          category: 'å†…é¥°',\n          view_type: neiShiViewTypes[i],\n          pic_id: pic.picid,\n          spec_id: pic.specid\n        });\n      }\n    }\n  }\n  \n  // æå–åº§æ¤…å›¾ç‰‡\n  const zuoYiClass = picinfo.callist.find(item => item.name === 'åº§æ¤…');\n  \n  if (zuoYiClass && zuoYiClass.list && zuoYiClass.list.length > 0) {\n    console.log('åº§æ¤…å›¾ç‰‡æ€»æ•°:', zuoYiClass.list.length);\n    \n    const zuoYiIndex = 2;\n    \n    if (zuoYiIndex < zuoYiClass.list.length) {\n      const pic = zuoYiClass.list[zuoYiIndex];\n      \n      imageList.push({\n        ...carInfo,\n        image_url: pic.picpath,\n        image_index: 7,\n        category: 'åº§æ¤…',\n        view_type: 'viewDoor',\n        pic_id: pic.picid,\n        spec_id: pic.specid\n      });\n    }\n  }\n  \n  // ğŸ”¥ è·å–ç­›é€‰å‚æ•°\n  const filterCategory = $('å‡†å¤‡æŸ¥è¯¢').first().json.filterCategory || 'all';\n  const filterViewType = $('å‡†å¤‡æŸ¥è¯¢').first().json.filterViewType || 'all';\n  \n  console.log(`ç­›é€‰å‚æ•° - åˆ†ç±»: ${filterCategory}, è§†è§’: ${filterViewType}`);\n  \n  let filteredImages = imageList;\n  \n  // æŒ‰åˆ†ç±»ç­›é€‰\n  if (filterCategory !== 'all') {\n    filteredImages = filteredImages.filter(img => img.category === filterCategory);\n    console.log(`æŒ‰åˆ†ç±»ç­›é€‰å: ${filteredImages.length} å¼ `);\n  }\n  \n  // æŒ‰è§†è§’ç­›é€‰\n  if (filterViewType !== 'all') {\n    filteredImages = filteredImages.filter(img => img.view_type === filterViewType);\n    console.log(`æŒ‰è§†è§’ç­›é€‰å: ${filteredImages.length} å¼ `);\n  }\n  \n  console.log(`æœ€ç»ˆè¿”å›: ${filteredImages.length} å¼ å›¾ç‰‡`);\n  \n  if (filteredImages.length === 0) {\n    console.log('æœªæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„å›¾ç‰‡');\n    return [{ \n      json: { \n        ...carInfo, \n        error: 'æœªæ‰¾åˆ°ç¬¦åˆç­›é€‰æ¡ä»¶çš„å›¾ç‰‡',\n        totalImages: 0,\n        images: []\n      } \n    }];\n  }\n  \n  return filteredImages.map(img => ({ json: img }));\n  \n} catch (error) {\n  console.log('è§£æJSONå‡ºé”™:', error.message);\n  return [{ json: { ...carInfo, error: 'JSONè§£æå¤±è´¥: ' + error.message } }];\n}"
      },
      "id": "extract-images",
      "name": "æå–å›¾ç‰‡ä¿¡æ¯",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2700, 500],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// åˆå¹¶æ‰€æœ‰å›¾ç‰‡ä¸ºæœ€ç»ˆç»“æœ\nconst allImages = $input.all();\n\nif (allImages.length === 0) {\n  return {\n    json: {\n      success: false,\n      error: 'æœªæ‰¾åˆ°ä»»ä½•å›¾ç‰‡',\n      message: 'æœªèƒ½æå–åˆ°å›¾ç‰‡ä¿¡æ¯'\n    }\n  };\n}\n\nconst firstImage = allImages[0].json;\n\n// æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯\nif (firstImage.error) {\n  return {\n    json: {\n      success: false,\n      error: firstImage.error,\n      carId: firstImage.carId,\n      carName: firstImage.carName,\n      inputCarName: firstImage.inputCarName\n    }\n  };\n}\n\n// æŒ‰åˆ†ç±»ç»Ÿè®¡\nconst categorySummary = {};\nconst images = [];\n\nfor (const item of allImages) {\n  const img = item.json;\n  images.push({\n    url: img.image_url,\n    category: img.category,\n    view_type: img.view_type,\n    index: img.image_index,\n    pic_id: img.pic_id,\n    spec_id: img.spec_id\n  });\n  \n  if (!categorySummary[img.category]) {\n    categorySummary[img.category] = 0;\n  }\n  categorySummary[img.category]++;\n}\n\nconsole.log('\\n=== å›¾ç‰‡æå–å®Œæˆ ===');\nconsole.log(`è½¦å‹: ${firstImage.carName}`);\nconsole.log(`carID: ${firstImage.carId}`);\nconsole.log(`åŒ¹é…æ–¹å¼: ${firstImage.matchType}`);\nconsole.log(`æ€»å›¾ç‰‡æ•°: ${images.length}`);\nconsole.log('åˆ†ç±»ç»Ÿè®¡:', categorySummary);\n\nreturn {\n  json: {\n    success: true,\n    carId: firstImage.carId,\n    carName: firstImage.carName,\n    inputCarName: firstImage.inputCarName,\n    brandID: firstImage.brandID,\n    matchType: firstImage.matchType,\n    totalImages: images.length,\n    categorySummary: categorySummary,\n    images: images,\n    message: `æˆåŠŸè·å–${images.length}å¼ å›¾ç‰‡`,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "merge-results",
      "name": "åˆå¹¶æœ€ç»ˆç»“æœ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2920, 500]
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "destinationFieldName": "data",
        "options": {}
      },
      "id": "aggregate-node",
      "name": "Aggregate",
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [3100, 500]
    },
    {
      "parameters": {
        "jsCode": "// æ ¼å¼åŒ–å¤šè½¦å‹ç»“æœ\nconst inputData = $input.first().json;\n\n// è·å–èšåˆçš„æ•°æ®\nconst allResults = inputData.data || [];\n\nconsole.log(`å¤„ç† ${allResults.length} ä¸ªè½¦å‹çš„ç»“æœ`);\n\nif (allResults.length === 0) {\n  return {\n    json: {\n      success: false,\n      error: 'æœªæ‰¾åˆ°ä»»ä½•è½¦å‹',\n      results: []\n    }\n  };\n}\n\nif (allResults.length === 1) {\n  // å•è½¦å‹ï¼Œç›´æ¥è¿”å›åŸå§‹æ ¼å¼\n  console.log('å•è½¦å‹ç»“æœï¼Œç›´æ¥è¿”å›');\n  return {\n    json: allResults[0]\n  };\n} else {\n  // å¤šè½¦å‹ï¼ŒåŒ…è£…æˆresultsæ•°ç»„\n  console.log(`å¤šè½¦å‹ç»“æœï¼Œè¿”å›${allResults.length}ä¸ªè½¦å‹`);\n  \n  let totalImages = 0;\n  let successCars = 0;\n  \n  allResults.forEach(car => {\n    if (car.success !== false && car.images) {\n      totalImages += car.images.length;\n      successCars++;\n    }\n  });\n  \n  return {\n    json: {\n      results: allResults,\n      totalCars: allResults.length,\n      successCars: successCars,\n      totalImages: totalImages,\n      message: `æˆåŠŸåŒ¹é…${successCars}/${allResults.length}ä¸ªè½¦å‹ï¼Œå…±${totalImages}å¼ å›¾ç‰‡`,\n      timestamp: new Date().toISOString()\n    }\n  };\n}"
      },
      "id": "format-results",
      "name": "æ ¼å¼åŒ–å¤šè½¦å‹ç»“æœ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3280, 500]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "respond-webhook",
      "name": "è¿”å›å“åº”",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [3460, 500]
    }
  ],
  "connections": {
    "Webhookè§¦å‘": {
      "main": [[{"node": "æå–è½¦å‹åç§°", "type": "main", "index": 0}]]
    },
    "æå–è½¦å‹åç§°": {
      "main": [[{"node": "å‡†å¤‡æŸ¥è¯¢", "type": "main", "index": 0}]]
    },
    "å‡†å¤‡æŸ¥è¯¢": {
      "main": [[{"node": "è¯»å–Google Sheet", "type": "main", "index": 0}]]
    },
    "è¯»å–Google Sheet": {
      "main": [[{"node": "æ¨¡ç³ŠåŒ¹é…åˆ†æ", "type": "main", "index": 0}]]
    },
    "æ¨¡ç³ŠåŒ¹é…åˆ†æ": {
      "main": [[{"node": "æ£€æŸ¥æ˜¯å¦éœ€è¦æœç´¢", "type": "main", "index": 0}]]
    },
    "æ£€æŸ¥æ˜¯å¦éœ€è¦æœç´¢": {
      "main": [
        [{"node": "SerpAPIæœç´¢", "type": "main", "index": 0}],
        [{"node": "åˆå¹¶carIDç»“æœ", "type": "main", "index": 0}]
      ]
    },
    "SerpAPIæœç´¢": {
      "main": [[{"node": "å¤„ç†SerpAPIå“åº”", "type": "main", "index": 0}]]
    },
    "å¤„ç†SerpAPIå“åº”": {
      "main": [[{"node": "åˆå¹¶carIDç»“æœ", "type": "main", "index": 1}]]
    },
    "åˆå¹¶carIDç»“æœ": {
      "main": [[{"node": "è¯·æ±‚å›¾ç‰‡é¡µé¢", "type": "main", "index": 0}]]
    },
    "è¯·æ±‚å›¾ç‰‡é¡µé¢": {
      "main": [[{"node": "æå–å›¾ç‰‡ä¿¡æ¯", "type": "main", "index": 0}]]
    },
    "æå–å›¾ç‰‡ä¿¡æ¯": {
      "main": [[{"node": "åˆå¹¶æœ€ç»ˆç»“æœ", "type": "main", "index": 0}]]
    },
    "åˆå¹¶æœ€ç»ˆç»“æœ": {
      "main": [[{"node": "Aggregate", "type": "main", "index": 0}]]
    },
    "Aggregate": {
      "main": [[{"node": "æ ¼å¼åŒ–å¤šè½¦å‹ç»“æœ", "type": "main", "index": 0}]]
    },
    "æ ¼å¼åŒ–å¤šè½¦å‹ç»“æœ": {
      "main": [[{"node": "è¿”å›å“åº”", "type": "main", "index": 0}]]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "5cb72472896fce0666bc03ef84936c4f09ec11e6b4f95f9aebe3d538947c7935"
  }
}

