{
  "name": "最终部分",
  "nodes": [
    {
      "parameters": {
        "content": "## 输入ID可以得到对应信息（单ID）\n\n\n",
        "height": 384,
        "width": 1712,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1424,
        -160
      ],
      "typeVersion": 1,
      "id": "4a95a821-ce40-485e-8297-178588d79d5c",
      "name": "Sticky Note8"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a1b2c3d4",
              "name": "htmlData",
              "value": "={{ $json.data }}",
              "type": "string"
            },
            {
              "id": "e5f6g7h8",
              "name": "page",
              "value": "={{ $('四页链接创建').item.json.page }}",
              "type": "number"
            },
            {
              "id": "i9j0k1l2",
              "name": "brandId",
              "value": "={{ $('四页链接创建').item.json.brandId }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2320,
        -16
      ],
      "id": "56f42cb7-2c3c-49f3-98c0-9bacb131a7f7",
      "name": "合并参数"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        2672,
        -16
      ],
      "id": "a1bfa7f5-9a07-4eac-bb8d-31c03e74ad02",
      "name": "Convert to File1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2a55c9e2-6ae2-4e0d-88dd-baff28782216",
              "name": "carID",
              "value": "5964",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1648,
        368
      ],
      "id": "d8865256-d5ae-4e8f-b2ca-73345521634c",
      "name": "UserCarIDInput"
    },
    {
      "parameters": {
        "url": "=https://www.autohome.com.cn/cars/imglist-x-x-{{ $json.carID }}-x-x-x-x-x-x-1.html",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0"
            }
          ]
        },
        "options": {
          "allowUnauthorizedCerts": true,
          "timeout": 15000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1824,
        368
      ],
      "id": "aa714301-135e-4d9e-8f78-3f4a631d557f",
      "name": "汽车之家URL构建",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// n8n Code Node - 提取外观、内饰、座椅图片（完整版）\n\n// 获取输入数据\nconst inputData = $input.first().json;\n\n// 获取HTML内容\nlet htmlContent = '';\nif (inputData.data) {\n  htmlContent = inputData.data;\n} else if (typeof inputData === 'string') {\n  htmlContent = inputData;\n} else {\n  console.log('无法找到HTML内容');\n  return [{ json: { error: '数据格式错误' } }];\n}\n\nconsole.log('HTML长度:', htmlContent.length);\n\n// 查找 __NEXT_DATA__ script标签\nconst scriptMatch = htmlContent.match(/<script id=\"__NEXT_DATA__\"[^>]*>(.*?)<\\/script>/);\n\nif (!scriptMatch) {\n  console.log('未找到__NEXT_DATA__标签');\n  return [{ json: { error: '未找到JSON数据' } }];\n}\n\ntry {\n  // 解析JSON数据\n  const jsonData = JSON.parse(scriptMatch[1]);\n  console.log('成功解析JSON数据');\n  \n  // 获取图片信息\n  const picinfo = jsonData.props?.pageProps?.SeriesPicList?.picinfo;\n  \n  if (!picinfo || !picinfo.callist) {\n    console.log('未找到图片分类列表');\n    return [{ json: { error: '未找到图片分类' } }];\n  }\n  \n  console.log('找到图片分类列表，数量:', picinfo.callist.length);\n  \n  const imageList = [];\n  \n  // ========== 1. 提取外观图片 ==========\n  const waiGuanClass = picinfo.callist.find(item => item.name === '外观');\n  \n  if (waiGuanClass && waiGuanClass.list && waiGuanClass.list.length > 0) {\n    console.log('外观图片总数:', waiGuanClass.list.length);\n    \n    // 外观图片的备注\n    const waiGuanViewTypes = ['view45', 'viewFront', 'view-45', 'viewSide'];\n    \n    // 提取前4张外观图片\n    const waiGuanCount = Math.min(4, waiGuanClass.list.length);\n    \n    for (let i = 0; i < waiGuanCount; i++) {\n      const pic = waiGuanClass.list[i];\n      \n      imageList.push({\n        image_url: pic.picpath,\n        image_index: imageList.length + 1,\n        category: '外观',\n        view_type: waiGuanViewTypes[i],\n        pic_id: pic.picid,\n        spec_id: pic.specid\n      });\n      \n      console.log(`外观图片 ${i + 1} [${waiGuanViewTypes[i]}]: ${pic.picpath}`);\n    }\n  }\n  \n  // ========== 2. 提取内饰图片 ==========\n  const neiShiClass = picinfo.callist.find(item => item.name === '内饰');\n  \n  if (neiShiClass && neiShiClass.list && neiShiClass.list.length > 0) {\n    console.log('内饰图片总数:', neiShiClass.list.length);\n    \n    // 提取第1张和第6张内饰图片\n    const neiShiIndexes = [0, 5]; // 第1张（索引0）和第6张（索引5）\n    const neiShiViewTypes = ['viewCNSL', 'viewIP'];  // 修改为 viewCNSL 和 viewIP\n    \n    for (let i = 0; i < neiShiIndexes.length; i++) {\n      const index = neiShiIndexes[i];\n      \n      if (index < neiShiClass.list.length) {\n        const pic = neiShiClass.list[index];\n        \n        imageList.push({\n          image_url: pic.picpath,\n          image_index: imageList.length + 1,\n          category: '内饰',\n          view_type: neiShiViewTypes[i],\n          pic_id: pic.picid,\n          spec_id: pic.specid\n        });\n        \n        console.log(`内饰图片 ${index + 1} [${neiShiViewTypes[i]}]: ${pic.picpath}`);\n      } else {\n        console.log(`内饰图片不足，无法提取第 ${index + 1} 张`);\n      }\n    }\n  }\n  \n  // ========== 3. 提取座椅图片 ==========\n  const zuoYiClass = picinfo.callist.find(item => item.name === '座椅');\n  \n  if (zuoYiClass && zuoYiClass.list && zuoYiClass.list.length > 0) {\n    console.log('座椅图片总数:', zuoYiClass.list.length);\n    \n    // 提取第3张座椅图片（索引2）\n    const zuoYiIndex = 2; // 第3张（索引2）\n    \n    if (zuoYiIndex < zuoYiClass.list.length) {\n      const pic = zuoYiClass.list[zuoYiIndex];\n      \n      imageList.push({\n        image_url: pic.picpath,\n        image_index: imageList.length + 1,\n        category: '座椅',\n        view_type: 'viewDoor',\n        pic_id: pic.picid,\n        spec_id: pic.specid\n      });\n      \n      console.log(`座椅图片 ${zuoYiIndex + 1} [viewDoor]: ${pic.picpath}`);\n    } else {\n      console.log(`座椅图片不足，无法提取第 ${zuoYiIndex + 1} 张`);\n    }\n  }\n  \n  if (imageList.length === 0) {\n    console.log('未找到任何图片');\n    return [{ json: { error: '未找到图片' } }];\n  }\n  \n  console.log(`\\\\n成功提取 ${imageList.length} 张图片（${imageList.filter(i => i.category === '外观').length} 张外观 + ${imageList.filter(i => i.category === '内饰').length} 张内饰 + ${imageList.filter(i => i.category === '座椅').length} 张座椅）`);\n  \n  // 返回结果\n  return imageList.map(img => ({ json: img }));\n  \n} catch (error) {\n  console.log('解析JSON出错:', error.message);\n  return [{ json: { error: 'JSON解析失败: ' + error.message } }];\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1984,
        368
      ],
      "id": "81fd5d4b-9165-4fba-86f5-5c6279dfc51b",
      "name": "提取图片URL",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "content": "## 展示的图片\n\n\n",
        "height": 352,
        "width": 1712,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1424,
        256
      ],
      "typeVersion": 1,
      "id": "5f1626c6-6fc5-49a8-8e78-dbc1b93e00f4",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6c88219d-52c3-46fa-9a7b-2ec112723985",
              "name": "brandID",
              "value": "75",
              "type": "string"
            },
            {
              "id": "37c56909-7ff5-468f-aa8a-d1165cd70611",
              "name": "brandID",
              "value": "1",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1808,
        -16
      ],
      "id": "2f32a4c9-b363-4140-a449-88c02b656d56",
      "name": "brandID"
    },
    {
      "parameters": {
        "jsCode": "const items = [];\nconst brandId = $input.first().json.brandID;\n// 汽车之家品牌ID大约在1-400之间\nfor (let i = 1; i <= 4; i++) {\n  items.push({ \n    json: { \n      brandId: brandId,\n      page: i\n    } \n  });\n}\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1968,
        -16
      ],
      "id": "cb707b9d-5af8-4fbb-8d8c-92170e1ee93f",
      "name": "四页链接创建"
    },
    {
      "parameters": {
        "url": "=https://www.autohome.com.cn/price/brandid_{{$json.brandId}}/x-x-x-x-{{$json.page}}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0"
            }
          ]
        },
        "options": {
          "allowUnauthorizedCerts": true,
          "timeout": 15000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2144,
        -16
      ],
      "id": "de40c3f9-ba22-4e46-86ee-670d21992a4d",
      "name": "请求",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// n8n Code Node - 提取汽车车型信息（处理所有输入项）\n\nconst allResults = [];\n\n// 遍历所有输入项\nfor (const item of $input.all()) {\n  const htmlContent = item.json.htmlData;\n  const currentPage = item.json.page;\n  const brandId = item.json.brandId;\n  \n  console.log(`处理页面 ${currentPage}, 品牌ID: ${brandId}`);\n  \n  // 使用正则表达式提取车型信息\n  const carList = [];\n  \n  // 正则表达式模式 - 匹配每个车型块\n  const carBlockPattern = /<div class=\"tw-relative tw-block tw-whitespace-nowrap tw-border-b tw-border-\\[#F0F3F8\\] hover:tw-bg-\\[rgba\\(0,136,255,0\\.04\\)\\]\">[\\s\\S]*?(?=<div class=\"tw-relative tw-block tw-whitespace-nowrap|<\\/div><\\/div><\\/div><\\/div><\\/div>)/g;\n  \n  // 提取所有车型块\n  const carBlocks = htmlContent.match(carBlockPattern) || [];\n  \n  console.log(`页面 ${currentPage} 找到 ${carBlocks.length} 个车型块`);\n  \n  carBlocks.forEach((block, index) => {\n    try {\n      // 1. 提取车系名称\n      let seriesName = null;\n      const nameMatch1 = block.match(/title=\"([^\"]*?)\" class=\"tw-text-hover tw-mr-2 tw-min-w-0 tw-text-\\[18px\\] tw-font-\\[500\\]\">([^<]+)</);\n      if (nameMatch1) {\n        seriesName = nameMatch1[2].trim();\n      } else {\n        const nameMatch2 = block.match(/class=\"tw-text-hover tw-mr-2 tw-min-w-0 tw-text-\\[18px\\] tw-font-\\[500\\]\">([^<]+)</);\n        if (nameMatch2) seriesName = nameMatch2[1].trim();\n      }\n      \n      // 2. 提取索引值 (series_id)\n      let seriesId = null;\n      const idMatch1 = block.match(/https:\\/\\/k\\.autohome\\.com\\.cn\\/(\\d+)\\/#pvareaid=/);\n      if (idMatch1) {\n        seriesId = idMatch1[1];\n      } else {\n        const idMatch2 = block.match(/href=\"\\/(\\d+)\\/#pvareaid=/);\n        if (idMatch2) seriesId = idMatch2[1];\n      }\n      \n      // 3. 提取价格区间\n      let priceRange = null;\n      const pricePattern1 = /(?<!限时)指导价：<a[^>]*>([0-9.]+-[0-9.]+万)<\\/a>/;\n      const priceMatch1 = block.match(pricePattern1);\n      if (priceMatch1) {\n        priceRange = priceMatch1[1].trim();\n      }\n      \n      if (!priceRange) {\n        const priceMatch2 = block.match(/指导价：[^>]*>([0-9.]+-[0-9.]+万)</);\n        if (priceMatch2) priceRange = priceMatch2[1].trim();\n      }\n      \n      if (!priceRange) {\n        const priceMatch3 = block.match(/!tw-text-\\[#f60\\]\">([0-9.]+-[0-9.]+万)<\\/a>/);\n        if (priceMatch3) priceRange = priceMatch3[1].trim();\n      }\n      \n      if (!priceRange) {\n        const priceMatch4 = block.match(/(\\d+\\.\\d+-\\d+\\.\\d+万)/);\n        if (priceMatch4) priceRange = priceMatch4[1].trim();\n      }\n      \n      // 4. 提取级别和车身结构\n      let vehicleClass = null;\n      let bodyStructure = null;\n      \n      const classMatch1 = block.match(/级别\\/车身结构：\\s*<span[^>]*title=\"([^\"]+)\"/);\n      if (classMatch1) {\n        const fullInfo = classMatch1[1].trim();\n        const parts = fullInfo.split('/').map(p => p.trim());\n        if (parts.length >= 1) vehicleClass = parts[0];\n        if (parts.length >= 2) bodyStructure = parts[1];\n        if (parts.length >= 3) bodyStructure = parts.slice(1).join(' ');\n      }\n      \n      if (!vehicleClass) {\n        const classMatch2 = block.match(/级别\\/车身结构：[^<]*<span[^>]*>([^<]+)</);\n        if (classMatch2) {\n          const fullInfo = classMatch2[1].trim();\n          const parts = fullInfo.split('/').map(p => p.trim());\n          if (parts.length >= 1) vehicleClass = parts[0];\n          if (parts.length >= 2) bodyStructure = parts[1];\n          if (parts.length >= 3) bodyStructure = parts.slice(1).join(' ');\n        }\n      }\n      \n      if (!vehicleClass) {\n        const classMatch3 = block.match(/title=\"(中型车|紧凑型车|中大型车|小型车|微型车|中型SUV|紧凑型SUV|中大型SUV|小型SUV|大型SUV|MPV|跑车|皮卡|轻客|微卡|微面)\\s*\\/\\s*([^\"]+)\"/);\n        if (classMatch3) {\n          vehicleClass = classMatch3[1].trim();\n          bodyStructure = classMatch3[2].trim();\n        }\n      }\n      \n      // 只有当车系名称和索引值都存在时才添加\n      if (seriesName && seriesId) {\n        carList.push({\n          series_name: seriesName,\n          price_range: priceRange || '暂无价格',\n          vehicle_class: vehicleClass || '未知级别',\n          body_structure: bodyStructure || '未知结构',\n          series_id: seriesId,\n          page: currentPage,\n          brand_id: brandId\n        });\n      }\n      \n    } catch (error) {\n      console.log(`页面 ${currentPage} 解析车型块 ${index + 1} 时出错:`, error.message);\n    }\n  });\n  \n  console.log(`页面 ${currentPage} 成功提取 ${carList.length} 个车型信息`);\n  \n  // 将当前页的结果添加到总结果中\n  allResults.push(...carList);\n}\n\nconsole.log(`总共提取 ${allResults.length} 个车型信息`);\n\n// 返回所有结果\nreturn allResults.map(car => ({ json: car }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2496,
        -16
      ],
      "id": "fdb64285-9033-4a76-a443-c44738adde75",
      "name": "整理数据",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "content": "## 输入ID可以得到对应信息（多ID）\n\n\n",
        "height": 464,
        "width": 1712,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1424,
        672
      ],
      "typeVersion": 1,
      "id": "3cee08e1-e808-42c5-ad6e-cfd8ca4ef578",
      "name": "Sticky Note9"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1776,
        752
      ],
      "id": "ee2956f0-46e4-4632-b635-393f3d9e45c9",
      "name": "Loop Over Items"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a1b2c3d4",
              "name": "htmlData",
              "value": "={{ $json.data }}",
              "type": "string"
            },
            {
              "id": "e5f6g7h8",
              "name": "page",
              "value": "={{ $('四页链接创建1').item.json.page }}",
              "type": "number"
            },
            {
              "id": "i9j0k1l2",
              "name": "brandId",
              "value": "={{ $('四页链接创建1').item.json.brandId }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2352,
        896
      ],
      "id": "4727807b-880f-4d56-a8ac-2c698c304031",
      "name": "合并参数1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        2768,
        736
      ],
      "id": "7ba35fb7-b8bc-4975-aaf0-3cd7be437b53",
      "name": "Convert to File"
    },
    {
      "parameters": {
        "jsCode": "const items = [];\nconst brandId = $input.first().json.brandID;\n// 汽车之家品牌ID大约在1-400之间\nfor (let i = 1; i <= 4; i++) {\n  items.push({ \n    json: { \n      brandId: brandId,\n      page: i\n    } \n  });\n}\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2000,
        896
      ],
      "id": "08971cc4-8016-4034-9dd7-e55b05416712",
      "name": "四页链接创建1"
    },
    {
      "parameters": {
        "url": "=https://www.autohome.com.cn/price/brandid_{{$json.brandId}}/x-x-x-x-{{$json.page}}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0"
            }
          ]
        },
        "options": {
          "allowUnauthorizedCerts": true,
          "timeout": 15000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2176,
        896
      ],
      "id": "dd233f9a-f97d-471c-85c3-e428251d65fe",
      "name": "请求1",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// n8n Code Node - 提取汽车车型信息（处理所有输入项）\n\nconst allResults = [];\n\n// 遍历所有输入项\nfor (const item of $input.all()) {\n  const htmlContent = item.json.htmlData;\n  const currentPage = item.json.page;\n  const brandId = item.json.brandId;\n  \n  console.log(`处理页面 ${currentPage}, 品牌ID: ${brandId}`);\n  \n  // 使用正则表达式提取车型信息\n  const carList = [];\n  \n  // 正则表达式模式 - 匹配每个车型块\n  const carBlockPattern = /<div class=\"tw-relative tw-block tw-whitespace-nowrap tw-border-b tw-border-\\[#F0F3F8\\] hover:tw-bg-\\[rgba\\(0,136,255,0\\.04\\)\\]\">[\\s\\S]*?(?=<div class=\"tw-relative tw-block tw-whitespace-nowrap|<\\/div><\\/div><\\/div><\\/div><\\/div>)/g;\n  \n  // 提取所有车型块\n  const carBlocks = htmlContent.match(carBlockPattern) || [];\n  \n  console.log(`页面 ${currentPage} 找到 ${carBlocks.length} 个车型块`);\n  \n  carBlocks.forEach((block, index) => {\n    try {\n      // 1. 提取车系名称\n      let seriesName = null;\n      const nameMatch1 = block.match(/title=\"([^\"]*?)\" class=\"tw-text-hover tw-mr-2 tw-min-w-0 tw-text-\\[18px\\] tw-font-\\[500\\]\">([^<]+)</);\n      if (nameMatch1) {\n        seriesName = nameMatch1[2].trim();\n      } else {\n        const nameMatch2 = block.match(/class=\"tw-text-hover tw-mr-2 tw-min-w-0 tw-text-\\[18px\\] tw-font-\\[500\\]\">([^<]+)</);\n        if (nameMatch2) seriesName = nameMatch2[1].trim();\n      }\n      \n      // 2. 提取索引值 (series_id)\n      let seriesId = null;\n      const idMatch1 = block.match(/https:\\/\\/k\\.autohome\\.com\\.cn\\/(\\d+)\\/#pvareaid=/);\n      if (idMatch1) {\n        seriesId = idMatch1[1];\n      } else {\n        const idMatch2 = block.match(/href=\"\\/(\\d+)\\/#pvareaid=/);\n        if (idMatch2) seriesId = idMatch2[1];\n      }\n      \n      // 3. 提取价格区间\n      let priceRange = null;\n      const pricePattern1 = /(?<!限时)指导价：<a[^>]*>([0-9.]+-[0-9.]+万)<\\/a>/;\n      const priceMatch1 = block.match(pricePattern1);\n      if (priceMatch1) {\n        priceRange = priceMatch1[1].trim();\n      }\n      \n      if (!priceRange) {\n        const priceMatch2 = block.match(/指导价：[^>]*>([0-9.]+-[0-9.]+万)</);\n        if (priceMatch2) priceRange = priceMatch2[1].trim();\n      }\n      \n      if (!priceRange) {\n        const priceMatch3 = block.match(/!tw-text-\\[#f60\\]\">([0-9.]+-[0-9.]+万)<\\/a>/);\n        if (priceMatch3) priceRange = priceMatch3[1].trim();\n      }\n      \n      if (!priceRange) {\n        const priceMatch4 = block.match(/(\\d+\\.\\d+-\\d+\\.\\d+万)/);\n        if (priceMatch4) priceRange = priceMatch4[1].trim();\n      }\n      \n      // 4. 提取级别和车身结构\n      let vehicleClass = null;\n      let bodyStructure = null;\n      \n      const classMatch1 = block.match(/级别\\/车身结构：\\s*<span[^>]*title=\"([^\"]+)\"/);\n      if (classMatch1) {\n        const fullInfo = classMatch1[1].trim();\n        const parts = fullInfo.split('/').map(p => p.trim());\n        if (parts.length >= 1) vehicleClass = parts[0];\n        if (parts.length >= 2) bodyStructure = parts[1];\n        if (parts.length >= 3) bodyStructure = parts.slice(1).join(' ');\n      }\n      \n      if (!vehicleClass) {\n        const classMatch2 = block.match(/级别\\/车身结构：[^<]*<span[^>]*>([^<]+)</);\n        if (classMatch2) {\n          const fullInfo = classMatch2[1].trim();\n          const parts = fullInfo.split('/').map(p => p.trim());\n          if (parts.length >= 1) vehicleClass = parts[0];\n          if (parts.length >= 2) bodyStructure = parts[1];\n          if (parts.length >= 3) bodyStructure = parts.slice(1).join(' ');\n        }\n      }\n      \n      if (!vehicleClass) {\n        const classMatch3 = block.match(/title=\"(中型车|紧凑型车|中大型车|小型车|微型车|中型SUV|紧凑型SUV|中大型SUV|小型SUV|大型SUV|MPV|跑车|皮卡|轻客|微卡|微面)\\s*\\/\\s*([^\"]+)\"/);\n        if (classMatch3) {\n          vehicleClass = classMatch3[1].trim();\n          bodyStructure = classMatch3[2].trim();\n        }\n      }\n      \n      // 只有当车系名称和索引值都存在时才添加\n      if (seriesName && seriesId) {\n        carList.push({\n          series_name: seriesName,\n          price_range: priceRange || '暂无价格',\n          vehicle_class: vehicleClass || '未知级别',\n          body_structure: bodyStructure || '未知结构',\n          series_id: seriesId,\n          page: currentPage,\n          brand_id: brandId\n        });\n      }\n      \n    } catch (error) {\n      console.log(`页面 ${currentPage} 解析车型块 ${index + 1} 时出错:`, error.message);\n    }\n  });\n  \n  console.log(`页面 ${currentPage} 成功提取 ${carList.length} 个车型信息`);\n  \n  // 将当前页的结果添加到总结果中\n  allResults.push(...carList);\n}\n\nconsole.log(`总共提取 ${allResults.length} 个车型信息`);\n\n// 返回所有结果\nreturn allResults.map(car => ({ json: car }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2528,
        896
      ],
      "id": "98a5cfb5-1f6c-4669-b4a6-81f99cbddf2c",
      "name": "整理数据1",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "6c88219d-52c3-46fa-9a7b-2ec112723985",
              "name": "brandID",
              "value": "75",
              "type": "string"
            },
            {
              "id": "37c56909-7ff5-468f-aa8a-d1165cd70611",
              "name": "brandID",
              "value": "1",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1536,
        752
      ],
      "id": "0d2b36d0-280c-4fad-ab0d-4de6bfa7e2d2",
      "name": "brandID1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        3904,
        80
      ],
      "id": "184d3df0-78b4-48ba-ab10-12c67e159969",
      "name": "Loop Over Items1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a1b2c3d4",
              "name": "htmlData",
              "value": "={{ $json.data }}",
              "type": "string"
            },
            {
              "id": "e5f6g7h8",
              "name": "page",
              "value": "={{ $('四页链接创建2').item.json.page }}",
              "type": "number"
            },
            {
              "id": "i9j0k1l2",
              "name": "brandId",
              "value": "={{ $('四页链接创建2').item.json.brandId }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4656,
        224
      ],
      "id": "4e480ad5-d846-4ca2-9c06-b6faa8516af8",
      "name": "合并参数2"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        5008,
        -128
      ],
      "id": "46629316-dfe6-44ea-aeaa-1206f2178bd4",
      "name": "Convert to File2"
    },
    {
      "parameters": {
        "jsCode": "const items = [];\nconst brandId = $input.first().json.brandID;\n// 汽车之家品牌ID大约在1-400之间\nfor (let i = 1; i <= 4; i++) {\n  items.push({ \n    json: { \n      brandId: brandId,\n      page: i\n    } \n  });\n}\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4128,
        224
      ],
      "id": "3ba9b889-4196-4692-b167-406322730c77",
      "name": "四页链接创建2"
    },
    {
      "parameters": {
        "url": "=https://www.autohome.com.cn/price/brandid_{{$json.brandId}}/x-x-x-x-{{$json.page}}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0"
            }
          ]
        },
        "options": {
          "allowUnauthorizedCerts": true,
          "timeout": 15000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4304,
        224
      ],
      "id": "a88e6f19-810d-4d62-ad32-8637231f4efb",
      "name": "请求2",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// n8n Code Node - 提取汽车车型信息（处理所有输入项）\n\nconst allResults = [];\n\n// 遍历所有输入项\nfor (const item of $input.all()) {\n  // 检查 htmlData 是否存在\n  if (!item.json.htmlData) {\n    console.log(`跳过页面 ${item.json.page}, 品牌ID: ${item.json.brandId} - 没有HTML数据`);\n    continue;\n  }\n  \n  const htmlContent = item.json.htmlData;\n  const currentPage = item.json.page;\n  const brandId = item.json.brandId;\n  \n  console.log(`处理页面 ${currentPage}, 品牌ID: ${brandId}`);\n  \n  // 使用正则表达式提取车型信息\n  const carList = [];\n  \n  try {\n    // 正则表达式模式 - 匹配每个车型块\n    const carBlockPattern = /<div class=\"tw-relative tw-block tw-whitespace-nowrap tw-border-b tw-border-\\[#F0F3F8\\] hover:tw-bg-\\[rgba\\(0,136,255,0\\.04\\)\\]\">[\\s\\S]*?(?=<div class=\"tw-relative tw-block tw-whitespace-nowrap|<\\/div><\\/div><\\/div><\\/div><\\/div>)/g;\n    \n    // 提取所有车型块\n    const carBlocks = htmlContent.match(carBlockPattern) || [];\n    \n    console.log(`页面 ${currentPage} 找到 ${carBlocks.length} 个车型块`);\n    \n    carBlocks.forEach((block, index) => {\n      try {\n        // 1. 提取车系名称\n        let seriesName = null;\n        const nameMatch1 = block.match(/title=\"([^\"]*?)\" class=\"tw-text-hover tw-mr-2 tw-min-w-0 tw-text-\\[18px\\] tw-font-\\[500\\]\">([^<]+)</);\n        if (nameMatch1) {\n          seriesName = nameMatch1[2].trim();\n        } else {\n          const nameMatch2 = block.match(/class=\"tw-text-hover tw-mr-2 tw-min-w-0 tw-text-\\[18px\\] tw-font-\\[500\\]\">([^<]+)</);\n          if (nameMatch2) seriesName = nameMatch2[1].trim();\n        }\n        \n        // 2. 提取索引值 (series_id)\n        let seriesId = null;\n        const idMatch1 = block.match(/https:\\/\\/k\\.autohome\\.com\\.cn\\/(\\d+)\\/#pvareaid=/);\n        if (idMatch1) {\n          seriesId = idMatch1[1];\n        } else {\n          const idMatch2 = block.match(/href=\"\\/(\\d+)\\/#pvareaid=/);\n          if (idMatch2) seriesId = idMatch2[1];\n        }\n        \n        // 3. 提取价格区间\n        let priceRange = null;\n        const pricePattern1 = /(?<!限时)指导价：<a[^>]*>([0-9.]+-[0-9.]+万)<\\/a>/;\n        const priceMatch1 = block.match(pricePattern1);\n        if (priceMatch1) {\n          priceRange = priceMatch1[1].trim();\n        }\n        \n        if (!priceRange) {\n          const priceMatch2 = block.match(/指导价：[^>]*>([0-9.]+-[0-9.]+万)</);\n          if (priceMatch2) priceRange = priceMatch2[1].trim();\n        }\n        \n        if (!priceRange) {\n          const priceMatch3 = block.match(/!tw-text-\\[#f60\\]\">([0-9.]+-[0-9.]+万)<\\/a>/);\n          if (priceMatch3) priceRange = priceMatch3[1].trim();\n        }\n        \n        if (!priceRange) {\n          const priceMatch4 = block.match(/(\\d+\\.\\d+-\\d+\\.\\d+万)/);\n          if (priceMatch4) priceRange = priceMatch4[1].trim();\n        }\n        \n        // 4. 提取级别和车身结构\n        let vehicleClass = null;\n        let bodyStructure = null;\n        \n        const classMatch1 = block.match(/级别\\/车身结构：\\s*<span[^>]*title=\"([^\"]+)\"/);\n        if (classMatch1) {\n          const fullInfo = classMatch1[1].trim();\n          const parts = fullInfo.split('/').map(p => p.trim());\n          if (parts.length >= 1) vehicleClass = parts[0];\n          if (parts.length >= 2) bodyStructure = parts[1];\n          if (parts.length >= 3) bodyStructure = parts.slice(1).join(' ');\n        }\n        \n        if (!vehicleClass) {\n          const classMatch2 = block.match(/级别\\/车身结构：[^<]*<span[^>]*>([^<]+)</);\n          if (classMatch2) {\n            const fullInfo = classMatch2[1].trim();\n            const parts = fullInfo.split('/').map(p => p.trim());\n            if (parts.length >= 1) vehicleClass = parts[0];\n            if (parts.length >= 2) bodyStructure = parts[1];\n            if (parts.length >= 3) bodyStructure = parts.slice(1).join(' ');\n          }\n        }\n        \n        if (!vehicleClass) {\n          const classMatch3 = block.match(/title=\"(中型车|紧凑型车|中大型车|小型车|微型车|中型SUV|紧凑型SUV|中大型SUV|小型SUV|大型SUV|MPV|跑车|皮卡|轻客|微卡|微面)\\s*\\/\\s*([^\"]+)\"/);\n          if (classMatch3) {\n            vehicleClass = classMatch3[1].trim();\n            bodyStructure = classMatch3[2].trim();\n          }\n        }\n        \n        // 只有当车系名称和索引值都存在时才添加\n        if (seriesName && seriesId) {\n          carList.push({\n            series_name: seriesName,\n            price_range: priceRange || '暂无价格',\n            vehicle_class: vehicleClass || '未知级别',\n            body_structure: bodyStructure || '未知结构',\n            series_id: seriesId,\n            page: currentPage,\n            brand_id: brandId\n          });\n        }\n        \n      } catch (error) {\n        console.log(`页面 ${currentPage} 解析车型块 ${index + 1} 时出错:`, error.message);\n      }\n    });\n    \n    console.log(`页面 ${currentPage} 成功提取 ${carList.length} 个车型信息`);\n    \n    // 将当前页的结果添加到总结果中\n    allResults.push(...carList);\n    \n  } catch (error) {\n    console.log(`处理页面 ${currentPage} 时出错:`, error.message);\n  }\n}\n\nconsole.log(`总共提取 ${allResults.length} 个车型信息`);\n\n// 如果没有结果，返回空数组而不是报错\nif (allResults.length === 0) {\n  return [{ json: { error: '未提取到任何数据' } }];\n}\n\n// 返回所有结果\nreturn allResults.map(car => ({ json: car }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4832,
        224
      ],
      "id": "aa24e812-f001-4a23-958e-092d1889171f",
      "name": "整理数据2",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// 从 Google Sheets 输出中提取所有 brandID\nconst items = $input.all();\nconst brandIDs = items.map(item => item.json.brandID.toString());\n\nreturn brandIDs.map(id => ({\n  json: {\n    brandID: id\n  }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3744,
        80
      ],
      "id": "d7589ca0-0397-40f6-af3d-1fc0b867e546",
      "name": "brandID2"
    },
    {
      "parameters": {
        "amount": 4
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        4480,
        224
      ],
      "id": "4f9ef1c9-0ef5-41a3-9df9-029cabc936e1",
      "name": "页面请求延迟",
      "webhookId": "wait-webhook-1"
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        5008,
        224
      ],
      "id": "d4a037da-a3e9-4062-af74-8f673a8409c9",
      "name": "数据处理延迟",
      "webhookId": "wait-webhook-2"
    },
    {
      "parameters": {
        "content": "## 输入ID可以得到对应信息（GoogleSheet）\n\n\n",
        "height": 624,
        "width": 2160,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3344,
        -160
      ],
      "typeVersion": 1,
      "id": "d330191b-9184-48fa-a120-d177436fd744",
      "name": "Sticky Note10"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1765689628,
          "mode": "list",
          "cachedResultName": "BrandMappingSheet（副本）",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit#gid=1765689628"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        3440,
        80
      ],
      "id": "4d0d60e9-7a0b-429a-aaf7-e3e5c33c24ab",
      "name": "Get row(s) in sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YS5a72jpKHezwxcc",
          "name": "Google Sheets account 5"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        1552,
        1280
      ],
      "id": "4d661307-2436-4df7-bedd-02c562dc10c0",
      "name": "Loop Over Items2"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a1b2c3d4",
              "name": "htmlData",
              "value": "={{ $json.data }}",
              "type": "string"
            },
            {
              "id": "e5f6g7h8",
              "name": "page",
              "value": "={{ $('四页链接创建3').item.json.page }}",
              "type": "number"
            },
            {
              "id": "i9j0k1l2",
              "name": "brandId",
              "value": "={{ $('四页链接创建3').item.json.brandId }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        2304,
        1424
      ],
      "id": "19c6cbf9-56ed-4b31-a0bf-cbf718652719",
      "name": "合并参数3"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        2896,
        1264
      ],
      "id": "b2c3ed46-b731-4f95-a37d-ed335db7fdc0",
      "name": "Convert to File3"
    },
    {
      "parameters": {
        "jsCode": "const items = [];\nconst brandId = $input.first().json.brandID;\n// 汽车之家品牌ID大约在1-400之间\nfor (let i = 1; i <= 4; i++) {\n  items.push({ \n    json: { \n      brandId: brandId,\n      page: i\n    } \n  });\n}\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1776,
        1424
      ],
      "id": "97562abb-60fe-46ad-9be6-92fccbdd5ab0",
      "name": "四页链接创建3"
    },
    {
      "parameters": {
        "url": "=https://www.autohome.com.cn/price/brandid_{{$json.brandId}}/x-x-x-x-{{$json.page}}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0"
            }
          ]
        },
        "options": {
          "allowUnauthorizedCerts": true,
          "timeout": 15000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1952,
        1424
      ],
      "id": "92a08dee-8f7b-4f7b-80c4-906fc3ce64af",
      "name": "请求3",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// n8n Code Node - 提取汽车车型信息（处理所有输入项）\n\nconst allResults = [];\n\n// 遍历所有输入项\nfor (const item of $input.all()) {\n  // 检查 htmlData 是否存在\n  if (!item.json.htmlData) {\n    console.log(`跳过页面 ${item.json.page}, 品牌ID: ${item.json.brandId} - 没有HTML数据`);\n    continue;\n  }\n  \n  const htmlContent = item.json.htmlData;\n  const currentPage = item.json.page;\n  const brandId = item.json.brandId;\n  \n  console.log(`处理页面 ${currentPage}, 品牌ID: ${brandId}`);\n  \n  // 使用正则表达式提取车型信息\n  const carList = [];\n  \n  try {\n    // 正则表达式模式 - 匹配每个车型块\n    const carBlockPattern = /<div class=\"tw-relative tw-block tw-whitespace-nowrap tw-border-b tw-border-\\[#F0F3F8\\] hover:tw-bg-\\[rgba\\(0,136,255,0\\.04\\)\\]\">[\\s\\S]*?(?=<div class=\"tw-relative tw-block tw-whitespace-nowrap|<\\/div><\\/div><\\/div><\\/div><\\/div>)/g;\n    \n    // 提取所有车型块\n    const carBlocks = htmlContent.match(carBlockPattern) || [];\n    \n    console.log(`页面 ${currentPage} 找到 ${carBlocks.length} 个车型块`);\n    \n    carBlocks.forEach((block, index) => {\n      try {\n        // 1. 提取车系名称\n        let seriesName = null;\n        const nameMatch1 = block.match(/title=\"([^\"]*?)\" class=\"tw-text-hover tw-mr-2 tw-min-w-0 tw-text-\\[18px\\] tw-font-\\[500\\]\">([^<]+)</);\n        if (nameMatch1) {\n          seriesName = nameMatch1[2].trim();\n        } else {\n          const nameMatch2 = block.match(/class=\"tw-text-hover tw-mr-2 tw-min-w-0 tw-text-\\[18px\\] tw-font-\\[500\\]\">([^<]+)</);\n          if (nameMatch2) seriesName = nameMatch2[1].trim();\n        }\n        \n        // 2. 提取索引值 (series_id)\n        let seriesId = null;\n        const idMatch1 = block.match(/https:\\/\\/k\\.autohome\\.com\\.cn\\/(\\d+)\\/#pvareaid=/);\n        if (idMatch1) {\n          seriesId = idMatch1[1];\n        } else {\n          const idMatch2 = block.match(/href=\"\\/(\\d+)\\/#pvareaid=/);\n          if (idMatch2) seriesId = idMatch2[1];\n        }\n        \n        // 3. 提取价格区间\n        let priceRange = null;\n        const pricePattern1 = /(?<!限时)指导价：<a[^>]*>([0-9.]+-[0-9.]+万)<\\/a>/;\n        const priceMatch1 = block.match(pricePattern1);\n        if (priceMatch1) {\n          priceRange = priceMatch1[1].trim();\n        }\n        \n        if (!priceRange) {\n          const priceMatch2 = block.match(/指导价：[^>]*>([0-9.]+-[0-9.]+万)</);\n          if (priceMatch2) priceRange = priceMatch2[1].trim();\n        }\n        \n        if (!priceRange) {\n          const priceMatch3 = block.match(/!tw-text-\\[#f60\\]\">([0-9.]+-[0-9.]+万)<\\/a>/);\n          if (priceMatch3) priceRange = priceMatch3[1].trim();\n        }\n        \n        if (!priceRange) {\n          const priceMatch4 = block.match(/(\\d+\\.\\d+-\\d+\\.\\d+万)/);\n          if (priceMatch4) priceRange = priceMatch4[1].trim();\n        }\n        \n        // 4. 提取级别和车身结构\n        let vehicleClass = null;\n        let bodyStructure = null;\n        \n        const classMatch1 = block.match(/级别\\/车身结构：\\s*<span[^>]*title=\"([^\"]+)\"/);\n        if (classMatch1) {\n          const fullInfo = classMatch1[1].trim();\n          const parts = fullInfo.split('/').map(p => p.trim());\n          if (parts.length >= 1) vehicleClass = parts[0];\n          if (parts.length >= 2) bodyStructure = parts[1];\n          if (parts.length >= 3) bodyStructure = parts.slice(1).join(' ');\n        }\n        \n        if (!vehicleClass) {\n          const classMatch2 = block.match(/级别\\/车身结构：[^<]*<span[^>]*>([^<]+)</);\n          if (classMatch2) {\n            const fullInfo = classMatch2[1].trim();\n            const parts = fullInfo.split('/').map(p => p.trim());\n            if (parts.length >= 1) vehicleClass = parts[0];\n            if (parts.length >= 2) bodyStructure = parts[1];\n            if (parts.length >= 3) bodyStructure = parts.slice(1).join(' ');\n          }\n        }\n        \n        if (!vehicleClass) {\n          const classMatch3 = block.match(/title=\"(中型车|紧凑型车|中大型车|小型车|微型车|中型SUV|紧凑型SUV|中大型SUV|小型SUV|大型SUV|MPV|跑车|皮卡|轻客|微卡|微面)\\s*\\/\\s*([^\"]+)\"/);\n          if (classMatch3) {\n            vehicleClass = classMatch3[1].trim();\n            bodyStructure = classMatch3[2].trim();\n          }\n        }\n        \n        // 只有当车系名称和索引值都存在时才添加\n        if (seriesName && seriesId) {\n          carList.push({\n            series_name: seriesName,\n            price_range: priceRange || '暂无价格',\n            vehicle_class: vehicleClass || '未知级别',\n            body_structure: bodyStructure || '未知结构',\n            series_id: seriesId,\n            page: currentPage,\n            brand_id: brandId\n          });\n        }\n        \n      } catch (error) {\n        console.log(`页面 ${currentPage} 解析车型块 ${index + 1} 时出错:`, error.message);\n      }\n    });\n    \n    console.log(`页面 ${currentPage} 成功提取 ${carList.length} 个车型信息`);\n    \n    // 将当前页的结果添加到总结果中\n    allResults.push(...carList);\n    \n  } catch (error) {\n    console.log(`处理页面 ${currentPage} 时出错:`, error.message);\n  }\n}\n\nconsole.log(`总共提取 ${allResults.length} 个车型信息`);\n\n// 如果没有结果，返回空数组而不是报错\nif (allResults.length === 0) {\n  return [{ json: { error: '未提取到任何数据' } }];\n}\n\n// 返回所有结果\nreturn allResults.map(car => ({ json: car }));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2480,
        1424
      ],
      "id": "bc1ba2c2-3a9f-4ccf-8e3b-6797f7f69580",
      "name": "整理数据3",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// 创建多个品牌ID\nconst brandIDs = ['75', '1'];\n\nreturn brandIDs.map(id => ({\n  json: {\n    brandID: id\n  }\n}));"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1328,
        1280
      ],
      "id": "b1100646-7249-4a71-b57e-5d5c811fe2de",
      "name": "brandID3"
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2128,
        1424
      ],
      "id": "c520c360-7c12-4d3c-a6e2-74f684946594",
      "name": "页面请求延迟1",
      "webhookId": "wait-webhook-1"
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2656,
        1424
      ],
      "id": "fa1d240e-6f75-42a1-9366-ed1d370776d2",
      "name": "数据处理延迟1",
      "webhookId": "wait-webhook-2"
    },
    {
      "parameters": {
        "content": "## 输入ID可以得到对应信息（多ID带Delay）\n\n\n",
        "height": 464,
        "width": 2112,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1024,
        1200
      ],
      "typeVersion": 1,
      "id": "1b847267-e309-4603-8328-2144236f95f3",
      "name": "Sticky Note11"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1268392982,
          "mode": "list",
          "cachedResultName": "BrandMappingSheetMVP用",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit#gid=1268392982"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1184,
        1424
      ],
      "id": "3fc4fa75-3123-4d46-aa2c-80bb306b0d8b",
      "name": "Get row(s) in sheet1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YS5a72jpKHezwxcc",
          "name": "Google Sheets account 5"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1837650523,
          "mode": "list",
          "cachedResultName": "NewallCarMapping完整",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit#gid=1837650523"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {},
          "matchingColumns": [],
          "schema": [],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        5008,
        64
      ],
      "id": "1b3682ec-5c25-4854-bc5c-5a84b6d1a47a",
      "name": "Append row in sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YS5a72jpKHezwxcc",
          "name": "Google Sheets account 5"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 2027336631,
          "mode": "list",
          "cachedResultName": "NewallCarMappingMVP用",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit#gid=2027336631"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        1408,
        368
      ],
      "id": "806af6c4-84fa-4d0c-8547-3971dd46e655",
      "name": "Get row(s) in sheet2",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YS5a72jpKHezwxcc",
          "name": "Google Sheets account 5"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 2027336631,
          "mode": "list",
          "cachedResultName": "NewallCarMappingMVP用",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit#gid=2027336631"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        3648,
        816
      ],
      "id": "b880d32d-7a12-4c0f-9fb2-3db56992fede",
      "name": "读取车型数据",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YS5a72jpKHezwxcc",
          "name": "Google Sheets account 5"
        }
      }
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        4016,
        816
      ],
      "id": "d8d4cfc4-ea8c-416d-9ebb-753ce85c62fb",
      "name": "循环处理车型"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "car-id-assign",
              "name": "carID",
              "value": "={{ $json.series_id }}",
              "type": "string"
            },
            {
              "id": "series-name-assign",
              "name": "series_name",
              "value": "={{ $json.series_name }}",
              "type": "string"
            },
            {
              "id": "price-range-assign",
              "name": "price_range",
              "value": "={{ $json.price_range }}",
              "type": "string"
            },
            {
              "id": "vehicle-class-assign",
              "name": "vehicle_class",
              "value": "={{ $json.vehicle_class }}",
              "type": "string"
            },
            {
              "id": "brand-id-assign",
              "name": "brand_id",
              "value": "={{ $json.brand_id }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        4208,
        864
      ],
      "id": "30df533f-62d3-4716-8eec-6497a85eb6fb",
      "name": "提取车型信息"
    },
    {
      "parameters": {
        "url": "=https://www.autohome.com.cn/cars/imglist-x-x-{{ $json.carID }}-x-x-x-x-x-x-1.html",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0"
            }
          ]
        },
        "options": {
          "allowUnauthorizedCerts": true,
          "timeout": 15000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4416,
        864
      ],
      "id": "957afae5-efae-4da8-9f32-8aeec792c0a6",
      "name": "请求图片页面",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        4608,
        864
      ],
      "id": "13e3a3f9-7d6c-4d2e-8dbd-8228cff55073",
      "name": "请求延迟",
      "webhookId": "wait-webhook-img"
    },
    {
      "parameters": {
        "jsCode": "// n8n Code Node - 提取外观、内饰、座椅图片并合并车型信息\n\n// 获取输入数据\nconst inputData = $input.first().json;\n\n// 从上游节点获取车型信息\nconst carInfo = {\n  series_id: $('提取车型信息').item.json.carID,\n  series_name: $('提取车型信息').item.json.series_name,\n  price_range: $('提取车型信息').item.json.price_range,\n  vehicle_class: $('提取车型信息').item.json.vehicle_class,\n  brand_id: $('提取车型信息').item.json.brand_id\n};\n\nconsole.log('处理车型:', carInfo.series_name, '(ID:', carInfo.series_id, ')');\n\n// 获取HTML内容\nlet htmlContent = '';\nif (inputData.data) {\n  htmlContent = inputData.data;\n} else if (typeof inputData === 'string') {\n  htmlContent = inputData;\n} else {\n  console.log('无法找到HTML内容');\n  return [{ json: { ...carInfo, error: '数据格式错误' } }];\n}\n\nconsole.log('HTML长度:', htmlContent.length);\n\n// 查找 __NEXT_DATA__ script标签\nconst scriptMatch = htmlContent.match(/<script id=\"__NEXT_DATA__\"[^>]*>(.*?)<\\/script>/);\n\nif (!scriptMatch) {\n  console.log('未找到__NEXT_DATA__标签');\n  return [{ json: { ...carInfo, error: '未找到JSON数据' } }];\n}\n\ntry {\n  // 解析JSON数据\n  const jsonData = JSON.parse(scriptMatch[1]);\n  console.log('成功解析JSON数据');\n  \n  // 获取图片信息\n  const picinfo = jsonData.props?.pageProps?.SeriesPicList?.picinfo;\n  \n  if (!picinfo || !picinfo.callist) {\n    console.log('未找到图片分类列表');\n    return [{ json: { ...carInfo, error: '未找到图片分类' } }];\n  }\n  \n  console.log('找到图片分类列表，数量:', picinfo.callist.length);\n  \n  const imageList = [];\n  \n  // ========== 1. 提取外观图片 ==========\n  const waiGuanClass = picinfo.callist.find(item => item.name === '外观');\n  \n  if (waiGuanClass && waiGuanClass.list && waiGuanClass.list.length > 0) {\n    console.log('外观图片总数:', waiGuanClass.list.length);\n    \n    const waiGuanViewTypes = ['view45', 'viewFront', 'view-45', 'viewSide'];\n    const waiGuanCount = Math.min(4, waiGuanClass.list.length);\n    \n    for (let i = 0; i < waiGuanCount; i++) {\n      const pic = waiGuanClass.list[i];\n      \n      imageList.push({\n        ...carInfo,  // 包含车型信息\n        image_url: pic.picpath,\n        image_index: i + 1,\n        category: '外观',\n        view_type: waiGuanViewTypes[i],\n        pic_id: pic.picid,\n        spec_id: pic.specid\n      });\n      \n      console.log(`外观图片 ${i + 1} [${waiGuanViewTypes[i]}]: ${pic.picpath}`);\n    }\n  }\n  \n  // ========== 2. 提取内饰图片 ==========\n  const neiShiClass = picinfo.callist.find(item => item.name === '内饰');\n  \n  if (neiShiClass && neiShiClass.list && neiShiClass.list.length > 0) {\n    console.log('内饰图片总数:', neiShiClass.list.length);\n    \n    const neiShiIndexes = [0, 5];\n    const neiShiViewTypes = ['viewCNSL', 'viewIP'];\n    \n    for (let i = 0; i < neiShiIndexes.length; i++) {\n      const index = neiShiIndexes[i];\n      \n      if (index < neiShiClass.list.length) {\n        const pic = neiShiClass.list[index];\n        \n        imageList.push({\n          ...carInfo,  // 包含车型信息\n          image_url: pic.picpath,\n          image_index: 4 + i + 1,  // 接续外观图片的编号\n          category: '内饰',\n          view_type: neiShiViewTypes[i],\n          pic_id: pic.picid,\n          spec_id: pic.specid\n        });\n        \n        console.log(`内饰图片 ${index + 1} [${neiShiViewTypes[i]}]: ${pic.picpath}`);\n      }\n    }\n  }\n  \n  // ========== 3. 提取座椅图片 ==========\n  const zuoYiClass = picinfo.callist.find(item => item.name === '座椅');\n  \n  if (zuoYiClass && zuoYiClass.list && zuoYiClass.list.length > 0) {\n    console.log('座椅图片总数:', zuoYiClass.list.length);\n    \n    const zuoYiIndex = 2;\n    \n    if (zuoYiIndex < zuoYiClass.list.length) {\n      const pic = zuoYiClass.list[zuoYiIndex];\n      \n      imageList.push({\n        ...carInfo,  // 包含车型信息\n        image_url: pic.picpath,\n        image_index: 7,  // 第7张图片\n        category: '座椅',\n        view_type: 'viewDoor',\n        pic_id: pic.picid,\n        spec_id: pic.specid\n      });\n      \n      console.log(`座椅图片 ${zuoYiIndex + 1} [viewDoor]: ${pic.picpath}`);\n    }\n  }\n  \n  if (imageList.length === 0) {\n    console.log('未找到任何图片');\n    return [{ json: { ...carInfo, error: '未找到图片' } }];\n  }\n  \n  console.log(`成功提取 ${imageList.length} 张图片`);\n  \n  // 返回结果\n  return imageList.map(img => ({ json: img }));\n  \n} catch (error) {\n  console.log('解析JSON出错:', error.message);\n  return [{ json: { ...carInfo, error: 'JSON解析失败: ' + error.message } }];\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4816,
        864
      ],
      "id": "6aa0fb2f-25cc-462c-b5ad-88d3907edd99",
      "name": "提取图片并合并信息",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "amount": 1
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        5008,
        864
      ],
      "id": "a359cca7-82b0-4f1f-a5a8-4ef8b81a728e",
      "name": "处理延迟",
      "webhookId": "wait-webhook-process"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.convertToFile",
      "typeVersion": 1.1,
      "position": [
        5008,
        624
      ],
      "id": "93172081-08f1-41b5-99df-96af2fda2ea0",
      "name": "转换为CSV"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1550254241,
          "mode": "list",
          "cachedResultName": "CarImageURLMVP用",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit#gid=1550254241"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {},
          "matchingColumns": [],
          "schema": [
            {
              "id": "series_id",
              "displayName": "series_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "series_name",
              "displayName": "series_name",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "price_range",
              "displayName": "price_range",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "vehicle_class",
              "displayName": "vehicle_class",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "brand_id",
              "displayName": "brand_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "image_url",
              "displayName": "image_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "image_index",
              "displayName": "image_index",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "category",
              "displayName": "category",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "view_type",
              "displayName": "view_type",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "pic_id",
              "displayName": "pic_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "spec_id",
              "displayName": "spec_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        5008,
        752
      ],
      "id": "0759423a-dfdd-405d-87da-3bfa4d0e93fa",
      "name": "Append row in sheet1",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YS5a72jpKHezwxcc",
          "name": "Google Sheets account 5"
        }
      }
    },
    {
      "parameters": {
        "content": "## 输入carID获得所有对应视角（GoogleSheet）\n\n\n",
        "height": 608,
        "width": 2160,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3344,
        544
      ],
      "typeVersion": 1,
      "id": "fe9e2a07-af09-416a-949d-67d6e4c6e7ab",
      "name": "Sticky Note12"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 611602121,
          "mode": "list",
          "cachedResultName": "AllinviteCodeMVP用",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit#gid=611602121"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        3984,
        1488
      ],
      "id": "9a1915b7-1f0f-4dce-be10-6859791f57d7",
      "name": "读取邀请码数据",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YS5a72jpKHezwxcc",
          "name": "Google Sheets account 5"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "api/login",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "473e3127-75b3-433a-86b8-618a07917484",
      "name": "Webhook - 接收登录请求1",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        3760,
        1488
      ],
      "webhookId": "c29dd183-8c5a-485b-b667-18afd2f17ee8"
    },
    {
      "parameters": {
        "jsCode": "// 获取请求的邀请码\nconst requestCode = $('Webhook - 接收登录请求1').first().json.body.inviteCode;\n\n// 获取所有数据\nconst allData = $input.all();\n\n// 查找匹配项\nconst matched = allData.find(item => \n  item.json.inviteCode === requestCode && item.json.status === 'active'\n);\n\n// 返回结果\nif (matched) {\n  return [{ json: { ...matched.json, isValid: true } }];\n} else {\n  return [{ json: { isValid: false, requestedCode: requestCode } }];\n}"
      },
      "id": "44cab036-3b28-43a1-9f7d-9a8cb7cfea6d",
      "name": "查找匹配邀请码",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4208,
        1488
      ]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 1
          },
          "conditions": [
            {
              "id": "check-valid",
              "leftValue": "={{ $json.isValid }}",
              "rightValue": "true",
              "operator": {
                "type": "boolean",
                "operation": "true",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "eb63bec1-e843-43df-828b-fd0e1c400eb1",
      "name": "IF判断是否有效",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        4432,
        1488
      ]
    },
    {
      "parameters": {
        "jsCode": "const user = $input.first().json;\nconst now = new Date().toISOString().split('T')[0];\n\nreturn [{\n  json: {\n    success: true,\n    message: '登录成功',\n    data: {\n      inviteCode: user.inviteCode,\n      userName: user.userName,\n      email: user.email,\n      lastLoginAt: now\n    },\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "d3f12c61-765d-4c8e-a067-7e8aff34baa2",
      "name": "✅ 登录成功1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4656,
        1376
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseCode": 200,
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              },
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "POST, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              }
            ]
          }
        }
      },
      "id": "a0d02395-c4b8-4697-b8df-f9756cb221db",
      "name": "返回成功响应1",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        4880,
        1376
      ]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\n\nreturn [{\n  json: {\n    success: false,\n    message: '邀请码无效或账户已被禁用',\n    data: {\n      inviteCode: data.requestedCode\n    },\n    timestamp: new Date().toISOString()\n  }\n}];"
      },
      "id": "9a30bfe1-fb34-4902-90c8-d4749492dbd1",
      "name": "❌ 登录失败1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4656,
        1600
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseCode": 401,
          "responseHeaders": {
            "entries": [
              {
                "name": "Content-Type",
                "value": "application/json"
              },
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "POST, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              }
            ]
          }
        }
      },
      "id": "da30c2aa-72dd-4cda-acc4-3addd36b5a9b",
      "name": "返回失败响应1",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        4880,
        1600
      ]
    },
    {
      "parameters": {
        "content": "## 登录API\n\n",
        "height": 608,
        "width": 2160
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3344,
        1232
      ],
      "typeVersion": 1,
      "id": "7e15b67a-82e7-41b1-99d9-891081d282c6",
      "name": "Sticky Note13"
    },
    {
      "parameters": {
        "jsCode": "// 批量处理所有车型 - 优化版(驼峰命名 + 大写变体)\nconst items = $input.all();\nconst allVectors = [];\nconsole.log(`开始处理 ${items.length} 个车型`);\n\nfor (const item of items) {\n  const row = item.json;\n  \n  // 使用新的驼峰命名字段\n  if (!row.carName || !row.carID || !row.brandID) {\n    console.log(`跳过无效行: ${JSON.stringify(row)}`);\n    continue;\n  }\n  \n  const carName = row.carName.trim();\n  const carID = row.carID.toString().trim();\n  const brandID = row.brandID.toString().trim();\n  const priceRange = row.carPriceRange || '';\n  const vehicleClass = row.vehicleClass || '';\n  const bodyStructure = row.bodyStructure || '';\n  \n  // 生成多个变体以提高匹配率\n  const variants = [\n    carName,                                          // 原名: 理想汽车-理想i6\n    carName.toLowerCase(),                            // 小写: 理想汽车-理想i6\n    carName.toUpperCase(),                            // 大写: 理想汽车-理想I6\n    carName.replace(/\\s+/g, ''),                     // 无空格: 理想汽车-理想i6\n    carName.replace(/-/g, ''),                       // 无连字符: 理想汽车理想i6\n    carName.replace(/-/g, '').toUpperCase(),         // 无连字符+大写: 理想汽车理想I6\n    carName.split('-').pop()?.trim() || carName,     // 只取后半部分: 理想i6\n    carName.split('-').pop()?.trim().toUpperCase() || '' // 后半部分大写: 理想I6\n  ];\n  \n  // 去重并过滤空值\n  const uniqueVariants = [...new Set(variants)].filter(v => v && v.length > 0);\n  \n  console.log(`${carName}: 生成 ${uniqueVariants.length} 个变体`);\n  \n  // 为每个变体创建向量记录(Pinecone 嵌套格式)\n  for (const variant of uniqueVariants) {\n    allVectors.push({\n      id: `${carID}_${variant}`,\n      values: [],  // 后续由 Embeddings 节点填充\n      metadata: {\n        type: 'car_mapping',\n        carName: carName,\n        carID: carID,\n        brandID: brandID,\n        variant: variant,\n        text: variant,  // 用于生成 embedding 的文本\n        priceRange: priceRange,\n        vehicleClass: vehicleClass,\n        bodyStructure: bodyStructure,\n        timestamp: new Date().toISOString(),\n        source: 'google_sheets'\n      }\n    });\n  }\n}\n\nconsole.log(`✅ 共生成 ${allVectors.length} 个向量待处理`);\nreturn allVectors;  // 直接返回数组，n8n 会自动处理"
      },
      "id": "e1291c69-0484-4642-969c-46db313af8c1",
      "name": "批量处理车型数据",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6096,
        32
      ],
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "pollTimes": {
          "item": [
            {
              "mode": "everyMinute"
            }
          ]
        },
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 2027336631,
          "mode": "list",
          "cachedResultName": "NewallCarMappingMVP用",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit#gid=2027336631"
        },
        "options": {}
      },
      "id": "45011ebb-fc55-4b6c-a37c-3ecce5af3040",
      "name": "监听车型表格2",
      "type": "n8n-nodes-base.googleSheetsTrigger",
      "typeVersion": 1,
      "position": [
        5872,
        32
      ],
      "credentials": {
        "googleSheetsTriggerOAuth2Api": {
          "id": "1agOeqhrJ2yNerY9",
          "name": "Google Sheets Trigger account 3"
        }
      }
    },
    {
      "parameters": {
        "jsonMode": "expressionData",
        "jsonData": "={{ $json.metadata.text }}",
        "options": {
          "metadata": {
            "metadataValues": [
              {
                "name": "carID",
                "value": "={{ $json.metadata.carID }}"
              },
              {
                "name": "carName",
                "value": "={{ $json.metadata.carName }}"
              },
              {
                "name": "brandID",
                "value": "={{ $json.metadata.brandID }}"
              },
              {
                "name": "variant",
                "value": "={{ $json.metadata.variant }}"
              },
              {
                "name": "priceRange",
                "value": "={{ $json.metadata.priceRange }}"
              },
              {
                "name": "vehicleClass",
                "value": "={{ $json.metadata.vehicleClass }}"
              },
              {
                "name": "bodyStructure",
                "value": "={{ $json.metadata.bodyStructure }}"
              },
              {
                "name": "type",
                "value": "={{ $json.metadata.type }}"
              },
              {
                "name": "timestamp",
                "value": "={{ $json.metadata.timestamp }}"
              },
              {
                "name": "source",
                "value": "={{ $json.metadata.source }}"
              }
            ]
          }
        }
      },
      "id": "668f7ed7-23c2-485d-b33a-b7286c476821",
      "name": "文档加载器2",
      "type": "@n8n/n8n-nodes-langchain.documentDefaultDataLoader",
      "typeVersion": 1.1,
      "position": [
        6336,
        240
      ]
    },
    {
      "parameters": {
        "options": {
          "dimensions": 1024
        }
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        6240,
        240
      ],
      "id": "8ec34029-a9e3-4938-b9b6-febdd1eec317",
      "name": "Embeddings OpenAI3",
      "credentials": {
        "openAiApi": {
          "id": "i9YtN4AdSgS8mWcx",
          "name": "openai-workshop"
        }
      }
    },
    {
      "parameters": {
        "mode": "insert",
        "pineconeIndex": {
          "__rl": true,
          "value": "sample-movies",
          "mode": "list",
          "cachedResultName": "sample-movies"
        },
        "options": {
          "pineconeNamespace": "car_mapping_v2"
        }
      },
      "id": "689a532d-9326-46ee-8744-0bb4f049efb1",
      "name": "存储到Pinecone2",
      "type": "@n8n/n8n-nodes-langchain.vectorStorePinecone",
      "typeVersion": 1,
      "position": [
        6288,
        32
      ],
      "credentials": {
        "pineconeApi": {
          "id": "63U996StLJtJbjSj",
          "name": "PineconeApi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 记录批量结果\nconst totalVectors = $input.all().length;\n\nconsole.log(`✅ 成功批量存储 ${totalVectors} 个向量到Pinecone`);\n\nreturn {\n  json: {\n    success: true,\n    totalVectors: totalVectors,\n    timestamp: new Date().toISOString(),\n    message: `批量同步完成,共 ${totalVectors} 个向量已存储到 namespace: car_mapping_v2`\n  }\n};"
      },
      "id": "97899fac-dc1f-4615-9bfe-3d4460f88a2f",
      "name": "记录结果2",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6816,
        32
      ]
    },
    {
      "parameters": {
        "content": "## Car相关信息转入Pinecone\n\n\n",
        "height": 624,
        "width": 1632,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        5600,
        -160
      ],
      "typeVersion": 1,
      "id": "453645fe-1113-4ee5-a1f3-a15eda9c8eff",
      "name": "Sticky Note14"
    },
    {
      "parameters": {
        "jsCode": "const carName = $('准备查询').item.json.carName;\nconst categoryCode = $('准备查询').item.json.categoryCode;\nconst categoryName = $('准备查询').item.json.categoryName;\nconst response = $input.item.json;\nconsole.log('SerpAPI响应:', JSON.stringify(response, null, 2));\n// SerpAPI返回的数据结构\nconst organicResults = response.organic_results || [];\nconsole.log('找到', organicResults.length, '个搜索结果');\nlet carId = null;\n// 遍历搜索结果\nfor (const result of organicResults) {\n  const link = result.link || '';\n  console.log('检查链接:', link);\n\n  // 从链接中提取carId\n  const patterns = [\n    /autohome\\.com\\.cn\\/(\\d{4,5})\\//,\n    /series-(\\d{4,5})\\.html/,\n    /config\\/series\\/(\\d{4,5})/\n  ];\n\n  for (const pattern of patterns) {\n    const match = link.match(pattern);\n    if (match && match[1]) {\n      carId = match[1];\n      console.log('找到carId:', carId);\n      break;\n    }\n  }\n\n  if (carId) break;\n}\nif (carId && /^\\d{4,5}$/.test(carId)) {\n  return {\n    json: {\n      carId: carId,\n      carName: carName,\n      categoryCode: categoryCode,\n      categoryName: categoryName,\n      matchType: 'serpapi_search',\n      resolved: true\n    }\n  };\n}\nreturn {\n  json: {\n    success: false,\n    error: '未能从搜索结果中提取carId',\n    code: 'EXTRACTION_FAILED',\n    carName: carName,\n    debug: {\n      resultsCount: organicResults.length,\n      firstResult: organicResults[0]?.link || 'none'\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2176,
        2096
      ],
      "id": "b2989ccd-86cb-41b3-8283-3061da1201cc",
      "name": "处理SerpAPI响应"
    },
    {
      "parameters": {
        "options": {
          "dimensions": 1024
        }
      },
      "type": "@n8n/n8n-nodes-langchain.embeddingsOpenAi",
      "typeVersion": 1.2,
      "position": [
        1360,
        2480
      ],
      "id": "d638a340-06d8-45e1-9846-694e7d799508",
      "name": "Embeddings OpenAI",
      "credentials": {
        "openAiApi": {
          "id": "i9YtN4AdSgS8mWcx",
          "name": "openai-workshop"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const params = $('安全参数验证').item.json;\nconst carName = params.carName;\nconst categoryName = params.categoryName;\nconst carId = params.carId;\nconst categoryCode = params.categoryCode;\nconst matchType = params.matchType;\n\nif ($input.item.json.error) {\n  return {\n    json: {\n      success: false,\n      error: '页面获取失败',\n      message: $input.item.json.error.message || '网络请求错误',\n      code: 'HTTP_REQUEST_FAILED',\n      carId: carId,\n      carName: carName\n    }\n  };\n}\n\n// 直接获取原始HTML（不管编码，只提取URL）\nlet html = '';\n\ntry {\n  if ($input.item.binary && $input.item.binary.data) {\n    // 方案1: 从二进制数据提取（推荐）\n    const binaryData = $input.item.binary.data;\n    if (Buffer.isBuffer(binaryData)) {\n      html = binaryData.toString('latin1'); // latin1可以保留所有字节，URL不受影响\n    } else if (binaryData.data) {\n      html = Buffer.from(binaryData.data).toString('latin1');\n    }\n  } \n  \n  if (!html || html.length < 100) {\n    // 方案2: 降级到文本模式\n    html = String($input.item.json.data || $input.item.json.body || '');\n  }\n} catch (error) {\n  html = String($input.item.json.data || $input.item.json.body || '');\n}\n\nif (html.length < 1000) {\n  return {\n    json: {\n      success: false,\n      error: '页面内容异常',\n      code: 'INVALID_PAGE_CONTENT',\n      debug: {\n        hasBinary: !!$input.item.binary,\n        hasJsonData: !!$input.item.json.data,\n        htmlLength: html.length\n      }\n    }\n  };\n}\n\nfunction extractImages(htmlContent, maxImages = 30) {\n  const images = [];\n  const seenUrls = new Set();\n  \n  // 提取图片URL的多种模式\n  const patterns = [\n    // 高清webp图片\n    /data-webp\\s*=\\s*[\"']([^\"']+)[\"']/gi,\n    // 原始图片\n    /data-original\\s*=\\s*[\"']([^\"']+)[\"']/gi,\n    // src属性（备用）\n    /src\\s*=\\s*[\"'](https?:\\/\\/[^\"']*(?:autoimg\\.cn|autohome\\.com\\.cn)[^\"']*)[\"']/gi\n  ];\n  \n  for (const pattern of patterns) {\n    let match;\n    while ((match = pattern.exec(htmlContent)) !== null && images.length < maxImages) {\n      let url = match[1];\n      \n      // 基本验证\n      if (!url || url.length > 500 || seenUrls.has(url)) continue;\n      \n      // URL标准化\n      if (url.startsWith('//')) {\n        url = 'https:' + url;\n      } else if (!url.startsWith('http')) {\n        continue;\n      }\n      \n      // 过滤有效图片URL\n      if ((url.includes('autoimg.cn') || url.includes('autohome.com.cn')) && \n          !url.includes('base64') &&\n          (url.includes('/cardfs/') || url.includes('/product/') || url.includes('.jpg') || url.includes('.webp'))) {\n        \n        seenUrls.add(url);\n        images.push({\n          url: url,\n          type: url.includes('data-webp') ? 'high_quality' : 'standard',\n          category: categoryName,\n          carName: carName\n        });\n      }\n    }\n  }\n  \n  return images;\n}\n\nconst images = extractImages(html);\n\nreturn {\n  json: {\n    success: images.length > 0,\n    carId: carId,\n    carName: carName,\n    category: categoryName,\n    categoryCode: categoryCode,\n    matchType: matchType,\n    totalImages: images.length,\n    images: images,\n    message: images.length > 0 ? `成功获取${images.length}张图片` : '未找到图片',\n    code: images.length > 0 ? 'SUCCESS' : 'NO_IMAGES_FOUND',\n    metadata: {\n      htmlLength: html.length,\n      urlUsed: `https://car.autohome.com.cn/pic/series/${carId}-${categoryCode}.html`,\n      timestamp: new Date().toISOString()\n    }\n  }\n};"
      },
      "id": "5cb5818a-792f-40fd-89ad-378df3af6063",
      "name": "安全解析提取",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2832,
        2288
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "url": "={{ 'https://car.autohome.com.cn/pic/series/' + $json.carId + '-' + $json.categoryCode + '.html' }}",
        "options": {
          "redirect": {
            "redirect": {
              "followRedirects": true,
              "maxRedirects": 3
            }
          },
          "response": {
            "response": {
              "responseFormat": "text"
            }
          },
          "timeout": 15000
        }
      },
      "id": "be835c48-a560-43b8-8885-fd6d9b955f37",
      "name": "爬取目标页面",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        2640,
        2288
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// 安全参数验证\nconst data = $input.item.json;\n\nif (data.success === false) {\n  return { json: data };\n}\n\nif (!data.resolved) {\n  return {\n    json: {\n      success: false,\n      error: '车型识别失败',\n      code: 'RESOLVE_FAILED'\n    }\n  };\n}\n\nconst carId = data.carId;\nconst categoryCode = data.categoryCode;\nconst carName = data.carName || '';\nconst categoryName = data.categoryName || '';\n\nif (!carId || !/^\\d+$/.test(carId.toString())) {\n  return {\n    json: {\n      success: false,\n      error: 'carId格式无效',\n      code: 'INVALID_CAR_ID'\n    }\n  };\n}\n\nconst allowedCategories = ['1', '10', '3'];\nif (!allowedCategories.includes(categoryCode)) {\n  return {\n    json: {\n      success: false,\n      error: 'categoryCode无效',\n      code: 'INVALID_CATEGORY'\n    }\n  };\n}\n\nconst sanitize = (str) => str.replace(/[<>\"'&]/g, '');\n\nreturn {\n  json: {\n    carId: carId,\n    carName: sanitize(carName),\n    categoryCode: categoryCode,\n    categoryName: sanitize(categoryName),\n    matchType: data.matchType,\n    validated: true\n  }\n};"
      },
      "id": "ce6ec7d4-455a-44d9-8596-7d5e6da20448",
      "name": "安全参数验证",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2448,
        2288
      ]
    },
    {
      "parameters": {
        "url": "=https://serpapi.com/search.json?engine=google&q=site:autohome.com.cn+{{ $json.carName }}&api_key=c6805b62d6f0757df69b7b0f41e27570c6b8989caec90d8356e455cf76794514",
        "options": {
          "redirect": {
            "redirect": {
              "followRedirects": true,
              "maxRedirects": 5
            }
          },
          "response": {
            "response": {
              "responseFormat": "json"
            }
          },
          "timeout": 15000
        }
      },
      "id": "d1cf3c6e-ad2d-4863-b84b-eb6979424718",
      "name": "搜索车型",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        2032,
        2096
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.needsSearch }}",
              "value2": true
            }
          ]
        }
      },
      "id": "d014dccf-e24c-4c56-b5f4-cdf80d5faf04",
      "name": "检查是否需要搜索",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        1824,
        2272
      ]
    },
    {
      "parameters": {
        "jsCode": "// 分析向量搜索结果 - 修复字段匹配问题\nconst originalInput = $('准备查询').item.json;\nconst results = $input.all();\n\nconst THRESHOLD = 0.75;\n\nif (!results || results.length === 0) {\n  console.log('Pinecone未返回结果，降级到SerpAPI');\n  return {\n    json: {\n      needsSearch: true,\n      carName: originalInput.carName,\n      categoryCode: originalInput.categoryCode,\n      categoryName: originalInput.categoryName,\n      matchType: 'no_vector_results'\n    }\n  };\n}\n\nconst topResult = results[0].json;\nconst similarityScore = topResult.score || 0;\nconst metadata = topResult.document.metadata || {};\n\nconsole.log(`向量匹配: ${originalInput.carName} -> ${metadata.variant || metadata.carName}, 相似度: ${similarityScore}`);\n\n// ✅ 修复：匹配正确的字段名 carID（大写D）\nconst carId = metadata.carID || metadata.carId || metadata.series_id;\nconst brandID = metadata.brandID || metadata.brandId;\nconst carName = metadata.variant || metadata.carName || originalInput.carName;\n\nconsole.log(`提取到的数据: carID=${carId}, brandID=${brandID}, carName=${carName}`);\n\nif (similarityScore >= THRESHOLD && carId) {\n  console.log(`✅ 向量搜索成功！carID: ${carId}, carName: ${carName}, brandID: ${brandID}`);\n  return {\n    json: {\n      needsSearch: false,\n      resolved: true,\n      carId: carId,\n      carName: carName,\n      brandID: brandID,\n      categoryCode: originalInput.categoryCode,\n      categoryName: originalInput.categoryName,\n      matchType: 'vector_search',\n      similarityScore: similarityScore\n    }\n  };\n}\n\nconsole.log(`相似度${similarityScore}低于阈值${THRESHOLD}或缺少carID，降级到SerpAPI`);\nreturn {\n  json: {\n    needsSearch: true,\n    carName: originalInput.carName,\n    categoryCode: originalInput.categoryCode,\n    categoryName: originalInput.categoryName,\n    matchType: 'low_similarity',\n    similarityScore: similarityScore,\n    debug: {\n      hasCarID: !!metadata.carID,\n      hasBrandID: !!metadata.brandID,\n      extractedCarId: carId,\n      metadata: metadata\n    }\n  }\n};"
      },
      "id": "c5ae942b-354b-4ffd-8d1a-553b8ec9651a",
      "name": "分析结果",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1664,
        2272
      ]
    },
    {
      "parameters": {
        "mode": "load",
        "pineconeIndex": {
          "__rl": true,
          "value": "sample-movies",
          "mode": "list",
          "cachedResultName": "sample-movies"
        },
        "prompt": "={{ $json.searchQuery }}",
        "topK": 1,
        "options": {
          "pineconeNamespace": "car_mapping_v2",
          "metadata": {
            "metadataValues": [
              {
                "name": "type",
                "value": "car_mapping"
              }
            ]
          }
        }
      },
      "id": "ae58a49d-f747-4a0d-af81-3a0664d8028f",
      "name": "Pinecone查询",
      "type": "@n8n/n8n-nodes-langchain.vectorStorePinecone",
      "typeVersion": 1,
      "position": [
        1360,
        2272
      ],
      "credentials": {
        "pineconeApi": {
          "id": "63U996StLJtJbjSj",
          "name": "PineconeApi account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 准备向量查询\nconst carName = ( $input.first().json.series_name || '').trim();\nconst categoryName = ($input.item.json.categoryName || '外观').trim();\n\nif (!carName) {\n  return {\n    json: {\n      success: false,\n      error: '请提供车型名称',\n      code: 'CAR_NAME_REQUIRED'\n    }\n  };\n}\n\n// 统一分类映射（保留）\nconst categoryMapping = {\n  '外观': '1',\n  '内饰': '10',\n  '座椅': '3',\n  '细节': '12'\n};\n\nconst categoryCode = categoryMapping[categoryName] || '1';\n\nconsole.log(`准备查询车型: ${carName}`);\n\nreturn {\n  json: {\n    searchQuery: carName,\n    carName: carName,\n    categoryCode: categoryCode,\n    categoryName: categoryName\n  }\n};"
      },
      "id": "ee8ce859-c08d-486e-8202-d6105c63a88a",
      "name": "准备查询",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1200,
        2272
      ]
    },
    {
      "parameters": {
        "keepOnlySet": true,
        "values": {
          "string": [
            {
              "name": "series_name",
              "value": "={{ $json.body && $json.body.carName ? $json.body.carName : $json.carName }}"
            },
            {
              "name": "categoryName",
              "value": "={{ $json.body && $json.body.categoryName ? $json.body.categoryName : ($json.categoryName || '外观') }}"
            }
          ]
        },
        "options": {}
      },
      "id": "1a264bad-afca-4236-a9f9-17bf74608fa7",
      "name": "提取用户输入",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [
        1008,
        2272
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "fdd98df6-7299-4b18-9d51-e533b62fd656",
      "name": "返回响应1",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        2976,
        2288
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "17f1615b-955b-4277-b081-0ee3aa3b95be",
        "responseMode": "responseNode",
        "options": {
          "rawBody": false
        }
      },
      "id": "a9e8b9e9-8b91-4c17-8355-802852f4cbf9",
      "name": "Webhook触发1",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        768,
        2272
      ],
      "webhookId": "17f1615b-955b-4277-b081-0ee3aa3b95be",
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "content": "## 多维度搜索\n\n",
        "height": 768,
        "width": 2448
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        688,
        1968
      ],
      "typeVersion": 1,
      "id": "0488ac99-0db9-4d66-9542-cff17cc2bdaf",
      "name": "Sticky Note15"
    },
    {
      "parameters": {
        "content": "## 筛选图片功能\n\n\n",
        "height": 768,
        "width": 2448
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3344,
        1968
      ],
      "typeVersion": 1,
      "id": "c6fc323c-e3af-4911-8e1e-89d7cb1e282b",
      "name": "Sticky Note16"
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "car-image-filter",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*, null"
        }
      },
      "id": "121a7e1e-3c4d-4b15-978c-4ec3ca150d05",
      "name": "Webhook接收筛选请求1",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        3600,
        2240
      ],
      "webhookId": "car-image-filter"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1550254241,
          "mode": "list",
          "cachedResultName": "CarImageURLMVP用",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit#gid=1550254241"
        },
        "options": {}
      },
      "id": "3ed5c50d-138e-4406-bfab-6f144d9f0c96",
      "name": "读取Google Sheet",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        4080,
        2240
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YS5a72jpKHezwxcc",
          "name": "Google Sheets account 5"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// ✅ 优化版 - 解析并转换筛选参数\nconst input = $input.item.json.body || $input.item.json;\n\n// 🎯 视角映射表：中文 → 英文（Google Sheet格式）\nconst VIEW_MAPPING = {\n  '正45°': ['view45'],              // ✅ 正面45度角\n  '侧45°': ['view-45'],             // ✅ 侧面45度角（新增）\n  '前脸': ['viewfront', 'viewFront'],\n  '正侧图': ['viewside', 'viewSide'],\n  '门板': ['viewdoor', 'viewDoor'],\n  'IP': ['viewip', 'viewIP'],\n  'CNSL': ['viewcnsl', 'viewCNSL'],\n  '座椅': ['viewseat', 'viewSeat']\n};\n\n// 转换视角参数\nlet convertedViews = [];\nif (Array.isArray(input.views) && input.views.length > 0) {\n  input.views.forEach(view => {\n    const mappedViews = VIEW_MAPPING[view];\n    if (mappedViews) {\n      convertedViews = convertedViews.concat(mappedViews);\n    } else {\n      // 如果没有映射，保留原值（兼容直接传英文的情况）\n      convertedViews.push(view);\n    }\n  });\n}\n\nconst filters = {\n  keyword: (input.keyword || '').trim(),\n  brands: Array.isArray(input.brands) ? input.brands : [],\n  models: Array.isArray(input.models) ? input.models : [],\n  views: convertedViews,\n  originalViews: input.views || [],\n  timestamp: new Date().toISOString()\n};\n\nconsole.log('===== 接收到的筛选条件 =====');\nconsole.log('关键词:', filters.keyword);\nconsole.log('品牌:', filters.brands.join(', ') || '无');\nconsole.log('车型:', filters.models.join(', ') || '无');\nconsole.log('视角（原始）:', filters.originalViews.join(', ') || '无');\nconsole.log('视角（转换后）:', filters.views.join(', ') || '无');\nconsole.log('==============================');\n\nreturn { json: filters };"
      },
      "id": "b525215b-1bb0-4a2b-8889-6cf4d675f75e",
      "name": "解析筛选条件",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3888,
        2240
      ]
    },
    {
      "parameters": {
        "jsCode": "// 高级筛选逻辑 - 修复版\nconst filters = $('解析筛选条件').item.json;\nconst sheetData = $input.all();\n\nconsole.log('===== 筛选执行 =====');\nconsole.log('总数据条数:', sheetData.length);\nconsole.log('筛选条件:', JSON.stringify(filters));\n\n// 筛选函数\nfunction matchesFilters(row) {\n  const carName = (row.carName || '').toLowerCase();\n  const vehicleClass = (row.vehicleClass || '').toLowerCase();\n  const viewType = (row.viewType || '').toLowerCase(); // 转小写\n  \n  // 1. 关键词搜索 - 修复版（支持多关键词，任一匹配）\n  if (filters.keyword) {\n    const keywords = filters.keyword.toLowerCase().split(/\\s+/); // 按空格分割\n    const matchesAnyKeyword = keywords.some(keyword => \n      keyword && carName.includes(keyword)\n    );\n    if (!matchesAnyKeyword) {\n      return false;\n    }\n  }\n  \n  // 2. 品牌筛选\n  if (filters.brands && filters.brands.length > 0) {\n    const matchesBrand = filters.brands.some(brand => \n      carName.includes(brand.toLowerCase())\n    );\n    if (!matchesBrand) {\n      return false;\n    }\n  }\n  \n  // 3. 车型筛选 - 匹配 vehicleClass 或 carName\n  if (filters.models && filters.models.length > 0) {\n    const matchesModel = filters.models.some(model => {\n      const modelLower = model.toLowerCase();\n      // vehicleClass 可能是 \"紧凑型车Sedan\"，所以用 includes\n      return vehicleClass.includes(modelLower) || carName.includes(modelLower);\n    });\n    if (!matchesModel) {\n      return false;\n    }\n  }\n  \n  // 4. 视角筛选 - 转小写比较\n  if (filters.views && filters.views.length > 0) {\n    const matchesView = filters.views.some(view => \n      viewType === view.toLowerCase()\n    );\n    if (!matchesView) {\n      return false;\n    }\n  }\n  \n  return true;\n}\n\n// 执行筛选\nconst filteredResults = [];\nsheetData.forEach((item, index) => {\n  if (matchesFilters(item.json)) {\n    filteredResults.push({\n      json: item.json,\n      pairedItem: { item: index }\n    });\n  }\n});\n\nconsole.log('筛选后结果数:', filteredResults.length);\nconsole.log('====================');\n\n// 如果没有结果\nif (filteredResults.length === 0) {\n  return [{\n    json: {\n      _noResults: true,\n      message: '未找到匹配的结果',\n      filters: filters\n    },\n    pairedItem: { item: 0 }\n  }];\n}\n\nreturn filteredResults;"
      },
      "id": "fea8a5f4-eb76-412f-b9ba-e703b194d195",
      "name": "执行筛选",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4336,
        2240
      ]
    },
    {
      "parameters": {
        "jsCode": "// 格式化返回结果\nconst allItems = $input.all();\nconst filters = $('解析筛选条件').item.json;\n\n// 检查是否有结果\nif (allItems.length === 1 && allItems[0].json._noResults) {\n  return {\n    json: {\n      success: true,\n      count: 0,\n      results: [],\n      filters: filters,\n      message: '未找到匹配的结果',\n      timestamp: new Date().toISOString()\n    }\n  };\n}\n\n// 提取所有结果\nconst results = allItems.map(item => item.json);\n\nconsole.log('===== 最终返回 =====');\nconsole.log('结果数量:', results.length);\nconsole.log('完整返回数据:', JSON.stringify({\n  success: true,\n  count: results.length,\n  results: results.slice(0, 2), // 只打印前2条\n  filters: filters\n}, null, 2));\nconsole.log('====================');\n\nreturn {\n  json: {\n    success: true,\n    count: results.length,\n    results: results,\n    filters: filters,\n    timestamp: new Date().toISOString()\n  }\n};\n\nconsole.log('完整返回数据:', JSON.stringify({\n  success: true,\n  count: results.length,\n  results: results.slice(0, 2)\n}, null, 2));"
      },
      "id": "359ebe7b-ff89-4772-9ee7-f853d03caebd",
      "name": "格式化响应",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4656,
        2240
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "POST, GET, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type, Authorization"
              },
              {
                "name": "Content-Type",
                "value": "application/json; charset=utf-8"
              }
            ]
          }
        }
      },
      "id": "81061b11-e921-4f27-a493-b458c01a95b2",
      "name": "返回结果1",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        4960,
        2240
      ]
    },
    {
      "parameters": {
        "content": "## GoogleSheet直接搜索\n\n\n\n",
        "height": 768,
        "width": 3232
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3344,
        2880
      ],
      "typeVersion": 1,
      "id": "4ba36bcc-6c06-4151-a6c4-41c7b2b37cdb",
      "name": "Sticky Note17"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1837650523,
          "mode": "list",
          "cachedResultName": "NewallCarMapping完整",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit#gid=1837650523"
        },
        "options": {}
      },
      "id": "a99fb46c-1fb8-485a-808e-acfe8597e32c",
      "name": "读取Google Sheet2",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        4112,
        3248
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YS5a72jpKHezwxcc",
          "name": "Google Sheets account 5"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 模糊匹配算法 - 最小修改版\nconst inputCarName = $('准备查询2').item.json.carName;\nconst allCars = $input.all();\n\nconst MATCH_THRESHOLD = 0.70; // 匹配阈值70%\n\nconsole.log(`\\n===== 开始模糊匹配 =====`);\nconsole.log(`输入车型: ${inputCarName}`);\nconsole.log(`数据库总数: ${allCars.length}`);\n\n// ===== 字符串相似度算法 =====\n\n// 1. Levenshtein距离（编辑距离）\nfunction levenshteinDistance(str1, str2) {\n  const len1 = str1.length;\n  const len2 = str2.length;\n  const matrix = [];\n\n  for (let i = 0; i <= len1; i++) {\n    matrix[i] = [i];\n  }\n  for (let j = 0; j <= len2; j++) {\n    matrix[0][j] = j;\n  }\n\n  for (let i = 1; i <= len1; i++) {\n    for (let j = 1; j <= len2; j++) {\n      const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;\n      matrix[i][j] = Math.min(\n        matrix[i - 1][j] + 1,\n        matrix[i][j - 1] + 1,\n        matrix[i - 1][j - 1] + cost\n      );\n    }\n  }\n\n  return matrix[len1][len2];\n}\n\n// 2. 基于编辑距离的相似度（0-1）\nfunction levenshteinSimilarity(str1, str2) {\n  const maxLen = Math.max(str1.length, str2.length);\n  if (maxLen === 0) return 1.0;\n  const distance = levenshteinDistance(str1, str2);\n  return 1 - distance / maxLen;\n}\n\n// 3. Jaro-Winkler相似度\nfunction jaroWinklerSimilarity(s1, s2) {\n  // Jaro相似度\n  function jaroSimilarity(s1, s2) {\n    if (s1.length === 0 && s2.length === 0) return 1.0;\n    if (s1.length === 0 || s2.length === 0) return 0.0;\n\n    const matchDistance = Math.floor(Math.max(s1.length, s2.length) / 2) - 1;\n    const s1Matches = new Array(s1.length).fill(false);\n    const s2Matches = new Array(s2.length).fill(false);\n\n    let matches = 0;\n    let transpositions = 0;\n\n    for (let i = 0; i < s1.length; i++) {\n      const start = Math.max(0, i - matchDistance);\n      const end = Math.min(i + matchDistance + 1, s2.length);\n\n      for (let j = start; j < end; j++) {\n        if (s2Matches[j] || s1[i] !== s2[j]) continue;\n        s1Matches[i] = true;\n        s2Matches[j] = true;\n        matches++;\n        break;\n      }\n    }\n\n    if (matches === 0) return 0.0;\n\n    let k = 0;\n    for (let i = 0; i < s1.length; i++) {\n      if (!s1Matches[i]) continue;\n      while (!s2Matches[k]) k++;\n      if (s1[i] !== s2[k]) transpositions++;\n      k++;\n    }\n\n    return (\n      (matches / s1.length +\n        matches / s2.length +\n        (matches - transpositions / 2) / matches) /\n      3\n    );\n  }\n\n  const jaro = jaroSimilarity(s1, s2);\n  const prefixLength = Math.min(4, s1.length, s2.length);\n  let prefix = 0;\n  for (let i = 0; i < prefixLength; i++) {\n    if (s1[i] === s2[i]) prefix++;\n    else break;\n  }\n\n  return jaro + prefix * 0.1 * (1 - jaro);\n}\n\n// 4. 简单包含匹配\nfunction containsMatch(input, target) {\n  const inputLower = input.toLowerCase();\n  const targetLower = target.toLowerCase();\n  \n  // 完全包含\n  if (targetLower.includes(inputLower) || inputLower.includes(targetLower)) {\n    return 1.0;\n  }\n  \n  // 分词后的包含匹配\n  const inputTokens = inputLower.split(/[\\s\\-]+/);\n  const targetTokens = targetLower.split(/[\\s\\-]+/);\n  \n  let matchCount = 0;\n  for (const inputToken of inputTokens) {\n    if (inputToken.length < 2) continue;\n    for (const targetToken of targetTokens) {\n      if (targetToken.includes(inputToken) || inputToken.includes(targetToken)) {\n        matchCount++;\n        break;\n      }\n    }\n  }\n  \n  return inputTokens.length > 0 ? matchCount / inputTokens.length : 0;\n}\n\n// 5. 品牌+车型分离匹配（针对中文车型）\nfunction brandModelMatch(input, target) {\n  const inputParts = input.split(/[-\\s]+/);\n  const targetParts = target.split(/[-\\s]+/);\n  \n  if (inputParts.length < 2 || targetParts.length < 2) {\n    return 0;\n  }\n  \n  // 品牌匹配\n  const brandMatch = inputParts[0].toLowerCase() === targetParts[0].toLowerCase() ? 1 : 0;\n  \n  // 车型匹配\n  const modelSimilarity = levenshteinSimilarity(\n    inputParts.slice(1).join('').toLowerCase(),\n    targetParts.slice(1).join('').toLowerCase()\n  );\n  \n  // 品牌必须匹配，车型相似度>=0.6\n  return brandMatch && modelSimilarity >= 0.6 ? (brandMatch + modelSimilarity) / 2 : 0;\n}\n\n// ===== 综合匹配计算 =====\nfunction calculateComprehensiveScore(input, target) {\n  const inputNorm = input.replace(/\\s+/g, '').toLowerCase();\n  const targetNorm = target.replace(/\\s+/g, '').toLowerCase();\n  \n  // 🔥 关键修改：检查完整包含\n  const inputClean = input.replace(/[\\s\\-]/g, '').toLowerCase();\n  const targetClean = target.replace(/[\\s\\-]/g, '').toLowerCase();\n  const isFullyContained = targetClean.includes(inputClean) && inputClean.length >= 3;\n  \n  // 计算各种相似度\n  const levenScore = levenshteinSimilarity(inputNorm, targetNorm);\n  const jaroScore = jaroWinklerSimilarity(inputNorm, targetNorm);\n  const containsScore = containsMatch(input, target);\n  const brandModelScore = brandModelMatch(input, target);\n  \n  // 加权综合评分\n  const weights = {\n    levenshtein: 0.25,\n    jaroWinkler: 0.25,\n    contains: 0.30,\n    brandModel: 0.20\n  };\n  \n  let finalScore = \n    levenScore * weights.levenshtein +\n    jaroScore * weights.jaroWinkler +\n    containsScore * weights.contains +\n    brandModelScore * weights.brandModel;\n  \n  // 🔥 完整包含加成：直接提升到85%以上\n  if (isFullyContained) {\n    finalScore = Math.max(finalScore, 0.88);\n  }\n  \n  return {\n    finalScore: finalScore,\n    details: {\n      levenshtein: levenScore.toFixed(3),\n      jaroWinkler: jaroScore.toFixed(3),\n      contains: containsScore.toFixed(3),\n      brandModel: brandModelScore.toFixed(3)\n    }\n  };\n}\n\n// ===== 执行匹配 =====\nconst matches = [];\n\nfor (const car of allCars) {\n  const carName = car.json.carName || '';\n  const carID = car.json.carID;\n  const brandID = car.json.brandID;\n  \n  if (!carName || !carID) continue;\n  \n  const scoreResult = calculateComprehensiveScore(inputCarName, carName);\n  \n  matches.push({\n    carName: carName,\n    carID: carID,\n    brandID: brandID,\n    vehicleClass: car.json.vehicleClass,\n    priceRange: car.json.carPriceRange,\n    score: scoreResult.finalScore,\n    scoreDetails: scoreResult.details\n  });\n}\n\n// 按分数排序\nmatches.sort((a, b) => b.score - a.score);\n\n// 输出前5个匹配结果\nconsole.log(`\\n前5个匹配结果:`);\nmatches.slice(0, 5).forEach((match, index) => {\n  console.log(`${index + 1}. ${match.carName} - 相似度: ${(match.score * 100).toFixed(1)}%`);\n  console.log(`   详情: L=${match.scoreDetails.levenshtein}, J=${match.scoreDetails.jaroWinkler}, C=${match.scoreDetails.contains}, B=${match.scoreDetails.brandModel}`);\n});\n\nconst bestMatch = matches[0];\n\nif (bestMatch && bestMatch.score >= MATCH_THRESHOLD) {\n  console.log(`\\n✅ 匹配成功！`);\n  console.log(`输入: ${inputCarName}`);\n  console.log(`匹配: ${bestMatch.carName}`);\n  console.log(`相似度: ${(bestMatch.score * 100).toFixed(1)}%`);\n  console.log(`carID: ${bestMatch.carID}`);\n  console.log(`========================\\n`);\n  \n  return {\n    json: {\n      needsSearch: false,\n      resolved: true,\n      carId: bestMatch.carID,\n      carName: bestMatch.carName,\n      brandID: bestMatch.brandID,\n      matchType: 'googlesheet_fuzzy_match',\n      similarityScore: bestMatch.score,\n      matchDetails: bestMatch.scoreDetails,\n      inputCarName: inputCarName\n    }\n  };\n}\n\nconsole.log(`\\n⚠️ 未找到满足阈值的匹配，降级到SerpAPI搜索`);\nconsole.log(`最佳匹配: ${bestMatch?.carName || 'N/A'} - 相似度: ${bestMatch ? (bestMatch.score * 100).toFixed(1) : '0'}%`);\nconsole.log(`阈值要求: ${(MATCH_THRESHOLD * 100).toFixed(0)}%`);\nconsole.log(`========================\\n`);\n\nreturn {\n  json: {\n    needsSearch: true,\n    carName: inputCarName,\n    matchType: 'low_similarity',\n    bestMatchScore: bestMatch?.score || 0,\n    bestMatchName: bestMatch?.carName || null\n  }\n};"
      },
      "id": "6d42760c-b31b-444f-b0b8-6712db525b10",
      "name": "模糊匹配分析",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4352,
        3248
      ]
    },
    {
      "parameters": {
        "keepOnlySet": true,
        "values": {
          "string": [
            {
              "name": "series_name",
              "value": "={{ $json.body && $json.body.carName ? $json.body.carName : $json.carName }}"
            }
          ]
        },
        "options": {}
      },
      "id": "531773ab-98fd-4c00-ac9f-23dd7318438a",
      "name": "提取车型名称1",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [
        3680,
        3248
      ]
    },
    {
      "parameters": {
        "jsCode": "// 准备查询 - 只需要车型名称\nconst carName = ($input.first().json.series_name || '').trim();\n\nif (!carName) {\n  return {\n    json: {\n      success: false,\n      error: '请提供车型名称',\n      code: 'CAR_NAME_REQUIRED'\n    }\n  };\n}\n\nconsole.log(`准备查询车型: ${carName}`);\n\nreturn {\n  json: {\n    carName: carName\n  }\n};"
      },
      "id": "945d2165-7907-4d71-9536-20390aeb41d8",
      "name": "准备查询2",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3920,
        3248
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.needsSearch }}",
              "value2": true
            }
          ]
        }
      },
      "id": "a664244a-6d44-444e-87fc-493c707b5521",
      "name": "检查是否需要搜索2",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        4592,
        3248
      ]
    },
    {
      "parameters": {
        "url": "=https://serpapi.com/search.json?engine=google&q=site:autohome.com.cn+{{ $json.carName }}&api_key=c6805b62d6f0757df69b7b0f41e27570c6b8989caec90d8356e455cf76794514",
        "options": {
          "redirect": {
            "redirect": {
              "followRedirects": true,
              "maxRedirects": 5
            }
          },
          "response": {
            "response": {
              "responseFormat": "json"
            }
          },
          "timeout": 15000
        }
      },
      "id": "394b510d-6a6c-4b62-b852-56959a106665",
      "name": "搜索车型2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        4832,
        3168
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// 从IF节点传递过来的数据中获取carName\nconst carName = $('检查是否需要搜索2').first().json.carName;\nconst response = $input.item.json;\n\nconsole.log('===== SerpAPI响应 =====');\nconsole.log('车型名称:', carName);\nconsole.log('SerpAPI响应:', JSON.stringify(response, null, 2));\n\nconst organicResults = response.organic_results || [];\nconsole.log('找到', organicResults.length, '个搜索结果');\n\nlet carId = null;\n\n// 遍历搜索结果\nfor (const result of organicResults) {\n  const link = result.link || '';\n  console.log('检查链接:', link);\n  \n  // 🔥 修改正则：支持2-5位数的carID\n  const patterns = [\n    /autohome\\.com\\.cn\\/(\\d{2,5})\\/?/,           // 改这里：2-5位\n    /series-(\\d{2,5})\\.html/,                    // 改这里：2-5位\n    /config\\/series\\/(\\d{2,5})/                  // 改这里：2-5位\n  ];\n  \n  for (const pattern of patterns) {\n    const match = link.match(pattern);\n    if (match && match[1]) {\n      carId = match[1];\n      console.log('✅ 找到carId:', carId);\n      break;\n    }\n  }\n  \n  if (carId) break;\n}\n\n// 🔥 验证carID格式：改成2-5位\nif (carId && /^\\d{2,5}$/.test(carId)) {\n  console.log('✅ 成功提取carId:', carId);\n  return {\n    json: {\n      carId: carId,\n      carName: carName,\n      matchType: 'serpapi_search',\n      resolved: true\n    }\n  };\n}\n\nconsole.log('❌ 未能从搜索结果中提取carId');\nreturn {\n  json: {\n    success: false,\n    error: '未能从搜索结果中提取carId',\n    code: 'EXTRACTION_FAILED',\n    carName: carName,\n    debug: {\n      resultsCount: organicResults.length,\n      firstResult: organicResults[0]?.link || 'none'\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5072,
        3168
      ],
      "id": "63fd9186-9b90-4292-a244-86fb4fe9aeaf",
      "name": "处理SerpAPI响应2"
    },
    {
      "parameters": {
        "jsCode": "// 生成所有分类的任务\nconst data = $input.item.json;\n\nif (data.success === false || !data.resolved) {\n  return { json: data };\n}\n\nconst carId = data.carId;\nconst carName = data.carName || '';\nconst brandID = data.brandID || '';\n\nif (!carId || !/^\\d+$/.test(carId.toString())) {\n  return {\n    json: {\n      success: false,\n      error: 'carId格式无效',\n      code: 'INVALID_CAR_ID'\n    }\n  };\n}\n\n// 定义所有要爬取的分类\nconst categories = [\n  { code: '1', name: '外观' },\n  { code: '10', name: '内饰' },\n  { code: '3', name: '座椅' }\n];\n\nconsole.log(`为车型 ${carName} (ID: ${carId}) 生成 ${categories.length} 个爬取任务`);\n\n// 为每个分类生成一个任务\nreturn categories.map(category => ({\n  json: {\n    carId: carId,\n    carName: carName,\n    brandID: brandID,\n    categoryCode: category.code,\n    categoryName: category.name,\n    matchType: data.matchType\n  }\n}));"
      },
      "id": "f78d8be0-d456-4a12-a5f8-8080f501b729",
      "name": "生成所有分类任务1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5344,
        3264
      ]
    },
    {
      "parameters": {
        "url": "={{ 'https://car.autohome.com.cn/pic/series/' + $json.carId + '-' + $json.categoryCode + '.html' }}",
        "options": {
          "redirect": {
            "redirect": {
              "followRedirects": true,
              "maxRedirects": 3
            }
          },
          "response": {
            "response": {
              "responseFormat": "text"
            }
          },
          "timeout": 15000
        }
      },
      "id": "ae74d8a9-763f-4a11-bf4b-70b7bc59e782",
      "name": "爬取目标页面2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        5568,
        3264
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// 从当前输入获取category信息\nconst currentInput = $input.item.json;\n\n// 尝试从生成所有分类任务节点获取参数（带错误处理）\nlet params;\ntry {\n  params = $('生成所有分类任务1').item.json;\n} catch (e) {\n  console.log('警告: 无法从生成所有分类任务1获取数据，尝试从当前输入获取');\n  params = currentInput;\n}\n\nconst carName = params.carName || currentInput.carName || '';\nconst categoryName = params.categoryName || currentInput.categoryName || '';\nconst carId = params.carId || currentInput.carId || '';\nconst categoryCode = params.categoryCode || currentInput.categoryCode || '';\nconst matchType = params.matchType || currentInput.matchType || '';\n\nconsole.log(`处理分类: ${categoryName} (code: ${categoryCode})`);\n\nif ($input.item.json.error) {\n  return {\n    json: {\n      success: false,\n      error: '页面获取失败',\n      message: $input.item.json.error.message || '网络请求错误',\n      code: 'HTTP_REQUEST_FAILED',\n      carId: carId,\n      carName: carName,\n      categoryName: categoryName\n    }\n  };\n}\n\n// 提取HTML内容\nlet html = '';\n\ntry {\n  if ($input.item.binary && $input.item.binary.data) {\n    const binaryData = $input.item.binary.data;\n    if (Buffer.isBuffer(binaryData)) {\n      html = binaryData.toString('latin1');\n    } else if (binaryData.data) {\n      html = Buffer.from(binaryData.data).toString('latin1');\n    }\n  } \n  \n  if (!html || html.length < 100) {\n    html = String($input.item.json.data || $input.item.json.body || '');\n  }\n} catch (error) {\n  html = String($input.item.json.data || $input.item.json.body || '');\n}\n\nif (html.length < 1000) {\n  return {\n    json: {\n      success: false,\n      error: '页面内容异常',\n      code: 'INVALID_PAGE_CONTENT',\n      carId: carId,\n      carName: carName,\n      categoryName: categoryName\n    }\n  };\n}\n\nfunction extractImages(htmlContent, maxImages = 30) {\n  const images = [];\n  const seenUrls = new Set();\n  \n  const patterns = [\n    /data-webp\\s*=\\s*[\"']([^\"']+)[\"']/gi,\n    /data-original\\s*=\\s*[\"']([^\"']+)[\"']/gi,\n    /src\\s*=\\s*[\"'](https?:\\/\\/[^\"']*(?:autoimg\\.cn|autohome\\.com\\.cn)[^\"']*)[\"']/gi\n  ];\n  \n  for (const pattern of patterns) {\n    let match;\n    while ((match = pattern.exec(htmlContent)) !== null && images.length < maxImages) {\n      let url = match[1];\n      \n      if (!url || url.length > 500 || seenUrls.has(url)) continue;\n      \n      if (url.startsWith('//')) {\n        url = 'https:' + url;\n      } else if (!url.startsWith('http')) {\n        continue;\n      }\n      \n      if ((url.includes('autoimg.cn') || url.includes('autohome.com.cn')) && \n          !url.includes('base64') &&\n          (url.includes('/cardfs/') || url.includes('/product/') || url.includes('.jpg') || url.includes('.webp'))) {\n        \n        seenUrls.add(url);\n        images.push({\n          url: url,\n          type: url.includes('data-webp') ? 'high_quality' : 'standard',\n          category: categoryName,\n          carName: carName\n        });\n      }\n    }\n  }\n  \n  return images;\n}\n\nconst images = extractImages(html);\n\nconsole.log(`${categoryName}: 提取到 ${images.length} 张图片`);\n\nreturn {\n  json: {\n    success: images.length > 0,\n    carId: carId,\n    carName: carName,\n    category: categoryName,\n    categoryCode: categoryCode,\n    matchType: matchType,\n    totalImages: images.length,\n    images: images\n  }\n};"
      },
      "id": "7b64fbaa-4369-4372-929e-67517263a14b",
      "name": "提取图片1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5808,
        3264
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// 合并所有分类的图片结果\nconst allResults = $input.all();\n\nlet allImages = [];\nlet successCount = 0;\nlet totalCount = 0;\nlet carId = null;\nlet carName = null;\nlet matchType = null;\n\nconst categorySummary = {};\n\nfor (const result of allResults) {\n  const data = result.json;\n  \n  if (!carId) carId = data.carId;\n  if (!carName) carName = data.carName;\n  if (!matchType) matchType = data.matchType;\n  \n  totalCount++;\n  \n  if (data.success && data.images && data.images.length > 0) {\n    successCount++;\n    allImages = allImages.concat(data.images);\n    categorySummary[data.category] = data.images.length;\n    console.log(`${data.category}: ${data.images.length} 张图片`);\n  } else {\n    categorySummary[data.category] = 0;\n    console.log(`${data.category}: 获取失败`);\n  }\n}\n\nconsole.log(`\\n=== 汇总 ===`);\nconsole.log(`总计: ${allImages.length} 张图片`);\nconsole.log(`成功分类: ${successCount}/${totalCount}`);\nconsole.log(`详细统计:`, categorySummary);\n\nreturn {\n  json: {\n    success: allImages.length > 0,\n    carId: carId,\n    carName: carName,\n    matchType: matchType,\n    totalImages: allImages.length,\n    images: allImages,\n    categorySummary: categorySummary,\n    message: allImages.length > 0 ? `成功获取${allImages.length}张图片（${successCount}个分类）` : '未找到任何图片',\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "cf4c15da-b308-41f0-9e0c-0ba5d2caea9d",
      "name": "合并所有结果1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6048,
        3264
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "239bd5d7-b366-4eff-93f1-4eec9410f199",
      "name": "返回响应2",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        6288,
        3264
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "get-all-car-images",
        "responseMode": "responseNode",
        "options": {
          "rawBody": false
        }
      },
      "id": "4a044d15-dd65-479a-a3d8-c610832807fb",
      "name": "直接搜索",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        3472,
        3248
      ],
      "webhookId": "get-all-car-images"
    },
    {
      "parameters": {
        "content": "## GoogleSheet详细界面\n\n\n\n",
        "height": 768,
        "width": 3232
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3344,
        3888
      ],
      "typeVersion": 1,
      "id": "cc739ae6-87f4-4d61-a469-ec9133d3e0e0",
      "name": "Sticky Note18"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1550254241,
          "mode": "list",
          "cachedResultName": "CarImageURLMVP用",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit#gid=1550254241"
        },
        "options": {}
      },
      "id": "51ce0d0e-6b40-4140-8c95-e7651662992d",
      "name": "读取Google Sheet1",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        4064,
        2448
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YS5a72jpKHezwxcc",
          "name": "Google Sheets account 5"
        }
      }
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ $json }}",
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "Access-Control-Allow-Origin",
                "value": "*"
              },
              {
                "name": "Access-Control-Allow-Methods",
                "value": "POST, GET, OPTIONS"
              },
              {
                "name": "Access-Control-Allow-Headers",
                "value": "Content-Type"
              }
            ]
          }
        }
      },
      "id": "d5de46a0-78a3-4788-8991-dddda158e616",
      "name": "返回结果",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        5632,
        4160
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "car-detail-complete",
        "responseMode": "responseNode",
        "options": {
          "allowedOrigins": "*, null"
        }
      },
      "id": "127ea067-ec9c-4d8c-8b68-0e8a5f9a5707",
      "name": "详细界面",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        3488,
        4160
      ],
      "webhookId": "car-detail-complete"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=={{ $json.chatInput }}",
        "options": {
          "systemMessage": "你是汽车专家，请用简洁专业的方式介绍车辆。格式要求：\n1. 车型定位(SUV/轿车等)\n2. 核心设计特点\n3. 相关竞品\n4. 3个核心亮点\n总字数100字内。"
        }
      },
      "id": "bc7b4c60-2d8e-449c-9e5c-a1fd70901b12",
      "name": "AI智能体1",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        4656,
        4160
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "df4bba87-ef95-4523-8107-080d49359ed8",
      "name": "DeepSeek Chat Model1",
      "type": "@n8n/n8n-nodes-langchain.lmChatDeepSeek",
      "typeVersion": 1,
      "position": [
        4656,
        4416
      ],
      "credentials": {
        "deepSeekApi": {
          "id": "Rq6VyJR7LeyTkMK8",
          "name": "DeepSeek account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 整合AI分析结果\nconst carData = $('处理所有逻辑2').item.json;\nlet aiAnalysis = '';\nlet smartTags = [];\n\nconsole.log('===== 整合最终结果 =====');\nconsole.log('车辆数据:', carData);\nconsole.log('相关车型数量:', carData.relatedCars ? carData.relatedCars.length : 0);\n\ntry {\n  const aiResponse = $input.item.json;\n  let rawOutput = '';\n  \n  if (aiResponse && aiResponse.output) {\n    rawOutput = aiResponse.output;\n  } else if (aiResponse && aiResponse.text) {\n    rawOutput = aiResponse.text;\n  }\n  \n  console.log('AI原始输出:', rawOutput);\n  \n  if (rawOutput) {\n    // 解析AI输出：第一行是标签，后面是分析内容\n    const lines = rawOutput.split('\\n').filter(line => line.trim());\n    \n    if (lines.length >= 2) {\n      // 第一行作为标签\n      const tagLine = lines[0];\n      const tagArray = tagLine.split(/[,，、]/).map(tag => tag.trim()).filter(tag => tag);\n      smartTags = tagArray.slice(0, 5);\n      \n      // 第二行开始作为分析内容\n      aiAnalysis = lines.slice(1).join(' ');\n    } else if (lines.length === 1) {\n      // 只有一行，尝试判断是标签还是内容\n      const line = lines[0];\n      if (line.length < 30 && (line.indexOf(',') !== -1 || line.indexOf('，') !== -1)) {\n        // 短且有逗号，可能是标签\n        smartTags = line.split(/[,，、]/).map(tag => tag.trim()).filter(tag => tag).slice(0, 5);\n        aiAnalysis = '智能分析中...';\n      } else {\n        // 长文本，当作分析内容\n        aiAnalysis = line;\n      }\n    } else {\n      aiAnalysis = rawOutput;\n    }\n  } else {\n    aiAnalysis = '暂无AI分析';\n  }\n} catch (e) {\n  console.log('AI分析解析失败:', e.message);\n  aiAnalysis = '车辆信息获取中...';\n}\n\n// 如果没有标签，提供默认标签\nif (smartTags.length === 0) {\n  smartTags = ['品质之选', '设计美学', '智能科技'];\n}\n\nconsole.log('解析后-AI分析:', aiAnalysis);\nconsole.log('解析后-智能标签:', smartTags);\n\n// 输出相关车型信息用于调试\nif (carData.relatedCars && carData.relatedCars.length > 0) {\n  console.log('准备返回的相关车型:');\n  carData.relatedCars.forEach((car, idx) => {\n    console.log(`  ${idx + 1}. ${car.carName} - ${car.carPriceRange}`);\n  });\n}\n\nconst finalResult = {\n  success: true,\n  data: {\n    carName: carData.carName,\n    carPriceRange: carData.carPriceRange,\n    vehicleClass: carData.vehicleClass,\n    carID: carData.carID,\n    brandID: carData.brandID,\n    mainImageUrl: carData.mainImageUrl,\n    aiAnalysis: aiAnalysis,\n    smartTags: smartTags,\n    relatedCars: carData.relatedCars || [],\n    detailImages: carData.detailImages || [],\n    stats: carData.stats || {}\n  },\n  timestamp: new Date().toISOString()\n};\n\nconsole.log('最终返回数据.relatedCars数量:', finalResult.data.relatedCars.length);\n\nreturn {\n  json: finalResult\n};"
      },
      "id": "4948b04b-f12e-4206-b0b6-eecfbda490f1",
      "name": "整合最终结果1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5152,
        4160
      ]
    },
    {
      "parameters": {
        "jsCode": "// 解析请求参数 - 支持 carID 和 carName\nconst input = $input.item.json.body || $input.item.json;\n\n// 优先使用 carID\nconst carID = input.carID;\nconst carName = (input.carName || '').trim();\n\n// 验证至少提供了一个参数\nif (!carID && !carName) {\n  return {\n    json: {\n      success: false,\n      error: '请提供 carID 或 carName'\n    }\n  };\n}\n\n// 如果有 carID，记录日志\nif (carID) {\n  console.log('🚗 通过 carID 查询:', carID);\n} else {\n  console.log('🚗 通过 carName 查询:', carName);\n}\n\nreturn { \n  json: { \n    carID: carID,\n    carName: carName\n  } \n};"
      },
      "id": "d1e49a43-965c-4b4c-8685-9d78ca611a92",
      "name": "解析参数2",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3776,
        4160
      ]
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1550254241,
          "mode": "list",
          "cachedResultName": "CarImageURLMVP用",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit#gid=1550254241"
        },
        "options": {}
      },
      "id": "1f0bb761-0969-417f-a400-32f025691044",
      "name": "读取GoogleSheet2",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        4016,
        4160
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YS5a72jpKHezwxcc",
          "name": "Google Sheets account 5"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 处理所有数据并返回结果\nconst inputParams = $('解析参数2').item.json;\nconst targetCarID = inputParams.carID;\nconst targetCarName = inputParams.carName;\nconst allData = $input.all();\n\nconsole.log('===== 开始处理 =====');\nconsole.log('输入参数 - carID:', targetCarID);\nconsole.log('输入参数 - carName:', targetCarName);\nconsole.log('总数据量:', allData.length);\n\n// 标准化函数：去掉空格、短横线、下划线\nfunction normalize(str) {\n  if (!str) return '';\n  return str.toLowerCase()\n    .split(' ').join('')\n    .split('-').join('')\n    .split('_').join('');\n}\n\nlet carData = [];\nlet matchType = '';\nlet actualCarName = '';\n\n// ========== 优先级1: 通过 carID 精确匹配 ==========\nif (targetCarID) {\n  console.log('🎯 尝试通过 carID 匹配:', targetCarID);\n  \n  carData = allData.filter(item => {\n    return Number(item.json.carID) === Number(targetCarID);\n  });\n  \n  if (carData.length > 0) {\n    matchType = 'carID精确匹配';\n    actualCarName = carData[0].json.carName;\n    console.log('✅ carID匹配成功:', actualCarName);\n  } else {\n    console.log('❌ carID匹配失败，没有找到 carID =', targetCarID);\n  }\n}\n\n// ========== 优先级2: 如果 carID 失败，尝试 carName 匹配 ==========\nif (carData.length === 0 && targetCarName) {\n  const normalizedTarget = normalize(targetCarName);\n  console.log('🎯 通过 carName 匹配:', targetCarName);\n  console.log('标准化搜索词:', normalizedTarget);\n  \n  // 第一级：精确匹配\n  carData = allData.filter(item => {\n    const dbCarName = item.json.carName || '';\n    const normalizedDb = normalize(dbCarName);\n    return normalizedDb === normalizedTarget;\n  });\n\n  if (carData.length > 0) {\n    matchType = 'carName精确匹配';\n    actualCarName = carData[0].json.carName;\n  } else {\n    // 第二级：包含匹配（长度控制，避免海豹匹配到海豹06）\n    console.log('精确匹配失败，尝试包含匹配...');\n    \n    carData = allData.filter(item => {\n      const dbCarName = item.json.carName || '';\n      const normalizedDb = normalize(dbCarName);\n      \n      // 数据库名称包含搜索词（如：腾势汽车-腾势N7 包含 腾势N7）\n      if (normalizedDb.indexOf(normalizedTarget) !== -1) {\n        const lengthDiff = normalizedDb.length - normalizedTarget.length;\n        // 允许数据库名称比搜索词长（品牌前缀等），但不能太长\n        if (lengthDiff >= 0 && lengthDiff <= 10) {\n          return true;\n        }\n      }\n      \n      // 搜索词包含数据库名称（反向匹配）\n      if (normalizedTarget.indexOf(normalizedDb) !== -1) {\n        const lengthRatio = normalizedDb.length / normalizedTarget.length;\n        if (lengthRatio >= 0.7) {\n          return true;\n        }\n      }\n      \n      return false;\n    });\n    \n    if (carData.length > 0) {\n      matchType = 'carName包含匹配';\n      actualCarName = carData[0].json.carName;\n    }\n  }\n\n  // 第三级：部分关键词匹配（如果前两级都失败）\n  if (carData.length === 0) {\n    console.log('包含匹配失败，尝试关键词匹配...');\n    \n    // 提取搜索词中的关键词（去掉品牌名等）\n    const keywords = normalizedTarget.split(/[^a-z0-9\\u4e00-\\u9fa5]+/).filter(k => k.length > 1);\n    \n    carData = allData.filter(item => {\n      const dbCarName = item.json.carName || '';\n      const normalizedDb = normalize(dbCarName);\n      \n      // 检查是否包含所有关键词\n      return keywords.every(keyword => normalizedDb.indexOf(keyword) !== -1);\n    });\n    \n    if (carData.length > 0) {\n      matchType = 'carName关键词匹配';\n      actualCarName = carData[0].json.carName;\n    }\n  }\n}\n\nconsole.log('匹配类型:', matchType);\nconsole.log('匹配结果:', carData.length, '条');\n\nif (carData.length === 0) {\n  console.log('❌ 未找到匹配');\n  console.log('carID:', targetCarID);\n  console.log('carName:', targetCarName);\n  return {\n    json: {\n      success: false,\n      error: '未找到车型: ' + (targetCarID || targetCarName)\n    }\n  };\n}\n\nconsole.log('✅ 实际车名:', actualCarName);\n\n// ========== 2. 提取基本信息 ==========\nconst baseInfo = carData[0].json;\nconst carName = baseInfo.carName;\nconst carPriceRange = baseInfo.carPriceRange;\nconst vehicleClass = baseInfo.vehicleClass;\nconst carID = baseInfo.carID;\nconst brandID = baseInfo.brandID;\n\n// ========== 3. 查找view45主图 ==========\nconst mainImage = carData.find(item => \n  item.json.viewType === 'view45' && item.json.category === '外观'\n);\nconst mainImageUrl = mainImage ? mainImage.json.imageURL : (carData[0].json.imageURL || '');\n\n// ========== 4. 收集所有详细图片 ==========\nconst detailImages = carData.map(item => ({\n  url: item.json.imageURL,\n  category: item.json.category || '外观',\n  viewType: item.json.viewType || 'unknown'\n})).filter(img => img.url);\n\nconsole.log('主图:', mainImageUrl);\nconsole.log('详细图片数量:', detailImages.length);\n\n// ========== 5. 查找相关车型 ==========\nfunction extractPriceRange(priceStr) {\n  if (!priceStr) return null;\n  const matches = priceStr.match(/([\\d.]+)/g);\n  if (!matches || matches.length < 2) return null;\n  const min = parseFloat(matches[0]);\n  const max = parseFloat(matches[1]);\n  return { min: min, max: max, avg: (min + max) / 2 };\n}\n\nconst currentPrice = extractPriceRange(carPriceRange);\nconst uniqueCars = new Map();\n\n// 去重并收集其他车型（排除当前车型）\nallData.forEach(item => {\n  const name = item.json.carName;\n  const id = item.json.carID;\n  if (!uniqueCars.has(name) && name !== carName) {\n    uniqueCars.set(name, {\n      carName: name,\n      carID: id,\n      carPriceRange: item.json.carPriceRange,\n      vehicleClass: item.json.vehicleClass,\n      brandID: item.json.brandID\n    });\n  }\n});\n\nconsole.log('其他车型数量:', uniqueCars.size);\n\n// 计算相关度\nconst relatedCars = [];\nfor (const [name, car] of uniqueCars) {\n  let score = 0;\n  \n  // 车型分类匹配\n  if (car.vehicleClass === vehicleClass) {\n    score += 40;\n  } else if (car.vehicleClass && vehicleClass && \n             car.vehicleClass.indexOf(vehicleClass.substring(0, 3)) !== -1) {\n    score += 20;\n  }\n  \n  // 价格相似度\n  if (currentPrice && car.carPriceRange) {\n    const carPrice = extractPriceRange(car.carPriceRange);\n    if (carPrice) {\n      const priceDiff = Math.abs(currentPrice.avg - carPrice.avg);\n      const priceScore = Math.max(0, 60 - (priceDiff * 3));\n      score += priceScore;\n    }\n  }\n  \n  if (score > 20) {\n    relatedCars.push({\n      carName: car.carName,\n      carID: car.carID,\n      carPriceRange: car.carPriceRange,\n      vehicleClass: car.vehicleClass,\n      brandID: car.brandID,\n      relevanceScore: score\n    });\n  }\n}\n\nrelatedCars.sort((a, b) => b.relevanceScore - a.relevanceScore);\nconst topRelated = relatedCars.slice(0, 6);\n\nconsole.log('相关车型数量:', topRelated.length);\nif (topRelated.length > 0) {\n  console.log('相关车型列表:');\n  topRelated.forEach((car, idx) => {\n    console.log(`  ${idx + 1}. ${car.carName} - ${car.carPriceRange} (分数: ${car.relevanceScore})`);\n  });\n}\nconsole.log('===== 处理完成 =====');\n\n// ========== 6. 返回完整数据和AI输入 ==========\nreturn {\n  json: {\n    carName: carName,\n    carPriceRange: carPriceRange,\n    vehicleClass: vehicleClass,\n    carID: carID,\n    brandID: brandID,\n    mainImageUrl: mainImageUrl,\n    relatedCars: topRelated,\n    detailImages: detailImages,\n    stats: {\n      totalImages: detailImages.length,\n      relatedCarsCount: topRelated.length\n    },\n    chatInput: '请分析车型【' + carName + '】，严格按以下格式输出：\\n\\n第一行：写3-5个核心亮点关键词，用逗号分隔（如：刀片电池,海洋美学,智能座舱）\\n第二行：作为资深设计师，用50字内阐述该车的设计美学特点\\n\\n注意：第一行只写关键词，第二行才是分析内容，不要返回其他内容！'\n  }\n};"
      },
      "id": "1fe2dbe8-382a-423a-8db5-b5b697d97eb1",
      "name": "处理所有逻辑2",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4272,
        4160
      ]
    },
    {
      "parameters": {
        "jsCode": "// 解析并验证筛选参数\nconst input = $input.item.json.body || $input.item.json;\n\nconst filters = {\n  keyword: (input.keyword || '').trim(),\n  brands: Array.isArray(input.brands) ? input.brands : [],\n  models: Array.isArray(input.models) ? input.models : [],\n  views: Array.isArray(input.views) ? input.views : [],\n  timestamp: new Date().toISOString()\n};\n\nconsole.log('===== 接收到的筛选条件 =====');\nconsole.log('关键词:', filters.keyword);\nconsole.log('品牌:', filters.brands.join(', ') || '无');\nconsole.log('车型:', filters.models.join(', ') || '无');\nconsole.log('视角:', filters.views.join(', ') || '无');\nconsole.log('==============================');\n\nreturn { json: filters };"
      },
      "id": "2f0c4d38-4e92-4da1-abde-659fe9c4d7b7",
      "name": "解析筛选条件1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3888,
        2448
      ]
    },
    {
      "parameters": {
        "jsCode": "// 提取并验证参数\nconst body = $input.item.json.body;\nconst action = body.action || 'add';\nconst userID = body.userID;\n\n// 验证必填参数\nif (!userID) {\n  return {\n    json: {\n      success: false,\n      error: '缺少用户ID'\n    }\n  };\n}\n\n// ========== 1. 创建收藏夹 ==========\nif (action === 'createFolder') {\n  const { folderName, folderIcon } = body;\n  \n  if (!folderName) {\n    return {\n      json: {\n        success: false,\n        error: '缺少收藏夹名称'\n      }\n    };\n  }\n  \n  const folderID = 'folder_' + new Date().toISOString().slice(0,10).replace(/-/g,'') + '_' + Math.random().toString(36).substr(2, 9);\n  \n  return {\n    json: {\n      action: 'createFolder',\n      folderID: folderID,\n      userID: userID,\n      folderName: folderName,\n      folderIcon: folderIcon || '📁',\n      createTime: new Date().toISOString(),\n      status: 'active'\n    }\n  };\n}\n\n// ========== 2. 查看收藏夹列表 ==========\nif (action === 'listFolders') {\n  return {\n    json: {\n      action: 'listFolders',\n      userID: userID\n    }\n  };\n}\n\n// ========== 3. 添加收藏（支持指定文件夹）==========\nif (action === 'add') {\n  const { carID, carName, imageURL, folderID, category, viewType } = body;\n  \n  if (!carID || !carName || !imageURL) {\n    return {\n      json: {\n        success: false,\n        error: '缺少必要参数：carID, carName 或 imageURL'\n      }\n    };\n  }\n  \n  const favoriteID = 'fav_' + new Date().toISOString().slice(0,10).replace(/-/g,'') + '_' + Math.random().toString(36).substr(2, 9);\n  \n  return {\n    json: {\n      action: 'add',\n      favoriteID: favoriteID,\n      userID: userID,\n      folderID: folderID || '',\n      carID: carID,\n      carName: carName,\n      imageURL: imageURL,\n      category: category || '',\n      viewType: viewType || '',\n      favoriteTime: new Date().toISOString(),\n      status: 'active'\n    }\n  };\n}\n\n// ========== 4. 查看收藏列表（支持按文件夹筛选）==========\nif (action === 'list') {\n  return {\n    json: {\n      action: 'list',\n      userID: userID,\n      folderID: body.folderID || ''\n    }\n  };\n}\n\n// ========== 5. 删除收藏 ==========\nif (action === 'delete') {\n  const { favoriteID } = body;\n  \n  if (!favoriteID) {\n    return {\n      json: {\n        success: false,\n        error: '缺少 favoriteID'\n      }\n    };\n  }\n  \n  return {\n    json: {\n      action: 'delete',\n      userID: userID,\n      favoriteID: favoriteID\n    }\n  };\n}\n\n// ========== 6. 删除收藏夹 ==========\nif (action === 'deleteFolder') {\n  const { folderID } = body;\n  \n  if (!folderID) {\n    return {\n      json: {\n        success: false,\n        error: '缺少 folderID'\n      }\n    };\n  }\n  \n  return {\n    json: {\n      action: 'deleteFolder',\n      userID: userID,\n      folderID: folderID\n    }\n  };\n}\n\nreturn {\n  json: {\n    success: false,\n    error: '未知操作类型: ' + action\n  }\n};"
      },
      "id": "d6a08011-4ed4-4379-a151-c2b861598350",
      "name": "处理参数",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3760,
        5296
      ]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 328604113,
          "mode": "list",
          "cachedResultName": "FavoriteFolders",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit#gid=328604113"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "folderID": "={{ $json.folderID }}",
            "userID": "={{ $json.userID }}",
            "folderName": "={{ $json.folderName }}",
            "folderIcon": "={{ $json.folderIcon }}",
            "createTime": "={{ $json.createTime }}",
            "status": "={{ $json.status }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "folderID",
              "displayName": "folderID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "userID",
              "displayName": "userID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "folderName",
              "displayName": "folderName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "folderIcon",
              "displayName": "folderIcon",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "createTime",
              "displayName": "createTime",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "64575e3e-9204-42a9-9793-648fdd918808",
      "name": "保存收藏夹",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        4192,
        4928
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YS5a72jpKHezwxcc",
          "name": "Google Sheets account 5"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 328604113,
          "mode": "list",
          "cachedResultName": "FavoriteFolders",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit#gid=328604113"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "userID",
              "lookupValue": "={{ $json.userID }}"
            },
            {
              "lookupColumn": "status",
              "lookupValue": "active"
            }
          ]
        },
        "options": {}
      },
      "id": "d9f9cb26-d3f5-45ee-998e-fbdfcc0f2da5",
      "name": "读取收藏夹",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        4192,
        5088
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YS5a72jpKHezwxcc",
          "name": "Google Sheets account 5"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1274046316,
          "mode": "list",
          "cachedResultName": "Favorites",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit#gid=1274046316"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "favoriteID": "={{ $json.favoriteID }}",
            "userID": "={{ $json.userID }}",
            "folderID": "={{ $json.folderID }}",
            "carID": "={{ $json.carID }}",
            "carName": "={{ $json.carName }}",
            "imageURL": "={{ $json.imageURL }}",
            "favoriteTime": "={{ $json.favoriteTime }}",
            "status": "={{ $json.status }}",
            "category": "={{ $json.category }}",
            "viewType": "={{ $json.viewType }} "
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "favoriteID",
              "displayName": "favoriteID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "userID",
              "displayName": "userID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "folderID",
              "displayName": "folderID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "carID",
              "displayName": "carID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "carName",
              "displayName": "carName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "imageURL",
              "displayName": "imageURL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "category",
              "displayName": "category",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "viewType",
              "displayName": "viewType",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "favoriteTime",
              "displayName": "favoriteTime",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "0799e822-28c1-4d19-b673-9eb32d177026",
      "name": "保存收藏",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        4192,
        5248
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YS5a72jpKHezwxcc",
          "name": "Google Sheets account 5"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1274046316,
          "mode": "list",
          "cachedResultName": "Favorites",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit#gid=1274046316"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "userID",
              "lookupValue": "={{ $json.userID }}"
            },
            {
              "lookupColumn": "status",
              "lookupValue": "active"
            }
          ]
        },
        "options": {}
      },
      "id": "1ea294d4-fe4f-45a1-a483-668cacd38c3f",
      "name": "读取收藏",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        4192,
        5408
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YS5a72jpKHezwxcc",
          "name": "Google Sheets account 5"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1274046316,
          "mode": "list",
          "cachedResultName": "Favorites",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit#gid=1274046316"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "favoriteID",
              "lookupValue": "={{ $json.favoriteID }}"
            },
            {
              "lookupColumn": "userID",
              "lookupValue": "={{ $json.userID }}"
            }
          ]
        },
        "options": {}
      },
      "id": "e6bef3a2-a8fa-42a5-ba4d-15136d06c65c",
      "name": "查找要删除的收藏",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        4192,
        5568
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YS5a72jpKHezwxcc",
          "name": "Google Sheets account 5"
        }
      }
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 328604113,
          "mode": "list",
          "cachedResultName": "FavoriteFolders",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit#gid=328604113"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "folderID",
              "lookupValue": "={{ $json.folderID }}"
            },
            {
              "lookupColumn": "userID",
              "lookupValue": "={{ $json.userID }}"
            }
          ]
        },
        "options": {}
      },
      "id": "c2369308-58fc-4411-8937-05f50bb843dc",
      "name": "查找要删除的收藏夹",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        4192,
        5728
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YS5a72jpKHezwxcc",
          "name": "Google Sheets account 5"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1274046316,
          "mode": "list",
          "cachedResultName": "Favorites",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit#gid=1274046316"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "row_number": "={{ $json.row_number }}",
            "status": "deleted"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "favoriteID",
              "displayName": "favoriteID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "userID",
              "displayName": "userID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "folderID",
              "displayName": "folderID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "carID",
              "displayName": "carID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "carName",
              "displayName": "carName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "imageURL",
              "displayName": "imageURL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "favoriteTime",
              "displayName": "favoriteTime",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "b0e0f69a-8cd8-4343-9bd0-069cbf52d097",
      "name": "标记收藏为删除",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        4400,
        5568
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YS5a72jpKHezwxcc",
          "name": "Google Sheets account 5"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 328604113,
          "mode": "list",
          "cachedResultName": "FavoriteFolders",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit#gid=328604113"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "status": "deleted",
            "row_number": "={{ $json.row_number }}"
          },
          "matchingColumns": [
            "row_number"
          ],
          "schema": [
            {
              "id": "folderID",
              "displayName": "folderID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "userID",
              "displayName": "userID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "folderName",
              "displayName": "folderName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "folderIcon",
              "displayName": "folderIcon",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "createTime",
              "displayName": "createTime",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": true
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "row_number",
              "displayName": "row_number",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "number",
              "canBeUsedToMatch": true,
              "readOnly": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "ae68cc3d-2a00-4a8a-93f6-2375d291929a",
      "name": "标记收藏夹为删除",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        4400,
        5728
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YS5a72jpKHezwxcc",
          "name": "Google Sheets account 5"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = $input.item.json;\nreturn {\n  json: {\n    success: true,\n    message: '收藏夹创建成功',\n    data: {\n      folderID: data.folderID,\n      folderName: data.folderName,\n      folderIcon: data.folderIcon\n    }\n  }\n};"
      },
      "id": "d7a398d3-95e1-444d-9a34-ddd9de021687",
      "name": "创建收藏夹成功",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4400,
        4928
      ]
    },
    {
      "parameters": {
        "jsCode": "// 收藏夹列表响应（更稳健的版本）\ntry {\n  const items = $input.all();\n  \n  // 检查是否有有效数据\n  const hasData = items && items.length > 0 && items[0].json && Object.keys(items[0].json).length > 0;\n  \n  if (!hasData) {\n    // 空数据：返回空列表\n    console.log('没有找到收藏夹数据，返回空列表');\n    return {\n      json: {\n        success: true,\n        folders: []\n      }\n    };\n  }\n  \n  // 有数据时的处理\n  const folders = items.map(item => ({\n    folderID: item.json.folderID || '',\n    folderName: item.json.folderName || '',\n    folderIcon: item.json.folderIcon || '📁',\n    createdAt: item.json.createTime || item.json.createTime || new Date().toISOString()\n  }));\n  \n  return {\n    json: {\n      success: true,\n      folders: folders\n    }\n  };\n} catch (error) {\n  // 捕获任何错误，确保总是返回响应\n  console.error('处理收藏夹列表时出错:', error);\n  return {\n    json: {\n      success: true,\n      folders: []\n    }\n  };\n}"
      },
      "id": "d2d17f80-3829-456b-941b-2f91e548f4af",
      "name": "收藏夹列表响应",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4400,
        5088
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "const data = $input.item.json;\n\n// 构建返回数据，确保 folderID 正确处理\nconst result = {\n  json: {\n    success: true,\n    message: '收藏成功',\n    data: {\n      favoriteID: data.favoriteID,\n      carName: data.carName,\n      timestamp: data.favoriteTime\n    }\n  }\n};\n\n// 只有当 folderID 存在且不为空时才添加到返回数据\nif (data.folderID && data.folderID !== '') {\n  result.json.data.folderID = data.folderID;\n}\n\nreturn result;"
      },
      "id": "0886b9f0-67c8-49f1-8b59-4127af0b985e",
      "name": "添加收藏成功",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4400,
        5248
      ]
    },
    {
      "parameters": {
        "jsCode": "// 查看列表响应（支持按 folderID 筛选）\nconst items = $input.all();\n\n// 检查是否有有效数据\nconst hasData = items && items.length > 0 && items[0].json && Object.keys(items[0].json).length > 0;\n\nif (!hasData) {\n  // 真正的空数据：返回空列表\n  return {\n    json: {\n      success: true,\n      message: '暂无收藏',\n      total: 0,\n      favorites: []\n    }\n  };\n}\n\n// 🎯 获取要筛选的 folderID（从前一个节点）\nconst requestedFolderID = $('处理参数').first().json.folderID;\n\nconsole.log('🔍 请求的 folderID:', requestedFolderID);\n\n// 🎯 根据 folderID 筛选数据\nlet filteredItems = items;\n\nif (requestedFolderID && requestedFolderID !== '') {\n  // 如果指定了 folderID，只返回该文件夹的收藏\n  filteredItems = items.filter(item => {\n    const itemFolderID = item.json.folderID || '';\n    return itemFolderID === requestedFolderID;\n  });\n  console.log(`✅ 按 folderID 筛选: ${requestedFolderID}, 找到 ${filteredItems.length} 项`);\n} else {\n  // 如果没有指定 folderID，返回所有收藏\n  console.log(`✅ 返回所有收藏: ${filteredItems.length} 项`);\n}\n\n// 转换为前端需要的格式\nconst favorites = filteredItems.map(item => ({\n  favoriteID: item.json.favoriteID || '',\n  folderID: item.json.folderID || '',\n  carID: item.json.carID || '',\n  carName: item.json.carName || '',\n  imageURL: item.json.imageURL || '',\n  category: item.json.category || '',\n  viewType: item.json.viewType || '',\n  favoriteTime: item.json.favoriteTime || ''\n}));\n\nreturn {\n  json: {\n    success: true,\n    message: `找到${favorites.length}个收藏`,\n    total: favorites.length,\n    favorites: favorites\n  }\n};"
      },
      "id": "cbf28904-db0c-451a-be40-7e73cb85699d",
      "name": "收藏列表响应",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4400,
        5408
      ]
    },
    {
      "parameters": {
        "jsCode": "return {\n  json: {\n    success: true,\n    message: '已取消收藏'\n  }\n};"
      },
      "id": "9a0de830-0dd9-4631-8ede-05f373bef228",
      "name": "删除收藏成功",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4592,
        5568
      ]
    },
    {
      "parameters": {
        "jsCode": "return {\n  json: {\n    success: true,\n    message: '收藏夹已删除'\n  }\n};"
      },
      "id": "b4b42ffd-76ee-4d8f-8288-1d2393446279",
      "name": "删除收藏夹成功",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4592,
        5728
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "user-favorite",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "b8e2b7a3-e42b-49cc-ba9f-79dcd80c16d1",
      "name": "收藏入口1",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        3536,
        5296
      ],
      "webhookId": "user-favorite"
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "createFolder",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "d15bdd64-c874-4651-b918-809166ea95d5"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "创建收藏夹"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "listFolders",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "3c7fedd3-de22-452d-9b9e-3351ead52a54"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "查看收藏夹"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "add",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "cc00ae70-fd3a-48e0-86e9-4c495fb1df67"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "添加收藏"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "list",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "dc756319-a131-4479-bcab-f521abe25584"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "查看收藏"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "delete",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "ea88b156-6b87-472b-b945-533628f751ac"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "删除收藏"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.action }}",
                    "rightValue": "deleteFolder",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "34cc7e29-98eb-49f5-9802-d4b57ce105cf"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "删除收藏夹"
            }
          ]
        },
        "options": {}
      },
      "id": "5895ab7c-84a2-47a7-9a9f-978c4ae92d69",
      "name": "选择操作1",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        4000,
        5232
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "a54d396b-7c85-4fb3-83cc-466389fefb2a",
      "name": "返回结果2",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        4816,
        5088
      ],
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "content": "## GoogleSheet用户收藏系统\n\n\n\n",
        "height": 1152,
        "width": 3232
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3360,
        4832
      ],
      "typeVersion": 1,
      "id": "bf4efcb3-87a5-4fe1-a43a-b0dd50ecf321",
      "name": "Sticky Note19"
    },
    {
      "parameters": {
        "content": "## GoogleSheet集成 多车多维度筛选\n\n\n",
        "height": 624,
        "width": 3232
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3376,
        8320
      ],
      "typeVersion": 1,
      "id": "0ea160ce-0920-4b3a-bf56-e7779e5964a7",
      "name": "Sticky Note20"
    },
    {
      "parameters": {
        "jsCode": "const action = $input.item.json.body.action;\nreturn {json: {action: action, data: $input.item.json.body}};"
      },
      "id": "d370aabe-0d95-4974-8677-9f2d83f2ace6",
      "name": "Router",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3760,
        6848
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{$json.action}}",
                    "rightValue": "sendMessage",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "condition-1"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "sendMessage"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{$json.action}}",
                    "rightValue": "generateReport",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "condition-2"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "generateReport"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{$json.action}}",
                    "rightValue": "getDialogueList",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "condition-3"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "getDialogueList"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{$json.action}}",
                    "rightValue": "getDialogueDetail",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "condition-4"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "getDialogueDetail"
            }
          ]
        },
        "options": {}
      },
      "id": "bb958d21-b706-4179-8dcd-8df94a51e226",
      "name": "Switch",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        4000,
        6832
      ]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.item.json.data;\nconst content = data.content || '';\nconst conversationHistory = data.conversationHistory || '';\nconst dialogueID = data.dialogueID || 'dlg_' + Date.now();\nconst userID = data.userID || 'testCode';\nconst isNewDialogue = !data.dialogueID;\n\n// ⭐ 接收前端传来的用户附加标签（收藏夹名称数组）\nconst userAttachedTags = data.tags || [];  // 前端传来的 tags\n\n// 提取关键词标签（从消息内容中）\nconst keywords = ['外观','内饰','性能','续航','空间','配置','智能化','价格','安全','舒适'];\nconst extractedTags = keywords.filter(k => content.includes(k));\n\n// ⭐ 合并两种 tags：用户附加的 + AI提取的\nconst allTags = [...userAttachedTags, ...extractedTags];\n\n// ⭐ 标题从前端传来，不在这里生成\nconst title = data.title || '未命名对话';\n\nconst timestamp = new Date().toISOString();\nconst messageID_user = 'msg_' + Date.now() + '_user';\n\nreturn {\n  json: {\n    dialogueID: dialogueID,\n    userID: userID,\n    title: title,  // ⭐ 直接使用前端传来的标题\n    tags: allTags.join(','),  // ⭐ 合并后的 tags，逗号分隔存储到 Google Sheets\n    userAttachedTags: userAttachedTags,  // ⭐ 单独传递用户附加的 tags，用于 AI prompt\n    createTime: timestamp,\n    status: 'active',\n    isNewDialogue: isNewDialogue,\n    conversationHistory: conversationHistory,\n    userMessage: {\n      messageID: messageID_user,\n      dialogueID: dialogueID,\n      role: 'user',\n      content: content,\n      timestamp: timestamp\n    }\n  }\n};"
      },
      "id": "23a4e674-e91c-4c30-b78b-9f680f4711cc",
      "name": "ProcessMessage",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4288,
        6464
      ]
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{$json.isNewDialogue}}",
                    "rightValue": true,
                    "operator": {
                      "type": "boolean",
                      "operation": "true"
                    },
                    "id": "condition-new"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "新对话"
            }
          ]
        },
        "options": {
          "fallbackOutput": "extra"
        }
      },
      "id": "80888c7d-9a9c-44a3-b815-55cf68897893",
      "name": "判断是否新对话",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        4496,
        6464
      ]
    },
    {
      "parameters": {
        "jsCode": "// ⭐ 从智能选图合并节点获取数据\nconst mergedData = $('智能选图合并').first().json;\nconst aiOutput = mergedData.aiOutput || '';\nconst dialogueID = mergedData.dialogueID;\nconst title = mergedData.title;\nconst vehiclesWithImages = mergedData.vehicles || [];\n\n// 解析AI返回的JSON\nlet reportData = {\n  vehicles: [],\n  dimensions: []\n};\n\ntry {\n  const jsonMatch = aiOutput.match(/```json\\s*([\\s\\S]+?)\\s*```/) || \n                    aiOutput.match(/\\{[\\s\\S]+\\}/);\n  \n  if (jsonMatch) {\n    const jsonStr = jsonMatch[1] || jsonMatch[0];\n    reportData = JSON.parse(jsonStr);\n  }\n} catch (e) {\n  reportData = {\n    vehicles: vehiclesWithImages.map(v => ({name: v.name})),\n    dimensions: [\n      {\n        name: '解析失败', \n        [vehiclesWithImages[0]?.name]: {label: '请重试', desc1: '数据生成异常', desc2: ''},\n        [vehiclesWithImages[1]?.name]: {label: '请重试', desc1: '数据生成异常', desc2: ''}\n      }\n    ]\n  };\n}\n\nconst dimensions = reportData.dimensions || [];\n\n// ⭐ 生成表头（使用原始高清图片）\nlet tableHeaders = '<th>对比维度</th>';\nfor (const v of vehiclesWithImages) {\n  const originalUrl = v.imageUrl || '';\n  \n  // 🎯 优先使用原始URL（最高清）\n  const primaryUrl = originalUrl;\n  \n  // 🛡️ 备用：代理URL（高质量，不压缩）\n  const proxiedUrl = originalUrl.startsWith('http') \n    ? `https://images.weserv.nl/?url=${encodeURIComponent(originalUrl)}&q=95&il`\n    : originalUrl;\n  \n  // 🎨 最终降级：SVG占位图\n  const fallbackUrl = `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 400 267'%3E%3Crect fill='%23f0f0f0' width='400' height='267'/%3E%3Ctext x='200' y='133' font-size='20' text-anchor='middle' fill='%23999'%3E${encodeURIComponent(v.name)}%3C/text%3E%3C/svg%3E`;\n  \n  tableHeaders += `<th>\n    <div class=\"car-header\">\n      <img src=\"${primaryUrl}\" \n           alt=\"${v.name}\" \n           class=\"car-image\" \n           data-proxy=\"${proxiedUrl}\"\n           data-fallback=\"${fallbackUrl}\"\n           crossorigin=\"anonymous\"\n           onerror=\"handleImageError(this)\"\n           onload=\"this.style.opacity=1;\"\n           onclick=\"openImageModal('${primaryUrl}', '${v.name}')\">\n      <div class=\"car-name\">${v.name}</div>\n    </div>\n  </th>`;\n}\n\n// 生成表格行\nlet tableRows = '';\nfor (const dim of dimensions) {\n  let row = '<tr><td>' + dim.name + '</td>';\n  \n  for (const v of vehiclesWithImages) {\n    const data = dim[v.name];\n    if (typeof data === 'object' && data.label) {\n      row += '<td><span class=\"dimension-label\">' + data.label + '</span>';\n      if (data.desc1) {\n        row += '<span class=\"dimension-desc\">' + data.desc1 + '</span>';\n      }\n      if (data.desc2) {\n        row += '<span class=\"dimension-desc\">' + data.desc2 + '</span>';\n      }\n      row += '</td>';\n    } else {\n      row += '<td>' + (data || '暂无数据') + '</td>';\n    }\n  }\n  \n  row += '</tr>';\n  tableRows += row;\n}\n\n// ⭐ 生成完整HTML\nconst html = `<!DOCTYPE html>\n<html lang=\"zh-CN\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>${title} - AI分析报告</title>\n    <style>\n        * {\n            margin: 0;\n            padding: 0;\n            box-sizing: border-box;\n        }\n        \n        body {\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Helvetica Neue', sans-serif;\n            background: #fafafa;\n            padding: 60px 40px;\n            color: #333;\n        }\n        \n        .container {\n            max-width: 1400px;\n            margin: 0 auto;\n        }\n        \n        .header {\n            margin-bottom: 60px;\n            border-left: 4px solid #667eea;\n            padding-left: 20px;\n        }\n        \n        .header h1 {\n            font-size: 28px;\n            font-weight: 600;\n            margin-bottom: 8px;\n            letter-spacing: -0.5px;\n        }\n        \n        .header p {\n            font-size: 14px;\n            color: #666;\n            font-weight: 300;\n            letter-spacing: 0.5px;\n        }\n        \n        .toolbar {\n            position: fixed;\n            top: 20px;\n            right: 20px;\n            display: flex;\n            flex-direction: column;\n            gap: 10px;\n            z-index: 1000;\n        }\n        \n        .toolbar-row {\n            display: flex;\n            gap: 10px;\n        }\n        \n        .btn {\n            padding: 12px 24px;\n            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n            color: white;\n            border: none;\n            border-radius: 50px;\n            font-weight: 600;\n            cursor: pointer;\n            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);\n            transition: all 0.3s;\n            font-size: 14px;\n            white-space: nowrap;\n        }\n        \n        .btn:hover {\n            transform: translateY(-2px);\n            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);\n        }\n        \n        .btn-secondary {\n            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);\n            box-shadow: 0 4px 12px rgba(245, 87, 108, 0.4);\n        }\n        \n        .btn-secondary:hover {\n            box-shadow: 0 6px 20px rgba(245, 87, 108, 0.6);\n        }\n        \n        .btn-success {\n            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);\n            box-shadow: 0 4px 12px rgba(79, 172, 254, 0.4);\n        }\n        \n        .btn-success:hover {\n            box-shadow: 0 6px 20px rgba(79, 172, 254, 0.6);\n        }\n        \n        .size-controls {\n            background: white;\n            padding: 15px 20px;\n            border-radius: 20px;\n            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);\n            display: flex;\n            flex-direction: column;\n            gap: 12px;\n        }\n        \n        .control-item {\n            display: flex;\n            align-items: center;\n            gap: 12px;\n        }\n        \n        .control-item label {\n            font-size: 13px;\n            color: #666;\n            font-weight: 500;\n            white-space: nowrap;\n            min-width: 50px;\n        }\n        \n        .slider {\n            width: 120px;\n            height: 6px;\n            border-radius: 3px;\n            outline: none;\n            -webkit-appearance: none;\n        }\n        \n        .height-slider {\n            background: linear-gradient(to right, #667eea, #764ba2);\n        }\n        \n        .width-slider {\n            background: linear-gradient(to right, #f093fb, #f5576c);\n        }\n        \n        .image-slider {\n            background: linear-gradient(to right, #43e97b, #38f9d7);\n        }\n        \n        .slider::-webkit-slider-thumb {\n            -webkit-appearance: none;\n            width: 18px;\n            height: 18px;\n            border-radius: 50%;\n            background: white;\n            cursor: pointer;\n            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);\n        }\n        \n        .slider::-moz-range-thumb {\n            width: 18px;\n            height: 18px;\n            border-radius: 50%;\n            background: white;\n            cursor: pointer;\n            border: none;\n            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);\n        }\n        \n        .value-display {\n            font-size: 13px;\n            font-weight: 600;\n            min-width: 45px;\n            text-align: right;\n        }\n        \n        .height-value {\n            color: #667eea;\n        }\n        \n        .width-value {\n            color: #f5576c;\n        }\n        \n        .image-value {\n            color: #38f9d7;\n        }\n        \n        .table-wrapper {\n            background: white;\n            border-radius: 8px;\n            overflow: hidden;\n            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);\n        }\n        \n        table {\n            width: 100%;\n            border-collapse: collapse;\n        }\n        \n        thead tr {\n            background: #f8f9fc;\n            border-bottom: 1px solid #e5e7eb;\n        }\n        \n        th {\n            text-align: center;\n            font-weight: 600;\n            font-size: 14px;\n            color: #333;\n            letter-spacing: 0.3px;\n            vertical-align: middle;\n        }\n        \n        th:first-child {\n            width: 15%;\n        }\n        \n        .car-header {\n            display: flex;\n            flex-direction: column;\n            align-items: center;\n            gap: 12px;\n            padding: 10px;\n        }\n        \n        .car-image {\n            object-fit: contain;\n            border-radius: 8px;\n            box-shadow: 0 2px 8px rgba(0,0,0,0.08);\n            background: #fafafa;\n            opacity: 0;\n            transition: all 0.3s ease;\n            cursor: zoom-in;\n            image-rendering: -webkit-optimize-contrast;\n            image-rendering: crisp-edges;\n        }\n        \n        .car-image:hover {\n            transform: scale(1.05);\n            box-shadow: 0 4px 16px rgba(0,0,0,0.15);\n        }\n        \n        .car-image:not([src*=\"data:image\"]) {\n            filter: none !important;\n            -webkit-filter: none !important;\n        }\n        \n        .car-name {\n            font-weight: 600;\n            font-size: 15px;\n            color: #333;\n        }\n        \n        tbody tr {\n            border-bottom: 1px solid #f0f0f0;\n            transition: background-color 0.2s ease;\n        }\n        \n        tbody tr:hover {\n            background: #fafbff;\n        }\n        \n        tbody tr:last-child {\n            border-bottom: none;\n        }\n        \n        td {\n            font-size: 14px;\n            color: #555;\n            text-align: center;\n            vertical-align: middle;\n        }\n        \n        td:first-child {\n            font-weight: 500;\n            color: #333;\n            background: #f9fafb;\n        }\n        \n        .dimension-label {\n            display: block;\n            font-weight: 500;\n            color: #333;\n            margin-bottom: 4px;\n            font-size: 14px;\n        }\n        \n        .dimension-desc {\n            display: block;\n            font-size: 12px;\n            color: #666;\n            font-weight: 400;\n            margin-top: 4px;\n            line-height: 1.5;\n        }\n        \n        .image-modal {\n            display: none;\n            position: fixed;\n            z-index: 2000;\n            left: 0;\n            top: 0;\n            width: 100%;\n            height: 100%;\n            background: rgba(0, 0, 0, 0.9);\n            justify-content: center;\n            align-items: center;\n            animation: fadeIn 0.3s ease;\n        }\n        \n        .image-modal.active {\n            display: flex;\n        }\n        \n        .modal-content {\n            max-width: 90%;\n            max-height: 90%;\n            object-fit: contain;\n            border-radius: 12px;\n            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);\n            animation: zoomIn 0.3s ease;\n        }\n        \n        .modal-close {\n            position: absolute;\n            top: 30px;\n            right: 40px;\n            font-size: 40px;\n            color: white;\n            cursor: pointer;\n            font-weight: 300;\n            transition: transform 0.2s;\n        }\n        \n        .modal-close:hover {\n            transform: scale(1.2);\n        }\n        \n        .modal-title {\n            position: absolute;\n            bottom: 30px;\n            left: 50%;\n            transform: translateX(-50%);\n            color: white;\n            font-size: 20px;\n            font-weight: 600;\n            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);\n        }\n        \n        @keyframes fadeIn {\n            from { opacity: 0; }\n            to { opacity: 1; }\n        }\n        \n        @keyframes zoomIn {\n            from { transform: scale(0.8); opacity: 0; }\n            to { transform: scale(1); opacity: 1; }\n        }\n        \n        [contenteditable=\"true\"] {\n            outline: 2px dashed #667eea;\n            outline-offset: 2px;\n            background: #fffbf0;\n            border-radius: 4px;\n        }\n        \n        [contenteditable=\"true\"]:focus {\n            outline: 2px solid #667eea;\n            background: #fff;\n        }\n        \n        .footer {\n            margin-top: 40px;\n            text-align: center;\n            color: #999;\n            font-size: 12px;\n        }\n        \n        @media print {\n            body {\n                background: white;\n                padding: 20px;\n            }\n            \n            .toolbar {\n                display: none;\n            }\n            \n            .image-modal {\n                display: none !important;\n            }\n            \n            .container {\n                box-shadow: none;\n            }\n            \n            [contenteditable=\"true\"] {\n                outline: none;\n                background: white;\n            }\n            \n            .car-image {\n                cursor: default;\n            }\n        }\n        \n        @media (max-width: 768px) {\n            body {\n                padding: 40px 20px;\n            }\n            \n            .toolbar {\n                top: 10px;\n                right: 10px;\n            }\n            \n            .toolbar-row {\n                flex-direction: column;\n            }\n            \n            .size-controls {\n                padding: 12px 16px;\n            }\n            \n            .control-item {\n                flex-direction: column;\n                align-items: stretch;\n            }\n            \n            .slider {\n                width: 100%;\n            }\n            \n            .modal-close {\n                top: 15px;\n                right: 20px;\n                font-size: 30px;\n            }\n            \n            .modal-title {\n                font-size: 16px;\n                bottom: 15px;\n            }\n            \n            .header {\n                margin-bottom: 40px;\n            }\n            \n            .header h1 {\n                font-size: 22px;\n            }\n        }\n    </style>\n</head>\n<body>\n    <div class=\"toolbar\">\n        <div class=\"toolbar-row\">\n            <button class=\"btn\" onclick=\"window.print()\">🖨️ 打印PDF</button>\n            <button class=\"btn btn-secondary\" onclick=\"toggleEdit()\" id=\"editBtn\">✏️ 编辑</button>\n            <button class=\"btn btn-success\" onclick=\"transposeTable()\" id=\"transposeBtn\">🔄 转置</button>\n        </div>\n        <div class=\"size-controls\">\n            <div class=\"control-item\">\n                <label>🖼️ 图片</label>\n                <input type=\"range\" min=\"150\" max=\"500\" value=\"250\" class=\"slider image-slider\" id=\"imageSlider\" oninput=\"adjustImageSize(this.value)\">\n                <span class=\"value-display image-value\" id=\"imageValue\">250px</span>\n            </div>\n            <div class=\"control-item\">\n                <label>📏 行高</label>\n                <input type=\"range\" min=\"10\" max=\"100\" value=\"28\" class=\"slider height-slider\" id=\"heightSlider\" oninput=\"adjustHeight(this.value)\">\n                <span class=\"value-display height-value\" id=\"heightValue\">28px</span>\n            </div>\n            <div class=\"control-item\">\n                <label>📐 宽度</label>\n                <input type=\"range\" min=\"10\" max=\"60\" value=\"20\" class=\"slider width-slider\" id=\"widthSlider\" oninput=\"adjustWidth(this.value)\">\n                <span class=\"value-display width-value\" id=\"widthValue\">20px</span>\n            </div>\n        </div>\n    </div>\n    \n    <div class=\"image-modal\" id=\"imageModal\" onclick=\"closeImageModal()\">\n        <span class=\"modal-close\">&times;</span>\n        <img src=\"\" alt=\"\" class=\"modal-content\" id=\"modalImage\" onclick=\"event.stopPropagation()\">\n        <div class=\"modal-title\" id=\"modalTitle\"></div>\n    </div>\n    \n    <div class=\"container\">\n        <div class=\"header\">\n            <h1>🚗 ${title}</h1>\n            <p>AI智能分析报告 · 生成时间：${new Date().toLocaleString('zh-CN')}</p>\n        </div>\n        \n        <div class=\"table-wrapper\" id=\"tableWrapper\">\n            <table id=\"reportTable\">\n                <thead>\n                    <tr>${tableHeaders}</tr>\n                </thead>\n                <tbody>\n                    ${tableRows}\n                </tbody>\n            </table>\n        </div>\n        \n        <div class=\"footer\">\n            <p>报告ID: report_${dialogueID} · 由AI车型分析助手生成 · 点击图片可放大查看</p>\n        </div>\n    </div>\n    \n    <script>\n        // ⭐ 图片错误处理（3层降级：原始 → 代理 → 占位图）\n        function handleImageError(img) {\n            if (!img.dataset.failedOnce) {\n                console.log('图片加载失败，尝试使用代理:', img.alt);\n                img.dataset.failedOnce = 'true';\n                img.src = img.dataset.proxy;\n            } else if (!img.dataset.failedTwice) {\n                console.log('代理也失败，使用占位图:', img.alt);\n                img.dataset.failedTwice = 'true';\n                img.onerror = null;\n                img.src = img.dataset.fallback;\n            }\n        }\n        \n        let isEditing = false;\n        let isTransposed = false;\n        let originalTableHTML = '';\n        let currentHeight = 28;\n        let currentWidth = 20;\n        let currentImageSize = 250;\n        \n        window.onload = function() {\n            const savedHeight = localStorage.getItem('reportRowHeight') || '28';\n            const savedWidth = localStorage.getItem('reportRowWidth') || '20';\n            const savedImageSize = localStorage.getItem('reportImageSize') || '250';\n            \n            document.getElementById('heightSlider').value = savedHeight;\n            document.getElementById('widthSlider').value = savedWidth;\n            document.getElementById('imageSlider').value = savedImageSize;\n            \n            currentHeight = parseInt(savedHeight);\n            currentWidth = parseInt(savedWidth);\n            currentImageSize = parseInt(savedImageSize);\n            \n            applySize();\n            applyImageSize();\n        };\n        \n        function adjustImageSize(value) {\n            currentImageSize = parseInt(value);\n            document.getElementById('imageValue').textContent = value + 'px';\n            localStorage.setItem('reportImageSize', value);\n            applyImageSize();\n        }\n        \n        function applyImageSize() {\n            const images = document.querySelectorAll('.car-image');\n            images.forEach(img => {\n                img.style.width = currentImageSize + 'px';\n                img.style.height = (currentImageSize * 0.67) + 'px';\n            });\n        }\n        \n        function adjustHeight(value) {\n            currentHeight = parseInt(value);\n            document.getElementById('heightValue').textContent = value + 'px';\n            localStorage.setItem('reportRowHeight', value);\n            applySize();\n        }\n        \n        function adjustWidth(value) {\n            currentWidth = parseInt(value);\n            document.getElementById('widthValue').textContent = value + 'px';\n            localStorage.setItem('reportRowWidth', value);\n            applySize();\n        }\n        \n        function applySize() {\n            const allCells = document.querySelectorAll('#reportTable td, #reportTable th');\n            \n            allCells.forEach(cell => {\n                if (cell.cellIndex === 0) {\n                    cell.style.paddingTop = currentHeight + 'px';\n                    cell.style.paddingBottom = currentHeight + 'px';\n                    cell.style.paddingLeft = '20px';\n                    cell.style.paddingRight = '20px';\n                } else {\n                    cell.style.padding = currentHeight + 'px ' + currentWidth + 'px';\n                }\n                \n                cell.style.verticalAlign = 'middle';\n                cell.style.height = 'auto';\n                cell.style.minHeight = (currentHeight * 2) + 'px';\n            });\n        }\n        \n        function openImageModal(src, title) {\n            const modal = document.getElementById('imageModal');\n            const modalImg = document.getElementById('modalImage');\n            const modalTitle = document.getElementById('modalTitle');\n            \n            modal.classList.add('active');\n            modalImg.src = src;\n            modalTitle.textContent = title;\n            \n            document.body.style.overflow = 'hidden';\n        }\n        \n        function closeImageModal() {\n            const modal = document.getElementById('imageModal');\n            modal.classList.remove('active');\n            document.body.style.overflow = 'auto';\n        }\n        \n        document.addEventListener('keydown', function(e) {\n            if (e.key === 'Escape') {\n                closeImageModal();\n            }\n        });\n        \n        function toggleEdit() {\n            isEditing = !isEditing;\n            const cells = document.querySelectorAll('td, th');\n            const btn = document.getElementById('editBtn');\n            \n            cells.forEach(cell => {\n                cell.contentEditable = isEditing;\n            });\n            \n            if (isEditing) {\n                btn.textContent = '✅ 完成';\n                btn.style.background = 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)';\n            } else {\n                btn.textContent = '✏️ 编辑';\n                btn.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';\n            }\n        }\n        \n        function transposeTable() {\n            const table = document.getElementById('reportTable');\n            const wrapper = document.getElementById('tableWrapper');\n            \n            if (!isTransposed) {\n                originalTableHTML = table.outerHTML;\n                \n                const rows = Array.from(table.rows);\n                const maxCols = Math.max(...rows.map(r => r.cells.length));\n                \n                let transposedHTML = '<table id=\"reportTable\">';\n                \n                for (let col = 0; col < maxCols; col++) {\n                    transposedHTML += '<tr>';\n                    for (let row = 0; row < rows.length; row++) {\n                        const cell = rows[row].cells[col];\n                        if (cell) {\n                            const tagName = (col === 0) ? 'th' : 'td';\n                            transposedHTML += '<' + tagName + '>' + cell.innerHTML + '</' + tagName + '>';\n                        }\n                    }\n                    transposedHTML += '</tr>';\n                }\n                \n                transposedHTML += '</table>';\n                wrapper.innerHTML = transposedHTML;\n                \n                setTimeout(() => {\n                    applySize();\n                    applyImageSize();\n                }, 50);\n                \n                document.getElementById('transposeBtn').textContent = '↩️ 还原';\n                isTransposed = true;\n            } else {\n                wrapper.innerHTML = originalTableHTML;\n                \n                setTimeout(() => {\n                    applySize();\n                    applyImageSize();\n                }, 50);\n                \n                document.getElementById('transposeBtn').textContent = '🔄 转置';\n                isTransposed = false;\n            }\n        }\n    </script>\n</body>\n</html>`;\n\nconst reportID = 'report_' + Date.now();\n\nreturn {\n  json: {\n    success: true,\n    reportID: reportID,\n    htmlContent: html,\n    createTime: new Date().toISOString(),\n    imageStats: mergedData.imageStats\n  }\n};"
      },
      "id": "594d3d39-e353-4e74-87d5-249cc5865819",
      "name": "GenerateReport",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5872,
        6752
      ]
    },
    {
      "parameters": {
        "jsCode": "// 从Google Sheets获取的数据\nconst items = $input.all();\n\n// 如果没有数据，返回空列表\nif (!items || items.length === 0) {\n  return {\n    json: {\n      success: true,\n      dialogues: [],\n      total: 0\n    }\n  };\n}\n\n// 处理每个对话记录\nconst dialogues = items.map(item => {\n  const data = item.json;\n  \n  // ⭐ 将tags字符串转换为数组（前端需要）- 添加类型检查\n  let tagsArray = [];\n  if (data.tags) {\n    if (typeof data.tags === 'string') {\n      // tags 是字符串，需要split\n      tagsArray = data.tags.split(',').map(t => t.trim()).filter(t => t);\n    } else if (Array.isArray(data.tags)) {\n      // tags 已经是数组，直接使用\n      tagsArray = data.tags;\n    }\n  }\n  \n  // ⭐ 提取conversationHistory的最后一条AI回复作为preview\n  let preview = '暂无内容';\n  if (data.conversationHistory) {\n    const pairs = data.conversationHistory.split('----').filter(s => s.trim());\n    // 找最后一条AISpeak\n    for (let i = pairs.length - 1; i >= 0; i--) {\n      if (pairs[i].startsWith('AISpeak:')) {\n        preview = pairs[i].replace('AISpeak:', '').substring(0, 50);\n        if (pairs[i].replace('AISpeak:', '').length > 50) {\n          preview += '...';\n        }\n        break;\n      }\n    }\n  }\n  \n  return {\n    dialogueID: data.dialogueID,\n    title: data.title || '未命名对话',\n    tags: tagsArray,  // ⭐ 数组格式\n    createTime: data.createTime,\n    preview: preview,\n    status: data.status\n  };\n});\n\n// ⭐ 按createTime降序排序（最新的在前）\ndialogues.sort((a, b) => {\n  const timeA = new Date(a.createTime).getTime();\n  const timeB = new Date(b.createTime).getTime();\n  return timeB - timeA;  // 降序\n});\n\nreturn {\n  json: {\n    success: true,\n    dialogues: dialogues,\n    total: dialogues.length\n  }\n};"
      },
      "id": "e188bfd7-37d5-4158-8a17-4d4b2e9c3591",
      "name": "GetDialogueList",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4496,
        7024
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{$json}}",
        "options": {}
      },
      "id": "7d072fe1-f8fb-46e6-b812-e81e33299c15",
      "name": "统一响应",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        7248,
        6864
      ]
    },
    {
      "parameters": {
        "jsCode": "const originalData = $('处理AI响应').first().json;\nreturn {json: originalData.response};"
      },
      "id": "6c38f1d4-2283-46f7-ab79-c373c721f5a8",
      "name": "格式化响应1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6736,
        6480
      ]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.item.json;\nconst userContent = data.userMessage.content;\n\nconst initialHistory = 'userSpeak:' + userContent + '----';\n\nreturn {\n  json: {\n    dialogueID: data.dialogueID,\n    userID: data.userID,\n    title: data.title,\n    tags: data.tags,  // ⭐ 传递合并后的 tags\n    userAttachedTags: data.userAttachedTags,  // ⭐ 传递用户附加的 tags\n    createTime: data.createTime,\n    status: data.status,\n    conversationHistory: initialHistory,\n    userMessage: data.userMessage,\n    aiMessage: data.aiMessage\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4784,
        6304
      ],
      "id": "45837232-4a68-4cf0-8a33-e750026806bb",
      "name": "初始化对话"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        5248,
        6480
      ],
      "id": "a9212692-1743-4f98-89e0-7da3688229a4",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatDeepSeek",
      "typeVersion": 1,
      "position": [
        5248,
        6624
      ],
      "id": "c18c40bf-f03b-424c-a6de-30f573654031",
      "name": "DeepSeek Chat Model",
      "credentials": {
        "deepSeekApi": {
          "id": "Rq6VyJR7LeyTkMK8",
          "name": "DeepSeek account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = $input.item.json;\nconst conversationHistory = data.conversationHistory || '';\n\nconst pairs = conversationHistory.split('----').filter(s => s.trim());\nconst chatInput = [];\n\nfor (const pair of pairs) {\n  if (pair.startsWith('userSpeak:')) {\n    chatInput.push('用户: ' + pair.replace('userSpeak:', ''));\n  } else if (pair.startsWith('AISpeak:')) {\n    chatInput.push('助手: ' + pair.replace('AISpeak:', ''));\n  }\n}\n\n// ⭐ 判断是否是新对话的第一轮（只有一条userSpeak）\nconst isFirstMessage = pairs.length === 1 && pairs[0].startsWith('userSpeak:');\n\n// ⭐ 获取最新的用户消息\nconst latestUserMessage = pairs[pairs.length - 1]?.replace('userSpeak:', '') || '';\n\n// ⭐ 检测是否是\"接受此方案\"的确认消息\nconst isAcceptConfirmation = latestUserMessage.includes('接受此方案') || \n                             latestUserMessage.includes('接受方案') ||\n                             latestUserMessage === '接受';\n\n// ⭐ 获取用户附加的收藏夹标签\nconst userAttachedTags = data.userAttachedTags || [];\n\n// ⭐ 添加系统角色设定（所有对话都有）\nlet prompt = '【系统设定】你是一位专业的世界级汽车设计师助手，擅长分析车辆外观、内饰、性能等设计细节。\\n\\n';\n\n// ⭐ 如果用户附加了收藏夹标签，注入到系统设定中\nif (userAttachedTags.length > 0) {\n  prompt += `【用户附加的参考收藏夹】：${userAttachedTags.join('、')}\\n`;\n  prompt += `这些收藏夹代表了用户感兴趣的主题和车型分类。在生成调研方案时，请优先围绕这些主题进行分析。\\n\\n`;\n}\n\n// ⭐ 增加研究请求识别能力\nprompt += `【特殊任务识别】\n当用户的消息包含以下意图时，你需要用特殊格式回复：\n- 请求生成报告/对比分析（如：\"帮我分析XX和YY\"、\"对比一下这几款车\"）\n- 要求详细对比某几款车型\n- 询问能否生成分析表格\n\n识别到研究请求后，你的回复格式为：\n[PROPOSAL]接下来我将为您进行以下调研：\n`;\n\n// ⭐ 如果有用户附加的标签，在方案中体现\nif (userAttachedTags.length > 0) {\n  prompt += `\\n**基于您附加的收藏夹「${userAttachedTags.join('」「')}」**，\\n`;\n}\n\nprompt += `1. 整理：{车型1}与{车型2}的关键信息\n2. 识别：为您提取{对比维度}（如外观、内饰、性能等）\n3. 数据整理：按您提出的需求生成对比报告\n\n请确认是否继续？\n\n【注意】：\n- 如果只是普通对话，不要加[PROPOSAL]标记\n- 用户说\"接受此方案\"或\"接受\"时，简短回复\"好的，正在为您生成报告...\"即可，不要再加[PROPOSAL]\n\n`;\n\nprompt += chatInput.join('\\n');\n\nif (isFirstMessage) {\n  // ⭐ 第一轮对话，要求AI生成标题（用清晰的格式）\n  prompt += `\n\n【重要】请严格按以下格式回复，标题和正文之间用空行分隔：\n\n第一行：[为本次对话生成一个5-10字的简洁标题]\n\n第二行：空行\n\n第三行：[你的专业回复，如果识别到研究请求则加[PROPOSAL]标记，50字以内]\n\n示例格式：\n问界M7外观设计\n\n这辆车M7采用贯穿式头灯与极简型面，营造科技感，风阻系数优秀。`;\n} else if (isAcceptConfirmation) {\n  // ⭐ 用户确认接受方案\n  prompt += '\\n\\n用户已确认接受方案，请简短回复\"好的，正在为您生成报告...\"（不超过20字）';\n} else {\n  // 后续对话，正常回复\n  prompt += '\\n\\n请以专业汽车设计师的角度回复用户（50字以内，如识别到研究请求则加[PROPOSAL]标记）：';\n}\n\nreturn {\n  json: {\n    conversationHistory: data.conversationHistory,\n    dialogueID: data.dialogueID,\n    userID: data.userID,\n    title: data.title,\n    tags: data.tags,\n    userAttachedTags: userAttachedTags,  // ⭐ 继续传递\n    createTime: data.createTime,\n    status: data.status,\n    chatInput: prompt,\n    isFirstMessage: isFirstMessage,\n    isAcceptConfirmation: isAcceptConfirmation\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5056,
        6480
      ],
      "id": "42dd2252-6e4a-49e1-bcac-78c0cfcf6953",
      "name": "转换为AI格式"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.item.json;\nconst aiResponse = data.output || '';\n\n// ⭐ 从\"转换为AI格式\"节点读取isFirstMessage和isAcceptConfirmation\nconst convertData = $('转换为AI格式').first().json;\nconst isFirstMessage = convertData.isFirstMessage || false;\nconst isAcceptConfirmation = convertData.isAcceptConfirmation || false;\n\nconst conversationHistory = convertData.conversationHistory || '';\nlet finalTitle = convertData.title || '未命名对话';\nlet finalReply = aiResponse;\n\n// ⭐ 检测消息类型\nlet messageType = 'text';  // 默认普通文本\n\n// 检测是否包含[PROPOSAL]标记\nif (aiResponse.includes('[PROPOSAL]')) {\n  messageType = 'proposal';\n  // 移除标记，保留正文\n  finalReply = aiResponse.replace('[PROPOSAL]', '').trim();\n} else if (isAcceptConfirmation) {\n  // 用户确认后，AI的回复标记为 confirmation\n  messageType = 'confirmation';\n}\n\n// ⭐ 如果是第一条消息，提取标题\nif (isFirstMessage && aiResponse) {\n  // 按双换行符分割\n  const parts = aiResponse.split('\\n\\n');\n  \n  if (parts.length >= 2 && parts[0].trim()) {\n    finalTitle = parts[0].trim();\n    finalReply = parts.slice(1).join('\\n\\n').trim();\n    \n    // 如果提取出的回复中还有[PROPOSAL]，需要处理\n    if (finalReply.includes('[PROPOSAL]')) {\n      messageType = 'proposal';\n      finalReply = finalReply.replace('[PROPOSAL]', '').trim();\n    }\n  } else {\n    // Fallback\n    const userContent = conversationHistory.match(/userSpeak:(.+?)----/);\n    if (userContent && userContent[1]) {\n      finalTitle = userContent[1].substring(0, 20) + (userContent[1].length > 20 ? '...' : '');\n    }\n  }\n}\n\nconst updatedHistory = conversationHistory + 'AISpeak:' + finalReply + '----';\n\nconst messageID = 'msg_' + Date.now();\n\nconst tagsArray = convertData.tags ? convertData.tags.split(',').filter(t => t.trim()) : [];\n\nreturn {\n  json: {\n    dialogueID: convertData.dialogueID,\n    userID: convertData.userID,\n    title: finalTitle,\n    tags: convertData.tags,  // ⭐ 传递合并后的 tags（逗号分隔字符串）\n    userAttachedTags: convertData.userAttachedTags,  // ⭐ 传递用户附加的 tags（数组）\n    createTime: convertData.createTime,\n    status: convertData.status,\n    conversationHistory: updatedHistory,\n    response: {\n      success: true,\n      dialogueID: convertData.dialogueID,\n      messageID: messageID,\n      aiReply: finalReply,\n      messageType: messageType,  // ⭐ 消息类型\n      title: finalTitle,\n      extractedTags: tagsArray,\n      conversationHistory: updatedHistory\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5520,
        6480
      ],
      "id": "32bf081e-6fff-41e8-b021-06f12ff7a7ac",
      "name": "处理AI响应",
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "operation": "appendOrUpdate",
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1586220630,
          "mode": "list",
          "cachedResultName": "AIDialogues",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit#gid=1586220630"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {
            "userID": "={{ $json.userID }}",
            "status": "={{ $json.status }}",
            "dialogueID": "={{$json.dialogueID}}",
            "title": "={{ $json.title }}",
            "tags": "={{$json.tags}}",
            "conversationHistory": "={{ $json.conversationHistory }}",
            "createTime": "={{$json.createTime}}"
          },
          "matchingColumns": [
            "dialogueID"
          ],
          "schema": [
            {
              "id": "dialogueID",
              "displayName": "dialogueID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "userID",
              "displayName": "userID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "title",
              "displayName": "title",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "tags",
              "displayName": "tags",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "conversationHistory",
              "displayName": "conversationHistory",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "createTime",
              "displayName": "createTime",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "bb299c95-f48e-44f2-9062-6b1aa062d940",
      "name": "保存conversationHistory到表格",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        6288,
        6480
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YS5a72jpKHezwxcc",
          "name": "Google Sheets account 5"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = $input.item.json;\nconst existingHistory = data.conversationHistory || '';\nconst userContent = data.userMessage.content;\n\n// ⭐ 调试日志\nconsole.log('========== 追加用户消息 ==========');\nconsole.log('收到的 conversationHistory 长度:', existingHistory.length);\nconsole.log('conversationHistory 内容:', existingHistory);\nconsole.log('用户消息:', userContent);\n\nconst updatedHistory = existingHistory + 'userSpeak:' + userContent + '----';\n\nconsole.log('追加后的 conversationHistory 长度:', updatedHistory.length);\nconsole.log('=====================================');\n\nreturn {\n  json: {\n    dialogueID: data.dialogueID,\n    userID: data.userID,\n    title: data.title,\n    tags: data.tags,  // ⭐ 传递合并后的 tags\n    userAttachedTags: data.userAttachedTags,  // ⭐ 传递用户附加的 tags\n    createTime: data.createTime,\n    status: data.status,\n    conversationHistory: updatedHistory\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4784,
        6480
      ],
      "id": "72076b5e-778b-4311-ba48-a213f6bee1bd",
      "name": "追加用户消息"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1586220630,
          "mode": "list",
          "cachedResultName": "AIDialogues",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit#gid=1586220630"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "dialogueID",
              "lookupValue": "={{$json.data.dialogueID}}"
            }
          ]
        },
        "options": {}
      },
      "id": "7527feb2-b72e-49a9-8d9f-00df699b2e52",
      "name": "读取对话详情",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        4288,
        7248
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YS5a72jpKHezwxcc",
          "name": "Google Sheets account 5"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const data = $input.item.json.data;\nconst sheetData = $('读取对话详情').first().json;\n\n// ⭐ 调试：查看原始数据\nconsole.log('🔍 [GetDialogueDetail] sheetData.tags 原始值:', sheetData.tags);\nconsole.log('🔍 [GetDialogueDetail] sheetData.tags 类型:', typeof sheetData.tags);\n\nconst dialogueID = sheetData.dialogueID || data.dialogueID;\nconst title = sheetData.title || '未命名对话';\nconst conversationHistory = sheetData.conversationHistory || '';\n\n// ⭐ 修复：统一处理 tags，转换为字符串\nlet tags = '';\n\n// 优先检查是否有 sheetData.tags\nif (sheetData.tags) {\n  if (Array.isArray(sheetData.tags)) {\n    // tags 是数组，合并为字符串\n    tags = sheetData.tags.join(',');\n    console.log('✅ [GetDialogueDetail] tags 是数组，合并后:', tags);\n  } else if (typeof sheetData.tags === 'string') {\n    // tags 是字符串，直接使用\n    tags = sheetData.tags.trim();  // ⭐ 去除首尾空格\n    console.log('✅ [GetDialogueDetail] tags 是字符串:', tags);\n  } else {\n    // 其他类型，转换为字符串\n    tags = String(sheetData.tags);\n    console.log('⚠️ [GetDialogueDetail] tags 是其他类型，转换为:', tags);\n  }\n} else {\n  console.log('⚠️ [GetDialogueDetail] sheetData.tags 为空或 undefined');\n}\n\nconsole.log('📤 [GetDialogueDetail] 最终返回的 tags:', tags);\n\n// 解析conversationHistory为messages数组\nconst pairs = conversationHistory.split('----').filter(s => s.trim());\nconst messages = [];\n\nfor (const pair of pairs) {\n  if (pair.startsWith('userSpeak:')) {\n    messages.push({\n      role: 'user',\n      content: pair.replace('userSpeak:', ''),\n      timestamp: new Date().toISOString()\n    });\n  } else if (pair.startsWith('AISpeak:')) {\n    messages.push({\n      role: 'assistant',\n      content: pair.replace('AISpeak:', ''),\n      timestamp: new Date().toISOString()\n    });\n  }\n}\n\nreturn {\n  json: {\n    success: true,\n    dialogueID: dialogueID,\n    title: title,\n    conversationHistory: conversationHistory,\n    tags: tags,  // ⭐ 返回处理后的 tags 字符串\n    messages: messages,\n    totalMessages: messages.length\n  }\n};"
      },
      "id": "898547e3-0a4e-407e-997b-d9761e9ad799",
      "name": "GetDialogueDetail",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4496,
        7248
      ]
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1586220630,
          "mode": "list",
          "cachedResultName": "AIDialogues",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit#gid=1586220630"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "userID",
              "lookupValue": "={{$json.data.userID}}"
            }
          ]
        },
        "options": {}
      },
      "id": "47f974b4-70f8-44d4-a680-bc3e5a5106c1",
      "name": "读取对话列表",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        4288,
        7024
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YS5a72jpKHezwxcc",
          "name": "Google Sheets account 5"
        }
      }
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "ai-analysis",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "f1bbbc68-c59e-4c18-8e2e-357ba2a2209c",
      "name": "AI分析入口",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2.1,
      "position": [
        3536,
        6848
      ],
      "webhookId": "ai-analysis-webhook"
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": 1586220630,
          "mode": "list",
          "cachedResultName": "AIDialogues",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit#gid=1586220630"
        },
        "filtersUI": {
          "values": [
            {
              "lookupColumn": "dialogueID",
              "lookupValue": "={{$json.data.dialogueID}}"
            }
          ]
        },
        "options": {}
      },
      "id": "1742d82c-e4a8-42c6-b062-9abbb32716dc",
      "name": "读取报告对话数据",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        4288,
        6752
      ],
      "alwaysOutputData": true,
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YS5a72jpKHezwxcc",
          "name": "Google Sheets account 5"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "={{$json.analysisPrompt}}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        4688,
        6752
      ],
      "id": "0d69aa7d-9fcf-40e3-ab34-4e2aa8ec47b1",
      "name": "AI Agent1"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatDeepSeek",
      "typeVersion": 1,
      "position": [
        4688,
        6896
      ],
      "id": "d7b490b4-357d-4479-9f09-1525b5b35560",
      "name": "DeepSeek Chat Model2",
      "credentials": {
        "deepSeekApi": {
          "id": "Rq6VyJR7LeyTkMK8",
          "name": "DeepSeek account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// 从Google Sheets读取的数据\nconst sheetData = $('读取报告对话数据').first().json;\n\nconst dialogueID = sheetData.dialogueID;\nconst title = sheetData.title || '对话分析';\n\n// ⭐ 修复：统一处理 tags，无论是数组还是字符串，都转换为字符串\nlet tags = '';\nif (Array.isArray(sheetData.tags)) {\n  tags = sheetData.tags.join(',');\n} else if (typeof sheetData.tags === 'string') {\n  tags = sheetData.tags;\n}\n\nconst conversationHistory = sheetData.conversationHistory || '';\n\n// 解析对话历史\nconst pairs = conversationHistory.split('----').filter(s => s.trim());\nconst dialogue = [];\n\nfor (const pair of pairs) {\n  if (pair.startsWith('userSpeak:')) {\n    dialogue.push('用户: ' + pair.replace('userSpeak:', ''));\n  } else if (pair.startsWith('AISpeak:')) {\n    dialogue.push('助手: ' + pair.replace('AISpeak:', ''));\n  }\n}\n\n// 构建AI分析prompt（⭐ 优化版：要求多层次描述）\nconst prompt = `你是一位专业的汽车分析师，需要根据以下对话生成一份车型对比报告。\n\n【对话内容】\n${dialogue.join('\\n')}\n\n【分析任务】\n请分析对话中提到的车型和对比维度，按以下JSON格式输出：\n\n\\`\\`\\`json\n{\n  \"vehicles\": [\n    {\"name\": \"车型名称1\"},\n    {\"name\": \"车型名称2\"}\n  ],\n  \"dimensions\": [\n    {\n      \"name\": \"对比维度（如：外观设计）\",\n      \"车型名称1\": {\n        \"label\": \"核心特点（5-8字）\",\n        \"desc1\": \"详细描述（15-20字）\",\n        \"desc2\": \"补充信息或亮点（15-20字）\"\n      },\n      \"车型名称2\": {\n        \"label\": \"核心特点\",\n        \"desc1\": \"详细描述\",\n        \"desc2\": \"补充信息或亮点\"\n      }\n    }\n  ]\n}\n\\`\\`\\`\n\n【重要规则】\n1. ⭐ 禁止使用\"未提及\"、\"未明确提及\"等词汇\n2. ⭐ 如果对话没有明确讨论某个维度，请根据车型定位、品牌特点、常识进行合理推断\n3. 例如：\n   - 腾势Z9（高端轿跑）→ 外观可推断\"GT跑车造型、贯穿式灯组、低风阻设计\"\n   - 问界M7（家用SUV）→ 空间可推断\"三排座椅布局、灵活储物、后备箱充裕\"\n4. 每个评价必须有实质内容，体现专业性和细节\n5. label要简洁有力，desc1/desc2要有层次感\n6. 只输出JSON，不要其他内容`;\n\nreturn {\n  json: {\n    dialogueID: dialogueID,\n    title: title,\n    tags: tags,  // ⭐ 现在 tags 一定是字符串\n    analysisPrompt: prompt\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4496,
        6752
      ],
      "id": "c6c36ed0-8d24-4393-ab3f-fea2c9871ecc",
      "name": "准备报告分析prompt"
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "id": "50008af2-8b20-480d-a2ff-acc9ccb9053b",
      "name": "Aggregate",
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        6032,
        8496
      ]
    },
    {
      "parameters": {
        "jsCode": "// 格式化多车型结果\nconst inputData = $input.first().json;\n\n// 获取聚合的数据\nconst allResults = inputData.data || [];\n\nconsole.log(`处理 ${allResults.length} 个车型的结果`);\n\nif (allResults.length === 0) {\n  return {\n    json: {\n      success: false,\n      error: '未找到任何车型',\n      results: []\n    }\n  };\n}\n\nif (allResults.length === 1) {\n  // 单车型，直接返回原始格式\n  console.log('单车型结果，直接返回');\n  return {\n    json: allResults[0]\n  };\n} else {\n  // 多车型，包装成results数组\n  console.log(`多车型结果，返回${allResults.length}个车型`);\n  \n  let totalImages = 0;\n  let successCars = 0;\n  \n  allResults.forEach(car => {\n    if (car.success !== false && car.images) {\n      totalImages += car.images.length;\n      successCars++;\n    }\n  });\n  \n  return {\n    json: {\n      results: allResults,\n      totalCars: allResults.length,\n      successCars: successCars,\n      totalImages: totalImages,\n      message: `成功匹配${successCars}/${allResults.length}个车型，共${totalImages}张图片`,\n      timestamp: new Date().toISOString()\n    }\n  };\n}"
      },
      "id": "cd6c6779-0040-4032-9da2-0e284330b197",
      "name": "格式化多车型结果",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        6224,
        8496
      ]
    },
    {
      "parameters": {
        "keepOnlySet": true,
        "values": {
          "string": [
            {
              "name": "carNames",
              "value": "={{ $json.body.carNames || [$json.body.carName] }}"
            },
            {
              "name": "filterCategory",
              "value": "={{ $json.body.filterCategory || 'all' }}"
            },
            {
              "name": "filterViewType",
              "value": "={{ $json.body.filterViewType || 'all' }}"
            }
          ]
        },
        "options": {}
      },
      "id": "e19fe093-f91e-481f-8942-fdb97e1c1442",
      "name": "提取车型名称2",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [
        3744,
        8512
      ]
    },
    {
      "parameters": {
        "jsCode": "// 准备查询 - 支持多车型\nconst carNamesInput = $input.first().json.carNames;\nconst carNames = Array.isArray(carNamesInput) ? carNamesInput : (carNamesInput ? [carNamesInput] : []);\n\nif (carNames.length === 0) {\n  return {\n    json: {\n      success: false,\n      error: '请提供车型名称',\n      code: 'CAR_NAME_REQUIRED'\n    }\n  };\n}\n\nconsole.log(`准备查询 ${carNames.length} 个车型:`, carNames);\n\n// 为每个车型创建一个item\nreturn carNames.map(carName => ({\n  json: {\n    carName: carName.trim(),\n    filterCategory: $input.first().json.filterCategory || 'all',\n    filterViewType: $input.first().json.filterViewType || 'all'\n  }\n}));"
      },
      "id": "a14e2efb-e44b-41c9-ac09-3f2c75f19355",
      "name": "准备查询3",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3952,
        8512
      ]
    },
    {
      "parameters": {
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet"
        },
        "sheetName": {
          "__rl": true,
          "value": 1837650523,
          "mode": "list",
          "cachedResultName": "NewallCarMapping完整"
        },
        "options": {}
      },
      "id": "ada90d76-0fcf-4d9e-9bb0-f3b3884d8bb3",
      "name": "读取Google Sheet4",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4,
      "position": [
        4272,
        8640
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YS5a72jpKHezwxcc",
          "name": "Google Sheets account 5"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const inputCarName = $('Loop Over Items3').item.json.carName;  // ✅ 从Loop获取！\nconst filterCategory = $('Loop Over Items3').item.json.filterCategory || 'all';\nconst filterViewType = $('Loop Over Items3').item.json.filterViewType || 'all';\n\n// 从\"读取Google Sheet4\"获取全部数据\nconst allCars = $input.all();  // ✅ 这个是对的，获取Sheet的2040条\n\nconst MATCH_THRESHOLD = 0.70;\n\nconsole.log(`\\n===== 开始模糊匹配 =====`);\nconsole.log(`输入车型: ${inputCarName}`);\nconsole.log(`数据库总数: ${allCars.length}`);\n\n// 字符串相似度算法\nfunction levenshteinDistance(str1, str2) {\n  const len1 = str1.length;\n  const len2 = str2.length;\n  const matrix = [];\n\n  for (let i = 0; i <= len1; i++) {\n    matrix[i] = [i];\n  }\n  for (let j = 0; j <= len2; j++) {\n    matrix[0][j] = j;\n  }\n\n  for (let i = 1; i <= len1; i++) {\n    for (let j = 1; j <= len2; j++) {\n      const cost = str1[i - 1] === str2[j - 1] ? 0 : 1;\n      matrix[i][j] = Math.min(\n        matrix[i - 1][j] + 1,\n        matrix[i][j - 1] + 1,\n        matrix[i - 1][j - 1] + cost\n      );\n    }\n  }\n\n  return matrix[len1][len2];\n}\n\nfunction levenshteinSimilarity(str1, str2) {\n  const maxLen = Math.max(str1.length, str2.length);\n  if (maxLen === 0) return 1.0;\n  const distance = levenshteinDistance(str1, str2);\n  return 1 - distance / maxLen;\n}\n\nfunction jaroWinklerSimilarity(s1, s2) {\n  function jaroSimilarity(s1, s2) {\n    if (s1.length === 0 && s2.length === 0) return 1.0;\n    if (s1.length === 0 || s2.length === 0) return 0.0;\n\n    const matchDistance = Math.floor(Math.max(s1.length, s2.length) / 2) - 1;\n    const s1Matches = new Array(s1.length).fill(false);\n    const s2Matches = new Array(s2.length).fill(false);\n\n    let matches = 0;\n    let transpositions = 0;\n\n    for (let i = 0; i < s1.length; i++) {\n      const start = Math.max(0, i - matchDistance);\n      const end = Math.min(i + matchDistance + 1, s2.length);\n\n      for (let j = start; j < end; j++) {\n        if (s2Matches[j] || s1[i] !== s2[j]) continue;\n        s1Matches[i] = true;\n        s2Matches[j] = true;\n        matches++;\n        break;\n      }\n    }\n\n    if (matches === 0) return 0.0;\n\n    let k = 0;\n    for (let i = 0; i < s1.length; i++) {\n      if (!s1Matches[i]) continue;\n      while (!s2Matches[k]) k++;\n      if (s1[i] !== s2[k]) transpositions++;\n      k++;\n    }\n\n    return (\n      (matches / s1.length +\n        matches / s2.length +\n        (matches - transpositions / 2) / matches) /\n      3\n    );\n  }\n\n  const jaro = jaroSimilarity(s1, s2);\n  const prefixLength = Math.min(4, s1.length, s2.length);\n  let prefix = 0;\n  for (let i = 0; i < prefixLength; i++) {\n    if (s1[i] === s2[i]) prefix++;\n    else break;\n  }\n\n  return jaro + prefix * 0.1 * (1 - jaro);\n}\n\nfunction containsMatch(input, target) {\n  const inputLower = input.toLowerCase();\n  const targetLower = target.toLowerCase();\n  \n  if (targetLower.includes(inputLower) || inputLower.includes(targetLower)) {\n    return 1.0;\n  }\n  \n  const inputTokens = inputLower.split(/[\\s\\-]+/);\n  const targetTokens = targetLower.split(/[\\s\\-]+/);\n  \n  let matchCount = 0;\n  for (const inputToken of inputTokens) {\n    if (inputToken.length < 2) continue;\n    for (const targetToken of targetTokens) {\n      if (targetToken.includes(inputToken) || inputToken.includes(targetToken)) {\n        matchCount++;\n        break;\n      }\n    }\n  }\n  \n  return inputTokens.length > 0 ? matchCount / inputTokens.length : 0;\n}\n\nfunction brandModelMatch(input, target) {\n  const inputParts = input.split(/[-\\s]+/);\n  const targetParts = target.split(/[-\\s]+/);\n  \n  if (inputParts.length < 2 || targetParts.length < 2) {\n    return 0;\n  }\n  \n  const brandMatch = inputParts[0].toLowerCase() === targetParts[0].toLowerCase() ? 1 : 0;\n  const modelSimilarity = levenshteinSimilarity(\n    inputParts.slice(1).join('').toLowerCase(),\n    targetParts.slice(1).join('').toLowerCase()\n  );\n  \n  return brandMatch && modelSimilarity >= 0.6 ? (brandMatch + modelSimilarity) / 2 : 0;\n}\n\nfunction calculateComprehensiveScore(input, target) {\n  const inputNorm = input.replace(/\\s+/g, '').toLowerCase();\n  const targetNorm = target.replace(/\\s+/g, '').toLowerCase();\n  \n  const inputClean = input.replace(/[\\s\\-]/g, '').toLowerCase();\n  const targetClean = target.replace(/[\\s\\-]/g, '').toLowerCase();\n  const isFullyContained = targetClean.includes(inputClean) && inputClean.length >= 3;\n  \n  const levenScore = levenshteinSimilarity(inputNorm, targetNorm);\n  const jaroScore = jaroWinklerSimilarity(inputNorm, targetNorm);\n  const containsScore = containsMatch(input, target);\n  const brandModelScore = brandModelMatch(input, target);\n  \n  const weights = {\n    levenshtein: 0.25,\n    jaroWinkler: 0.25,\n    contains: 0.30,\n    brandModel: 0.20\n  };\n  \n  let finalScore = \n    levenScore * weights.levenshtein +\n    jaroScore * weights.jaroWinkler +\n    containsScore * weights.contains +\n    brandModelScore * weights.brandModel;\n  \n  if (isFullyContained) {\n    finalScore = Math.max(finalScore, 0.88);\n  }\n  \n  return {\n    finalScore: finalScore,\n    details: {\n      levenshtein: levenScore.toFixed(3),\n      jaroWinkler: jaroScore.toFixed(3),\n      contains: containsScore.toFixed(3),\n      brandModel: brandModelScore.toFixed(3)\n    }\n  };\n}\n\nconst matches = [];\n\nfor (const car of allCars) {\n  const carName = car.json.carName || '';\n  const carID = car.json.carID;\n  const brandID = car.json.brandID;\n  \n  if (!carName || !carID) continue;\n  \n  const scoreResult = calculateComprehensiveScore(inputCarName, carName);\n  \n  matches.push({\n    carName: carName,\n    carID: carID,\n    brandID: brandID,\n    vehicleClass: car.json.vehicleClass,\n    priceRange: car.json.carPriceRange,\n    score: scoreResult.finalScore,\n    scoreDetails: scoreResult.details\n  });\n}\n\nmatches.sort((a, b) => b.score - a.score);\n\nconsole.log(`\\n前5个匹配结果:`);\nmatches.slice(0, 5).forEach((match, index) => {\n  console.log(`${index + 1}. ${match.carName} - 相似度: ${(match.score * 100).toFixed(1)}%`);\n});\n\nconst bestMatch = matches[0];\n\nif (bestMatch && bestMatch.score >= MATCH_THRESHOLD) {\n  console.log(`\\n✅ 匹配成功！`);\n  console.log(`输入: ${inputCarName}`);\n  console.log(`匹配: ${bestMatch.carName}`);\n  console.log(`相似度: ${(bestMatch.score * 100).toFixed(1)}%`);\n  console.log(`carID: ${bestMatch.carID}`);\n  \n  return {\n    json: {\n      needsSearch: false,\n      resolved: true,\n      carId: bestMatch.carID,\n      carName: bestMatch.carName,\n      brandID: bestMatch.brandID,\n      matchType: 'googlesheet_fuzzy_match',\n      similarityScore: bestMatch.score,\n      inputCarName: inputCarName,\n      filterCategory: filterCategory,\n      filterViewType: filterViewType\n    }\n  };\n}\n\nconsole.log(`\\n⚠️ 未找到满足阈值的匹配，降级到SerpAPI搜索`);\n\nreturn {\n  json: {\n    needsSearch: true,\n    carName: inputCarName,\n    inputCarName: inputCarName,\n    matchType: 'low_similarity',\n    bestMatchScore: bestMatch?.score || 0,\n    filterCategory: filterCategory,\n    filterViewType: filterViewType\n  }\n};"
      },
      "id": "33807a35-c254-44c0-ac16-fab8c01b9854",
      "name": "模糊匹配分析2",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4432,
        8640
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.needsSearch }}",
              "value2": true
            }
          ]
        }
      },
      "id": "5a44b1b2-f47f-4faa-b67b-e64ac576331d",
      "name": "检查是否需要搜索3",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        4560,
        8640
      ]
    },
    {
      "parameters": {
        "url": "=https://serpapi.com/search.json?engine=google&q=site:autohome.com.cn+{{ $json.carName }}&api_key=c6805b62d6f0757df69b7b0f41e27570c6b8989caec90d8356e455cf76794514",
        "options": {
          "redirect": {
            "redirect": {
              "followRedirects": true,
              "maxRedirects": 5
            }
          },
          "response": {
            "response": {
              "responseFormat": "json"
            }
          },
          "timeout": 15000
        }
      },
      "id": "ddb3545a-4cd5-42f4-9403-b4463b220a4b",
      "name": "SerpAPI搜索1",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 3,
      "position": [
        4784,
        8576
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "const carName = $('检查是否需要搜索3').item.json.carName;\nconst inputCarName = $('检查是否需要搜索3').item.json.inputCarName;\nconst response = $input.item.json;\n\nconsole.log('===== SerpAPI响应 =====');\nconsole.log('车型名称:', carName);\n\nconst organicResults = response.organic_results || [];\nconsole.log('找到', organicResults.length, '个搜索结果');\n\nlet carId = null;\n\nfor (const result of organicResults) {\n  const link = result.link || '';\n  console.log('检查链接:', link);\n  \n  const patterns = [\n    /autohome\\.com\\.cn\\/(\\d{2,5})\\/?/,\n    /series-(\\d{2,5})\\.html/,\n    /config\\/series\\/(\\d{2,5})/\n  ];\n  \n  for (const pattern of patterns) {\n    const match = link.match(pattern);\n    if (match && match[1]) {\n      carId = match[1];\n      console.log('✅ 找到carId:', carId);\n      break;\n    }\n  }\n  \n  if (carId) break;\n}\n\nif (carId && /^\\d{2,5}$/.test(carId)) {\n  console.log('✅ 成功提取carId:', carId);\n  return {\n    json: {\n      carId: carId,\n      carName: carName,\n      inputCarName: inputCarName,\n      matchType: 'serpapi_search',\n      resolved: true\n    }\n  };\n}\n\nconsole.log('❌ 未能从搜索结果中提取carId');\nreturn {\n  json: {\n    success: false,\n    error: '未能从搜索结果中提取carId',\n    code: 'EXTRACTION_FAILED',\n    carName: carName,\n    inputCarName: inputCarName\n  }\n};"
      },
      "id": "9e2fd891-216f-4135-ad21-eb3f7838b9e7",
      "name": "处理SerpAPI响应3",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4976,
        8576
      ]
    },
    {
      "parameters": {},
      "id": "21f829da-60a4-4c5d-b372-700584091672",
      "name": "合并carID结果1",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        5248,
        8672
      ]
    },
    {
      "parameters": {
        "url": "=https://www.autohome.com.cn/cars/imglist-x-x-{{ $json.carId }}-x-x-x-x-x-x-1.html",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "User-Agent",
              "value": "Mozilla/5.0 (Windows NT 10.0; Win64; x64) Chrome/120.0.0.0"
            }
          ]
        },
        "options": {
          "allowUnauthorizedCerts": true,
          "timeout": 15000
        }
      },
      "id": "9e881d49-a766-4218-8a17-13810238a59a",
      "name": "请求图片页面2",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5424,
        8640
      ],
      "onError": "continueRegularOutput"
    },
    {
      "parameters": {
        "jsCode": "// 提取外观、内饰、座椅图片\nconst inputData = $input.first().json;\n\n// 获取筛选参数 - 从合并节点获取\nconst filterCategory = $('合并carID结果1').first().json.filterCategory || 'all';\nconst filterViewType = $('合并carID结果1').first().json.filterViewType || 'all';\n\n// 从上游节点获取车型信息\nconst carInfo = {\n  carId: $('合并carID结果1').first().json.carId,\n  carName: $('合并carID结果1').first().json.carName,\n  inputCarName: $('合并carID结果1').first().json.inputCarName,\n  brandID: $('合并carID结果1').first().json.brandID,\n  matchType: $('合并carID结果1').first().json.matchType\n};\n\nconsole.log('处理车型:', carInfo.carName, '(ID:', carInfo.carId, ')');\nconsole.log('筛选参数 - 分类:', filterCategory, ', 视角:', filterViewType);\n\nlet htmlContent = '';\nif (inputData.data) {\n  htmlContent = inputData.data;\n} else if (typeof inputData === 'string') {\n  htmlContent = inputData;\n} else {\n  console.log('无法找到HTML内容');\n  return [{ json: { ...carInfo, error: '数据格式错误' } }];\n}\n\nconsole.log('HTML长度:', htmlContent.length);\n\nconst scriptMatch = htmlContent.match(/<script id=\"__NEXT_DATA__\"[^>]*>(.*?)<\\/script>/);\n\nif (!scriptMatch) {\n  console.log('未找到__NEXT_DATA__标签');\n  return [{ json: { ...carInfo, error: '未找到JSON数据' } }];\n}\n\ntry {\n  const jsonData = JSON.parse(scriptMatch[1]);\n  console.log('成功解析JSON数据');\n  \n  const picinfo = jsonData.props?.pageProps?.SeriesPicList?.picinfo;\n  \n  if (!picinfo || !picinfo.callist) {\n    console.log('未找到图片分类列表');\n    return [{ json: { ...carInfo, error: '未找到图片分类' } }];\n  }\n  \n  console.log('找到图片分类列表，数量:', picinfo.callist.length);\n  \n  const imageList = [];\n  \n  // 提取外观图片 (前4张)\n  const waiGuanClass = picinfo.callist.find(item => item.name === '外观');\n  \n  if (waiGuanClass && waiGuanClass.list && waiGuanClass.list.length > 0) {\n    console.log('外观图片总数:', waiGuanClass.list.length);\n    \n    const waiGuanViewTypes = ['view45', 'viewFront', 'view-45', 'viewSide'];\n    const waiGuanCount = Math.min(4, waiGuanClass.list.length);\n    \n    for (let i = 0; i < waiGuanCount; i++) {\n      const pic = waiGuanClass.list[i];\n      \n      imageList.push({\n        ...carInfo,\n        image_url: pic.picpath,\n        image_index: i + 1,\n        category: '外观',\n        view_type: waiGuanViewTypes[i],\n        pic_id: pic.picid,\n        spec_id: pic.specid\n      });\n      \n      console.log(`外观图片 ${i + 1} [${waiGuanViewTypes[i]}]: ${pic.picpath}`);\n    }\n  }\n  \n  // 提取内饰图片 (第1张和第6张)\n  const neiShiClass = picinfo.callist.find(item => item.name === '内饰');\n  \n  if (neiShiClass && neiShiClass.list && neiShiClass.list.length > 0) {\n    console.log('内饰图片总数:', neiShiClass.list.length);\n    \n    const neiShiIndexes = [0, 5];\n    const neiShiViewTypes = ['viewCNSL', 'viewIP'];\n    \n    for (let i = 0; i < neiShiIndexes.length; i++) {\n      const index = neiShiIndexes[i];\n      \n      if (index < neiShiClass.list.length) {\n        const pic = neiShiClass.list[index];\n        \n        imageList.push({\n          ...carInfo,\n          image_url: pic.picpath,\n          image_index: 4 + i + 1,\n          category: '内饰',\n          view_type: neiShiViewTypes[i],\n          pic_id: pic.picid,\n          spec_id: pic.specid\n        });\n        \n        console.log(`内饰图片 ${index + 1} [${neiShiViewTypes[i]}]: ${pic.picpath}`);\n      }\n    }\n  }\n  \n  // 提取座椅图片 (第3张)\n  const zuoYiClass = picinfo.callist.find(item => item.name === '座椅');\n  \n  if (zuoYiClass && zuoYiClass.list && zuoYiClass.list.length > 0) {\n    console.log('座椅图片总数:', zuoYiClass.list.length);\n    \n    const zuoYiIndex = 2;\n    \n    if (zuoYiIndex < zuoYiClass.list.length) {\n      const pic = zuoYiClass.list[zuoYiIndex];\n      \n      imageList.push({\n        ...carInfo,\n        image_url: pic.picpath,\n        image_index: 7,\n        category: '座椅',\n        view_type: 'viewDoor',\n        pic_id: pic.picid,\n        spec_id: pic.specid\n      });\n      \n      console.log(`座椅图片 ${zuoYiIndex + 1} [viewDoor]: ${pic.picpath}`);\n    }\n  }\n  \n  // 应用筛选\n  let filteredImages = imageList;\n  \n  if (filterCategory !== 'all') {\n    filteredImages = filteredImages.filter(img => img.category === filterCategory);\n    console.log(`按分类筛选后: ${filteredImages.length} 张`);\n  }\n  \n  if (filterViewType !== 'all') {\n    filteredImages = filteredImages.filter(img => img.view_type === filterViewType);\n    console.log(`按视角筛选后: ${filteredImages.length} 张`);\n  }\n  \n  console.log(`最终返回: ${filteredImages.length} 张图片`);\n  \n  if (filteredImages.length === 0) {\n    console.log('未找到符合条件的图片');\n    return [{ \n      json: { \n        ...carInfo, \n        error: '未找到符合筛选条件的图片',\n        totalImages: 0,\n        images: []\n      } \n    }];\n  }\n  \n  return filteredImages.map(img => ({ json: img }));\n  \n} catch (error) {\n  console.log('解析JSON出错:', error.message);\n  return [{ json: { ...carInfo, error: 'JSON解析失败: ' + error.message } }];\n}"
      },
      "id": "cffaf5fb-79c5-4cfb-9669-550af03cd944",
      "name": "提取图片信息1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5616,
        8672
      ],
      "alwaysOutputData": true
    },
    {
      "parameters": {
        "jsCode": "// 合并所有图片为最终结果\nconst allImages = $input.all();\n\nif (allImages.length === 0) {\n  return {\n    json: {\n      success: false,\n      error: '未找到任何图片',\n      message: '未能提取到图片信息'\n    }\n  };\n}\n\nconst firstImage = allImages[0].json;\n\n// 检查是否有错误\nif (firstImage.error) {\n  return {\n    json: {\n      success: false,\n      error: firstImage.error,\n      carId: firstImage.carId,\n      carName: firstImage.carName,\n      inputCarName: firstImage.inputCarName\n    }\n  };\n}\n\n// 按分类统计\nconst categorySummary = {};\nconst images = [];\n\nfor (const item of allImages) {\n  const img = item.json;\n  images.push({\n    url: img.image_url,\n    category: img.category,\n    view_type: img.view_type,\n    index: img.image_index,\n    pic_id: img.pic_id,\n    spec_id: img.spec_id\n  });\n  \n  if (!categorySummary[img.category]) {\n    categorySummary[img.category] = 0;\n  }\n  categorySummary[img.category]++;\n}\n\nconsole.log('\\n=== 图片提取完成 ===');\nconsole.log(`车型: ${firstImage.carName}`);\nconsole.log(`carID: ${firstImage.carId}`);\nconsole.log(`匹配方式: ${firstImage.matchType}`);\nconsole.log(`总图片数: ${images.length}`);\nconsole.log('分类统计:', categorySummary);\n\nreturn {\n  json: {\n    success: true,\n    carId: firstImage.carId,\n    carName: firstImage.carName,\n    inputCarName: firstImage.inputCarName,\n    brandID: firstImage.brandID,\n    matchType: firstImage.matchType,\n    totalImages: images.length,\n    categorySummary: categorySummary,\n    images: images,\n    message: `成功获取${images.length}张图片`,\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "a4d758cb-4d6c-4582-8272-3f23e84b04df",
      "name": "合并最终结果1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5840,
        8672
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "be806d4b-f08f-4e62-8e45-64ce9296eb27",
      "name": "返回响应3",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        6400,
        8496
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "get-car-images",
        "responseMode": "responseNode",
        "options": {
          "rawBody": false
        }
      },
      "id": "7a2b78e3-618e-4117-9d5d-535451c50edf",
      "name": "多车筛选",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        3520,
        8512
      ],
      "webhookId": "get-car-images"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        4128,
        8512
      ],
      "id": "00b79fc7-514b-4d45-aaa4-c6d240e104bf",
      "name": "Loop Over Items3"
    },
    {
      "parameters": {
        "jsCode": "// 从AI Agent的输出中提取车型列表\nconst aiOutput = $input.item.json.output || '';\nconst promptData = $('准备报告分析prompt').first().json;\n\nlet vehicles = [];\n\ntry {\n  const jsonMatch = aiOutput.match(/```json\\s*([\\s\\S]+?)\\s*```/) || \n                    aiOutput.match(/\\{[\\s\\S]+\\}/);\n  \n  if (jsonMatch) {\n    const jsonStr = jsonMatch[1] || jsonMatch[0];\n    const reportData = JSON.parse(jsonStr);\n    vehicles = (reportData.vehicles || []).map(v => v.name);\n  }\n} catch (e) {\n  console.log('解析车型失败，使用默认值');\n  vehicles = ['车型1', '车型2'];\n}\n\n// 根据对话tags判断需要什么类型的图片\n// ⭐ tags 可能是数组或字符串，需要统一处理\nlet tagsStr = '';\nif (Array.isArray(promptData.tags)) {\n  tagsStr = promptData.tags.join(',');\n} else if (typeof promptData.tags === 'string') {\n  tagsStr = promptData.tags;\n}\n\nlet filterCategory = 'all';\nlet filterViewType = 'all';\n\nif (tagsStr.includes('外观') || tagsStr.includes('外饰')) {\n  filterCategory = '外观';\n  filterViewType = 'view45';  // 默认45度角\n} else if (tagsStr.includes('内饰')) {\n  filterCategory = '内饰';\n  filterViewType = 'viewCNSL';  // 中控台视角\n} else if (tagsStr.includes('空间') || tagsStr.includes('座椅')) {\n  filterCategory = '座椅';\n  filterViewType = 'viewDoor';\n}\n\nconsole.log(`提取到${vehicles.length}个车型:`, vehicles);\nconsole.log(`图片筛选 - 分类: ${filterCategory}, 视角: ${filterViewType}`);\n\nreturn {\n  json: {\n    ...promptData,\n    vehicles: vehicles,\n    filterCategory: filterCategory,\n    filterViewType: filterViewType,\n    aiOutput: aiOutput\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4992,
        6752
      ],
      "id": "edcbf729-04b7-485a-aaf6-b4044a319fee",
      "name": "提取车型列表"
    },
    {
      "parameters": {
        "jsCode": "// 合并AI分析结果和图片数据\nconst extractData = $('提取车型列表').first().json;\nconst imageResponse = $input.first().json;\n\nconsole.log('=== 智能选图合并 ===');\nconsole.log('车型数量:', extractData.vehicles.length);\n\n// 处理图片API的返回（可能是单车型或多车型）\nlet imageResults = [];\nif (imageResponse.results) {\n  // 多车型返回\n  imageResults = imageResponse.results;\n} else if (imageResponse.images) {\n  // 单车型返回\n  imageResults = [imageResponse];\n}\n\nconsole.log('图片数据:', imageResults.length, '个车型');\n\n// 为每个车型匹配图片\nconst vehiclesWithImages = extractData.vehicles.map(carName => {\n  // 找到匹配的车型图片数据\n  const matchedData = imageResults.find(img => \n    img.carName && (\n      img.carName.includes(carName) || \n      carName.includes(img.carName) ||\n      img.inputCarName === carName\n    )\n  );\n  \n  if (matchedData && matchedData.images && matchedData.images.length > 0) {\n    // 优先使用第一张图片（已经按view_type筛选过了）\n    const selectedImage = matchedData.images[0];\n    console.log(`✅ ${carName} 匹配到图片: ${selectedImage.view_type}`);\n    \n    return {\n      name: carName,\n      imageUrl: selectedImage.url,\n      viewType: selectedImage.view_type,\n      category: selectedImage.category\n    };\n  } else {\n    // 没有匹配到，使用占位图\n    console.log(`⚠️ ${carName} 未匹配到图片，使用占位图`);\n    return {\n      name: carName,\n      imageUrl: 'https://via.placeholder.com/150x100/667eea/ffffff?text=' + encodeURIComponent(carName),\n      viewType: 'placeholder',\n      category: 'unknown'\n    };\n  }\n});\n\nreturn {\n  json: {\n    dialogueID: extractData.dialogueID,\n    title: extractData.title,\n    tags: extractData.tags,\n    analysisPrompt: extractData.analysisPrompt,\n    aiOutput: extractData.aiOutput,\n    vehicles: vehiclesWithImages,\n    imageStats: {\n      total: vehiclesWithImages.length,\n      matched: vehiclesWithImages.filter(v => v.viewType !== 'placeholder').length,\n      filterCategory: extractData.filterCategory,\n      filterViewType: extractData.filterViewType\n    }\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5408,
        6752
      ],
      "id": "b16bd86c-52b2-4d3b-b162-720526fbf837",
      "name": "智能选图合并"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://lynn-cafa-system.app.n8n.cloud/webhook/get-car-images",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({\n  carNames: $json.vehicles,\n  filterCategory: $json.filterCategory,\n  filterViewType: $json.filterViewType\n}) }}",
        "options": {
          "timeout": 120000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        5184,
        6752
      ],
      "id": "56222433-e177-4ab2-9fea-7836be56573b",
      "name": "调用图片API (HTTP Request)1"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.item.json;\nconst convertData = $('转换为AI格式').first().json;\nconst isFirstMessage = convertData.isFirstMessage || false;\n\nconsole.log('========== 准备写入 Google Sheets ==========');\nconsole.log('dialogueID:', data.dialogueID);\nconsole.log('isFirstMessage:', isFirstMessage);\nconsole.log('当前 title:', data.title);\n\n// ⭐ 构建基础数据对象（不包含 title）\nconst result = {\n  dialogueID: data.dialogueID,\n  userID: data.userID,\n  tags: data.tags,\n  conversationHistory: data.conversationHistory,\n  createTime: data.createTime,\n  status: data.status,\n  response: data.response\n};\n\n// ⭐ 只有新对话才添加 title 字段\nif (isFirstMessage) {\n  result.title = data.title || '未命名对话';\n  console.log('✅ 新对话，写入 title:', result.title);\n} else {\n  console.log('⏭️ 继续对话，完全不传 title 字段，保留 Google Sheets 原值');\n}\n\nconsole.log('最终写入的字段:', Object.keys(result));\nconsole.log('=======================================');\n\nreturn { json: result };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5728,
        6480
      ],
      "id": "be167702-94da-44f9-9bb5-83d4390b299e",
      "name": "准备写入数据"
    },
    {
      "parameters": {
        "content": "## GoogleSheet quanbu全部AI分析\n\n\n\n",
        "height": 1568,
        "width": 4256
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        3360,
        6096
      ],
      "typeVersion": 1,
      "id": "fcd41c78-5d67-4b69-bbd2-352c7ea5c807",
      "name": "Sticky Note21"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.item.json;\nconst result = {};\n\n// ⭐ 只复制有值的字段，过滤掉 undefined\nfor (const key in data) {\n  if (data[key] !== undefined && data[key] !== null) {\n    result[key] = data[key];\n  }\n}\n\n// ⭐ response 需要单独处理（始终保留）\nif (data.response) {\n  result.response = data.response;\n}\n\nreturn { json: result };"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5968,
        6480
      ],
      "id": "abf7d57b-954b-4a8b-98ef-250eaf82cd72",
      "name": "过滤空字段"
    },
    {
      "parameters": {
        "jsCode": "const data = $input.item.json.data;\nconst content = data.content || '';\nconst conversationHistory = data.conversationHistory || '';\nconst dialogueID = data.dialogueID || 'dlg_' + Date.now();\nconst userID = data.userID || 'testCode';\nconst isNewDialogue = !data.dialogueID;\n\n// 提取关键词标签\nconst keywords = ['外观','内饰','性能','续航','空间','配置','智能化','价格','安全','舒适'];\nconst extractedTags = keywords.filter(k => content.includes(k));\n\n// ⭐ 标题从前端传来，不在这里生成\nconst title = data.title || '未命名对话';\n\nconst timestamp = new Date().toISOString();\nconst messageID_user = 'msg_' + Date.now() + '_user';\n\nreturn {\n  json: {\n    dialogueID: dialogueID,\n    userID: userID,\n    title: title,  // ⭐ 直接使用前端传来的标题\n    tags: extractedTags.join(','),\n    createTime: timestamp,\n    status: 'active',\n    isNewDialogue: isNewDialogue,\n    conversationHistory: conversationHistory,\n    userMessage: {\n      messageID: messageID_user,\n      dialogueID: dialogueID,\n      role: 'user',\n      content: content,\n      timestamp: timestamp\n    }\n  }\n};"
      },
      "id": "bd48711c-d7f6-402e-9be5-eb8285ea0dbe",
      "name": "ProcessMessage1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4288,
        6080
      ]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.item.json.data;\nconst sheetData = $('读取对话详情').first().json;\n\nconst dialogueID = sheetData.dialogueID || data.dialogueID;\nconst title = sheetData.title || '未命名对话';\nconst conversationHistory = sheetData.conversationHistory || '';\n\n// ⭐ 修复：统一处理 tags，转换为字符串\nlet tags = '';\nif (Array.isArray(sheetData.tags)) {\n  tags = sheetData.tags.join(',');\n} else if (typeof sheetData.tags === 'string') {\n  tags = sheetData.tags;\n}\n\n// 解析conversationHistory为messages数组\nconst pairs = conversationHistory.split('----').filter(s => s.trim());\nconst messages = [];\n\nfor (const pair of pairs) {\n  if (pair.startsWith('userSpeak:')) {\n    messages.push({\n      role: 'user',\n      content: pair.replace('userSpeak:', ''),\n      timestamp: new Date().toISOString()\n    });\n  } else if (pair.startsWith('AISpeak:')) {\n    messages.push({\n      role: 'assistant',\n      content: pair.replace('AISpeak:', ''),\n      timestamp: new Date().toISOString()\n    });\n  }\n}\n\nreturn {\n  json: {\n    success: true,\n    dialogueID: dialogueID,\n    title: title,\n    conversationHistory: conversationHistory,\n    tags: tags,  // ⭐ 现在 tags 一定是字符串（逗号分隔，如 \"越野车,SUV,外观\"）\n    messages: messages,\n    totalMessages: messages.length\n  }\n};"
      },
      "id": "00c8d0e3-166d-4a3d-b910-b0442518d192",
      "name": "GetDialogueDetail1",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4496,
        7504
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "smart-organize-to-folder",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "f7c48c17-ea1d-4e9e-8996-457f93027c39",
      "name": "智能整理入口",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        3536,
        9440
      ],
      "webhookId": "smart-organize-to-folder"
    },
    {
      "parameters": {
        "jsCode": "// 验证必需参数\nconst body = $input.first().json.body;\n\nconsole.log('收到请求:', body);\n\nif (!body.userID) {\n  throw new Error('缺少参数: userID');\n}\n\nif (!body.folderID) {\n  throw new Error('缺少参数: folderID');\n}\n\nif (!body.carNames || (Array.isArray(body.carNames) && body.carNames.length === 0)) {\n  throw new Error('缺少参数: carNames');\n}\n\n// 标准化carNames为数组\nlet carNames = body.carNames;\nif (typeof carNames === 'string') {\n  carNames = carNames.split(',').map(name => name.trim()).filter(name => name);\n}\n\nif (carNames.length > 5) {\n  throw new Error('车型数量不能超过5个');\n}\n\nconsole.log('验证通过，准备处理', carNames.length, '个车型');\n\nreturn {\n  json: {\n    userID: body.userID,\n    folderID: body.folderID,\n    carNames: carNames,\n    filterCategory: body.filterCategory || 'all',\n    filterViewType: body.filterViewType || 'all'\n  }\n};"
      },
      "id": "c98e88b2-cb9a-45f9-8cb9-a49f5d5cff12",
      "name": "验证参数",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3696,
        9440
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "=https://lynn-cafa-system.app.n8n.cloud/webhook/get-car-images",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"carNames\": {{ JSON.stringify($json.carNames) }},\n  \"filterCategory\": \"{{ $json.filterCategory }}\",\n  \"filterViewType\": \"{{ $json.filterViewType }}\"\n}",
        "options": {
          "timeout": 120000
        }
      },
      "id": "885ed7c9-c5a1-43f0-aea9-434d0d4c612f",
      "name": "调用图片获取API",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3888,
        9440
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.success }}",
              "value2": true
            }
          ]
        }
      },
      "id": "9a280807-2a4f-4f2b-a64e-3952d524c547",
      "name": "检查是否成功",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        4352,
        9440
      ]
    },
    {
      "parameters": {
        "jsCode": "// 处理失败响应\nconst response = $input.first().json;\n\nconsole.log('API调用失败:', response);\n\nreturn {\n  json: {\n    success: false,\n    error: response.error || '获取图片失败',\n    message: response.message || '无法获取车型图片',\n    details: response\n  }\n};"
      },
      "id": "10417102-14b6-414b-9996-98fa75e1c337",
      "name": "处理失败",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4544,
        9536
      ]
    },
    {
      "parameters": {
        "fieldToSplitOut": "=images",
        "options": {}
      },
      "id": "f2076792-5951-49b4-8a52-6907eb695f90",
      "name": "展开图片数组",
      "type": "n8n-nodes-base.itemLists",
      "typeVersion": 3,
      "position": [
        4544,
        9328
      ]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// 为每张图片生成收藏项\nconst userID = $('验证参数').first().json.userID;\nconst folderID = $('验证参数').first().json.folderID;\nconst imageData = $input.item.json;\n\n// ⭐ 从处理API响应节点获取车型信息\nconst apiData = $('处理API响应').first().json;\n\n// 尝试从多个来源获取车型信息\nlet carName = '';\nlet carId = '';\nlet brandID = '';\n\n// 优先从图片数据本身获取\nif (imageData.carName) {\n  carName = imageData.carName;\n  carId = imageData.carId || imageData.car_id || '';\n  brandID = imageData.brandID || imageData.brand_id || '';\n} else {\n  // 否则从API响应中获取\n  carName = apiData.carName || '';\n  carId = apiData.carId || '';\n  brandID = apiData.brandID || '';\n}\n\n// 生成唯一ID\nconst timestamp = Date.now();\nconst randomId = Math.random().toString(36).substring(2, 8);\nconst favoriteID = `${folderID}_${timestamp}_${randomId}`;\n\nconsole.log('生成收藏项:', {\n  favoriteID,\n  carName: carName,\n  imageURL: imageData.url || imageData.image_url\n});\n\n// ⭐ 字段名完全匹配Google Sheets列名\nreturn {\n  json: {\n    favoriteID: favoriteID,\n    userID: userID,\n    folderID: folderID,\n    carID: carId,\n    carName: carName,\n    imageURL: imageData.url || imageData.image_url || '',\n    category: imageData.category || '',\n    viewType: imageData.view_type || imageData.viewType || '',\n    favoriteTime: new Date().toISOString(),\n    status: 'active'\n  }\n};"
      },
      "id": "d16b5fa1-6359-4645-9a76-6a93942b2adb",
      "name": "生成收藏项",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4752,
        9328
      ]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ",
          "mode": "list",
          "cachedResultName": "CarSheet"
        },
        "sheetName": {
          "__rl": true,
          "value": 1274046316,
          "mode": "list",
          "cachedResultName": "Favorites",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1mjs9hbxuETgarWLqKlHxhK3XQHKG2E6BmkpMs6RUghQ/edit#gid=1274046316"
        },
        "columns": {
          "mappingMode": "autoMapInputData",
          "value": {
            "carName": "={{ $json.carName }}",
            "carID": "={{ $json.carID }}"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "favoriteID",
              "displayName": "favoriteID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "userID",
              "displayName": "userID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "folderID",
              "displayName": "folderID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "carID",
              "displayName": "carID",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "carName",
              "displayName": "carName",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true
            },
            {
              "id": "imageURL",
              "displayName": "imageURL",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "category",
              "displayName": "category",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "viewType",
              "displayName": "viewType",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "favoriteTime",
              "displayName": "favoriteTime",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "id": "7320ceb3-3052-4c46-98df-86716b0c6461",
      "name": "保存到收藏夹",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        4944,
        9328
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "YS5a72jpKHezwxcc",
          "name": "Google Sheets account 5"
        }
      }
    },
    {
      "parameters": {
        "aggregate": "aggregateAllItemData",
        "options": {}
      },
      "id": "32717b23-3800-4a63-bfb7-6cb246dc6ee5",
      "name": "聚合结果",
      "type": "n8n-nodes-base.aggregate",
      "typeVersion": 1,
      "position": [
        5152,
        9328
      ]
    },
    {
      "parameters": {},
      "id": "ce8780d6-f582-4420-bc91-6109e71d5321",
      "name": "合并响应",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        5344,
        9520
      ]
    },
    {
      "parameters": {
        "options": {}
      },
      "id": "fb244d31-4c7e-4a22-87f8-22096d73e171",
      "name": "返回响应",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        5728,
        9520
      ]
    },
    {
      "parameters": {
        "jsCode": "// 格式化最终响应\nconst allItems = $input.first().json.data || [];\nconst apiData = $('处理API响应').first().json;\n\nconsole.log('智能整理完成，保存了', allItems.length, '张图片');\n\n// 按车型统计\nconst carSummary = {};\nfor (const item of allItems) {\n  const carName = item.carName || '未知车型';\n  if (!carSummary[carName]) {\n    carSummary[carName] = 0;\n  }\n  carSummary[carName]++;\n}\n\nreturn {\n  json: {\n    success: true,\n    message: `成功整理${allItems.length}张图片到收藏夹`,\n    totalImages: allItems.length,\n    savedImages: allItems.length,\n    carSummary: carSummary,\n    apiResponse: {\n      totalCars: apiData.totalCars || 0,\n      successCars: apiData.successCars || 0,\n      totalImagesFromAPI: apiData.totalImages || 0\n    },\n    timestamp: new Date().toISOString()\n  }\n};"
      },
      "id": "dadf7d8b-bda0-4923-9dcf-3fb626d27526",
      "name": "格式化响应2",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5344,
        9328
      ]
    },
    {
      "parameters": {
        "jsCode": "// 标准化API响应格式\nconst apiResponse = $input.first().json;\n\nconsole.log('========== 开始处理API响应 ==========');\nconsole.log('totalCars:', apiResponse.totalCars);\nconsole.log('totalImages:', apiResponse.totalImages);\nconsole.log('results 数量:', apiResponse.results?.length || 0);\n\n// ⭐ 从 results 中展平所有图片\nlet images = [];\nconst results = apiResponse.results || [];\n\nif (results.length === 0) {\n  console.log('❌ results 为空');\n  return {\n    json: {\n      success: false,\n      error: '没有找到匹配的车型',\n      message: apiResponse.message || '未找到车型',\n      apiResponse: apiResponse\n    }\n  };\n}\n\n// 遍历每个车型的 results\nfor (let i = 0; i < results.length; i++) {\n  const result = results[i];\n  console.log(`处理车型 [${i}]: ${result.carName}`);\n  \n  if (!result.images || !Array.isArray(result.images)) {\n    console.log(`  ⚠️ 该车型没有图片数组`);\n    continue;\n  }\n  \n  console.log(`  - 该车型有 ${result.images.length} 张图片`);\n  \n  // 为每张图片添加车型信息\n  for (const img of result.images) {\n    const enrichedImage = {\n      url: img.url,\n      category: img.category || '',\n      view_type: img.view_type || '',\n      index: img.index,\n      pic_id: img.pic_id,\n      spec_id: img.spec_id,\n      // ⭐ 从 result 层级获取车型信息\n      carName: result.carName || '',\n      carId: result.carId || '',\n      brandID: result.brandID || ''\n    };\n    images.push(enrichedImage);\n    console.log(`  ✅ 添加图片: ${img.url}`);\n  }\n}\n\nconsole.log(`最终提取到 ${images.length} 张图片`);\nconsole.log('========================================');\n\n// 检查是否有图片\nif (images.length === 0) {\n  return {\n    json: {\n      success: false,\n      error: '没有找到匹配的图片',\n      message: apiResponse.message || '未找到图片',\n      apiResponse: apiResponse\n    }\n  };\n}\n\n// 有图片，返回成功\nreturn {\n  json: {\n    success: true,\n    images: images,  // ⭐ 展平后的图片数组，每张图片都包含车型信息\n    results: results,\n    totalCars: apiResponse.totalCars || results.length,\n    successCars: apiResponse.successCars || results.length,\n    totalImages: images.length,\n    message: apiResponse.message || `找到${images.length}张图片`,\n    // 保留第一个车型的信息（向后兼容）\n    carName: results[0]?.carName || '',\n    carId: results[0]?.carId || '',\n    brandID: results[0]?.brandID || ''\n  }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4096,
        9440
      ],
      "id": "ad7ba611-136a-44d3-824f-4cec6599b6ab",
      "name": "处理API响应"
    }
  ],
  "pinData": {},
  "connections": {
    "合并参数": {
      "main": [
        [
          {
            "node": "整理数据",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "UserCarIDInput": {
      "main": [
        [
          {
            "node": "汽车之家URL构建",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "汽车之家URL构建": {
      "main": [
        [
          {
            "node": "提取图片URL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "brandID": {
      "main": [
        [
          {
            "node": "四页链接创建",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "四页链接创建": {
      "main": [
        [
          {
            "node": "请求",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "请求": {
      "main": [
        [
          {
            "node": "合并参数",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "整理数据": {
      "main": [
        [
          {
            "node": "Convert to File1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items": {
      "main": [
        [],
        [
          {
            "node": "四页链接创建1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "合并参数1": {
      "main": [
        [
          {
            "node": "整理数据1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "四页链接创建1": {
      "main": [
        [
          {
            "node": "请求1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "请求1": {
      "main": [
        [
          {
            "node": "合并参数1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "整理数据1": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          },
          {
            "node": "Convert to File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "brandID1": {
      "main": [
        [
          {
            "node": "Loop Over Items",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items1": {
      "main": [
        [
          {
            "node": "Convert to File2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "四页链接创建2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "合并参数2": {
      "main": [
        [
          {
            "node": "整理数据2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "四页链接创建2": {
      "main": [
        [
          {
            "node": "请求2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "请求2": {
      "main": [
        [
          {
            "node": "页面请求延迟",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "整理数据2": {
      "main": [
        [
          {
            "node": "数据处理延迟",
            "type": "main",
            "index": 0
          },
          {
            "node": "Append row in sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "brandID2": {
      "main": [
        [
          {
            "node": "Loop Over Items1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "页面请求延迟": {
      "main": [
        [
          {
            "node": "合并参数2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "数据处理延迟": {
      "main": [
        [
          {
            "node": "Loop Over Items1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items2": {
      "main": [
        [
          {
            "node": "Convert to File3",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "四页链接创建3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "合并参数3": {
      "main": [
        [
          {
            "node": "整理数据3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "四页链接创建3": {
      "main": [
        [
          {
            "node": "请求3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "请求3": {
      "main": [
        [
          {
            "node": "页面请求延迟1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "整理数据3": {
      "main": [
        [
          {
            "node": "数据处理延迟1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "brandID3": {
      "main": [
        [
          {
            "node": "Loop Over Items2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "页面请求延迟1": {
      "main": [
        [
          {
            "node": "合并参数3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "数据处理延迟1": {
      "main": [
        [
          {
            "node": "Loop Over Items2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get row(s) in sheet": {
      "main": [
        []
      ]
    },
    "Convert to File2": {
      "main": [
        []
      ]
    },
    "Get row(s) in sheet2": {
      "main": [
        []
      ]
    },
    "读取车型数据": {
      "main": [
        []
      ]
    },
    "循环处理车型": {
      "main": [
        [
          {
            "node": "转换为CSV",
            "type": "main",
            "index": 0
          },
          {
            "node": "Append row in sheet1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "提取车型信息",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "提取车型信息": {
      "main": [
        [
          {
            "node": "请求图片页面",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "请求图片页面": {
      "main": [
        [
          {
            "node": "请求延迟",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "请求延迟": {
      "main": [
        [
          {
            "node": "提取图片并合并信息",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "提取图片并合并信息": {
      "main": [
        [
          {
            "node": "处理延迟",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "处理延迟": {
      "main": [
        [
          {
            "node": "循环处理车型",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "读取邀请码数据": {
      "main": [
        [
          {
            "node": "查找匹配邀请码",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook - 接收登录请求1": {
      "main": [
        [
          {
            "node": "读取邀请码数据",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "查找匹配邀请码": {
      "main": [
        [
          {
            "node": "IF判断是否有效",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF判断是否有效": {
      "main": [
        [
          {
            "node": "✅ 登录成功1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "❌ 登录失败1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "✅ 登录成功1": {
      "main": [
        [
          {
            "node": "返回成功响应1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "❌ 登录失败1": {
      "main": [
        [
          {
            "node": "返回失败响应1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "批量处理车型数据": {
      "main": [
        [
          {
            "node": "存储到Pinecone2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "监听车型表格2": {
      "main": [
        []
      ]
    },
    "文档加载器2": {
      "ai_document": [
        [
          {
            "node": "存储到Pinecone2",
            "type": "ai_document",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI3": {
      "ai_embedding": [
        [
          {
            "node": "存储到Pinecone2",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "存储到Pinecone2": {
      "main": [
        [
          {
            "node": "记录结果2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "处理SerpAPI响应": {
      "main": [
        [
          {
            "node": "安全参数验证",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Embeddings OpenAI": {
      "ai_embedding": [
        [
          {
            "node": "Pinecone查询",
            "type": "ai_embedding",
            "index": 0
          }
        ]
      ]
    },
    "安全解析提取": {
      "main": [
        [
          {
            "node": "返回响应1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "爬取目标页面": {
      "main": [
        [
          {
            "node": "安全解析提取",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "安全参数验证": {
      "main": [
        [
          {
            "node": "爬取目标页面",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "搜索车型": {
      "main": [
        [
          {
            "node": "处理SerpAPI响应",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "检查是否需要搜索": {
      "main": [
        [
          {
            "node": "搜索车型",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "安全参数验证",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "分析结果": {
      "main": [
        [
          {
            "node": "检查是否需要搜索",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pinecone查询": {
      "main": [
        [
          {
            "node": "分析结果",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "准备查询": {
      "main": [
        [
          {
            "node": "Pinecone查询",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "提取用户输入": {
      "main": [
        [
          {
            "node": "准备查询",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook触发1": {
      "main": [
        []
      ]
    },
    "Webhook接收筛选请求1": {
      "main": [
        [
          {
            "node": "解析筛选条件",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "读取Google Sheet": {
      "main": [
        [
          {
            "node": "执行筛选",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "解析筛选条件": {
      "main": [
        [
          {
            "node": "读取Google Sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "执行筛选": {
      "main": [
        [
          {
            "node": "格式化响应",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "格式化响应": {
      "main": [
        [
          {
            "node": "返回结果1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "模糊匹配分析": {
      "main": [
        [
          {
            "node": "检查是否需要搜索2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "提取车型名称1": {
      "main": [
        [
          {
            "node": "准备查询2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "准备查询2": {
      "main": [
        [
          {
            "node": "读取Google Sheet2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "检查是否需要搜索2": {
      "main": [
        [
          {
            "node": "搜索车型2",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "生成所有分类任务1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "搜索车型2": {
      "main": [
        [
          {
            "node": "处理SerpAPI响应2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "处理SerpAPI响应2": {
      "main": [
        [
          {
            "node": "生成所有分类任务1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "生成所有分类任务1": {
      "main": [
        [
          {
            "node": "爬取目标页面2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "爬取目标页面2": {
      "main": [
        [
          {
            "node": "提取图片1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "提取图片1": {
      "main": [
        [
          {
            "node": "合并所有结果1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "合并所有结果1": {
      "main": [
        [
          {
            "node": "返回响应2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "读取Google Sheet2": {
      "main": [
        [
          {
            "node": "模糊匹配分析",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "直接搜索": {
      "main": [
        [
          {
            "node": "提取车型名称1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "详细界面": {
      "main": [
        [
          {
            "node": "解析参数2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI智能体1": {
      "main": [
        [
          {
            "node": "整合最终结果1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DeepSeek Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "AI智能体1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "整合最终结果1": {
      "main": [
        [
          {
            "node": "返回结果",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "解析参数2": {
      "main": [
        [
          {
            "node": "读取GoogleSheet2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "读取GoogleSheet2": {
      "main": [
        [
          {
            "node": "处理所有逻辑2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "处理所有逻辑2": {
      "main": [
        [
          {
            "node": "AI智能体1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "处理参数": {
      "main": [
        [
          {
            "node": "选择操作1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "保存收藏夹": {
      "main": [
        [
          {
            "node": "创建收藏夹成功",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "读取收藏夹": {
      "main": [
        [
          {
            "node": "收藏夹列表响应",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "保存收藏": {
      "main": [
        [
          {
            "node": "添加收藏成功",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "读取收藏": {
      "main": [
        [
          {
            "node": "收藏列表响应",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "查找要删除的收藏": {
      "main": [
        [
          {
            "node": "标记收藏为删除",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "查找要删除的收藏夹": {
      "main": [
        [
          {
            "node": "标记收藏夹为删除",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "标记收藏为删除": {
      "main": [
        [
          {
            "node": "删除收藏成功",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "标记收藏夹为删除": {
      "main": [
        [
          {
            "node": "删除收藏夹成功",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "创建收藏夹成功": {
      "main": [
        [
          {
            "node": "返回结果2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "收藏夹列表响应": {
      "main": [
        [
          {
            "node": "返回结果2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "添加收藏成功": {
      "main": [
        [
          {
            "node": "返回结果2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "收藏列表响应": {
      "main": [
        [
          {
            "node": "返回结果2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "删除收藏成功": {
      "main": [
        [
          {
            "node": "返回结果2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "删除收藏夹成功": {
      "main": [
        [
          {
            "node": "返回结果2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "收藏入口1": {
      "main": [
        [
          {
            "node": "处理参数",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "选择操作1": {
      "main": [
        [
          {
            "node": "保存收藏夹",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "读取收藏夹",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "保存收藏",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "读取收藏",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "查找要删除的收藏",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "查找要删除的收藏夹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Router": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "ProcessMessage",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "读取报告对话数据",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "读取对话列表",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "读取对话详情",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ProcessMessage": {
      "main": [
        [
          {
            "node": "判断是否新对话",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "判断是否新对话": {
      "main": [
        [
          {
            "node": "初始化对话",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "追加用户消息",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GenerateReport": {
      "main": [
        [
          {
            "node": "统一响应",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GetDialogueList": {
      "main": [
        [
          {
            "node": "统一响应",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "格式化响应1": {
      "main": [
        [
          {
            "node": "统一响应",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "处理AI响应",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DeepSeek Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "转换为AI格式": {
      "main": [
        [
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "初始化对话": {
      "main": [
        [
          {
            "node": "转换为AI格式",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "处理AI响应": {
      "main": [
        [
          {
            "node": "准备写入数据",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "保存conversationHistory到表格": {
      "main": [
        [
          {
            "node": "格式化响应1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "追加用户消息": {
      "main": [
        [
          {
            "node": "转换为AI格式",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "读取对话详情": {
      "main": [
        [
          {
            "node": "GetDialogueDetail",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "GetDialogueDetail": {
      "main": [
        [
          {
            "node": "统一响应",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "读取对话列表": {
      "main": [
        [
          {
            "node": "GetDialogueList",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI分析入口": {
      "main": [
        [
          {
            "node": "Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "读取报告对话数据": {
      "main": [
        [
          {
            "node": "准备报告分析prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "DeepSeek Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent1": {
      "main": [
        [
          {
            "node": "提取车型列表",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "准备报告分析prompt": {
      "main": [
        [
          {
            "node": "AI Agent1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Aggregate": {
      "main": [
        [
          {
            "node": "格式化多车型结果",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "格式化多车型结果": {
      "main": [
        [
          {
            "node": "返回响应3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "提取车型名称2": {
      "main": [
        [
          {
            "node": "准备查询3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "准备查询3": {
      "main": [
        [
          {
            "node": "Loop Over Items3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "读取Google Sheet4": {
      "main": [
        [
          {
            "node": "模糊匹配分析2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "模糊匹配分析2": {
      "main": [
        [
          {
            "node": "检查是否需要搜索3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "检查是否需要搜索3": {
      "main": [
        [
          {
            "node": "SerpAPI搜索1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "合并carID结果1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "SerpAPI搜索1": {
      "main": [
        [
          {
            "node": "处理SerpAPI响应3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "处理SerpAPI响应3": {
      "main": [
        [
          {
            "node": "合并carID结果1",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "合并carID结果1": {
      "main": [
        [
          {
            "node": "请求图片页面2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "请求图片页面2": {
      "main": [
        [
          {
            "node": "提取图片信息1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "提取图片信息1": {
      "main": [
        [
          {
            "node": "合并最终结果1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "合并最终结果1": {
      "main": [
        [
          {
            "node": "Loop Over Items3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "多车筛选": {
      "main": [
        [
          {
            "node": "提取车型名称2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items3": {
      "main": [
        [
          {
            "node": "Aggregate",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "读取Google Sheet4",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "提取车型列表": {
      "main": [
        [
          {
            "node": "调用图片API (HTTP Request)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "智能选图合并": {
      "main": [
        [
          {
            "node": "GenerateReport",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "调用图片API (HTTP Request)1": {
      "main": [
        [
          {
            "node": "智能选图合并",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "准备写入数据": {
      "main": [
        [
          {
            "node": "过滤空字段",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "过滤空字段": {
      "main": [
        [
          {
            "node": "保存conversationHistory到表格",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "智能整理入口": {
      "main": [
        [
          {
            "node": "验证参数",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "验证参数": {
      "main": [
        [
          {
            "node": "调用图片获取API",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "调用图片获取API": {
      "main": [
        [
          {
            "node": "处理API响应",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "检查是否成功": {
      "main": [
        [
          {
            "node": "展开图片数组",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "处理失败",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "展开图片数组": {
      "main": [
        [
          {
            "node": "生成收藏项",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "生成收藏项": {
      "main": [
        [
          {
            "node": "保存到收藏夹",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "保存到收藏夹": {
      "main": [
        [
          {
            "node": "聚合结果",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "聚合结果": {
      "main": [
        [
          {
            "node": "格式化响应2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "处理失败": {
      "main": [
        [
          {
            "node": "合并响应",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "合并响应": {
      "main": [
        [
          {
            "node": "返回响应",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "格式化响应2": {
      "main": [
        [
          {
            "node": "合并响应",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "处理API响应": {
      "main": [
        [
          {
            "node": "检查是否成功",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "0633e497-5a3b-4b7f-98f1-249f1a2c8ed8",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "5cb72472896fce0666bc03ef84936c4f09ec11e6b4f95f9aebe3d538947c7935"
  },
  "id": "plqdvfnb9yrcWgDi",
  "tags": []
}